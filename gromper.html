<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ChordFlow + CTK-3200</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
  <style>
    * { font-family: 'Outfit', sans-serif; }
    ::-webkit-scrollbar { width: 8px; }
    ::-webkit-scrollbar-track { background: #1e293b; }
    ::-webkit-scrollbar-thumb { background: #475569; border-radius: 4px; }
    .tone-grid { max-height: 300px; overflow-y: auto; }
    #status-log { max-height: 100px; overflow-y: auto; font-family: monospace; font-size: 11px; }
  </style>
</head>
<body class="bg-slate-950 text-white">
  <div id="root"></div>

  <script>
    // Constants
    const NOTES = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'];
    const NOTE_TO_MIDI = { 'C': 0, 'C#': 1, 'D': 2, 'D#': 3, 'E': 4, 'F': 5, 'F#': 6, 'G': 7, 'G#': 8, 'A': 9, 'A#': 10, 'B': 11 };
    
    const CHORD_TYPES = {
      'maj': { intervals: [0, 4, 7], symbol: '' },
      'min': { intervals: [0, 3, 7], symbol: 'm' },
      'dim': { intervals: [0, 3, 6], symbol: '¬∞' },
      'aug': { intervals: [0, 4, 8], symbol: '+' },
      'maj7': { intervals: [0, 4, 7, 11], symbol: 'maj7' },
      'min7': { intervals: [0, 3, 7, 10], symbol: 'm7' },
      '7': { intervals: [0, 4, 7, 10], symbol: '7' },
      'sus2': { intervals: [0, 2, 7], symbol: 'sus2' },
      'sus4': { intervals: [0, 5, 7], symbol: 'sus4' },
    };

    const SCALES = {
      'major': { pattern: [0, 2, 4, 5, 7, 9, 11], chords: ['maj', 'min', 'min', 'maj', 'maj', 'min', 'dim'] },
      'minor': { pattern: [0, 2, 3, 5, 7, 8, 10], chords: ['min', 'dim', 'maj', 'min', 'min', 'maj', 'maj'] },
      'dorian': { pattern: [0, 2, 3, 5, 7, 9, 10], chords: ['min', 'min', 'maj', 'maj', 'min', 'dim', 'maj'] },
    };

    const PROGRESSIONS = [
      { name: 'Pop', degrees: [0, 4, 5, 3] },
      { name: 'Jazz', degrees: [1, 4, 0] },
      { name: 'Blues', degrees: [0, 3, 0, 4] },
      { name: '50s', degrees: [0, 5, 3, 4] },
      { name: 'Canon', degrees: [0, 4, 5, 2, 3, 0, 3, 4] },
    ];

    const PATTERNS = { 'whole': [[0, 4]], 'half': [[0, 2], [2, 2]], 'quarter': [[0, 1], [1, 1], [2, 1], [3, 1]], 'arpUp': 'arpUp', 'strum': 'strum' };

    const LP_GRID = [
      [81,82,83,84,85,86,87,88], [71,72,73,74,75,76,77,78],
      [61,62,63,64,65,66,67,68], [51,52,53,54,55,56,57,58],
      [41,42,43,44,45,46,47,48], [31,32,33,34,35,36,37,38],
      [21,22,23,24,25,26,27,28], [11,12,13,14,15,16,17,18],
    ];
    const LP_SCENE = [89, 79, 69, 59, 49, 39, 29, 19];
    const LP_COLORS = { off: 0, green: 87, red: 72, orange: 84, cyan: 90, blue: 78, purple: 94, magenta: 81, pink: 56, white: 119, yellow: 62 };

    // State
    let state = {
      key: 'C',
      scale: 'major',
      tempo: 120,
      octave: 4,
      velocity: 100,
      progression: [
        { root: 'C', type: 'maj', beats: 4 },
        { root: 'G', type: 'maj', beats: 4 },
        { root: 'A', type: 'min', beats: 4 },
        { root: 'F', type: 'maj', beats: 4 },
      ],
      selectedSlot: null,
      pattern: 'whole',
      isPlaying: false,
      currentChord: -1,
      tones: [],
      selectedTone: null,
      showTones: false,
      toneSearch: '',
      synthOutput: null,
      launchpadIn: null,
      launchpadOut: null,
      midiOutputs: [],
      midiInputs: [],
      midiAccess: null,
      midiEnabled: false,
      logs: [],
    };

    let playInterval = null;
    let activeNotes = new Set();

    // Logging
    const log = (msg, type = 'info') => {
      const time = new Date().toLocaleTimeString();
      state.logs.unshift({ time, msg, type });
      if (state.logs.length > 20) state.logs.pop();
      console.log(`[${type}] ${msg}`);
      render();
    };

    // Helpers
    const getChordName = (root, type) => `${root}${CHORD_TYPES[type]?.symbol || ''}`;
    
    const getChordNotes = (root, type, octave) => {
      const rootMidi = NOTE_TO_MIDI[root] + (octave + 1) * 12;
      return (CHORD_TYPES[type]?.intervals || [0, 4, 7]).map(i => rootMidi + i);
    };

    const getScaleChords = () => {
      const keyIdx = NOTE_TO_MIDI[state.key];
      const scaleData = SCALES[state.scale];
      return scaleData.pattern.map((interval, i) => ({
        root: NOTES[(keyIdx + interval) % 12],
        type: scaleData.chords[i],
        degree: ['I', 'II', 'III', 'IV', 'V', 'VI', 'VII'][i]
      }));
    };

    // MIDI Functions
    const sendNote = (note, vel, duration) => {
      if (!state.synthOutput) return;
      try {
        state.synthOutput.send([0x90, note, vel]);
        activeNotes.add(note);
        setTimeout(() => {
          if (state.synthOutput) state.synthOutput.send([0x80, note, 0]);
          activeNotes.delete(note);
        }, duration);
      } catch (e) { log('Erreur MIDI: ' + e.message, 'error'); }
    };

    const playChord = (root, type) => {
      const notes = getChordNotes(root, type, state.octave);
      const dur = 60000 / state.tempo * 0.8;
      notes.forEach((n, i) => setTimeout(() => sendNote(n, state.velocity, dur), i * 25));
    };

    const sendProgramChange = (tone) => {
      if (!state.synthOutput || !tone) return;
      try {
        if (tone.bank !== undefined) {
          state.synthOutput.send([0xB0, 0, Math.floor(tone.bank / 128)]);
          state.synthOutput.send([0xB0, 32, tone.bank % 128]);
        }
        const prog = tone.program !== undefined ? tone.program : (tone.number - 1) % 128;
        state.synthOutput.send([0xC0, prog]);
        log(`Program Change: ${tone.number}. ${tone.name}`);
      } catch (e) { log('Erreur Program Change: ' + e.message, 'error'); }
    };

    const stopPlayback = () => {
      if (playInterval) { clearInterval(playInterval); playInterval = null; }
      state.isPlaying = false;
      state.currentChord = -1;
      activeNotes.forEach(n => { if (state.synthOutput) state.synthOutput.send([0x80, n, 0]); });
      activeNotes.clear();
      render();
      updateLaunchpad();
    };

    const startPlayback = () => {
      if (state.isPlaying) { stopPlayback(); return; }
      if (state.progression.length === 0) return;
      
      state.isPlaying = true;
      log('Lecture d√©marr√©e');
      const beatMs = 60000 / state.tempo;
      const totalBeats = state.progression.reduce((s, c) => s + c.beats, 0);
      
      let chordStarts = [], cum = 0;
      state.progression.forEach(c => { chordStarts.push(cum); cum += c.beats; });
      
      const startTime = performance.now();
      
      playInterval = setInterval(() => {
        const elapsed = performance.now() - startTime;
        const beat = (elapsed / beatMs) % totalBeats;
        
        let chordIdx = 0;
        for (let i = 0; i < chordStarts.length; i++) {
          if (beat >= chordStarts[i]) chordIdx = i;
        }
        
        if (chordIdx !== state.currentChord) {
          state.currentChord = chordIdx;
          const chord = state.progression[chordIdx];
          playChord(chord.root, chord.type);
          render();
          updateLaunchpad();
        }
      }, 50);
      
      render();
      updateLaunchpad();
    };

    // Launchpad
    const setLED = (note, color) => {
      if (state.launchpadOut) {
        try { state.launchpadOut.send([0x90, note, color]); } catch (e) {}
      }
    };

    const updateLaunchpad = () => {
      if (!state.launchpadOut) return;
      
      LP_GRID.flat().forEach(n => setLED(n, 0));
      LP_SCENE.forEach(n => setLED(n, 0));
      
      state.progression.forEach((c, i) => {
        if (i < 16) {
          const row = i < 8 ? 0 : 1;
          const col = i % 8;
          let color = [LP_COLORS.cyan, LP_COLORS.blue, LP_COLORS.purple, LP_COLORS.magenta, LP_COLORS.pink, LP_COLORS.orange, LP_COLORS.red][i % 7];
          if (i === state.currentChord && state.isPlaying) color = LP_COLORS.green;
          else if (i === state.selectedSlot) color = LP_COLORS.white;
          setLED(LP_GRID[row][col], color);
        }
      });
      
      getScaleChords().forEach((_, i) => setLED(LP_GRID[2][i], [LP_COLORS.cyan, LP_COLORS.blue, LP_COLORS.purple, LP_COLORS.magenta, LP_COLORS.pink, LP_COLORS.orange, LP_COLORS.red][i]));
      PROGRESSIONS.forEach((_, i) => setLED(LP_GRID[3][i], LP_COLORS.purple));
      Object.keys(PATTERNS).forEach((p, i) => setLED(LP_GRID[4][i], state.pattern === p ? LP_COLORS.green : 21));
      NOTES.slice(0, 8).forEach((n, i) => setLED(LP_GRID[5][i], state.key === n ? LP_COLORS.cyan : 37));
      NOTES.slice(8).forEach((n, i) => setLED(LP_GRID[6][i], state.key === n ? LP_COLORS.cyan : 37));
      Object.keys(SCALES).forEach((s, i) => setLED(LP_GRID[6][4+i], state.scale === s ? LP_COLORS.magenta : 53));
      setLED(LP_GRID[7][0], state.isPlaying ? LP_COLORS.red : LP_COLORS.green);
      setLED(LP_GRID[7][1], LP_COLORS.orange);
      setLED(LP_GRID[7][2], LP_COLORS.blue);
      LP_SCENE.slice(0, 6).forEach((n, i) => setLED(n, state.velocity >= (i+1)*20 ? LP_COLORS.orange : 9));
      setLED(LP_SCENE[6], LP_COLORS.blue);
      setLED(LP_SCENE[7], LP_COLORS.blue);
    };

    const handleLaunchpadInput = (note, vel) => {
      if (vel === 0) return;
      
      let row = -1, col = -1;
      for (let r = 0; r < 8; r++) {
        const c = LP_GRID[r].indexOf(note);
        if (c !== -1) { row = r; col = c; break; }
      }
      
      if (row !== -1) {
        if (row < 2) {
          const idx = row * 8 + col;
          if (idx < state.progression.length) {
            state.selectedSlot = idx;
            playChord(state.progression[idx].root, state.progression[idx].type);
          }
        } else if (row === 2 && col < 7) {
          const chord = getScaleChords()[col];
          if (state.selectedSlot !== null) {
            state.progression[state.selectedSlot] = { ...state.progression[state.selectedSlot], root: chord.root, type: chord.type };
            state.selectedSlot = null;
          } else {
            state.progression.push({ root: chord.root, type: chord.type, beats: 4 });
          }
          playChord(chord.root, chord.type);
        } else if (row === 3 && col < PROGRESSIONS.length) {
          const scaleChords = getScaleChords();
          state.progression = PROGRESSIONS[col].degrees.map(d => ({ root: scaleChords[d].root, type: scaleChords[d].type, beats: 4 }));
        } else if (row === 4 && col < Object.keys(PATTERNS).length) {
          state.pattern = Object.keys(PATTERNS)[col];
        } else if (row === 5 && col < 8) {
          state.key = NOTES[col];
        } else if (row === 6) {
          if (col < 4) state.key = NOTES[8 + col];
          else if (col - 4 < Object.keys(SCALES).length) state.scale = Object.keys(SCALES)[col - 4];
        } else if (row === 7) {
          if (col === 0) state.isPlaying ? stopPlayback() : startPlayback();
          else if (col === 1) { state.progression = []; state.selectedSlot = null; }
          else if (col === 2) downloadMidi();
        }
        render();
        updateLaunchpad();
      }
      
      const sceneIdx = LP_SCENE.indexOf(note);
      if (sceneIdx !== -1) {
        if (sceneIdx < 6) state.velocity = Math.min(127, (sceneIdx + 1) * 21);
        else if (sceneIdx === 6) navigateTone(-1);
        else if (sceneIdx === 7) navigateTone(1);
        render();
        updateLaunchpad();
      }
    };

    const navigateTone = (dir) => {
      if (state.tones.length === 0) return;
      const idx = state.selectedTone ? state.tones.findIndex(t => t.number === state.selectedTone.number) : -1;
      let newIdx = idx + dir;
      if (newIdx < 0) newIdx = state.tones.length - 1;
      if (newIdx >= state.tones.length) newIdx = 0;
      state.selectedTone = state.tones[newIdx];
      sendProgramChange(state.selectedTone);
      render();
    };

    // MIDI Export
    const downloadMidi = () => {
      const tpb = 480;
      const events = [];
      let tick = 0;
      
      state.progression.forEach(chord => {
        const notes = getChordNotes(chord.root, chord.type, state.octave);
        notes.forEach(n => {
          events.push({ tick, type: 'on', note: n });
          events.push({ tick: tick + chord.beats * tpb - 10, type: 'off', note: n });
        });
        tick += chord.beats * tpb;
      });
      
      events.sort((a, b) => a.tick - b.tick);
      
      const track = [];
      let lastTick = 0;
      
      const uspb = Math.floor(60000000 / state.tempo);
      track.push(0, 0xFF, 0x51, 0x03, (uspb >> 16) & 0xFF, (uspb >> 8) & 0xFF, uspb & 0xFF);
      
      events.forEach(e => {
        const delta = e.tick - lastTick;
        if (delta < 128) track.push(delta);
        else track.push((delta >> 7) | 0x80, delta & 0x7F);
        track.push(e.type === 'on' ? 0x90 : 0x80, e.note, e.type === 'on' ? state.velocity : 0);
        lastTick = e.tick;
      });
      
      track.push(0, 0xFF, 0x2F, 0x00);
      
      const header = [0x4D, 0x54, 0x68, 0x64, 0, 0, 0, 6, 0, 0, 0, 1, (tpb >> 8) & 0xFF, tpb & 0xFF];
      const trackHeader = [0x4D, 0x54, 0x72, 0x6B, (track.length >> 24) & 0xFF, (track.length >> 16) & 0xFF, (track.length >> 8) & 0xFF, track.length & 0xFF];
      
      const midi = new Uint8Array([...header, ...trackHeader, ...track]);
      const blob = new Blob([midi], { type: 'audio/midi' });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = `progression_${state.key}_${state.scale}.mid`;
      a.click();
      log('Fichier MIDI export√©');
    };

    // Request MIDI Access - EXPLICIT BUTTON
    const requestMidiAccess = async () => {
      log('Demande d\'acc√®s MIDI...');
      
      if (!navigator.requestMIDIAccess) {
        log('Web MIDI non support√© par ce navigateur!', 'error');
        return;
      }
      
      try {
        const access = await navigator.requestMIDIAccess({ sysex: true });
        state.midiAccess = access;
        state.midiEnabled = true;
        log('Acc√®s MIDI obtenu!', 'success');
        
        const updateDevices = () => {
          state.midiOutputs = Array.from(access.outputs.values());
          state.midiInputs = Array.from(access.inputs.values());
          
          log(`Trouv√© ${state.midiOutputs.length} sorties, ${state.midiInputs.length} entr√©es`);
          
          state.midiOutputs.forEach(d => log(`  Output: ${d.name}`));
          state.midiInputs.forEach(d => log(`  Input: ${d.name}`));
          
          // Auto-select Launchpad
          const lpOut = state.midiOutputs.find(d => d.name.toLowerCase().includes('launchpad'));
          const lpIn = state.midiInputs.find(d => d.name.toLowerCase().includes('launchpad'));
          const synth = state.midiOutputs.find(d => !d.name.toLowerCase().includes('launchpad'));
          
          if (lpOut && !state.launchpadOut) {
            state.launchpadOut = lpOut;
            log(`Launchpad Out: ${lpOut.name}`, 'success');
            updateLaunchpad();
          }
          if (lpIn && !state.launchpadIn) {
            state.launchpadIn = lpIn;
            lpIn.onmidimessage = (e) => {
              if ((e.data[0] & 0xF0) === 0x90) handleLaunchpadInput(e.data[1], e.data[2]);
            };
            log(`Launchpad In: ${lpIn.name}`, 'success');
          }
          if (synth && !state.synthOutput) {
            state.synthOutput = synth;
            log(`Synth: ${synth.name}`, 'success');
            if (state.selectedTone) sendProgramChange(state.selectedTone);
          }
          
          render();
        };
        
        updateDevices();
        access.onstatechange = () => {
          log('Changement de p√©riph√©riques MIDI');
          updateDevices();
        };
        
      } catch (e) {
        log('Erreur acc√®s MIDI: ' + e.message, 'error');
        state.midiEnabled = false;
      }
      
      render();
    };

    // Load tones
    const loadTones = async () => {
      log('Chargement des voix CTK-3200...');
      try {
        const res = await fetch('https://rogergodro.github.io/CTK3200_WPA_MIDI/ctk3200_tones.json');
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        state.tones = await res.json();
        log(`${state.tones.length} voix charg√©es!`, 'success');
        if (state.tones.length > 0) state.selectedTone = state.tones[0];
      } catch (e) {
        log('Erreur chargement voix: ' + e.message, 'error');
        log('Utilisation des voix GM par d√©faut');
        state.tones = Array.from({ length: 128 }, (_, i) => ({ number: i + 1, name: `GM ${i + 1}`, program: i }));
        state.selectedTone = state.tones[0];
      }
      render();
    };

    // Select MIDI device
    const selectSynthOutput = (id) => {
      state.synthOutput = state.midiOutputs.find(o => o.id === id) || null;
      if (state.synthOutput) {
        log(`Synth s√©lectionn√©: ${state.synthOutput.name}`);
        if (state.selectedTone) sendProgramChange(state.selectedTone);
      }
      render();
    };

    const selectLaunchpadIn = (id) => {
      if (state.launchpadIn) state.launchpadIn.onmidimessage = null;
      state.launchpadIn = state.midiInputs.find(o => o.id === id) || null;
      if (state.launchpadIn) {
        state.launchpadIn.onmidimessage = (e) => {
          if ((e.data[0] & 0xF0) === 0x90) handleLaunchpadInput(e.data[1], e.data[2]);
        };
        log(`Launchpad In s√©lectionn√©: ${state.launchpadIn.name}`);
      }
      render();
    };

    const selectLaunchpadOut = (id) => {
      state.launchpadOut = state.midiOutputs.find(o => o.id === id) || null;
      if (state.launchpadOut) {
        log(`Launchpad Out s√©lectionn√©: ${state.launchpadOut.name}`);
        updateLaunchpad();
      }
      render();
    };

    // Render
    const render = () => {
      const scaleChords = getScaleChords();
      const totalBeats = state.progression.reduce((s, c) => s + c.beats, 0);
      const filteredTones = state.tones.filter(t => 
        !state.toneSearch || t.name.toLowerCase().includes(state.toneSearch.toLowerCase()) || t.number.toString().includes(state.toneSearch)
      );

      document.getElementById('root').innerHTML = `
        <div class="min-h-screen bg-gradient-to-br from-slate-950 via-slate-900 to-slate-950 p-4">
          <div class="max-w-6xl mx-auto space-y-4">
            
            <!-- Header -->
            <div class="flex flex-wrap items-center justify-between gap-2">
              <div>
                <h1 class="text-2xl font-black bg-gradient-to-r from-violet-400 via-fuchsia-400 to-cyan-400 text-transparent bg-clip-text">ChordFlow + CTK-3200</h1>
                <p class="text-slate-500 text-xs">Launchpad MK2 ‚Ä¢ ${state.tones.length} Voices</p>
              </div>
              <div class="flex items-center gap-2">
                <button onclick="navigateTone(-1)" class="w-8 h-8 bg-slate-700 rounded-lg hover:bg-slate-600">‚óÄ</button>
                <button onclick="state.showTones=!state.showTones;render()" class="bg-gradient-to-r from-amber-600 to-orange-600 px-4 py-2 rounded-xl font-bold">
                  üéπ ${state.selectedTone ? `${state.selectedTone.number}. ${state.selectedTone.name}` : 'Select'}
                </button>
                <button onclick="navigateTone(1)" class="w-8 h-8 bg-slate-700 rounded-lg hover:bg-slate-600">‚ñ∂</button>
              </div>
            </div>

            <!-- MIDI ACCESS BUTTON -->
            ${!state.midiEnabled ? `
            <div class="bg-gradient-to-r from-emerald-600 to-cyan-600 rounded-2xl p-4 text-center">
              <p class="mb-2">Pour utiliser les appareils MIDI, cliquez sur le bouton ci-dessous:</p>
              <button onclick="requestMidiAccess()" class="bg-white text-slate-900 px-6 py-3 rounded-xl font-bold text-lg hover:bg-slate-100 transition">
                üéπ Activer MIDI
              </button>
            </div>
            ` : ''}

            <!-- Tone Picker -->
            ${state.showTones ? `
            <div class="bg-slate-800/95 rounded-2xl p-4 border border-slate-700">
              <div class="flex items-center justify-between mb-3">
                <h3 class="font-bold">CTK-3200 Voices (${state.tones.length})</h3>
                <button onclick="state.showTones=false;render()" class="text-slate-400 hover:text-white">‚úï</button>
              </div>
              <input type="text" placeholder="Rechercher..." value="${state.toneSearch}" oninput="state.toneSearch=this.value;render()" 
                class="w-full bg-slate-900 border border-slate-700 rounded-lg px-3 py-2 mb-3">
              <div class="tone-grid grid grid-cols-3 sm:grid-cols-4 md:grid-cols-6 gap-1">
                ${filteredTones.slice(0, 100).map(t => `
                  <button onclick="state.selectedTone=state.tones.find(x=>x.number===${t.number});sendProgramChange(state.selectedTone);state.showTones=false;render()"
                    class="p-2 rounded-lg text-left ${state.selectedTone?.number === t.number ? 'bg-amber-600' : 'bg-slate-700/50 hover:bg-slate-600'}">
                    <span class="text-xs text-slate-400">${t.number}</span>
                    <span class="text-sm block truncate">${t.name}</span>
                  </button>
                `).join('')}
              </div>
            </div>
            ` : ''}

            <!-- MIDI Devices -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-2">
              <div class="bg-slate-800/50 rounded-xl p-3 border border-slate-700/50">
                <label class="text-xs text-slate-400 block mb-1">Synth Output (CTK-3200)</label>
                <select onchange="selectSynthOutput(this.value)" class="w-full bg-slate-900 border border-slate-700 rounded-lg px-2 py-1 text-sm">
                  <option value="">None</option>
                  ${state.midiOutputs.filter(o => !o.name.toLowerCase().includes('launchpad')).map(o => 
                    `<option value="${o.id}" ${state.synthOutput?.id === o.id ? 'selected' : ''}>${o.name}</option>`
                  ).join('')}
                </select>
              </div>
              <div class="bg-slate-800/50 rounded-xl p-3 border border-slate-700/50">
                <label class="text-xs text-slate-400 block mb-1">Launchpad In</label>
                <select onchange="selectLaunchpadIn(this.value)" class="w-full bg-slate-900 border border-slate-700 rounded-lg px-2 py-1 text-sm">
                  <option value="">None</option>
                  ${state.midiInputs.map(o => 
                    `<option value="${o.id}" ${state.launchpadIn?.id === o.id ? 'selected' : ''}>${o.name}</option>`
                  ).join('')}
                </select>
              </div>
              <div class="bg-slate-800/50 rounded-xl p-3 border border-slate-700/50">
                <label class="text-xs text-slate-400 block mb-1">Launchpad Out</label>
                <select onchange="selectLaunchpadOut(this.value)" class="w-full bg-slate-900 border border-slate-700 rounded-lg px-2 py-1 text-sm">
                  <option value="">None</option>
                  ${state.midiOutputs.map(o => 
                    `<option value="${o.id}" ${state.launchpadOut?.id === o.id ? 'selected' : ''}>${o.name}</option>`
                  ).join('')}
                </select>
              </div>
            </div>

            <!-- Controls -->
            <div class="grid grid-cols-2 lg:grid-cols-5 gap-2">
              <div class="bg-slate-800/50 rounded-xl p-3 border border-slate-700/50">
                <div class="grid grid-cols-2 gap-2">
                  <select onchange="state.key=this.value;render();updateLaunchpad()" class="bg-slate-900 border border-slate-700 rounded-lg px-2 py-1.5 text-lg font-bold">
                    ${NOTES.map(n => `<option value="${n}" ${state.key === n ? 'selected' : ''}>${n}</option>`).join('')}
                  </select>
                  <select onchange="state.scale=this.value;render();updateLaunchpad()" class="bg-slate-900 border border-slate-700 rounded-lg px-2 py-1.5 text-sm capitalize">
                    ${Object.keys(SCALES).map(s => `<option value="${s}" ${state.scale === s ? 'selected' : ''}>${s}</option>`).join('')}
                  </select>
                </div>
              </div>
              
              <div class="bg-slate-800/50 rounded-xl p-3 border border-slate-700/50">
                <div class="flex items-center gap-2">
                  <span class="text-xs text-slate-400">BPM</span>
                  <input type="range" min="40" max="200" value="${state.tempo}" oninput="state.tempo=+this.value;render()" class="flex-1 accent-violet-500">
                  <span class="font-bold w-8 text-right">${state.tempo}</span>
                </div>
              </div>
              
              <div class="bg-slate-800/50 rounded-xl p-3 border border-slate-700/50">
                <div class="flex items-center gap-2">
                  <button onclick="state.octave=Math.max(1,state.octave-1);render()" class="w-6 h-6 bg-slate-700 rounded">-</button>
                  <span class="font-bold">Oct ${state.octave}</span>
                  <button onclick="state.octave=Math.min(7,state.octave+1);render()" class="w-6 h-6 bg-slate-700 rounded">+</button>
                  <input type="range" min="1" max="127" value="${state.velocity}" oninput="state.velocity=+this.value;render();updateLaunchpad()" class="flex-1 accent-cyan-500">
                </div>
              </div>
              
              <div class="bg-slate-800/50 rounded-xl p-3 border border-slate-700/50">
                <div class="flex flex-wrap gap-1">
                  ${Object.keys(PATTERNS).map(p => `
                    <button onclick="state.pattern='${p}';render();updateLaunchpad()" 
                      class="px-2 py-1 rounded text-xs ${state.pattern === p ? 'bg-violet-600' : 'bg-slate-700'}">${p}</button>
                  `).join('')}
                </div>
              </div>
              
              <div class="bg-slate-800/50 rounded-xl p-3 border border-slate-700/50 flex items-center justify-center gap-2">
                <button onclick="startPlayback()" class="px-4 py-2 rounded-lg font-bold ${state.isPlaying ? 'bg-red-500' : 'bg-emerald-500'}">
                  ${state.isPlaying ? '‚èπ' : '‚ñ∂'}
                </button>
                <button onclick="downloadMidi()" class="px-4 py-2 rounded-lg font-bold bg-violet-600">üíæ</button>
              </div>
            </div>

            <!-- Scale Chords -->
            <div class="bg-slate-800/50 rounded-xl p-3 border border-slate-700/50">
              <div class="flex flex-wrap gap-1">
                ${scaleChords.map((c, i) => `
                  <button onclick="state.progression.push({root:'${c.root}',type:'${c.type}',beats:4});playChord('${c.root}','${c.type}');render();updateLaunchpad()"
                    class="px-2 py-1 rounded bg-slate-700 hover:bg-violet-600 text-sm">
                    <span class="text-[10px] text-slate-400">${c.degree}</span> ${getChordName(c.root, c.type)}
                  </button>
                `).join('')}
                <span class="text-slate-600 mx-2">|</span>
                ${PROGRESSIONS.map(p => `
                  <button onclick="const sc=getScaleChords();state.progression=${JSON.stringify(p.degrees)}.map(d=>({root:sc[d].root,type:sc[d].type,beats:4}));render();updateLaunchpad()"
                    class="px-2 py-1 rounded bg-purple-700/50 hover:bg-purple-600 text-xs">${p.name}</button>
                `).join('')}
              </div>
            </div>

            <!-- Progression -->
            <div class="bg-slate-800/50 rounded-xl p-3 border border-slate-700/50">
              <div class="flex items-center justify-between mb-2">
                <span class="text-xs text-slate-400">${state.progression.length} chords ‚Ä¢ ${totalBeats} beats</span>
                <button onclick="state.progression=[];state.selectedSlot=null;render();updateLaunchpad()" class="text-xs text-slate-500 hover:text-red-400">Clear</button>
              </div>
              <div class="grid grid-cols-4 sm:grid-cols-8 gap-2">
                ${state.progression.map((c, i) => `
                  <div onclick="state.selectedSlot=${i};playChord('${c.root}','${c.type}');render();updateLaunchpad()"
                    class="relative group p-2 rounded-xl cursor-pointer ${i === state.currentChord && state.isPlaying ? 'bg-green-600 scale-105' : i === state.selectedSlot ? 'bg-violet-600' : 'bg-slate-700/50 hover:bg-slate-600'}">
                    <button onclick="event.stopPropagation();state.progression.splice(${i},1);state.selectedSlot=null;render();updateLaunchpad()"
                      class="absolute -top-1 -right-1 w-4 h-4 bg-red-500 rounded-full text-[10px] opacity-0 group-hover:opacity-100">√ó</button>
                    <div class="text-center">
                      <span class="font-bold block">${getChordName(c.root, c.type)}</span>
                      <div class="flex items-center justify-center gap-1 mt-1">
                        <button onclick="event.stopPropagation();state.progression[${i}].beats=Math.max(1,state.progression[${i}].beats-1);render()" class="w-4 h-4 bg-slate-600 rounded text-[10px]">-</button>
                        <span class="text-[10px]">${c.beats}b</span>
                        <button onclick="event.stopPropagation();state.progression[${i}].beats=Math.min(16,state.progression[${i}].beats+1);render()" class="w-4 h-4 bg-slate-600 rounded text-[10px]">+</button>
                      </div>
                    </div>
                  </div>
                `).join('')}
              </div>
            </div>

            <!-- Status Log -->
            <div class="bg-slate-800/30 rounded-xl p-3 border border-slate-700/30">
              <div class="flex items-center justify-between mb-2">
                <span class="text-xs font-bold text-slate-400">Status Log</span>
                <button onclick="state.logs=[];render()" class="text-[10px] text-slate-500 hover:text-white">Clear</button>
              </div>
              <div id="status-log" class="text-slate-500 space-y-0.5">
                ${state.logs.map(l => `
                  <div class="${l.type === 'error' ? 'text-red-400' : l.type === 'success' ? 'text-emerald-400' : 'text-slate-400'}">
                    <span class="text-slate-600">${l.time}</span> ${l.msg}
                  </div>
                `).join('')}
              </div>
            </div>

            <!-- Legend -->
            <div class="bg-slate-800/30 rounded-xl p-2 text-[10px] text-slate-500">
              <b class="text-slate-400">Launchpad:</b> Row 1-2: Progression | Row 3: Scale | Row 4: Progs | Row 5: Patterns | Row 6-7: Key/Scale | Row 8: Transport | Scene: Velocity/Tone‚óÄ‚ñ∂
            </div>
          </div>
        </div>
      `;
    };

    // Init
    window.addEventListener('DOMContentLoaded', async () => {
      log('ChordFlow d√©marr√©');
      render();
      await loadTones();
    });

    // Expose functions
    window.state = state;
    window.render = render;
    window.playChord = playChord;
    window.startPlayback = startPlayback;
    window.stopPlayback = stopPlayback;
    window.downloadMidi = downloadMidi;
    window.getScaleChords = getScaleChords;
    window.navigateTone = navigateTone;
    window.sendProgramChange = sendProgramChange;
    window.updateLaunchpad = updateLaunchpad;
    window.handleLaunchpadInput = handleLaunchpadInput;
    window.requestMidiAccess = requestMidiAccess;
    window.selectSynthOutput = selectSynthOutput;
    window.selectLaunchpadIn = selectLaunchpadIn;
    window.selectLaunchpadOut = selectLaunchpadOut;
  </script>
</body>
</html>
