<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>Monotron Duo Synth - MIDI</title>
  <!-- React + ReactDOM via CDN -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <!-- Tailwind (OK pour démo; en prod, compiler en CSS) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body, html, #root { margin:0; padding:0; width:100%; height:100%; overflow:hidden; }
    body { position:fixed; overscroll-behavior:none; }
    .piano-key { transition: background-color 0.05s; }
    .piano-key:active { filter: brightness(0.8); }
    .keyboard-area { touch-action: none; }
    /* Simple modal styles */
    .modal-backdrop { background: rgba(0,0,0,0.6); }
    /* MIDI blink animation */
    @keyframes midi-blink {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.3; }
    }
    .midi-active {
      animation: midi-blink 0.5s ease-in-out;
    }
  </style>
</head>
<body>
  <div id="root"></div>

  <script>
    const { useState, useRef, useEffect } = React;

    function MonotronSynth() {
      // UI state
      const [isPlaying, setIsPlaying] = useState(false);
      const [isPoweredOn, setIsPoweredOn] = useState(true);
      const [currentNote, setCurrentNote] = useState('');
      const [isFullscreen, setIsFullscreen] = useState(false);

      // MIDI state
      const [midiAccess, setMidiAccess] = useState(null);
      const [midiEnabled, setMidiEnabled] = useState(true);
      const [midiDevices, setMidiDevices] = useState([]);
      const [midiActivity, setMidiActivity] = useState(false);

      // Presets state
      const [selectedPreset, setSelectedPreset] = useState('');
      const [showSaveModal, setShowSaveModal] = useState(false);
      const [showDeleteConfirm, setShowDeleteConfirm] = useState(false);
      const [presetDraftName, setPresetDraftName] = useState('');

      // Synth params
      const [osc1Wave, setOsc1Wave] = useState('sine');
      const [osc2Wave, setOsc2Wave] = useState('sine');
      const [osc1Pitch, setOsc1Pitch] = useState(0);
      const [osc2Pitch, setOsc2Pitch] = useState(-12);
      const [osc2Mix, setOsc2Mix] = useState(0.5);

      const [cutoff, setCutoff] = useState(2000);
      const [resonance, setResonance] = useState(1);
      const [peak, setPeak] = useState(0);

      const [lfoRate, setLfoRate] = useState(5);
      const [lfoDepth, setLfoDepth] = useState(0);
      const [lfoTarget, setLfoTarget] = useState('pitch');

      const [volume, setVolume] = useState(0.5);

      // Audio refs
      const audioContextRef = useRef(null);
      const osc1Ref = useRef(null);
      const osc2Ref = useRef(null);
      const filterRef = useRef(null);
      const lfoRef = useRef(null);
      const lfoGainRef = useRef(null);
      const gainNodeRef = useRef(null);
      const masterGainRef = useRef(null);

      // MIDI refs
      const midiActivityTimeoutRef = useRef(null);
      const currentMidiNoteRef = useRef(null);

      // Icons
      const PowerIcon = () => React.createElement('svg', {
        width: 20, height: 20, viewBox: "0 0 24 24", fill: "none", stroke: "currentColor", strokeWidth: 2
      },
        React.createElement('path', { d: "M18.36 6.64a9 9 0 1 1-12.73 0" }),
        React.createElement('line', { x1: 12, y1: 2, x2: 12, y2: 12 })
      );
      
      const FullscreenIcon = () => React.createElement('svg', {
        width: 20, height: 20, viewBox: "0 0 24 24", fill: "none", stroke: "currentColor", strokeWidth: 2
      },
        isFullscreen
          ? React.createElement('path', { d: "M8 3v3a2 2 0 0 1-2 2H3m18 0h-3a2 2 0 0 1-2-2V3m0 18v-3a2 2 0 0 1 2-2h3M3 16h3a2 2 0 0 1 2 2v3" })
          : React.createElement('path', { d: "M8 3H5a2 2 0 0 0-2 2v3m18 0V5a2 2 0 0 0-2-2h-3m0 18h3a2 2 0 0 0 2-2v-3M3 16v3a2 2 0 0 0 2 2h3" })
      );

      const MidiIcon = () => React.createElement('svg', {
        width: 20, height: 20, viewBox: "0 0 24 24", fill: "none", stroke: "currentColor", strokeWidth: 2
      },
        React.createElement('rect', { x: 2, y: 6, width: 20, height: 12, rx: 2 }),
        React.createElement('path', { d: "M6 10h2v4H6zM10 8h2v8h-2zM14 9h2v6h-2zM18 11h2v2h-2z" })
      );

      // Knob
      const Knob = ({ label, value, onChange, min, max, step = 1, unit = '' }) => {
        const percentage = ((value - min) / (max - min)) * 100;
        const rotation = (percentage * 2.7) - 135;
        return React.createElement('div', { className: "flex flex-col items-center gap-0.5" },
          React.createElement('div', { className: "relative w-12 h-12" },
            React.createElement('div', { className: "absolute inset-0 rounded-full bg-gray-800 border-2 border-gray-600 shadow-inner" }),
            React.createElement('div', {
              className: "absolute inset-1 rounded-full bg-gradient-to-br from-blue-400 to-blue-600 shadow-lg cursor-pointer",
              style: { transform: `rotate(${rotation}deg)` }
            }, React.createElement('div', { className: "absolute top-1 left-1/2 w-0.5 h-3 bg-white rounded-full -translate-x-1/2" })),
            React.createElement('input', {
              type: "range", min, max, step, value,
              onChange: (e) => onChange(parseFloat(e.target.value)),
              className: "absolute inset-0 opacity-0 cursor-pointer"
            })
          ),
          React.createElement('div', { className: "text-[10px] text-blue-200 font-mono text-center leading-tight" },
            label,
            React.createElement('div', { className: "text-white text-[9px]" },
              typeof value === 'number' ? value.toFixed(step < 1 ? 2 : 0) : value, unit
            )
          )
        );
      };

      // Fullscreen listener
      useEffect(() => {
        const handleFullscreenChange = () => setIsFullscreen(!!document.fullscreenElement);
        document.addEventListener('fullscreenchange', handleFullscreenChange);
        return () => document.removeEventListener('fullscreenchange', handleFullscreenChange);
      }, []);
      
      const toggleFullscreen = () => {
        if (!document.fullscreenElement) document.documentElement.requestFullscreen();
        else document.exitFullscreen();
      };

      // Audio context init/close
      useEffect(() => {
        if (isPoweredOn && !audioContextRef.current) {
          audioContextRef.current = new (window.AudioContext || window.webkitAudioContext)();
        }
        return () => {
          if (audioContextRef.current && audioContextRef.current.state !== 'closed') {
            audioContextRef.current.close();
            audioContextRef.current = null;
          }
        };
      }, [isPoweredOn]);

      // MIDI initialization
      useEffect(() => {
        if (!midiEnabled) return;

        const initMIDI = async () => {
          try {
            const access = await navigator.requestMIDIAccess();
            setMidiAccess(access);
            
            // List all MIDI inputs
            const inputs = Array.from(access.inputs.values());
            setMidiDevices(inputs.map(input => input.name));
            
            // Attach listeners to all inputs
            inputs.forEach(input => {
              input.onmidimessage = handleMIDIMessage;
            });

            // Listen for device changes
            access.onstatechange = (e) => {
              const inputs = Array.from(access.inputs.values());
              setMidiDevices(inputs.map(input => input.name));
            };

            console.log('MIDI initialized with', inputs.length, 'device(s)');
          } catch (err) {
            console.error('MIDI access denied:', err);
          }
        };

        initMIDI();

        return () => {
          if (midiAccess) {
            midiAccess.inputs.forEach(input => {
              input.onmidimessage = null;
            });
          }
        };
      }, [midiEnabled]);

      // MIDI activity indicator
      const flashMidiActivity = () => {
        setMidiActivity(true);
        if (midiActivityTimeoutRef.current) {
          clearTimeout(midiActivityTimeoutRef.current);
        }
        midiActivityTimeoutRef.current = setTimeout(() => {
          setMidiActivity(false);
        }, 100);
      };

      // MIDI message handler
      const handleMIDIMessage = (message) => {
        if (!midiEnabled || !isPoweredOn) return;
        
        flashMidiActivity();
        
        const [status, data1, data2] = message.data;
        const command = status & 0xF0;
        const channel = status & 0x0F;

        // Note On
        if (command === 0x90 && data2 > 0) {
          const frequency = 440 * Math.pow(2, (data1 - 69) / 12);
          currentMidiNoteRef.current = data1;
          startNote(frequency);
        }
        // Note Off
        else if (command === 0x80 || (command === 0x90 && data2 === 0)) {
          if (currentMidiNoteRef.current === data1) {
            stopNote();
            currentMidiNoteRef.current = null;
          }
        }
        // Control Change (CC)
        else if (command === 0xB0) {
          handleMIDIControlChange(data1, data2);
        }
        // Pitch Bend
        else if (command === 0xE0) {
          const bendValue = (data2 << 7) | data1;
          const normalizedBend = ((bendValue - 8192) / 8192) * 2; // -2 to +2 semitones
          // Could apply pitch bend here if desired
        }
      };

      // MIDI CC mapping
      const handleMIDIControlChange = (cc, value) => {
        const normalized = value / 127;

        // Standard MIDI CC mappings
        switch(cc) {
          // Modulation Wheel (CC1) -> LFO Depth
          case 1:
            setLfoDepth(normalized * 100);
            break;
          
          // Volume (CC7)
          case 7:
            setVolume(normalized);
            break;
          
          // Pan (CC10) -> OSC2 Mix
          case 10:
            setOsc2Mix(normalized);
            break;
          
          // Expression (CC11) -> Filter Cutoff
          case 11:
            setCutoff(50 + normalized * 7950);
            break;
          
          // General Purpose 1-4 (CC16-19)
          case 16: // Filter Cutoff
            setCutoff(50 + normalized * 7950);
            break;
          case 17: // Resonance
            setResonance(0.1 + normalized * 29.9);
            break;
          case 18: // LFO Rate
            setLfoRate(0.1 + normalized * 19.9);
            break;
          case 19: // Peak
            setPeak(normalized * 5);
            break;
          
          // Knobs 1-8 (CC74-81 on many controllers)
          case 74: // OSC1 Pitch
            setOsc1Pitch(-24 + normalized * 48);
            break;
          case 75: // OSC2 Pitch
            setOsc2Pitch(-24 + normalized * 48);
            break;
          case 76: // OSC2 Mix
            setOsc2Mix(normalized);
            break;
          case 77: // Filter Cutoff
            setCutoff(50 + normalized * 7950);
            break;
          case 78: // Resonance
            setResonance(0.1 + normalized * 29.9);
            break;
          case 79: // LFO Rate
            setLfoRate(0.1 + normalized * 19.9);
            break;
          case 80: // LFO Depth
            setLfoDepth(normalized * 100);
            break;
          case 81: // Volume
            setVolume(normalized);
            break;
        }
      };

      // Note display helper
      const noteNames = ['C','C#','D','D#','E','F','F#','G','G#','A','A#','B'];
      const frequencyToNote = (frequency) => {
        const noteNum = 12 * Math.log2(frequency / 440) + 69;
        const noteIndex = Math.round(noteNum);
        const octave = Math.floor((noteIndex - 12) / 12);
        const note = noteNames[noteIndex % 12];
        return `${note}${octave}`;
      };

      // Start/Stop note
      const startNote = (frequency) => {
        if (!isPoweredOn || !audioContextRef.current) return;
        const ctx = audioContextRef.current;
        setCurrentNote(frequencyToNote(frequency));
        setIsPlaying(true);

        // Update if already running
        if (osc1Ref.current && osc2Ref.current) {
          osc1Ref.current.frequency.setValueAtTime(frequency * Math.pow(2, osc1Pitch / 12), ctx.currentTime);
          osc2Ref.current.frequency.setValueAtTime(frequency * Math.pow(2, osc2Pitch / 12), ctx.currentTime);
          return;
        }

        // Create nodes
        osc1Ref.current = ctx.createOscillator();
        osc2Ref.current = ctx.createOscillator();
        filterRef.current = ctx.createBiquadFilter();
        lfoRef.current = ctx.createOscillator();
        lfoGainRef.current = ctx.createGain();
        gainNodeRef.current = ctx.createGain();
        masterGainRef.current = ctx.createGain();

        // Setup oscillators
        osc1Ref.current.type = osc1Wave;
        osc2Ref.current.type = osc2Wave;
        osc1Ref.current.frequency.value = frequency * Math.pow(2, osc1Pitch / 12);
        osc2Ref.current.frequency.value = frequency * Math.pow(2, osc2Pitch / 12);

        // Setup filter (MS-20 style)
        filterRef.current.type = 'lowpass';
        filterRef.current.frequency.value = cutoff;
        filterRef.current.Q.value = resonance;

        // Setup LFO
        lfoRef.current.type = 'sine';
        lfoRef.current.frequency.value = lfoRate;
        lfoGainRef.current.gain.value = lfoDepth / 100;

        // Setup gains
        gainNodeRef.current.gain.value = 0.3;
        masterGainRef.current.gain.value = volume;

        // Create oscillator gains for mixing
        const osc1Gain = ctx.createGain();
        const osc2Gain = ctx.createGain();
        osc1Gain.gain.value = 1 - osc2Mix;
        osc2Gain.gain.value = osc2Mix;

        // Connect oscillators through gains
        osc1Ref.current.connect(osc1Gain);
        osc2Ref.current.connect(osc2Gain);
        osc1Gain.connect(gainNodeRef.current);
        osc2Gain.connect(gainNodeRef.current);

        // Connect LFO based on target
        if (lfoTarget === 'pitch') {
          lfoRef.current.connect(lfoGainRef.current);
          lfoGainRef.current.connect(osc1Ref.current.frequency);
          lfoGainRef.current.connect(osc2Ref.current.frequency);
        } else {
          lfoRef.current.connect(lfoGainRef.current);
          lfoGainRef.current.connect(filterRef.current.frequency);
        }

        // Connect filter with peak
        gainNodeRef.current.connect(filterRef.current);
        if (peak > 0) {
          const peakGain = ctx.createGain();
          peakGain.gain.value = peak;
          filterRef.current.connect(peakGain);
          peakGain.connect(masterGainRef.current);
        }
        filterRef.current.connect(masterGainRef.current);

        // Connect to output
        masterGainRef.current.connect(ctx.destination);

        // Start everything
        osc1Ref.current.start();
        osc2Ref.current.start();
        lfoRef.current.start();
      };

      const stopNote = () => {
        if (osc1Ref.current && osc2Ref.current) {
          const ctx = audioContextRef.current;
          const now = ctx.currentTime;
          
          // Fade out
          masterGainRef.current.gain.setValueAtTime(masterGainRef.current.gain.value, now);
          masterGainRef.current.gain.linearRampToValueAtTime(0, now + 0.1);
          
          setTimeout(() => {
            if (osc1Ref.current) osc1Ref.current.stop();
            if (osc2Ref.current) osc2Ref.current.stop();
            if (lfoRef.current) lfoRef.current.stop();
            osc1Ref.current = null;
            osc2Ref.current = null;
            filterRef.current = null;
            lfoRef.current = null;
            lfoGainRef.current = null;
            gainNodeRef.current = null;
            masterGainRef.current = null;
          }, 150);
        }
        setIsPlaying(false);
        setCurrentNote('');
      };

      // Update params in real-time
      useEffect(() => {
        if (osc1Ref.current) osc1Ref.current.type = osc1Wave;
      }, [osc1Wave]);
      useEffect(() => {
        if (osc2Ref.current) osc2Ref.current.type = osc2Wave;
      }, [osc2Wave]);
      useEffect(() => {
        if (filterRef.current) filterRef.current.frequency.value = cutoff;
      }, [cutoff]);
      useEffect(() => {
        if (filterRef.current) filterRef.current.Q.value = resonance;
      }, [resonance]);
      useEffect(() => {
        if (lfoRef.current) lfoRef.current.frequency.value = lfoRate;
      }, [lfoRate]);
      useEffect(() => {
        if (lfoGainRef.current) lfoGainRef.current.gain.value = lfoDepth / 100;
      }, [lfoDepth]);
      useEffect(() => {
        if (masterGainRef.current) masterGainRef.current.gain.value = volume;
      }, [volume]);

      // Presets
      const savePreset = (name) => {
        if (!name.trim()) return;
        const preset = {
          osc1Wave, osc2Wave, osc1Pitch, osc2Pitch, osc2Mix,
          cutoff, resonance, peak, lfoRate, lfoDepth, lfoTarget, volume
        };
        localStorage.setItem(`preset-${name}`, JSON.stringify(preset));
        setSelectedPreset(name);
      };

      const loadPreset = (name) => {
        const data = localStorage.getItem(`preset-${name}`);
        if (data) {
          const p = JSON.parse(data);
          setOsc1Wave(p.osc1Wave);
          setOsc2Wave(p.osc2Wave);
          setOsc1Pitch(p.osc1Pitch);
          setOsc2Pitch(p.osc2Pitch);
          setOsc2Mix(p.osc2Mix);
          setCutoff(p.cutoff);
          setResonance(p.resonance);
          setPeak(p.peak);
          setLfoRate(p.lfoRate);
          setLfoDepth(p.lfoDepth);
          setLfoTarget(p.lfoTarget);
          setVolume(p.volume);
        }
      };

      const deletePreset = (name) => {
        localStorage.removeItem(`preset-${name}`);
        if (selectedPreset === name) setSelectedPreset('');
      };

      // Ribbon keyboard
      const handleRibbonTouch = (e) => {
        if (!isPoweredOn) return;
        e.preventDefault();
        const rect = e.currentTarget.getBoundingClientRect();
        const x = (e.touches ? e.touches[0].clientX : e.clientX) - rect.left;
        const position = x / rect.width;
        const minFreq = 55;
        const maxFreq = 1760;
        const frequency = minFreq * Math.pow(maxFreq / minFreq, position);
        startNote(frequency);
      };

      const handleRibbonRelease = () => {
        stopNote();
      };

      // Generate keyboard
      const whiteKeys = [];
      const blackKeys = [];
      const whiteNotes = [0, 2, 4, 5, 7, 9, 11];
      const blackNotes = [1, 3, 6, 8, 10];
      
      for (let octave = 0; octave < 5; octave++) {
        whiteNotes.forEach((note, idx) => {
          const midiNote = octave * 12 + note + 24;
          const frequency = 440 * Math.pow(2, (midiNote - 69) / 12);
          const left = ((octave * 7 + idx) / 35) * 100;
          whiteKeys.push(
            React.createElement('div', {
              key: `w-${octave}-${note}`,
              className: `absolute h-full bg-white border border-gray-400 cursor-pointer piano-key ${isPlaying && currentNote === frequencyToNote(frequency) ? 'bg-blue-200' : ''}`,
              style: { left: `${left}%`, width: `${100/35}%` },
              onMouseDown: () => handleRibbonTouch({ currentTarget: { getBoundingClientRect: () => ({ left: left * window.innerWidth / 100, width: window.innerWidth / 35 }) }, clientX: left * window.innerWidth / 100 + window.innerWidth / 70, preventDefault: () => {} }),
              onTouchStart: (e) => handleRibbonTouch(e)
            })
          );
        });
        
        blackNotes.forEach((note) => {
          const midiNote = octave * 12 + note + 24;
          const frequency = 440 * Math.pow(2, (midiNote - 69) / 12);
          const whiteKeysBefore = whiteNotes.filter(n => n < note).length;
          const left = ((octave * 7 + whiteKeysBefore + 0.7) / 35) * 100;
          blackKeys.push(
            React.createElement('div', {
              key: `b-${octave}-${note}`,
              className: `absolute bg-black cursor-pointer piano-key ${isPlaying && currentNote === frequencyToNote(frequency) ? 'bg-blue-600' : ''}`,
              style: { left: `${left}%`, width: `${100/35 * 0.6}%`, height: '60%', zIndex: 10 },
              onMouseDown: () => handleRibbonTouch({ currentTarget: { getBoundingClientRect: () => ({ left: left * window.innerWidth / 100, width: window.innerWidth / 35 * 0.6 }) }, clientX: left * window.innerWidth / 100 + window.innerWidth / 70 * 0.6, preventDefault: () => {} }),
              onTouchStart: (e) => handleRibbonTouch(e)
            })
          );
        });
      }

      // Render
      return React.createElement('div', { className: "w-full h-full bg-gradient-to-br from-blue-950 to-blue-900 flex flex-col" },
        // Header
        React.createElement('div', { className: "bg-blue-950 bg-opacity-80 p-2 flex justify-between items-center border-b border-blue-700" },
          React.createElement('div', { className: "flex items-center gap-3" },
            React.createElement('h1', { className: "text-white font-bold text-lg" }, "MONOTRON DUO"),
            React.createElement('div', { className: `text-xs px-2 py-1 rounded ${isPlaying ? 'bg-green-600 text-white' : 'bg-gray-700 text-gray-400'}` },
              isPlaying ? `♪ ${currentNote}` : '---'
            )
          ),
          React.createElement('div', { className: "flex gap-2" },
            // MIDI indicator and toggle
            midiDevices.length > 0 && React.createElement('div', {
              className: `flex items-center gap-2 px-3 py-1 rounded ${midiEnabled ? 'bg-green-600' : 'bg-gray-600'} cursor-pointer`,
              onClick: () => setMidiEnabled(!midiEnabled),
              title: midiEnabled ? `MIDI: ${midiDevices.join(', ')}` : 'MIDI désactivé'
            },
              React.createElement('div', { className: midiActivity ? 'midi-active' : '' }, React.createElement(MidiIcon)),
              React.createElement('span', { className: "text-white text-xs" }, 
                midiEnabled ? `MIDI (${midiDevices.length})` : 'MIDI OFF'
              )
            ),
            React.createElement('button', {
              onClick: () => setShowSaveModal(true),
              className: "px-3 py-1 bg-green-600 hover:bg-green-700 text-white rounded text-sm",
              disabled: !isPoweredOn
            }, "Save"),
            React.createElement('button', {
              onClick: () => setShowDeleteConfirm(true),
              className: "px-3 py-1 bg-red-600 hover:bg-red-700 text-white rounded text-sm",
              disabled: !isPoweredOn || !selectedPreset
            }, "Delete"),
            React.createElement('button', {
              onClick: toggleFullscreen,
              className: "p-2 bg-blue-700 hover:bg-blue-600 rounded text-white"
            }, React.createElement(FullscreenIcon)),
            React.createElement('button', {
              onClick: () => {
                setIsPoweredOn(!isPoweredOn);
                if (isPoweredOn) stopNote();
              },
              className: `p-2 rounded text-white ${isPoweredOn ? 'bg-green-600 hover:bg-green-700' : 'bg-red-600 hover:bg-red-700'}`
            }, React.createElement(PowerIcon))
          )
        ),

        // Controls
        React.createElement('div', { className: "flex-1 p-3 overflow-auto" },
          React.createElement('div', { className: "grid grid-cols-4 gap-3 max-w-6xl mx-auto" },
            // VCO 1
            React.createElement('div', { className: "bg-blue-950 bg-opacity-50 rounded-lg p-2" },
              React.createElement('h3', { className: "text-white text-xs mb-2 text-center border-b border-blue-500 pb-1" }, "VCO 1"),
              React.createElement('div', { className: "space-y-2" },
                React.createElement('div', null,
                  React.createElement('div', { className: "text-blue-200 text-[9px] mb-1" }, "Wave"),
                  React.createElement('select', {
                    value: osc1Wave, onChange: (e) => setOsc1Wave(e.target.value),
                    className: "w-full bg-blue-900 text-white rounded px-1 py-0.5 text-[10px]", disabled: !isPoweredOn
                  },
                    React.createElement('option', { value: "sine" }, "Sine"),
                    React.createElement('option', { value: "sawtooth" }, "Saw"),
                    React.createElement('option', { value: "square" }, "Square"),
                    React.createElement('option', { value: "triangle" }, "Tri")
                  )
                ),
                React.createElement(Knob, { label: "PITCH", value: osc1Pitch, onChange: setOsc1Pitch, min: -24, max: 24, step: 1 }),
                // Presets
                React.createElement('div', { className: "bg-blue-950 bg-opacity-50 rounded-lg p-2" },
                  React.createElement('h3', { className: "text-white text-xs mb-2 text-center border-b border-blue-500 pb-1" }, "PRESETS"),
                  React.createElement('div', { className: "flex flex-col gap-2" },
                    React.createElement('select', {
                      value: selectedPreset,
                      onChange: (e) => { setSelectedPreset(e.target.value); if (e.target.value) loadPreset(e.target.value); },
                      className: "bg-blue-900 text-white rounded px-2 py-1 text-[10px]"
                    },
                      React.createElement('option', { value: "" }, "-- Choisir un preset --"),
                      ...Object.keys(localStorage)
                        .filter((key) => key.startsWith('preset-'))
                        .map((key) => {
                          const name = key.replace('preset-', '');
                          return React.createElement('option', { key: name, value: name }, name);
                        })
                    )
                  )
                )
              )
            ),

            // VCO 2
            React.createElement('div', { className: "bg-blue-950 bg-opacity-50 rounded-lg p-2" },
              React.createElement('h3', { className: "text-white text-xs mb-2 text-center border-b border-blue-500 pb-1" }, "VCO 2"),
              React.createElement('div', { className: "space-y-2" },
                React.createElement('div', null,
                  React.createElement('div', { className: "text-blue-200 text-[9px] mb-1" }, "Wave"),
                  React.createElement('select', {
                    value: osc2Wave, onChange: (e) => setOsc2Wave(e.target.value),
                    className: "w-full bg-blue-900 text-white rounded px-1 py-0.5 text-[10px]", disabled: !isPoweredOn
                  },
                    React.createElement('option', { value: "sine" }, "Sine"),
                    React.createElement('option', { value: "sawtooth" }, "Saw"),
                    React.createElement('option', { value: "square" }, "Square"),
                    React.createElement('option', { value: "triangle" }, "Tri")
                  )
                ),
                React.createElement(Knob, { label: "PITCH", value: osc2Pitch, onChange: setOsc2Pitch, min: -24, max: 24, step: 1 }),
                React.createElement(Knob, { label: "MIX", value: osc2Mix, onChange: setOsc2Mix, min: 0, max: 1, step: 0.01 })
              )
            ),

            // Filter
            React.createElement('div', { className: "bg-blue-950 bg-opacity-50 rounded-lg p-2" },
              React.createElement('h3', { className: "text-white text-xs mb-2 text-center border-b border-blue-500 pb-1" }, "VCF (MS-20)"),
              React.createElement('div', { className: "flex flex-col gap-2" },
                React.createElement(Knob, { label: "CUTOFF", value: cutoff, onChange: setCutoff, min: 50, max: 8000, step: 10, unit: "Hz" }),
                React.createElement(Knob, { label: "PEAK", value: peak, onChange: setPeak, min: 0, max: 5, step: 0.1 }),
                React.createElement(Knob, { label: "RES", value: resonance, onChange: setResonance, min: 0.1, max: 30, step: 0.1 })
              )
            ),

            // LFO + Volume
            React.createElement('div', { className: "bg-blue-950 bg-opacity-50 rounded-lg p-2" },
              React.createElement('h3', { className: "text-white text-xs mb-2 text-center border-b border-blue-500 pb-1" }, "LFO & VOL"),
              React.createElement('div', { className: "flex flex-col gap-2" },
                React.createElement(Knob, { label: "RATE", value: lfoRate, onChange: setLfoRate, min: 0.1, max: 20, step: 0.1, unit: "Hz" }),
                React.createElement(Knob, { label: "DEPTH", value: lfoDepth, onChange: setLfoDepth, min: 0, max: 100, step: 1 }),
                React.createElement('div', { className: "flex flex-col items-center gap-0.5" },
                  React.createElement('div', { className: "text-[9px] text-blue-200" }, "Target"),
                  React.createElement('select', {
                    value: lfoTarget, onChange: (e) => setLfoTarget(e.target.value),
                    className: "bg-blue-900 text-white rounded px-2 py-1 text-[10px] w-full", disabled: !isPoweredOn
                  },
                    React.createElement('option', { value: "pitch" }, "Pitch"),
                    React.createElement('option', { value: "filter" }, "Filter")
                  )
                ),
                React.createElement(Knob, { label: "VOL", value: volume, onChange: setVolume, min: 0, max: 1, step: 0.01 })
              )
            )
          )
        ),

        // Ribbon keyboard
        React.createElement('div', { className: "h-64 relative keyboard-area" },
          React.createElement('div', {
            className: `absolute inset-0 ${isPoweredOn ? 'cursor-pointer' : 'cursor-not-allowed opacity-50'}`,
            onMouseDown: handleRibbonTouch,
            onMouseMove: (e) => e.buttons === 1 && handleRibbonTouch(e),
            onMouseUp: handleRibbonRelease,
            onMouseLeave: handleRibbonRelease,
            onTouchStart: handleRibbonTouch,
            onTouchMove: handleRibbonTouch,
            onTouchEnd: handleRibbonRelease
          },
            React.createElement('div', { className: "absolute inset-0 flex" }, ...whiteKeys),
            React.createElement('div', { className: "absolute inset-0" }, ...blackKeys)
          )
        ),

        // MIDI info panel
        midiEnabled && midiDevices.length > 0 && React.createElement('div', {
          className: "bg-blue-950 bg-opacity-90 p-2 text-white text-xs border-t border-blue-700"
        },
          React.createElement('div', { className: "max-w-6xl mx-auto" },
            React.createElement('strong', null, "Contrôleurs MIDI détectés:"),
            React.createElement('div', { className: "mt-1 text-green-400" }, midiDevices.join(', ')),
            React.createElement('div', { className: "mt-2 text-gray-400 text-[10px]" },
              "CC Mapping: CC1=LFO Depth, CC7/81=Volume, CC10/76=OSC2 Mix, CC11/16/77=Cutoff, CC17/78=Resonance, CC18/79=LFO Rate, CC19=Peak, CC74=OSC1 Pitch, CC75=OSC2 Pitch"
            )
          )
        ),

        // Save modal
        showSaveModal && React.createElement('div', { className: "fixed inset-0 z-50 flex items-center justify-center modal-backdrop" },
          React.createElement('div', { className: "bg-white rounded-lg p-4 w-80 shadow-lg" },
            React.createElement('h2', { className: "text-lg font-bold mb-2" }, "Sauvegarder le preset"),
            React.createElement('div', { className: "text-sm text-gray-700 mb-2" }, "Entrez un nom pour le preset :"),
            React.createElement('input', {
              type: "text",
              value: presetDraftName,
              onChange: (e) => setPresetDraftName(e.target.value),
              placeholder: "Nom du preset",
              className: "w-full border rounded px-2 py-1 mb-3 text-sm"
            }),
            React.createElement('div', { className: "flex justify-end gap-2" },
              React.createElement('button', {
                onClick: () => { setShowSaveModal(false); setPresetDraftName(''); },
                className: "px-3 py-1 rounded bg-gray-200 hover:bg-gray-300"
              }, "Annuler"),
              React.createElement('button', {
                onClick: () => {
                  savePreset(presetDraftName);
                  setShowSaveModal(false);
                  setPresetDraftName('');
                },
                className: "px-3 py-1 rounded bg-blue-600 text-white hover:bg-blue-700"
              }, "Sauvegarder")
            )
          )
        ),

        // Delete confirmation modal
        showDeleteConfirm && React.createElement('div', { className: "fixed inset-0 z-50 flex items-center justify-center modal-backdrop" },
          React.createElement('div', { className: "bg-white rounded-lg p-4 w-96 shadow-lg" },
            React.createElement('h2', { className: "text-lg font-bold mb-2 text-red-600" }, "Confirmer la suppression"),
            React.createElement('div', { className: "text-sm text-gray-700 mb-4" },
              selectedPreset
                ? `Supprimer le preset "${selectedPreset}" ? Cette action est irréversible.`
                : "Aucun preset sélectionné."
            ),
            React.createElement('div', { className: "flex justify-end gap-2" },
              React.createElement('button', {
                onClick: () => setShowDeleteConfirm(false),
                className: "px-3 py-1 rounded bg-gray-200 hover:bg-gray-300"
              }, "Annuler"),
              React.createElement('button', {
                onClick: () => {
                  if (selectedPreset) {
                    deletePreset(selectedPreset);
                  }
                  setShowDeleteConfirm(false);
                },
                className: `px-3 py-1 rounded ${selectedPreset ? 'bg-red-600 text-white hover:bg-red-700' : 'bg-gray-200 cursor-not-allowed'}`,
                disabled: !selectedPreset
              }, "Supprimer")
            )
          )
        )
      );
    }

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(React.createElement(MonotronSynth));
  </script>
</body>
</html>
