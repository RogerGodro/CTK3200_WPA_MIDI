<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>CTK-3200 V8 FINAL - Launchpad MK2 Full Control</title>
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<style>
*{margin:0;padding:0;box-sizing:border-box;user-select:none;font-family:system-ui,sans-serif}
:root{
    --p:#00ff88;--a:#00aaff;--s:#ff00aa;--w:#ff8800;--d:#ff3333;--g:#00ff00;
    --bg:#0a0a0f;--bg2:#14141a;--bg3:#1f1f28;--t:#fff;--t2:#aaa;
}
body{background:var(--bg);color:var(--t);overflow:hidden;height:100vh;width:100vw;display:flex;flex-direction:column}
header{background:#header{background:var(--bg2);padding:15px;display:flex;align-items:center;justify-content:space-between;border-bottom:2px solid var(--p)}
.logo{font-size:28px;font-weight:900;background:linear-gradient(90deg,var(--p),var(--a));-webkit-background-clip:text;color:transparent}
.tempo{display:flex;align-items:center;gap:12px;background:var(--bg3);padding:8px 20px;border-radius:30px}
.tempo span{font-size:28px;font-weight:800;color:var(--a)}
.tempo button{width:30px;height:30px;background:var(--bg2);border:1px solid var(--a);border-radius:6px;color:var(--a)}
.tap{padding:12px 28px;background:var(--bg2);border:2px solid var(--w);border-radius:30px;color:var(--w);font-weight:bold}
.fs{position:absolute;right:20px;top:15px;font-size:24px;cursor:pointer}
.main{display:grid;grid-template-columns:280px 1fr 380px;gap:20px;padding:20px;height:calc(100vh-70px)}
.panel{background:var(--bg2);border-radius:16px;padding:16px;border:1px solid #333;overflow:hidden}
.title{font-size:11px;color:var(--t2);text-transform:uppercase;letter-spacing:2px;margin-bottom:12px;border-left:3px solid var(--p);padding-left:8px}
.grid{display:grid;gap:8px}
.g2{grid-template-columns:repeat(2,1fr)}
.g3{grid-template-columns:repeat(3,1fr)}
.g4{grid-template-columns:repeat(4,1fr)}
.btn{padding:12px;border-radius:10px;background:var(--bg3);border:2px solid #444;color:var(--t2);text-align:center;cursor:pointer;transition:.15s}
.btn:hover{border-color:var(--p);color:var(--p)}
.btn.active{background:var(--p);color:#000;border-color:var(--p)}
.var-btn.active{background:var(--s);border-color:var(--s)}
.section-btn.active{background:var(--a);border-color:var(--a)}
.chord-disp{height:130px;border-radius:16px;background:linear-gradient(135deg,var(--bg2),var(--bg3));display:flex;align-items:center;justify-content:center}
.chord-text{font-size:60px;font-weight:900;background:linear-gradient(135deg,var(--p),var(--a));-webkit-background-clip:text;color:transparent}
.chord-grid{grid-template-columns:repeat(6,1fr);gap:10px;height:100%}
.chord-pad{background:var(--bg3);border:2px solid #444;border-radius:12px;display:flex;align-items:center;justify-content:center;cursor:pointer;transition:.2s}
.chord-pad:hover{border-color:var(--p)}
.chord-pad.active{background:var(--p);color:#000;transform:scale(0.94)}
.pattern-grid{display:grid;grid-template-rows:repeat(4,45px);gap:8px}
.pattern-row{display:grid;grid-template-columns:repeat(16,1fr);gap:4px}
.cell{background:#222;border:1px solid #444;border-radius:4px;cursor:pointer;transition:.1s}
.cell.active{background:var(--p)}
.cell.playing{background:var(--a)!important;box-shadow:0 0 0 12px var(--a)}
.sliders{display:grid;grid-template-columns:repeat(3,1fr);gap:20px;margin-top:15px}
.slider{-webkit-appearance:none;height:6px;background:#333;border-radius:3px}
.slider::-webkit-slider-thumb{-webkit-appearance:none;width:18px;height:18px;background:var(--p);border-radius:50%;cursor:pointer}
.lp-view{width:360px;height:360px;background:#000;border-radius:16px;position:relative;overflow:hidden}
.lp-grid{display:grid;grid-template-columns:repeat(8,1fr);grid-template-rows:repeat(8,1fr);gap:3px;padding:15px;height:100%}
.lp-pad{background:#1e1e1e;border-radius:6px;transition:.1s}
.lp-pad.on{box-shadow:0 0 15px currentColor}
.lp-top{display:flex;gap:3px;margin:10px 15px}
.lp-right{position:absolute;right:15px;top:15px;display:flex;flex-direction:column;gap:3px}
.lp-btn{width:38px;height:38px;border-radius:50%;background:#333}
.toast{position:fixed;top:20px;left:50%;transform:translateX(-50%);padding:12px 30px;background:#222;border-radius:30px;color:var(--t);box-shadow:0 5px 20px #000;z-index:9999;animation:toast 2.5s forwards}
@keyframes toast{0%,100%{opacity:0;transform:translate(-50%,-20px)} 10%,90%{opacity:1;transform:translate(-50%,0)}}
</style>
</head>
<body>
<div id="header">
    <div class="logo">CTK3200 V8</div>
    <div class="tempo">
        <button onclick="tempo(-1)">-</button>
        <span id="tempo">120</span>
        <button onclick="tempo(1)">+</button>
        <button class="tap" onclick="tap()">TAP</button>
    </div>
    <div id="fs" onclick="full()">Full Screen</div>
</div>

<div class="main">
    <div class="panel">
        <div class="title">STYLE</div>
        <div class="grid g2" id="styles"></div>
        <div class="title">SECTION</div>
        <div class="grid g3" id="sections"></div>
        <div class="title">VARIATION</div>
        <div class="grid g4" id="variations"></div>
    </div>

    <div style="display:flex;flex-direction:column;gap:15px">
        <div class="chord-disp"><div class="chord-text" id="chord">C</div></div>
        <div class="panel chord-grid-container"><div class="chord-grid" id="chords"></div></div>
        <div class="panel pattern-section">
            <div class="title">PATTERN SEQUENCER (drag = draw/erase)</div>
            <div style="display:flex;gap:12px;margin:10px 0">
                <button class="btn" id="play" onclick="play()">Play</button>
                <button class="btn" id="stop" onclick="stop()">Stop</button>
            </div>
            <div class="pattern-grid" id="pattern"></div>
            <div class="sliders">
                <input type="range" min="20" max="127" value="100" id="vel">
                <input type="range" min="50" max="80" value="50" value="50" id="swing">
                <input type="range" min="0" max="100" value="0" id="human">
            </div>
        </div>
    </div>

    <div class="panel lp-view">
        <div class="title">LAUNCHPAD MK2 LIVE</div>
        <div style="display:flex;flex-direction:column;height:100%;justify-content:space-between">
            <div class="lp-top" id="lptop"></div>
            <div class="lp-grid" id="lppads"></div>
            <div class="lp-right" id="lpright"></div>
        </div>
    </div>
</div>

<script>
// État global
const S = {
    tempo:120, playing:false, beat:0, swing:50, vel:100, human:0,
    mode:'session', drumKit:0, bassBank:0,
    pattern:Array(16).fill().map(()=> ({k:0,s:0,h:0,o:0})),
    bassPat:Array(16).fill().map(()=>Array(8).fill(0)),
    midiCTK:null, midiLP:null, tap:[], fs:false
};

// Mapping Launchpad MK2 (bottom row = notes 11-18)
const LP = { pads:[], top:[104,105,106,107,108,109,110,111], right:[89,79,69,59,49,39,29,19] };
for(let r=0;r<8;r++) { LP.pads[r]=[]; for(let c=0;c<8;c++) LP.pads[r].push(11+c+r*10); }

// Couleurs Novation
const COL = {off:0,red:5,orange:9,amber:13,yellow:17,lime:21,green:25,turq:29,cyan:33,sky:37,blue:41,purple:49,pink:53,magenta:57,white:3};

// Drum kits (Program Change)
const DRUMKIT = [0,8,16,25,40,48]; // Standard, Room, Power, Synth, Brush, Orchestra

// Accords (6×8 = 48)
const CHORDS = [
    "C","Cm","C7","Cm7","Cmaj7","Cdim","Caug","Csus4",
    "D","Dm","D7","Dm7","Dmaj7","Ddim","Daug","Dsus4",
    "E","Em","E7","Em7","Emaj7","Edim","Eaug","Esus4",
    "F","Fm","F7","Fm7","Fmaj7","Fdim","Faug","Fsus4",
    "G","Gm","G7","Gm7","Gmaj7","Gdim","Gaug","Gsus4",
    "A","Am","A7","Am7","Amaj7","Adim","Aaug","Asus4",
];

// Notes basse pour User2
const BASSNOTES = [24,28,26,31,33,36,40,38]; // C0 E0 D0 G0 A0 C1 E1 D1

// === MIDI ===
async function connect(){
    try{
        const access = await navigator.requestMIDIAccess({sysex:true});
        for(let o of access.outputs.values()){
            if(o.name.includes('CASIO') || o.name.includes('CTK')) S.midiCTK = o;
            if(o.name.includes('Launchpad MK2')) S.midiLP = o;
        }
        if(S.midiLP){
            S.midiLP.send([240,0,32,41,2,24,14,1,247]); // Programmer mode
            clearLP();
        }
        toast(S.midiCTK?"CTK OK":"CTK not found" + " | " + S.midiLP?"LP OK":"LP not found");
        updateLP();
    }catch(e){toast("MIDI error");}
}

// Envoi couleur Launchpad
function lp(r,c,color){
    if(!S.midiLP) return;
    const note = LP.pads[r][c];
    S.midiLP.send([144,note,color]);
}
function clearLP(){
    if(!S.midiLP) return;
    S.midiLP.send([176,0,0]); // All off
}

// === UI ===
function build(){
    // Styles
    ["Pop","Rock","Jazz","Dance","Latin","World","8Beat","Ballad"].forEach(s=>{
        const b = document.createElement('div'); b.className='btn'; b.textContent=s;
        b.onclick=()=>selectStyle(s); document.getElementById('styles').appendChild(b);
    });
    // Sections
    ["intro","main","chorus","fill","break","ending"].forEach(s=>{
        const b = document.createElement('div'); b.className='btn section-btn';
        b.textContent=s.toUpperCase(); b.onclick=()=>selectSection(s);
        document.getElementById('sections').appendChild(b);
    });
    // Variations
    ["A","B","C","D"].forEach(v=>{
        const b = document.createElement('div'); b.className='btn var-btn';
        b.textContent=v; b.onclick=()=>selectVariation(v);
        document.getElementById('variations').appendChild(b);
    });
    // Chords
    const cg = document.getElementById('chords');
    CHORDS.forEach(c=>{
        const p = document.createElement('div'); p.className='chord-pad'; p.textContent=c;
        p.onpointerdown = () => playChord(c);
        p.onpointerup = stopChord;
        cg.appendChild(p);
    });
    // Pattern grid
    const pg = document.getElementById('pattern');
    ["kick","snare","hihat","open"].forEach(t=>{
        const row = document.createElement('div'); row.className='pattern-row';
        for(let i=0;i<16;i++){
            const cell = document.createElement('div'); cell.className='cell';
            cell.dataset.step=i; cell.dataset.track=t;
            cell.onclick = e => toggleCell(e);
            row.appendChild(cell);
        }
        pg.appendChild(row);
    });
    updatePattern();
    // Launchpad view
    const top = document.getElementById('lptop');
    LP.top.forEach(()=>{const b=document.createElement('div');b.className='lp-btn';top.appendChild(b);});
    const grid = document.getElementById('lppads');
    const right = document.getElementById('lpright');
    for(let r=0;r<8;r++)for(let c=0;c<8;c++){const p=document.createElement('div');p.className='lp-pad';grid.appendChild(p);}
    for(let i=0;i<8;i++){const b=document.createElement('div');b.className='lp-btn lp-right-btn';right.appendChild(b);}
}
build();

// === Functions ===
function tempo(d){
    S.tempo = Math.max(40,Math.min(240,S.tempo+d));
    document.getElementById('tempo').textContent = S.tempo;
}
function tap(){
    const n = Date.now();
    S.tap.push(n); if(S.tap.length>4) S.tap.shift();
    if(S.tap.length>1){
        const avg = S.tap.slice(1).reduce((a,b,i)=>a+(b-S.tap[i]),0)/(S.tap.length-1);
        S.tempo = Math.round(60000/avg);
        document.getElementById('tempo').textContent = S.tempo;
    }
}
function full(){
    document.fullscreenElement?document.exitFullscreen():document.documentElement.requestFullscreen();
}

function selectStyle(s){ /* TODO: load real patterns */){}
function selectSection(s){}
function selectVariation(v){}

function playChord(name){
    document.getElementById('chord').textContent = name;
    // Send chord notes to CTK (example C major)
    const root = ["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"].indexOf(name.replace(/m|7|maj7|dim|aug|sus4/g,''));
    const notes = [60+root,64+root,67+root];
    if(S.midiCTK) notes.forEach(n=>S.midiCTK.send([144,n,S.vel])));
}
function stopChord(){
    if(S.midiCTK) for(let n=36;n<96;n++) S.midiCTK.send([128,n,0]));
}

function toggleCell(e){
    const cell = e.target;
    const step = +cell.dataset.step;
    const track = cell.dataset.track;
    S.pattern[step][track[0]] = S.pattern[step][track[0]]?0:1;
    updatePattern();
    updateLP();
}

function updatePattern(){
    document.querySelectorAll('.cell').forEach(c=>{
        const s = +c.dataset.step;
        const t = c.dataset.track[0];
        c.classList.toggle('active', S.pattern[s][t]);
    });
}

// === PLAYBACK ===
let timer;
function play(){
    if(S.playing) return;
    S.playing=true;
    document.getElementById('play').textContent='Stop';
    const step = ()=>{
        beat();
        updateBeat();
        updateLP();
        S.beat = (S.beat+1)%16;
        let delay = 60000/S.tempo/4;
        if(S.beat%2&&S.swing>50)&&(delay+=(S.swing-50)/50*delay);
        timer=setTimeout(step,delay);
    };
    step();
}
function stop(){
    clearTimeout(timer);
    S.playing=false;
    S.beat=0;
    document.getElementById('play').textContent='Play';
    if(S.midiCTK){
        // Fade reverb 2s
        S.midiCTK.send([176,91,80]);
        let v=S.vel;
        const fade=setInterval(()=>{v-=10;if(v<=0){clearInterval(fade);S.midiCTK.send([176,123,0]);}},100);
    }
    updateBeat();
    updateLP();
}
function togglePlayback(){ S.playing?stop():play(); }

function beat(){
    const p = S.pattern[S.beat];
    const v = Math.max(20,S.vel + (Math.random()-0.5)*S.human);
    if(S.midiCTK){
        p.k&&S.midiCTK.send([153,36,v]);
        p.s&&S.midiCTK.send([153,38,v]);
        p.h&&S.midiCTK.send([153,42,v]);
        p.o&&S.midiCTK.send([153,46,v]);
    }
    // Bass in user2
    if(S.mode==='user2'){
        S.bassPat[S.beat].forEach((on,i)=>{
            if(on){
                const note = BASSNOTES[i];
                S.midiCTK.send([144,note,v]);
                setTimeout(()=>S.midiCTK.send([128,note,0]),120);
            }
        });
    }
}

function updateBeat(){
    document.querySelectorAll('.playing').forEach(e=>e.classList.remove('playing'));
    document.querySelectorAll(`.cell[data-step="${S.beat}"]`).forEach(c=>c.classList.add('playing'));
}

// === LAUNCHPAD LIVE UPDATE ===
function updateLP(){
    if(!S.midiLP) return;
    clearLP();
    if(S.mode==='session'){
        // 16 steps on 64 pads
        for(let s=0;s<16;s++){
            const r = s<8 ? 7-s : 15-s;
            const c = s<8 ? s : s-8;
            const on = S.pattern[s].k||S.pattern[s].s||S.pattern[s].h||S.pattern[s].o;
            lp(r,c, on?COL.green:COL.off);
            if(S.playing && s===S.beat) lp(r,c,COL.amber);
        }
        // Drum kits on right
        for(let i=0;i<6;i++) lp(i,0, i===S.drumKit?COL.cyan:COL.off);
        // Play/Stop
        lp(6,0, S.playing?COL.green:COL.off);
        lp(7,0, S.playing?COL.off:COL.red);
    }
    else if(S.mode==='user1'){
        // Full GM drum kit
        for(let r=0;r<8;r++)for(let c=0;c<8;c++){
            const idx = r*8+c;
            lp(r,c, drumColors[idx%drumColors.length]);
        }
    }
    else if(S.mode==='user2'){
        // Bass sequencer
        const page = S.beat<8?0:1;
        lp(0,0, page===0?COL.green:COL.off); // Up
        lp(1,0, page===1?COL.green:COL.off); // Down
        for(let s=0;s<8;s++)for(let n=0;n<8;n++){
            const on = S.bassPat[page*8+s][7-n];
            lp(n,s, on?COL.blue:COL.off);
        }
    }
}

// === Misc ===
function toast(t){ const d=document.createElement('div');d.className='toast';d.textContent=t;document.body.appendChild(d);setTimeout(()=>d.remove(),2500); }

// Auto connect
connect();
setInterval(updateLP,80);
</script>
</body>
</html>
