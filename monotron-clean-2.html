<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>Monotron Duo Synth</title>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body, html, #root {
      margin: 0;
      padding: 0;
      width: 100%;
      height: 100%;
      overflow: hidden;
    }
    body { position: fixed; overscroll-behavior: none; }
    .piano-key { transition: background-color 0.05s; }
    .piano-key:active { filter: brightness(0.8); }
    .keyboard-area { touch-action: none; }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useRef, useEffect } = React;

    const MonotronSynth = () => {
      const [isPlaying, setIsPlaying] = useState(false);
      const [isPoweredOn, setIsPoweredOn] = useState(false);
      const [currentNote, setCurrentNote] = useState('');
      const [isFullscreen, setIsFullscreen] = useState(false);

      // Presets
      const [presetName, setPresetName] = useState('');
      const [selectedPreset, setSelectedPreset] = useState('');

      const generateDefaultName = () => {
        let i = 1;
        while (localStorage.getItem(`preset-Preset-${i}`)) {
          i++;
        }
        return `Preset-${i}`;
      };

      const savePreset = (name) => {
        const finalName = name || generateDefaultName();
        const preset = {
          osc1Wave, osc2Wave, osc1Pitch, osc2Pitch, osc2Mix,
          cutoff, resonance, peak,
          lfoRate, lfoDepth, lfoTarget,
          volume
        };
        localStorage.setItem(`preset-${finalName}`, JSON.stringify(preset));
        setSelectedPreset(finalName);
      };

      const loadPreset = (name) => {
        const data = localStorage.getItem(`preset-${name}`);
        if (!data) return;
        const preset = JSON.parse(data);
        setOsc1Wave(preset.osc1Wave);
        setOsc2Wave(preset.osc2Wave);
        setOsc1Pitch(preset.osc1Pitch);
        setOsc2Pitch(preset.osc2Pitch);
        setOsc2Mix(preset.osc2Mix);
        setCutoff(preset.cutoff);
        setResonance(preset.resonance);
        setPeak(preset.peak);
        setLfoRate(preset.lfoRate);
        setLfoDepth(preset.lfoDepth);
        setLfoTarget(preset.lfoTarget);
        setVolume(preset.volume);
      };

      const deletePreset = (name) => {
        localStorage.removeItem(`preset-${name}`);
        setSelectedPreset('');
      };

      // Oscillator parameters
      const [osc1Wave, setOsc1Wave] = useState('sine');
      const [osc2Wave, setOsc2Wave] = useState('sine');
      const [osc1Pitch, setOsc1Pitch] = useState(0);
      const [osc2Pitch, setOsc2Pitch] = useState(-12);
      const [osc2Mix, setOsc2Mix] = useState(0.5);

      // Filter parameters
      const [cutoff, setCutoff] = useState(2000);
      const [resonance, setResonance] = useState(1);
      const [peak, setPeak] = useState(0);

      // LFO parameters
      const [lfoRate, setLfoRate] = useState(5);
      const [lfoDepth, setLfoDepth] = useState(0);
      const [lfoTarget, setLfoTarget] = useState('pitch');

      // Master volume
      const [volume, setVolume] = useState(0.5);

      // Audio context refs
      const audioContextRef = useRef(null);
      const osc1Ref = useRef(null);
      const osc2Ref = useRef(null);
      const filterRef = useRef(null);
      const lfoRef = useRef(null);
      const lfoGainRef = useRef(null);
      const gainNodeRef = useRef(null);
      const masterGainRef = useRef(null);

      // Note names
      const noteNames = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'];

      // Fullscreen handling
      useEffect(() => {
        const handleFullscreenChange = () => setIsFullscreen(!!document.fullscreenElement);
        document.addEventListener('fullscreenchange', handleFullscreenChange);
        return () => document.removeEventListener('fullscreenchange', handleFullscreenChange);
      }, []);

      const toggleFullscreen = () => {
        if (!document.fullscreenElement) {
          document.documentElement.requestFullscreen();
        } else {
          document.exitFullscreen();
        }
      };

      const frequencyToNote = (frequency) => {
        const noteNum = 12 * Math.log2(frequency / 440) + 69;
        const noteIndex = Math.round(noteNum);
        const octave = Math.floor((noteIndex - 12) / 12);
        const note = noteNames[noteIndex % 12];
        return `${note}${octave}`;
      };

      // … (tout le reste du code audio : startNote, stopNote, updateFilter, updateLFO, updateVolume, clavier, etc. reste identique à ta version précédente)

      // UI Knob + Icons
      const Knob = ({ label, value, onChange, min, max, step = 1, unit = '' }) => {
        const percentage = ((value - min) / (max - min)) * 100;
        const rotation = (percentage * 2.7) - 135;
        return React.createElement('div', { className: "flex flex-col items-center gap-0.5" },
          React.createElement('div', { className: "relative w-12 h-12" },
            React.createElement('div', { className: "absolute inset-0 rounded-full bg-gray-800 border-2 border-gray-600 shadow-inner" }),
            React.createElement('div', {
              className: "absolute inset-1 rounded-full bg-gradient-to-br from-blue-400 to-blue-600 shadow-lg cursor-pointer",
              style: { transform: `rotate(${rotation}deg)` }
            },
              React.createElement('div', { className: "absolute top-1 left-1/2 w-0.5 h-3 bg-white rounded-full -translate-x-1/2" })
            ),
            React.createElement('input', {
              type: "range", min, max, step, value,
              onChange: (e) => onChange(parseFloat(e.target.value)),
              className: "absolute inset-0 opacity-0 cursor-pointer"
            })
          ),
          React.createElement('div', { className: "text-[10px] text-blue-200 font-mono text-center leading-tight" },
            label,
            React.createElement('div', { className: "text-white text-[9px]" },
              typeof value === 'number' ? value.toFixed(step < 1 ? 2 : 0) : value, unit
            )
          )
        );
      };

      // … (rendu principal avec VCO1, VCO2, Filter, LFO, Volume, PRESETS section, clavier piano)
    };

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(React.createElement(MonotronSynth));
  </script>
</body>
</html>
