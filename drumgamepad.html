<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üéÆ iPega Drum Machine - CTK-3200</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            min-height: 100vh;
            color: #fff;
            overflow-x: hidden;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            text-align: center;
            padding: 20px 0;
            border-bottom: 2px solid rgba(255,255,255,0.1);
            margin-bottom: 20px;
        }

        h1 {
            font-size: 2.5em;
            background: linear-gradient(45deg, #ff6b6b, #feca57, #48dbfb, #ff9ff3);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 10px;
        }

        .subtitle {
            color: #a0a0a0;
            font-size: 1.1em;
        }

        /* Connection Status */
        .status-bar {
            display: flex;
            justify-content: center;
            gap: 30px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .status-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 20px;
            background: rgba(255,255,255,0.05);
            border-radius: 25px;
            border: 1px solid rgba(255,255,255,0.1);
        }

        .status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #e74c3c;
            animation: pulse 2s infinite;
        }

        .status-dot.connected {
            background: #2ecc71;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* Mode Selector */
        .mode-selector {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        .mode-btn {
            padding: 12px 30px;
            font-size: 1.1em;
            border: none;
            border-radius: 30px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .mode-btn.auto {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }

        .mode-btn.semi {
            background: linear-gradient(135deg, #11998e, #38ef7d);
            color: white;
        }

        .mode-btn.manual {
            background: linear-gradient(135deg, #f093fb, #f5576c);
            color: white;
        }

        .mode-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }

        .mode-btn.active {
            box-shadow: 0 0 30px rgba(255,255,255,0.5);
            transform: scale(1.1);
        }

        /* Main Content */
        .main-content {
            display: grid;
            grid-template-columns: 1fr 400px;
            gap: 30px;
            align-items: start;
        }

        @media (max-width: 1200px) {
            .main-content {
                grid-template-columns: 1fr;
            }
        }

        /* Controller Visual */
        .controller-container {
            background: rgba(0,0,0,0.3);
            border-radius: 20px;
            padding: 30px;
            border: 1px solid rgba(255,255,255,0.1);
        }

        .controller-title {
            text-align: center;
            margin-bottom: 20px;
            font-size: 1.3em;
            color: #48dbfb;
        }

        .controller-visual {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            background: linear-gradient(145deg, #2d2d2d, #1a1a1a);
            border-radius: 50px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.5);
            position: relative;
        }

        /* Left Side */
        .left-side, .right-side {
            display: flex;
            flex-direction: column;
            gap: 15px;
            align-items: center;
        }

        /* D-Pad */
        .dpad {
            width: 100px;
            height: 100px;
            position: relative;
        }

        .dpad-btn {
            position: absolute;
            width: 30px;
            height: 30px;
            background: #444;
            border-radius: 5px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7em;
            transition: all 0.1s;
            cursor: pointer;
        }

        .dpad-btn.active {
            background: #ff6b6b;
            box-shadow: 0 0 20px #ff6b6b;
            transform: scale(1.1);
        }

        .dpad-up { top: 0; left: 35px; }
        .dpad-down { bottom: 0; left: 35px; }
        .dpad-left { left: 0; top: 35px; }
        .dpad-right { right: 0; top: 35px; }
        .dpad-center { top: 35px; left: 35px; background: #333; }

        /* Joysticks */
        .joystick-container {
            width: 70px;
            height: 70px;
            background: radial-gradient(circle, #333, #222);
            border-radius: 50%;
            position: relative;
            border: 3px solid #444;
        }

        .joystick-dot {
            width: 30px;
            height: 30px;
            background: radial-gradient(circle, #666, #444);
            border-radius: 50%;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            transition: all 0.05s;
        }

        /* Triggers */
        .triggers {
            display: flex;
            gap: 10px;
        }

        .trigger {
            width: 40px;
            height: 25px;
            background: #444;
            border-radius: 10px 10px 5px 5px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7em;
            transition: all 0.1s;
        }

        .trigger.active {
            background: #feca57;
            box-shadow: 0 0 15px #feca57;
        }

        /* Center Buttons */
        .center-section {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
        }

        .center-btns {
            display: flex;
            gap: 20px;
        }

        .center-btn {
            width: 35px;
            height: 20px;
            background: #444;
            border-radius: 10px;
            font-size: 0.6em;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.1s;
        }

        .center-btn.active {
            background: #48dbfb;
            box-shadow: 0 0 15px #48dbfb;
        }

        /* ABXY Buttons */
        .abxy {
            width: 100px;
            height: 100px;
            position: relative;
        }

        .abxy-btn {
            position: absolute;
            width: 35px;
            height: 35px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            transition: all 0.1s;
            cursor: pointer;
        }

        .abxy-btn.active {
            transform: scale(1.2);
            box-shadow: 0 0 25px currentColor;
        }

        .btn-a { bottom: 0; left: 32px; background: #2ecc71; color: white; }
        .btn-b { right: 0; top: 32px; background: #e74c3c; color: white; }
        .btn-x { left: 0; top: 32px; background: #3498db; color: white; }
        .btn-y { top: 0; left: 32px; background: #f1c40f; color: #333; }

        /* Control Panel */
        .control-panel {
            background: rgba(0,0,0,0.3);
            border-radius: 20px;
            padding: 25px;
            border: 1px solid rgba(255,255,255,0.1);
        }

        .panel-section {
            margin-bottom: 25px;
        }

        .panel-title {
            font-size: 1.1em;
            color: #feca57;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* Kit Selector */
        .kit-selector {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
        }

        .kit-btn {
            padding: 12px;
            background: rgba(255,255,255,0.05);
            border: 2px solid rgba(255,255,255,0.1);
            border-radius: 10px;
            color: white;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.9em;
        }

        .kit-btn:hover {
            background: rgba(255,255,255,0.1);
        }

        .kit-btn.active {
            border-color: #48dbfb;
            background: rgba(72, 219, 251, 0.2);
            box-shadow: 0 0 15px rgba(72, 219, 251, 0.3);
        }

        /* Tempo Control */
        .tempo-control {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .tempo-display {
            font-size: 2.5em;
            font-weight: bold;
            color: #ff6b6b;
            min-width: 100px;
            text-align: center;
        }

        .tempo-display span {
            font-size: 0.4em;
            color: #888;
        }

        .tempo-slider {
            flex: 1;
            -webkit-appearance: none;
            height: 8px;
            border-radius: 4px;
            background: linear-gradient(90deg, #667eea, #764ba2, #f5576c);
        }

        .tempo-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 25px;
            height: 25px;
            border-radius: 50%;
            background: white;
            cursor: pointer;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
        }

        /* Pattern Grid (Auto Mode) */
        .pattern-section {
            display: none;
        }

        .pattern-section.visible {
            display: block;
        }

        .pattern-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
        }

        .pattern-btn {
            padding: 20px 10px;
            background: linear-gradient(145deg, #2a2a4a, #1a1a3a);
            border: 2px solid rgba(255,255,255,0.1);
            border-radius: 15px;
            color: white;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
        }

        .pattern-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 20px rgba(0,0,0,0.3);
        }

        .pattern-btn.playing {
            border-color: #2ecc71;
            background: linear-gradient(145deg, #1a4a2a, #0a3a1a);
            animation: patternPulse 0.5s ease infinite;
        }

        @keyframes patternPulse {
            0%, 100% { box-shadow: 0 0 10px rgba(46, 204, 113, 0.3); }
            50% { box-shadow: 0 0 25px rgba(46, 204, 113, 0.6); }
        }

        .pattern-name {
            font-weight: bold;
            margin-bottom: 5px;
        }

        .pattern-info {
            font-size: 0.75em;
            color: #888;
        }

        /* Manual Mode Sound Map */
        .sound-map {
            display: none;
        }

        .sound-map.visible {
            display: block;
        }

        .sound-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
            font-size: 0.85em;
        }

        .sound-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            background: rgba(255,255,255,0.03);
            border-radius: 8px;
            border-left: 3px solid transparent;
        }

        .sound-item.active {
            background: rgba(255,255,255,0.1);
            border-left-color: #ff6b6b;
        }

        .sound-item.held {
            background: rgba(46, 204, 113, 0.2);
            border-left-color: #2ecc71;
            animation: heldPulse 0.5s ease infinite;
        }

        @keyframes heldPulse {
            0%, 100% { background: rgba(46, 204, 113, 0.2); }
            50% { background: rgba(46, 204, 113, 0.4); }
        }

        .sound-key {
            font-weight: bold;
            color: #feca57;
            min-width: 30px;
        }

        .sound-name {
            color: #ccc;
        }

        /* Beat Visualizer */
        .visualizer {
            height: 60px;
            background: rgba(0,0,0,0.3);
            border-radius: 10px;
            display: flex;
            align-items: flex-end;
            justify-content: center;
            gap: 4px;
            padding: 10px;
            margin-top: 20px;
            overflow: hidden;
        }

        .viz-bar {
            width: 8px;
            background: linear-gradient(to top, #667eea, #f5576c);
            border-radius: 4px 4px 0 0;
            transition: height 0.05s;
        }

        /* Transport Controls */
        .transport {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 20px;
        }

        .transport-btn {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            border: none;
            cursor: pointer;
            font-size: 1.5em;
            transition: all 0.2s;
        }

        .play-btn {
            background: linear-gradient(145deg, #2ecc71, #27ae60);
            color: white;
        }

        .stop-btn {
            background: linear-gradient(145deg, #e74c3c, #c0392b);
            color: white;
        }

        .transport-btn:hover {
            transform: scale(1.1);
        }

        .transport-btn:active {
            transform: scale(0.95);
        }

        /* Hit Feedback */
        .hit-display {
            text-align: center;
            padding: 15px;
            margin-top: 15px;
            background: rgba(0,0,0,0.2);
            border-radius: 10px;
            min-height: 60px;
        }

        .hit-name {
            font-size: 1.5em;
            font-weight: bold;
            color: #ff6b6b;
            text-transform: uppercase;
        }

        .hit-note {
            color: #888;
            font-size: 0.9em;
        }

        /* MIDI Setup */
        .midi-setup {
            background: rgba(0,0,0,0.2);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .midi-select {
            width: 100%;
            padding: 10px;
            border-radius: 8px;
            border: 1px solid rgba(255,255,255,0.2);
            background: rgba(255,255,255,0.05);
            color: white;
            font-size: 1em;
            margin-top: 10px;
        }

        .midi-select option {
            background: #1a1a2e;
        }

        /* Instructions */
        .instructions {
            background: rgba(255,255,255,0.02);
            border-radius: 15px;
            padding: 20px;
            margin-top: 20px;
            border: 1px dashed rgba(255,255,255,0.1);
        }

        .instructions h3 {
            color: #48dbfb;
            margin-bottom: 15px;
        }

        .instructions ul {
            list-style: none;
            display: grid;
            gap: 8px;
        }

        .instructions li {
            padding-left: 25px;
            position: relative;
            color: #aaa;
        }

        .instructions li::before {
            content: "‚ñ∏";
            position: absolute;
            left: 0;
            color: #feca57;
        }

        /* Footer */
        footer {
            text-align: center;
            padding: 20px;
            margin-top: 30px;
            color: #666;
            border-top: 1px solid rgba(255,255,255,0.05);
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üéÆ iPega Drum Machine</h1>
            <p class="subtitle">CTK-3200 ‚Ä¢ Contr√¥leur iPega PG-9083S</p>
        </header>

        <!-- Status Bar -->
        <div class="status-bar">
            <div class="status-item">
                <div class="status-dot" id="midiStatus"></div>
                <span>MIDI: <span id="midiStatusText">Non connect√©</span></span>
            </div>
            <div class="status-item">
                <div class="status-dot" id="gamepadStatus"></div>
                <span>Manette: <span id="gamepadStatusText">Non connect√©e</span></span>
            </div>
        </div>

        <!-- Mode Selector -->
        <div class="mode-selector">
            <button class="mode-btn auto active" onclick="setMode('auto')">
                ü§ñ Auto
            </button>
            <button class="mode-btn semi" onclick="setMode('semi')">
                üîÑ Semi-Auto
            </button>
            <button class="mode-btn manual" onclick="setMode('manual')">
                üéØ Manuel
            </button>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Controller Visual -->
            <div class="controller-container">
                <h2 class="controller-title">üéÆ iPega PG-9083S</h2>
                
                <div class="controller-visual">
                    <!-- Left Side -->
                    <div class="left-side">
                        <div class="triggers">
                            <div class="trigger" id="L1">L1</div>
                            <div class="trigger" id="L2">L2</div>
                        </div>
                        
                        <div class="dpad">
                            <div class="dpad-btn dpad-up" id="DPadUp">‚ñ≤</div>
                            <div class="dpad-btn dpad-down" id="DPadDown">‚ñº</div>
                            <div class="dpad-btn dpad-left" id="DPadLeft">‚óÑ</div>
                            <div class="dpad-btn dpad-right" id="DPadRight">‚ñ∫</div>
                            <div class="dpad-btn dpad-center"></div>
                        </div>
                        
                        <div class="joystick-container">
                            <div class="joystick-dot" id="leftJoystick"></div>
                        </div>
                    </div>

                    <!-- Center -->
                    <div class="center-section">
                        <div class="center-btns">
                            <div class="center-btn" id="Select">SEL</div>
                            <div class="center-btn" id="Start">STA</div>
                        </div>
                        
                        <!-- Beat Visualizer -->
                        <div class="visualizer" id="visualizer">
                            <!-- Generated by JS -->
                        </div>
                    </div>

                    <!-- Right Side -->
                    <div class="right-side">
                        <div class="triggers">
                            <div class="trigger" id="R1">R1</div>
                            <div class="trigger" id="R2">R2</div>
                        </div>
                        
                        <div class="abxy">
                            <div class="abxy-btn btn-a" id="BtnA">A</div>
                            <div class="abxy-btn btn-b" id="BtnB">B</div>
                            <div class="abxy-btn btn-x" id="BtnX">X</div>
                            <div class="abxy-btn btn-y" id="BtnY">Y</div>
                        </div>
                        
                        <div class="joystick-container">
                            <div class="joystick-dot" id="rightJoystick"></div>
                        </div>
                    </div>
                </div>

                <!-- Hit Display -->
                <div class="hit-display">
                    <div class="hit-name" id="hitName">Pr√™t!</div>
                    <div class="hit-note" id="hitNote">Appuie sur un bouton</div>
                </div>

                <!-- Transport -->
                <div class="transport">
                    <button class="transport-btn play-btn" id="playBtn" onclick="togglePlay()">‚ñ∂</button>
                    <button class="transport-btn stop-btn" onclick="stopPlayback()">‚ñ†</button>
                </div>
            </div>

            <!-- Control Panel -->
            <div class="control-panel">
                <!-- MIDI Setup -->
                <div class="midi-setup">
                    <div class="panel-title">üîå Sortie MIDI</div>
                    <select class="midi-select" id="midiOutput">
                        <option value="">-- S√©lectionner CTK-3200 --</option>
                    </select>
                </div>

                <!-- Kit Selector -->
                <div class="panel-section">
                    <div class="panel-title">ü•Å Kit de Batterie</div>
                    <div class="kit-selector" id="kitSelector">
                        <!-- Generated by JS -->
                    </div>
                </div>

                <!-- Tempo Control -->
                <div class="panel-section">
                    <div class="panel-title">‚è±Ô∏è Tempo</div>
                    <div class="tempo-control">
                        <div class="tempo-display">
                            <span id="tempoValue">120</span>
                            <span>BPM</span>
                        </div>
                        <input type="range" class="tempo-slider" id="tempoSlider" 
                               min="60" max="200" value="120">
                    </div>
                </div>

                <!-- Patterns (Auto Mode) -->
                <div class="panel-section pattern-section visible" id="patternSection">
                    <div class="panel-title">üéµ Patterns</div>
                    <div class="pattern-grid" id="patternGrid">
                        <!-- Generated by JS -->
                    </div>
                </div>

                <!-- Sound Map (Manual Mode) -->
                <div class="panel-section sound-map" id="soundMapSection">
                    <div class="panel-title">üéπ Mapping des Sons</div>
                    <div class="sound-grid" id="soundGrid">
                        <!-- Generated by JS -->
                    </div>
                </div>

                <!-- Instructions -->
                <div class="instructions">
                    <h3>üí° Contr√¥les</h3>
                    <ul id="instructionsList">
                        <!-- Generated by JS based on mode -->
                    </ul>
                </div>
            </div>
        </div>

        <footer>
            üéÆ iPega Drum Machine pour CTK-3200 ‚Ä¢ Mode <span id="footerMode">Auto</span>
        </footer>
    </div>

    <script>
        // ============================================
        // CONFIGURATION
        // ============================================
        
        // Drum Kits (CTK-3200 voices 395+) with GM Program numbers
        // CTK-3200 uses Bank Select for drum kits on channel 10
        const DRUM_KITS = [
            { voice: 395, name: "Standard Kit 1", icon: "ü•Å", program: 0, bankMSB: 0, bankLSB: 0 },
            { voice: 396, name: "Standard Kit 2", icon: "ü•Å", program: 0, bankMSB: 0, bankLSB: 1 },
            { voice: 397, name: "Room Kit", icon: "üè†", program: 8, bankMSB: 0, bankLSB: 0 },
            { voice: 398, name: "Rock Kit", icon: "üé∏", program: 16, bankMSB: 0, bankLSB: 0 },
            { voice: 399, name: "Electronic Kit", icon: "‚ö°", program: 24, bankMSB: 0, bankLSB: 0 },
            { voice: 400, name: "Analog Kit", icon: "üéõÔ∏è", program: 25, bankMSB: 0, bankLSB: 0 },
            { voice: 401, name: "Dance Kit", icon: "üíÉ", program: 27, bankMSB: 0, bankLSB: 0 },
            { voice: 402, name: "Jazz Kit", icon: "üé∑", program: 32, bankMSB: 0, bankLSB: 0 },
            { voice: 403, name: "Brush Kit", icon: "üñåÔ∏è", program: 40, bankMSB: 0, bankLSB: 0 },
            { voice: 404, name: "Orchestra Kit", icon: "üéª", program: 48, bankMSB: 0, bankLSB: 0 },
            { voice: 405, name: "SFX Kit", icon: "‚ú®", program: 56, bankMSB: 0, bankLSB: 0 },
            { voice: 406, name: "GM Kit", icon: "üéπ", program: 0, bankMSB: 121, bankLSB: 0 }
        ];

        // GM Drum Notes (Channel 10)
        const DRUM_SOUNDS = {
            kick: { note: 36, name: "Kick" },
            kick2: { note: 35, name: "Kick 2" },
            snare: { note: 38, name: "Snare" },
            snareRim: { note: 37, name: "Rim Shot" },
            snare2: { note: 40, name: "Snare 2" },
            hihatClosed: { note: 42, name: "Hi-Hat Closed" },
            hihatPedal: { note: 44, name: "Hi-Hat Pedal" },
            hihatOpen: { note: 46, name: "Hi-Hat Open" },
            tomLow: { note: 41, name: "Tom Low" },
            tomMid: { note: 43, name: "Tom Mid" },
            tomHigh: { note: 45, name: "Tom High" },
            crash: { note: 49, name: "Crash" },
            ride: { note: 51, name: "Ride" },
            rideBell: { note: 53, name: "Ride Bell" },
            clap: { note: 39, name: "Clap" },
            cowbell: { note: 56, name: "Cowbell" },
            tambourine: { note: 54, name: "Tambourine" },
            conga: { note: 63, name: "Conga" }
        };

        // Button to Sound Mapping for Manual Mode
        const MANUAL_MAPPING = {
            0: 'kick',        // A
            1: 'snare',       // B  
            2: 'hihatClosed', // X
            3: 'hihatOpen',   // Y
            4: 'tomLow',      // L1
            5: 'tomMid',      // R1
            6: 'crash',       // L2
            7: 'ride',        // R2
            8: 'clap',        // Select
            9: 'cowbell',     // Start
            12: 'kick2',      // DPad Up
            13: 'snare2',     // DPad Down
            14: 'tambourine', // DPad Left
            15: 'rideBell'    // DPad Right
        };

        // Patterns for Auto Mode
        const PATTERNS = [
            {
                name: "Basic Rock",
                icon: "üé∏",
                signature: "4/4",
                pattern: [
                    { time: 0, sounds: ['kick', 'hihatClosed'] },
                    { time: 0.25, sounds: ['hihatClosed'] },
                    { time: 0.5, sounds: ['snare', 'hihatClosed'] },
                    { time: 0.75, sounds: ['hihatClosed'] },
                    { time: 1, sounds: ['kick', 'hihatClosed'] },
                    { time: 1.25, sounds: ['hihatClosed'] },
                    { time: 1.5, sounds: ['snare', 'hihatClosed'] },
                    { time: 1.75, sounds: ['hihatOpen'] }
                ]
            },
            {
                name: "Disco",
                icon: "ü™©",
                signature: "4/4",
                pattern: [
                    { time: 0, sounds: ['kick'] },
                    { time: 0.25, sounds: ['hihatOpen'] },
                    { time: 0.5, sounds: ['kick', 'snare'] },
                    { time: 0.75, sounds: ['hihatOpen'] },
                    { time: 1, sounds: ['kick'] },
                    { time: 1.25, sounds: ['hihatOpen'] },
                    { time: 1.5, sounds: ['kick', 'snare'] },
                    { time: 1.75, sounds: ['hihatOpen'] }
                ]
            },
            {
                name: "Hip Hop",
                icon: "üé§",
                signature: "4/4",
                pattern: [
                    { time: 0, sounds: ['kick'] },
                    { time: 0.75, sounds: ['snare'] },
                    { time: 1, sounds: ['kick'] },
                    { time: 1.25, sounds: ['kick'] },
                    { time: 1.5, sounds: ['snare'] }
                ]
            },
            {
                name: "Funk",
                icon: "üï∫",
                signature: "4/4",
                pattern: [
                    { time: 0, sounds: ['kick', 'hihatClosed'] },
                    { time: 0.25, sounds: ['hihatClosed'] },
                    { time: 0.375, sounds: ['kick'] },
                    { time: 0.5, sounds: ['snare', 'hihatClosed'] },
                    { time: 0.75, sounds: ['hihatOpen'] },
                    { time: 1, sounds: ['kick', 'hihatClosed'] },
                    { time: 1.125, sounds: ['kick'] },
                    { time: 1.25, sounds: ['hihatClosed'] },
                    { time: 1.5, sounds: ['snare', 'hihatClosed'] },
                    { time: 1.75, sounds: ['hihatClosed'] }
                ]
            },
            {
                name: "Reggae",
                icon: "üå¥",
                signature: "4/4",
                pattern: [
                    { time: 0.5, sounds: ['snareRim', 'hihatClosed'] },
                    { time: 1, sounds: ['kick'] },
                    { time: 1.5, sounds: ['snareRim', 'hihatClosed'] }
                ]
            },
            {
                name: "Jazz Swing",
                icon: "üé∑",
                signature: "4/4",
                pattern: [
                    { time: 0, sounds: ['ride'] },
                    { time: 0.33, sounds: ['ride'] },
                    { time: 0.5, sounds: ['ride'] },
                    { time: 0.83, sounds: ['ride'] },
                    { time: 1, sounds: ['ride'] },
                    { time: 1.33, sounds: ['ride'] },
                    { time: 1.5, sounds: ['snare'] },
                    { time: 1.83, sounds: ['ride'] }
                ]
            },
            {
                name: "Bossa Nova",
                icon: "üåä",
                signature: "4/4",
                pattern: [
                    { time: 0, sounds: ['kick'] },
                    { time: 0.25, sounds: ['snareRim'] },
                    { time: 0.5, sounds: ['snareRim'] },
                    { time: 0.75, sounds: ['kick', 'snareRim'] },
                    { time: 1, sounds: ['snareRim'] },
                    { time: 1.25, sounds: ['kick', 'snareRim'] },
                    { time: 1.5, sounds: ['snareRim'] },
                    { time: 1.75, sounds: ['snareRim'] }
                ]
            },
            {
                name: "Techno",
                icon: "ü§ñ",
                signature: "4/4",
                pattern: [
                    { time: 0, sounds: ['kick'] },
                    { time: 0.25, sounds: ['hihatClosed'] },
                    { time: 0.5, sounds: ['kick', 'clap'] },
                    { time: 0.75, sounds: ['hihatOpen'] },
                    { time: 1, sounds: ['kick'] },
                    { time: 1.25, sounds: ['hihatClosed'] },
                    { time: 1.5, sounds: ['kick', 'clap'] },
                    { time: 1.75, sounds: ['hihatClosed'] }
                ]
            },
            {
                name: "Waltz",
                icon: "üíÉ",
                signature: "3/4",
                pattern: [
                    { time: 0, sounds: ['kick'] },
                    { time: 0.33, sounds: ['hihatClosed'] },
                    { time: 0.67, sounds: ['hihatClosed'] }
                ]
            },
            {
                name: "Latin",
                icon: "üå∂Ô∏è",
                signature: "4/4",
                pattern: [
                    { time: 0, sounds: ['kick', 'conga'] },
                    { time: 0.25, sounds: ['conga'] },
                    { time: 0.5, sounds: ['snare', 'conga'] },
                    { time: 0.75, sounds: ['kick'] },
                    { time: 1, sounds: ['conga'] },
                    { time: 1.25, sounds: ['conga'] },
                    { time: 1.5, sounds: ['snare', 'conga'] },
                    { time: 1.75, sounds: ['conga'] }
                ]
            },
            {
                name: "Fill 1",
                icon: "üî•",
                signature: "1 bar",
                isFill: true,
                pattern: [
                    { time: 0, sounds: ['snare'] },
                    { time: 0.125, sounds: ['snare'] },
                    { time: 0.25, sounds: ['tomHigh'] },
                    { time: 0.375, sounds: ['tomHigh'] },
                    { time: 0.5, sounds: ['tomMid'] },
                    { time: 0.625, sounds: ['tomMid'] },
                    { time: 0.75, sounds: ['tomLow'] },
                    { time: 0.875, sounds: ['tomLow'] },
                    { time: 1, sounds: ['crash', 'kick'] }
                ]
            },
            {
                name: "Fill 2",
                icon: "üí•",
                signature: "1 bar",
                isFill: true,
                pattern: [
                    { time: 0, sounds: ['snare'] },
                    { time: 0.25, sounds: ['snare'] },
                    { time: 0.5, sounds: ['snare'] },
                    { time: 0.625, sounds: ['snare'] },
                    { time: 0.75, sounds: ['snare'] },
                    { time: 0.8125, sounds: ['snare'] },
                    { time: 0.875, sounds: ['snare'] },
                    { time: 0.9375, sounds: ['snare'] },
                    { time: 1, sounds: ['crash', 'kick'] }
                ]
            }
        ];

        // ============================================
        // STATE
        // ============================================
        
        let midiOutput = null;
        let midiChannel = 9; // Channel 10 for drums
        let currentKit = 0;
        let currentMode = 'auto';
        let isPlaying = false;
        let tempo = 120;
        let currentPattern = 0;
        let patternTimeout = null;
        let beatPosition = 0;
        let gamepadIndex = null;
        let prevButtonStates = {};
        
        // Semi-auto mode state
        let heldButtons = new Set();
        let semiAutoInterval = null;
        let beatClock = 0;
        
        // ============================================
        // MIDI FUNCTIONS
        // ============================================
        
        async function initMIDI() {
            try {
                const access = await navigator.requestMIDIAccess();
                const outputs = Array.from(access.outputs.values());
                
                const select = document.getElementById('midiOutput');
                select.innerHTML = '<option value="">-- S√©lectionner CTK-3200 --</option>';
                
                outputs.forEach((output, index) => {
                    const option = document.createElement('option');
                    option.value = index;
                    option.textContent = output.name;
                    select.appendChild(option);
                    
                    // Auto-select CTK
                    if (output.name.toLowerCase().includes('ctk') || 
                        output.name.toLowerCase().includes('casio')) {
                        select.value = index;
                        midiOutput = output;
                        updateMIDIStatus(true, output.name);
                    }
                });

                select.addEventListener('change', (e) => {
                    if (e.target.value !== '') {
                        midiOutput = outputs[parseInt(e.target.value)];
                        updateMIDIStatus(true, midiOutput.name);
                        selectKit(currentKit);
                    } else {
                        midiOutput = null;
                        updateMIDIStatus(false);
                    }
                });

                // If we auto-selected, initialize the kit
                if (midiOutput) {
                    selectKit(currentKit);
                }
                
            } catch (err) {
                console.error('MIDI Error:', err);
                updateMIDIStatus(false, 'Erreur MIDI');
            }
        }

        function updateMIDIStatus(connected, text = 'Non connect√©') {
            const dot = document.getElementById('midiStatus');
            const textEl = document.getElementById('midiStatusText');
            
            dot.classList.toggle('connected', connected);
            textEl.textContent = connected ? text : 'Non connect√©';
        }

        function sendProgramChange(kit) {
            if (!midiOutput) return;
            
            // Send Bank Select MSB (CC#0)
            midiOutput.send([0xB0 + midiChannel, 0, kit.bankMSB]);
            // Send Bank Select LSB (CC#32)
            midiOutput.send([0xB0 + midiChannel, 32, kit.bankLSB]);
            // Send Program Change
            midiOutput.send([0xC0 + midiChannel, kit.program]);
            
            console.log(`Kit changed: ${kit.name} (Bank ${kit.bankMSB}/${kit.bankLSB}, PC ${kit.program})`);
        }

        function playNote(note, velocity = 100) {
            if (!midiOutput) return;
            // Note on
            midiOutput.send([0x90 + midiChannel, note, velocity]);
            // Note off after short time
            setTimeout(() => {
                midiOutput.send([0x80 + midiChannel, note, 0]);
            }, 100);
            
            // Visual feedback
            triggerVisualizer();
        }

        function playSound(soundName, velocity = 100) {
            const sound = DRUM_SOUNDS[soundName];
            if (sound) {
                playNote(sound.note, velocity);
                showHit(sound.name, sound.note);
            }
        }

        // ============================================
        // GAMEPAD FUNCTIONS
        // ============================================
        
        function initGamepad() {
            window.addEventListener('gamepadconnected', (e) => {
                console.log('Gamepad connected:', e.gamepad.id);
                gamepadIndex = e.gamepad.index;
                updateGamepadStatus(true, e.gamepad.id);
                requestAnimationFrame(pollGamepad);
            });

            window.addEventListener('gamepaddisconnected', (e) => {
                console.log('Gamepad disconnected');
                gamepadIndex = null;
                updateGamepadStatus(false);
            });

            // Check for already connected gamepad
            const gamepads = navigator.getGamepads();
            for (let i = 0; i < gamepads.length; i++) {
                if (gamepads[i]) {
                    gamepadIndex = i;
                    updateGamepadStatus(true, gamepads[i].id);
                    requestAnimationFrame(pollGamepad);
                    break;
                }
            }
        }

        function updateGamepadStatus(connected, name = '') {
            const dot = document.getElementById('gamepadStatus');
            const textEl = document.getElementById('gamepadStatusText');
            
            dot.classList.toggle('connected', connected);
            textEl.textContent = connected ? 
                (name.length > 25 ? name.substring(0, 25) + '...' : name) : 
                'Non connect√©e';
        }

        function pollGamepad() {
            if (gamepadIndex === null) return;
            
            const gamepad = navigator.getGamepads()[gamepadIndex];
            if (!gamepad) {
                requestAnimationFrame(pollGamepad);
                return;
            }

            // Process buttons
            gamepad.buttons.forEach((button, index) => {
                const isPressed = button.pressed || button.value > 0.5;
                const wasPressed = prevButtonStates[index];
                
                // Update visual
                updateButtonVisual(index, isPressed);
                
                // Handle button state changes
                if (isPressed && !wasPressed) {
                    // Button just pressed
                    handleButtonPress(index, button.value);
                    
                    // Semi-auto: track held buttons
                    if (currentMode === 'semi' && MANUAL_MAPPING[index]) {
                        heldButtons.add(index);
                        updateSoundGridHeld();
                    }
                } else if (!isPressed && wasPressed) {
                    // Button released
                    heldButtons.delete(index);
                    updateSoundGridHeld();
                }
                
                prevButtonStates[index] = isPressed;
            });

            // Process joysticks
            updateJoystickVisual('leftJoystick', gamepad.axes[0], gamepad.axes[1]);
            updateJoystickVisual('rightJoystick', gamepad.axes[2], gamepad.axes[3]);
            
            // Use joysticks for tempo/velocity in auto mode
            if (currentMode === 'auto' || currentMode === 'semi') {
                // Left joystick Y for tempo adjustment
                if (Math.abs(gamepad.axes[1]) > 0.5) {
                    adjustTempo(-gamepad.axes[1] * 2);
                }
            }

            requestAnimationFrame(pollGamepad);
        }

        function handleButtonPress(buttonIndex, value) {
            if (currentMode === 'manual') {
                // Manual mode - play individual sounds
                const soundName = MANUAL_MAPPING[buttonIndex];
                if (soundName) {
                    const velocity = Math.round(64 + (value || 1) * 63);
                    playSound(soundName, velocity);
                }
            } else if (currentMode === 'semi') {
                // Semi-auto mode - play sound immediately on press
                // Repeats are handled by the beat clock while held
                const soundName = MANUAL_MAPPING[buttonIndex];
                if (soundName) {
                    const velocity = Math.round(64 + (value || 1) * 63);
                    playSound(soundName, velocity);
                }
                // Handle transport controls same as auto
                switch (buttonIndex) {
                    case 8: // Select - Previous kit
                        selectKit((currentKit - 1 + DRUM_KITS.length) % DRUM_KITS.length);
                        break;
                    case 9: // Start - Next kit
                        selectKit((currentKit + 1) % DRUM_KITS.length);
                        break;
                }
            } else {
                // Auto mode - control patterns and playback
                switch (buttonIndex) {
                    case 0: // A - Play/Pause
                        togglePlay();
                        break;
                    case 1: // B - Stop
                        stopPlayback();
                        break;
                    case 2: // X - Previous pattern
                        selectPattern((currentPattern - 1 + PATTERNS.length) % PATTERNS.length);
                        break;
                    case 3: // Y - Next pattern
                        selectPattern((currentPattern + 1) % PATTERNS.length);
                        break;
                    case 4: // L1 - Decrease tempo
                        adjustTempo(-5);
                        break;
                    case 5: // R1 - Increase tempo
                        adjustTempo(5);
                        break;
                    case 6: // L2 - Fill 1
                        playFill(10);
                        break;
                    case 7: // R2 - Fill 2
                        playFill(11);
                        break;
                    case 8: // Select - Previous kit
                        selectKit((currentKit - 1 + DRUM_KITS.length) % DRUM_KITS.length);
                        break;
                    case 9: // Start - Next kit
                        selectKit((currentKit + 1) % DRUM_KITS.length);
                        break;
                    case 12: // DPad Up - Accent hit (crash)
                        playSound('crash', 127);
                        break;
                    case 13: // DPad Down - Accent hit (kick)
                        playSound('kick', 127);
                        break;
                    case 14: // DPad Left - Tempo down big
                        adjustTempo(-10);
                        break;
                    case 15: // DPad Right - Tempo up big
                        adjustTempo(10);
                        break;
                }
            }
        }

        function updateButtonVisual(index, active) {
            const mapping = {
                0: 'BtnA',
                1: 'BtnB',
                2: 'BtnX',
                3: 'BtnY',
                4: 'L1',
                5: 'R1',
                6: 'L2',
                7: 'R2',
                8: 'Select',
                9: 'Start',
                12: 'DPadUp',
                13: 'DPadDown',
                14: 'DPadLeft',
                15: 'DPadRight'
            };
            
            const elementId = mapping[index];
            if (elementId) {
                const el = document.getElementById(elementId);
                if (el) {
                    el.classList.toggle('active', active);
                }
            }
        }

        function updateJoystickVisual(id, x, y) {
            const el = document.getElementById(id);
            if (el) {
                const maxOffset = 15;
                el.style.transform = `translate(calc(-50% + ${x * maxOffset}px), calc(-50% + ${y * maxOffset}px))`;
            }
        }

        // ============================================
        // PLAYBACK FUNCTIONS
        // ============================================
        
        function togglePlay() {
            if (isPlaying) {
                stopPlayback();
            } else {
                startPlayback();
            }
        }

        function startPlayback() {
            if (currentMode !== 'auto') return;
            
            isPlaying = true;
            beatPosition = 0;
            document.getElementById('playBtn').textContent = '‚è∏';
            document.getElementById('playBtn').style.background = 'linear-gradient(145deg, #f1c40f, #f39c12)';
            
            playPattern();
        }

        function stopPlayback() {
            isPlaying = false;
            beatPosition = 0;
            document.getElementById('playBtn').textContent = '‚ñ∂';
            document.getElementById('playBtn').style.background = 'linear-gradient(145deg, #2ecc71, #27ae60)';
            
            if (patternTimeout) {
                clearTimeout(patternTimeout);
                patternTimeout = null;
            }
            
            showHit('Arr√™t√©', '');
        }

        function playPattern() {
            if (!isPlaying) return;
            
            const pattern = PATTERNS[currentPattern];
            const beatsPerMeasure = pattern.signature === '3/4' ? 1.5 : 2;
            const msPerBeat = (60000 / tempo);
            
            // Find all notes at current position
            const currentNotes = pattern.pattern.filter(p => 
                Math.abs(p.time - beatPosition) < 0.01
            );
            
            currentNotes.forEach(noteGroup => {
                noteGroup.sounds.forEach(sound => {
                    playSound(sound);
                });
            });
            
            // Find next note time
            let nextBeat = null;
            for (const p of pattern.pattern) {
                if (p.time > beatPosition + 0.01) {
                    nextBeat = p.time;
                    break;
                }
            }
            
            if (nextBeat === null) {
                // Loop back to start
                nextBeat = 0;
                beatPosition = -0.001; // Small offset to ensure first note plays
            }
            
            const delay = (nextBeat - beatPosition) * msPerBeat;
            beatPosition = nextBeat;
            
            patternTimeout = setTimeout(playPattern, delay);
        }

        function playFill(fillIndex) {
            const wasPlaying = isPlaying;
            const prevPattern = currentPattern;
            
            stopPlayback();
            currentPattern = fillIndex;
            
            // Play fill once
            const pattern = PATTERNS[fillIndex];
            const msPerBeat = (60000 / tempo);
            
            pattern.pattern.forEach(noteGroup => {
                setTimeout(() => {
                    noteGroup.sounds.forEach(sound => playSound(sound));
                }, noteGroup.time * msPerBeat);
            });
            
            // Return to previous pattern after fill
            setTimeout(() => {
                currentPattern = prevPattern;
                if (wasPlaying) {
                    startPlayback();
                }
            }, msPerBeat * 2);
        }

        // ============================================
        // SEMI-AUTO BEAT CLOCK
        // ============================================
        
        function startSemiAutoBeat() {
            if (semiAutoInterval) return;
            
            const ticksPerBeat = 4; // 16th notes
            let lastTick = performance.now();
            
            function semiAutoTick() {
                if (currentMode !== 'semi') {
                    stopSemiAutoBeat();
                    return;
                }
                
                const msPerTick = (60000 / tempo) / ticksPerBeat;
                const now = performance.now();
                
                if (now - lastTick >= msPerTick) {
                    lastTick = now;
                    beatClock = (beatClock + 1) % (ticksPerBeat * 4);
                    
                    // Play held buttons on the beat (every 4 ticks = quarter note)
                    // Or every 2 ticks for 8th notes on certain buttons
                    heldButtons.forEach(buttonIndex => {
                        const soundName = MANUAL_MAPPING[buttonIndex];
                        if (soundName) {
                            // Hi-hats play on 8th notes
                            const is8thNote = soundName.includes('hihat');
                            const shouldPlay = is8thNote ? 
                                (beatClock % 2 === 0) : 
                                (beatClock % 4 === 0);
                            
                            if (shouldPlay) {
                                playSound(soundName, 90);
                            }
                        }
                    });
                    
                    // Visual beat indicator
                    if (beatClock % 4 === 0) {
                        triggerVisualizer();
                    }
                }
                
                semiAutoInterval = requestAnimationFrame(semiAutoTick);
            }
            
            semiAutoTick();
            document.getElementById('playBtn').textContent = 'üîÑ';
            document.getElementById('playBtn').style.background = 'linear-gradient(145deg, #11998e, #38ef7d)';
        }
        
        function stopSemiAutoBeat() {
            if (semiAutoInterval) {
                cancelAnimationFrame(semiAutoInterval);
                semiAutoInterval = null;
            }
            heldButtons.clear();
            beatClock = 0;
            document.getElementById('playBtn').textContent = '‚ñ∂';
            document.getElementById('playBtn').style.background = 'linear-gradient(145deg, #2ecc71, #27ae60)';
        }

        // ============================================
        // UI FUNCTIONS
        // ============================================
        
        function setMode(mode) {
            currentMode = mode;
            
            // Update buttons
            document.querySelectorAll('.mode-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`.mode-btn.${mode}`).classList.add('active');
            
            // Show/hide sections
            document.getElementById('patternSection').classList.toggle('visible', mode === 'auto');
            document.getElementById('soundMapSection').classList.toggle('visible', mode === 'manual' || mode === 'semi');
            
            // Update footer
            const modeNames = { auto: 'Auto', semi: 'Semi-Auto', manual: 'Manuel' };
            document.getElementById('footerMode').textContent = modeNames[mode];
            
            // Stop any playback when switching modes
            stopPlayback();
            stopSemiAutoBeat();
            
            // Start semi-auto beat clock
            if (mode === 'semi') {
                startSemiAutoBeat();
            }
            
            // Update instructions
            updateInstructions();
        }

        function selectKit(index) {
            currentKit = index;
            const kit = DRUM_KITS[index];
            
            // Send bank select + program change
            sendProgramChange(kit);
            
            // Update UI
            document.querySelectorAll('.kit-btn').forEach((btn, i) => {
                btn.classList.toggle('active', i === index);
            });
            
            showHit(kit.name, `Voice ${kit.voice}`);
        }

        function selectPattern(index) {
            currentPattern = index;
            
            document.querySelectorAll('.pattern-btn').forEach((btn, i) => {
                btn.classList.toggle('playing', i === index && isPlaying);
            });
            
            showHit(PATTERNS[index].name, PATTERNS[index].signature);
            
            // Restart playback with new pattern if playing
            if (isPlaying) {
                stopPlayback();
                startPlayback();
            }
        }

        function adjustTempo(delta) {
            tempo = Math.max(60, Math.min(200, tempo + delta));
            document.getElementById('tempoValue').textContent = tempo;
            document.getElementById('tempoSlider').value = tempo;
        }

        function showHit(name, note) {
            document.getElementById('hitName').textContent = name;
            document.getElementById('hitNote').textContent = note;
        }

        function triggerVisualizer() {
            const bars = document.querySelectorAll('.viz-bar');
            bars.forEach(bar => {
                const height = Math.random() * 40 + 5;
                bar.style.height = height + 'px';
            });
            
            setTimeout(() => {
                bars.forEach(bar => {
                    bar.style.height = '5px';
                });
            }, 100);
        }

        function updateInstructions() {
            const list = document.getElementById('instructionsList');
            
            if (currentMode === 'auto') {
                list.innerHTML = `
                    <li><strong>A</strong> - Play / Pause</li>
                    <li><strong>B</strong> - Stop</li>
                    <li><strong>X/Y</strong> - Pattern pr√©c√©dent/suivant</li>
                    <li><strong>L1/R1</strong> - Tempo -/+ 5 BPM</li>
                    <li><strong>L2/R2</strong> - Fill 1 / Fill 2</li>
                    <li><strong>Select/Start</strong> - Kit pr√©c√©dent/suivant</li>
                    <li><strong>D-Pad ‚Üë‚Üì</strong> - Crash / Kick accent</li>
                    <li><strong>D-Pad ‚Üê‚Üí</strong> - Tempo -/+ 10 BPM</li>
                    <li><strong>Joystick G</strong> - Ajustement tempo</li>
                `;
            } else if (currentMode === 'semi') {
                list.innerHTML = `
                    <li><strong>üîÑ MAINTENIR = R√âP√âTER</strong> sur le beat!</li>
                    <li><strong>A</strong> - Kick (r√©p√®te en noires)</li>
                    <li><strong>B</strong> - Snare (r√©p√®te en noires)</li>
                    <li><strong>X</strong> - Hi-Hat Closed (r√©p√®te en croches!)</li>
                    <li><strong>Y</strong> - Hi-Hat Open (r√©p√®te en croches!)</li>
                    <li><strong>L1/R1</strong> - Tom Low / Tom Mid</li>
                    <li><strong>L2/R2</strong> - Crash / Ride</li>
                    <li><strong>Select/Start</strong> - Kit pr√©c√©dent/suivant</li>
                    <li><strong>Joystick G</strong> - Ajustement tempo</li>
                `;
            } else {
                list.innerHTML = `
                    <li><strong>A</strong> - Kick</li>
                    <li><strong>B</strong> - Snare</li>
                    <li><strong>X</strong> - Hi-Hat Closed</li>
                    <li><strong>Y</strong> - Hi-Hat Open</li>
                    <li><strong>L1/R1</strong> - Tom Low / Tom Mid</li>
                    <li><strong>L2/R2</strong> - Crash / Ride</li>
                    <li><strong>Select/Start</strong> - Clap / Cowbell</li>
                    <li><strong>D-Pad</strong> - Kick2, Snare2, Tambourine, Ride Bell</li>
                `;
            }
        }

        // ============================================
        // INITIALIZATION
        // ============================================
        
        function initUI() {
            // Kit selector
            const kitSelector = document.getElementById('kitSelector');
            DRUM_KITS.forEach((kit, i) => {
                const btn = document.createElement('button');
                btn.className = 'kit-btn' + (i === 0 ? ' active' : '');
                btn.innerHTML = `${kit.icon} ${kit.name}`;
                btn.onclick = () => selectKit(i);
                kitSelector.appendChild(btn);
            });
            
            // Pattern grid
            const patternGrid = document.getElementById('patternGrid');
            PATTERNS.forEach((pattern, i) => {
                const btn = document.createElement('button');
                btn.className = 'pattern-btn';
                btn.innerHTML = `
                    <div class="pattern-name">${pattern.icon} ${pattern.name}</div>
                    <div class="pattern-info">${pattern.signature}</div>
                `;
                btn.onclick = () => {
                    if (pattern.isFill) {
                        playFill(i);
                    } else {
                        selectPattern(i);
                        if (!isPlaying) togglePlay();
                    }
                };
                patternGrid.appendChild(btn);
            });
            
            // Sound map
            const soundGrid = document.getElementById('soundGrid');
            const buttonNames = {
                0: 'A', 1: 'B', 2: 'X', 3: 'Y',
                4: 'L1', 5: 'R1', 6: 'L2', 7: 'R2',
                8: 'Select', 9: 'Start',
                12: 'D‚Üë', 13: 'D‚Üì', 14: 'D‚Üê', 15: 'D‚Üí'
            };
            
            Object.entries(MANUAL_MAPPING).forEach(([btnIndex, soundName]) => {
                const item = document.createElement('div');
                item.className = 'sound-item';
                item.id = `sound-${btnIndex}`;
                item.innerHTML = `
                    <span class="sound-key">${buttonNames[btnIndex]}</span>
                    <span class="sound-name">${DRUM_SOUNDS[soundName].name}</span>
                `;
                soundGrid.appendChild(item);
            });
            
            // Visualizer bars
            const visualizer = document.getElementById('visualizer');
            for (let i = 0; i < 20; i++) {
                const bar = document.createElement('div');
                bar.className = 'viz-bar';
                bar.style.height = '5px';
                visualizer.appendChild(bar);
            }
            
            // Tempo slider
            document.getElementById('tempoSlider').addEventListener('input', (e) => {
                tempo = parseInt(e.target.value);
                document.getElementById('tempoValue').textContent = tempo;
            });
            
            // Initial instructions
            updateInstructions();
        }

        // Keyboard fallback for testing without gamepad
        const keyboardHeld = new Set();
        
        document.addEventListener('keydown', (e) => {
            if (e.repeat) return;
            
            const keyMap = {
                'a': 0, 's': 1, 'd': 2, 'w': 3,  // ABXY
                'q': 4, 'e': 5,                    // L1/R1
                'z': 6, 'c': 7,                    // L2/R2
                'Tab': 8, 'Enter': 9,              // Select/Start
                'ArrowUp': 12, 'ArrowDown': 13,
                'ArrowLeft': 14, 'ArrowRight': 15
            };
            
            if (keyMap.hasOwnProperty(e.key)) {
                e.preventDefault();
                const btnIndex = keyMap[e.key];
                
                handleButtonPress(btnIndex, 1);
                updateButtonVisual(btnIndex, true);
                keyboardHeld.add(btnIndex);
                
                // Semi-auto: track held keys
                if (currentMode === 'semi' && MANUAL_MAPPING[btnIndex]) {
                    heldButtons.add(btnIndex);
                    updateSoundGridHeld();
                }
            }
        });
        
        document.addEventListener('keyup', (e) => {
            const keyMap = {
                'a': 0, 's': 1, 'd': 2, 'w': 3,
                'q': 4, 'e': 5,
                'z': 6, 'c': 7,
                'Tab': 8, 'Enter': 9,
                'ArrowUp': 12, 'ArrowDown': 13,
                'ArrowLeft': 14, 'ArrowRight': 15
            };
            
            if (keyMap.hasOwnProperty(e.key)) {
                const btnIndex = keyMap[e.key];
                updateButtonVisual(btnIndex, false);
                keyboardHeld.delete(btnIndex);
                heldButtons.delete(btnIndex);
                updateSoundGridHeld();
            }
        });
        
        function updateSoundGridHeld() {
            document.querySelectorAll('.sound-item').forEach(item => {
                item.classList.remove('held');
            });
            heldButtons.forEach(btnIndex => {
                const el = document.getElementById(`sound-${btnIndex}`);
                if (el) el.classList.add('held');
            });
        }

        // Start everything
        initUI();
        initMIDI();
        initGamepad();
    </script>
</body>
</html>
