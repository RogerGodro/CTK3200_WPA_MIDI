<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Launchpad Drum Controller - CTK-3200</title>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;700;900&family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #00ffcc;
            --secondary: #ff00aa;
            --background: #0a0a0f;
            --surface: #1a1a24;
            --surface-bright: #252535;
            --text: #e0e0e8;
            --text-dim: #8888a0;
            --border: #2a2a3a;
            --success: #00ff88;
            --warning: #ffaa00;
            --danger: #ff3366;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #0a0a0f 0%, #1a1a2e 100%);
            color: var(--text);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            margin-bottom: 40px;
            animation: fadeIn 0.8s ease-out;
        }

        h1 {
            font-family: 'Orbitron', monospace;
            font-size: 2.5rem;
            font-weight: 900;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-transform: uppercase;
            letter-spacing: 4px;
            margin-bottom: 10px;
        }

        .subtitle {
            font-size: 0.9rem;
            color: var(--text-dim);
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        .control-panel {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
            animation: slideUp 0.6s ease-out;
        }

        .status-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .status-card {
            background: var(--surface-bright);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 20px;
            position: relative;
            overflow: hidden;
        }

        .status-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
            background: var(--primary);
            opacity: 0;
            transition: opacity 0.3s;
        }

        .status-card.connected::before {
            opacity: 1;
        }

        .status-label {
            font-size: 0.75rem;
            color: var(--text-dim);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 8px;
        }

        .status-value {
            font-family: 'Orbitron', monospace;
            font-size: 1.1rem;
            color: var(--text);
            font-weight: 600;
        }

        .controls-row {
            display: flex;
            gap: 20px;
            align-items: center;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }

        .control-group {
            flex: 1;
            min-width: 250px;
        }

        label {
            display: block;
            font-size: 0.85rem;
            color: var(--text-dim);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 8px;
        }

        select, input[type="number"] {
            width: 100%;
            padding: 12px 16px;
            background: var(--surface-bright);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text);
            font-family: 'Inter', sans-serif;
            font-size: 1rem;
            transition: all 0.3s;
        }

        select:focus, input[type="number"]:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(0, 255, 204, 0.1);
        }

        select:hover, input[type="number"]:hover {
            border-color: var(--primary);
        }

        .tempo-control {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .tempo-control input {
            flex: 1;
        }

        .tempo-display {
            font-family: 'Orbitron', monospace;
            font-size: 2rem;
            font-weight: 700;
            color: var(--primary);
            min-width: 100px;
            text-align: center;
        }

        .btn {
            padding: 12px 24px;
            background: linear-gradient(135deg, var(--primary), #00ddaa);
            color: var(--background);
            border: none;
            border-radius: 8px;
            font-family: 'Orbitron', monospace;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 12px rgba(0, 255, 204, 0.3);
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 255, 204, 0.4);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn.secondary {
            background: linear-gradient(135deg, var(--secondary), #dd0088);
            box-shadow: 0 4px 12px rgba(255, 0, 170, 0.3);
        }

        .btn.secondary:hover {
            box-shadow: 0 6px 20px rgba(255, 0, 170, 0.4);
        }

        .launchpad-grid {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 30px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
            animation: slideUp 0.8s ease-out;
        }

        .grid-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .grid-title {
            font-family: 'Orbitron', monospace;
            font-size: 1.3rem;
            font-weight: 700;
            color: var(--primary);
        }

        .user-mode {
            display: flex;
            gap: 10px;
        }

        .user-btn {
            padding: 8px 20px;
            background: var(--surface-bright);
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--text-dim);
            font-family: 'Orbitron', monospace;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .user-btn.active {
            background: var(--primary);
            color: var(--background);
            border-color: var(--primary);
        }

        .pad-grid {
            display: grid;
            grid-template-columns: repeat(8, 1fr);
            gap: 8px;
            margin-bottom: 20px;
        }

        .pad {
            aspect-ratio: 1;
            border: 2px solid var(--border);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
            overflow: hidden;
        }

        .pad::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            transform: translate(-50%, -50%);
            transition: all 0.4s;
        }

        .pad:active::before {
            width: 100%;
            height: 100%;
        }

        .pad:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 16px rgba(0, 255, 204, 0.3);
        }

        .pad.intro { background: #0066ff; border-color: #0066ff; }
        .pad.main { background: #00aaff; border-color: #00aaff; }
        .pad.variation { background: #ff3366; border-color: #ff3366; }
        .pad.outro { background: #ff6633; border-color: #ff6633; }
        .pad.inactive { background: #ffaa00; border-color: #ffaa00; opacity: 0.6; }
        .pad.off { background: var(--surface-bright); border-color: var(--border); }
        
        .pad.active {
            box-shadow: 0 0 20px currentColor;
            animation: pulse 1s infinite;
        }

        .right-column {
            display: grid;
            grid-template-rows: repeat(8, 1fr);
            gap: 8px;
        }

        .side-btn {
            aspect-ratio: 1;
            border: 2px solid var(--border);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
            font-weight: 600;
            text-align: center;
            padding: 4px;
        }

        .side-btn:hover {
            transform: scale(1.05);
        }

        .side-btn.drumset {
            background: var(--surface-bright);
            color: var(--text-dim);
        }

        .side-btn.drumset.active {
            background: var(--success);
            color: var(--background);
            box-shadow: 0 0 20px var(--success);
        }

        .side-btn.stop {
            background: var(--danger);
            color: white;
        }

        .side-btn.pause {
            background: var(--warning);
            color: var(--background);
        }

        .bottom-row {
            display: grid;
            grid-template-columns: repeat(8, 1fr);
            gap: 8px;
            margin-top: 8px;
        }

        .bottom-btn {
            aspect-ratio: 1;
            border: 2px solid var(--border);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--surface-bright);
            color: var(--text-dim);
            font-size: 1.2rem;
        }

        .bottom-btn:hover {
            transform: scale(1.05);
            background: var(--primary);
            color: var(--background);
        }

        .group-label {
            position: absolute;
            bottom: 4px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 0.6rem;
            font-weight: 600;
            color: rgba(255, 255, 255, 0.8);
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.8);
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideUp {
            from { 
                opacity: 0;
                transform: translateY(20px);
            }
            to { 
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        .info-panel {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 20px;
            margin-top: 20px;
            font-size: 0.85rem;
            color: var(--text-dim);
        }

        .info-panel h3 {
            color: var(--primary);
            font-family: 'Orbitron', monospace;
            margin-bottom: 10px;
        }

        .legend {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            margin-top: 15px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .legend-color {
            width: 24px;
            height: 24px;
            border-radius: 4px;
            border: 2px solid var(--border);
        }

        @media (max-width: 768px) {
            h1 { font-size: 1.8rem; }
            .pad-grid { gap: 4px; }
            .control-panel { padding: 20px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Launchpad Drum Controller</h1>
            <p class="subtitle">CTK-3200 Rhythm System</p>
        </header>

        <div class="control-panel">
            <div class="status-grid">
                <div class="status-card" id="launchpadStatus">
                    <div class="status-label">Launchpad MK2</div>
                    <div class="status-value">Déconnecté</div>
                </div>
                <div class="status-card" id="ctkStatus">
                    <div class="status-label">CTK-3200</div>
                    <div class="status-value">Déconnecté</div>
                </div>
                <div class="status-card">
                    <div class="status-label">Drum Set Actuel</div>
                    <div class="status-value" id="currentDrumset">STANDARD</div>
                </div>
                <div class="status-card">
                    <div class="status-label">État</div>
                    <div class="status-value" id="playbackState">Arrêté</div>
                </div>
            </div>

            <div class="controls-row">
                <div class="control-group">
                    <label for="rhythmSelect">Sélectionner un groupe de rythme</label>
                    <select id="rhythmSelect">
                        <option value="">-- Choisir --</option>
                    </select>
                </div>

                <div class="control-group">
                    <label for="tempoInput">Tempo (BPM)</label>
                    <div class="tempo-control">
                        <input type="number" id="tempoInput" min="40" max="240" value="120">
                        <div class="tempo-display" id="tempoDisplay">120</div>
                    </div>
                </div>
            </div>

            <div class="controls-row">
                <button class="btn" onclick="connectDevices()">Connecter les appareils</button>
                <button class="btn secondary" onclick="stopAllRhythms()">Arrêter tout</button>
            </div>
        </div>

        <div class="launchpad-grid">
            <div class="grid-header">
                <div class="grid-title">Contrôleur de pads</div>
                <div class="user-mode">
                    <button class="user-btn active" onclick="switchUserMode(1)">USER 1</button>
                    <button class="user-btn" onclick="switchUserMode(2)">USER 2</button>
                </div>
            </div>

            <div style="display: flex; gap: 8px;">
                <div class="pad-grid" id="padGrid"></div>
                <div class="right-column" id="rightColumn"></div>
            </div>

            <div class="bottom-row" id="bottomRow"></div>
        </div>

        <div class="info-panel">
            <h3>Légende des pads</h3>
            <div class="legend">
                <div class="legend-item">
                    <div class="legend-color intro"></div>
                    <span>Intro (16 temps)</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color main"></div>
                    <span>Corps (loop)</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color variation"></div>
                    <span>Variation (loop)</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color outro"></div>
                    <span>Outro (8 temps)</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color inactive"></div>
                    <span>Inactif (autre groupe joue)</span>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Configuration
        const DRUM_SETS = [
            { id: 0, name: 'STANDARD', program: 0 },
            { id: 1, name: 'ROOM', program: 8 },
            { id: 2, name: 'POWER', program: 16 },
            { id: 3, name: 'SYNTH', program: 17 },
            { id: 4, name: 'BRUSH', program: 40 },
            { id: 5, name: 'ORCHESTRA', program: 48 }
        ];

        const RHYTHM_GROUPS = [
            // USER 1 (16 groupes)
            { id: 0, name: 'Rock Standard', user: 1 },
            { id: 1, name: 'Pop Groove', user: 1 },
            { id: 2, name: 'Ballad Soft', user: 1 },
            { id: 3, name: 'Funk Drive', user: 1 },
            { id: 4, name: 'Blues Shuffle', user: 1 },
            { id: 5, name: 'Jazz Swing', user: 1 },
            { id: 6, name: 'Latin Fire', user: 1 },
            { id: 7, name: 'Reggae One', user: 1 },
            { id: 8, name: 'Country Beat', user: 1 },
            { id: 9, name: 'Soul Pocket', user: 1 },
            { id: 10, name: 'Disco Fever', user: 1 },
            { id: 11, name: 'R&B Smooth', user: 1 },
            { id: 12, name: 'Gospel Spirit', user: 1 },
            { id: 13, name: 'Metal Blast', user: 1 },
            { id: 14, name: 'Punk Energy', user: 1 },
            { id: 15, name: 'Indie Alt', user: 1 },
            // USER 2 (16 groupes)
            { id: 16, name: 'Electronic House', user: 2 },
            { id: 17, name: 'Techno Pulse', user: 2 },
            { id: 18, name: 'Dubstep Drop', user: 2 },
            { id: 19, name: 'Trap 808', user: 2 },
            { id: 20, name: 'Hip Hop Boom', user: 2 },
            { id: 21, name: 'Breakbeat', user: 2 },
            { id: 22, name: 'Drum n Bass', user: 2 },
            { id: 23, name: 'Ambient Chill', user: 2 },
            { id: 24, name: 'World Percussion', user: 2 },
            { id: 25, name: 'Afrobeat', user: 2 },
            { id: 26, name: 'Bossa Nova', user: 2 },
            { id: 27, name: 'Samba Heat', user: 2 },
            { id: 28, name: 'Flamenco Fire', user: 2 },
            { id: 29, name: 'Middle Eastern', user: 2 },
            { id: 30, name: 'Industrial', user: 2 },
            { id: 31, name: 'Experimental', user: 2 }
        ];

        // État global
        let midiInputLaunchpad = null;
        let midiOutputLaunchpad = null;
        let midiOutputCTK = null;
        let currentUserMode = 1;
        let currentDrumset = 0;
        let tempo = 120;
        let isPlaying = false;
        let isPaused = false;
        let activeGroup = null;
        let activeSection = null; // 'intro', 'main', 'variation', 'outro'
        let beatPosition = 0;
        let intervalId = null;

        // Patterns de rythmes (notes MIDI pour chaque drum)
        const DRUM_PATTERNS = {
            intro: {
                kick: [0, 4, 8, 12],
                snare: [4, 12],
                hihat: [0, 2, 4, 6, 8, 10, 12, 14],
                length: 16
            },
            main: {
                kick: [0, 6, 8, 14],
                snare: [4, 12],
                hihat: [0, 2, 4, 6, 8, 10, 12, 14],
                length: 16
            },
            variation: {
                kick: [0, 3, 6, 8, 11, 14],
                snare: [4, 10, 12],
                hihat: [0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15],
                length: 16
            },
            outro: {
                kick: [0, 4],
                snare: [2, 6],
                hihat: [0, 1, 2, 3, 4, 5, 6, 7],
                length: 8
            }
        };

        // Notes MIDI (General MIDI Drum Map)
        const DRUM_NOTES = {
            kick: 36,    // Bass Drum 1
            snare: 38,   // Acoustic Snare
            hihat: 42,   // Closed Hi-Hat
            crash: 49    // Crash Cymbal 1
        };

        // Initialisation
        function init() {
            populateRhythmSelect();
            createPadGrid();
            createRightColumn();
            createBottomRow();
            updateTempo(120);
            
            document.getElementById('tempoInput').addEventListener('input', (e) => {
                updateTempo(parseInt(e.target.value));
            });

            document.getElementById('rhythmSelect').addEventListener('change', (e) => {
                if (e.target.value !== '') {
                    highlightGroup(parseInt(e.target.value));
                }
            });
        }

        function populateRhythmSelect() {
            const select = document.getElementById('rhythmSelect');
            RHYTHM_GROUPS.forEach(group => {
                const option = document.createElement('option');
                option.value = group.id;
                option.textContent = `${group.name} (USER ${group.user})`;
                select.appendChild(option);
            });
        }

        function createPadGrid() {
            const grid = document.getElementById('padGrid');
            grid.innerHTML = '';
            
            for (let row = 0; row < 8; row++) {
                for (let col = 0; col < 8; col++) {
                    const pad = document.createElement('div');
                    pad.className = 'pad off';
                    pad.dataset.row = row;
                    pad.dataset.col = col;
                    pad.addEventListener('click', () => handlePadClick(row, col));
                    
                    // Ajouter le label du groupe
                    if (col % 4 === 0) {
                        const groupIndex = row * 2 + Math.floor(col / 4);
                        const actualGroupId = currentUserMode === 1 ? groupIndex : groupIndex + 16;
                        if (actualGroupId < RHYTHM_GROUPS.length) {
                            const label = document.createElement('div');
                            label.className = 'group-label';
                            label.textContent = `G${actualGroupId + 1}`;
                            pad.appendChild(label);
                        }
                    }
                    
                    grid.appendChild(pad);
                }
            }
            
            updatePadColors();
        }

        function createRightColumn() {
            const column = document.getElementById('rightColumn');
            column.innerHTML = '';
            
            // 6 boutons pour les drum sets
            DRUM_SETS.forEach((drumset, index) => {
                const btn = document.createElement('div');
                btn.className = 'side-btn drumset';
                if (index === currentDrumset) btn.classList.add('active');
                btn.textContent = drumset.name;
                btn.addEventListener('click', () => selectDrumset(index));
                column.appendChild(btn);
            });
            
            // Bouton Stop
            const stopBtn = document.createElement('div');
            stopBtn.className = 'side-btn stop';
            stopBtn.textContent = 'STOP';
            stopBtn.addEventListener('click', stopAllRhythms);
            column.appendChild(stopBtn);
            
            // Bouton Pause
            const pauseBtn = document.createElement('div');
            pauseBtn.className = 'side-btn pause';
            pauseBtn.textContent = 'PAUSE';
            pauseBtn.addEventListener('click', togglePause);
            column.appendChild(pauseBtn);
        }

        function createBottomRow() {
            const row = document.getElementById('bottomRow');
            row.innerHTML = '';
            
            // 8 boutons: 6 vides + tempo- + tempo+
            for (let i = 0; i < 6; i++) {
                const btn = document.createElement('div');
                btn.className = 'bottom-btn';
                row.appendChild(btn);
            }
            
            // Tempo -
            const tempoDown = document.createElement('div');
            tempoDown.className = 'bottom-btn';
            tempoDown.textContent = '▼';
            tempoDown.addEventListener('click', () => adjustTempo(-5));
            row.appendChild(tempoDown);
            
            // Tempo +
            const tempoUp = document.createElement('div');
            tempoUp.className = 'bottom-btn';
            tempoUp.textContent = '▲';
            tempoUp.addEventListener('click', () => adjustTempo(5));
            row.appendChild(tempoUp);
        }

        function updatePadColors() {
            const pads = document.querySelectorAll('.pad');
            pads.forEach(pad => {
                const row = parseInt(pad.dataset.row);
                const col = parseInt(pad.dataset.col);
                const groupIndex = row * 2 + Math.floor(col / 4);
                const actualGroupId = currentUserMode === 1 ? groupIndex : groupIndex + 16;
                const padType = col % 4;
                
                pad.classList.remove('intro', 'main', 'variation', 'outro', 'inactive', 'active', 'off');
                
                if (actualGroupId >= RHYTHM_GROUPS.length) {
                    pad.classList.add('off');
                    return;
                }
                
                if (activeGroup !== null && activeGroup !== actualGroupId) {
                    pad.classList.add('inactive');
                } else {
                    switch (padType) {
                        case 0: pad.classList.add('intro'); break;
                        case 1: pad.classList.add('main'); break;
                        case 2: pad.classList.add('variation'); break;
                        case 3: pad.classList.add('outro'); break;
                    }
                }
                
                // Marquer le pad actif
                if (activeGroup === actualGroupId) {
                    const sectionMap = ['intro', 'main', 'variation', 'outro'];
                    if (sectionMap[padType] === activeSection) {
                        pad.classList.add('active');
                    }
                }
            });
        }

        function handlePadClick(row, col) {
            const groupIndex = row * 2 + Math.floor(col / 4);
            const actualGroupId = currentUserMode === 1 ? groupIndex : groupIndex + 16;
            const padType = col % 4;
            const sections = ['intro', 'main', 'variation', 'outro'];
            
            if (actualGroupId >= RHYTHM_GROUPS.length) return;
            
            playSection(actualGroupId, sections[padType]);
        }

        function playSection(groupId, section) {
            stopPlayback();
            
            activeGroup = groupId;
            activeSection = section;
            beatPosition = 0;
            isPlaying = true;
            isPaused = false;
            
            updatePadColors();
            updatePlaybackState();
            
            startPlayback();
        }

        function startPlayback() {
            if (!midiOutputCTK) return;
            
            const pattern = DRUM_PATTERNS[activeSection];
            const beatDuration = (60 / tempo) * 1000 / 4; // Durée d'un 16ème de note en ms
            
            intervalId = setInterval(() => {
                if (isPaused) return;
                
                playBeat(beatPosition, pattern);
                beatPosition++;
                
                // Vérifier si on doit passer à la section suivante
                if (beatPosition >= pattern.length) {
                    beatPosition = 0;
                    
                    if (activeSection === 'intro') {
                        // Passer automatiquement au corps
                        activeSection = 'main';
                        updatePadColors();
                    } else if (activeSection === 'outro') {
                        // Arrêter après l'outro
                        stopAllRhythms();
                    }
                    // Les sections main et variation loopent
                }
            }, beatDuration);
        }

        function playBeat(position, pattern) {
            if (!midiOutputCTK) return;
            
            const channel = 9; // Canal 10 (0-indexed) pour les drums
            
            // Jouer les notes actives à cette position
            Object.keys(DRUM_NOTES).forEach(drumName => {
                if (pattern[drumName] && pattern[drumName].includes(position)) {
                    const note = DRUM_NOTES[drumName];
                    const velocity = 100;
                    
                    // Note ON
                    midiOutputCTK.send([0x90 + channel, note, velocity]);
                    
                    // Note OFF après 50ms
                    setTimeout(() => {
                        midiOutputCTK.send([0x80 + channel, note, 0]);
                    }, 50);
                }
            });
        }

        function stopPlayback() {
            if (intervalId) {
                clearInterval(intervalId);
                intervalId = null;
            }
        }

        function stopAllRhythms() {
            stopPlayback();
            
            activeGroup = null;
            activeSection = null;
            beatPosition = 0;
            isPlaying = false;
            isPaused = false;
            
            // Envoyer All Notes Off
            if (midiOutputCTK) {
                midiOutputCTK.send([0xB9, 123, 0]); // All Notes Off sur canal 10
            }
            
            updatePadColors();
            updatePlaybackState();
        }

        function togglePause() {
            if (!isPlaying) return;
            
            isPaused = !isPaused;
            updatePlaybackState();
        }

        function selectDrumset(index) {
            currentDrumset = index;
            
            if (midiOutputCTK) {
                // Envoyer Program Change sur canal 10 (drums)
                const channel = 9;
                midiOutputCTK.send([0xC0 + channel, DRUM_SETS[index].program]);
            }
            
            document.getElementById('currentDrumset').textContent = DRUM_SETS[index].name;
            
            // Mettre à jour les boutons
            document.querySelectorAll('.side-btn.drumset').forEach((btn, i) => {
                btn.classList.toggle('active', i === index);
            });
        }

        function switchUserMode(mode) {
            if (currentUserMode === mode) return;
            
            currentUserMode = mode;
            
            // Mettre à jour les boutons
            document.querySelectorAll('.user-btn').forEach((btn, i) => {
                btn.classList.toggle('active', i + 1 === mode);
            });
            
            createPadGrid();
        }

        function highlightGroup(groupId) {
            const group = RHYTHM_GROUPS.find(g => g.id === groupId);
            if (!group) return;
            
            // Changer de mode USER si nécessaire
            if (group.user !== currentUserMode) {
                switchUserMode(group.user);
            }
            
            // Trouver et mettre en évidence les pads du groupe
            setTimeout(() => {
                const pads = document.querySelectorAll('.pad');
                pads.forEach(pad => {
                    const row = parseInt(pad.dataset.row);
                    const col = parseInt(pad.dataset.col);
                    const groupIndex = row * 2 + Math.floor(col / 4);
                    const actualGroupId = group.user === 1 ? groupIndex : groupIndex + 16;
                    
                    if (actualGroupId === groupId) {
                        pad.style.animation = 'pulse 0.5s ease-in-out 3';
                        setTimeout(() => {
                            pad.style.animation = '';
                        }, 1500);
                    }
                });
            }, 100);
        }

        function updateTempo(newTempo) {
            tempo = Math.max(40, Math.min(240, newTempo));
            document.getElementById('tempoInput').value = tempo;
            document.getElementById('tempoDisplay').textContent = tempo;
            
            // Redémarrer le playback si en cours
            if (isPlaying && !isPaused) {
                stopPlayback();
                startPlayback();
            }
        }

        function adjustTempo(delta) {
            updateTempo(tempo + delta);
        }

        function updatePlaybackState() {
            const stateText = isPaused ? 'En pause' : (isPlaying ? 'Lecture' : 'Arrêté');
            document.getElementById('playbackState').textContent = stateText;
        }

        // Connexion MIDI
        async function connectDevices() {
            if (!navigator.requestMIDIAccess) {
                alert('Web MIDI API non supportée par ce navigateur');
                return;
            }

            try {
                const midiAccess = await navigator.requestMIDIAccess();
                
                // Trouver le Launchpad
                for (let input of midiAccess.inputs.values()) {
                    if (input.name.includes('Launchpad')) {
                        midiInputLaunchpad = input;
                        midiInputLaunchpad.onmidimessage = handleLaunchpadMessage;
                        document.getElementById('launchpadStatus').classList.add('connected');
                        document.querySelector('#launchpadStatus .status-value').textContent = 'Connecté';
                    }
                }
                
                for (let output of midiAccess.outputs.values()) {
                    if (output.name.includes('Launchpad')) {
                        midiOutputLaunchpad = output;
                        initializeLaunchpad();
                    }
                    if (output.name.includes('CTK') || output.name.includes('Casio')) {
                        midiOutputCTK = output;
                        document.getElementById('ctkStatus').classList.add('connected');
                        document.querySelector('#ctkStatus .status-value').textContent = 'Connecté';
                        selectDrumset(0); // Initialiser avec STANDARD SET
                    }
                }
                
                if (!midiInputLaunchpad || !midiOutputLaunchpad) {
                    alert('Launchpad MK2 non trouvé');
                }
                if (!midiOutputCTK) {
                    alert('CTK-3200 non trouvé');
                }
            } catch (error) {
                console.error('Erreur de connexion MIDI:', error);
                alert('Erreur lors de la connexion MIDI: ' + error.message);
            }
        }

        function initializeLaunchpad() {
            if (!midiOutputLaunchpad) return;
            
            // Mettre le Launchpad en mode programmeur
            midiOutputLaunchpad.send([0xF0, 0x00, 0x20, 0x29, 0x02, 0x18, 0x0E, 0x01, 0xF7]);
            
            // Synchroniser les couleurs
            syncLaunchpadColors();
        }

        function syncLaunchpadColors() {
            // À implémenter: envoyer les couleurs au Launchpad MK2
            // Utiliser les messages SysEx appropriés pour le MK2
        }

        function handleLaunchpadMessage(message) {
            const [status, note, velocity] = message.data;
            
            if (velocity === 0) return; // Ignorer les note off
            
            // Mapper les messages MIDI du Launchpad aux fonctions
            if (status === 0x90) { // Note On
                const row = Math.floor(note / 10);
                const col = note % 10;
                
                if (row < 8 && col < 8) {
                    handlePadClick(row, col);
                }
            }
        }

        // Initialiser au chargement
        window.addEventListener('load', init);
    </script>
</body>
</html>