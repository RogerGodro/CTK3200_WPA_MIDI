<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Launchpad Drum Controller - CTK-3200</title>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;700;900&family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #00ffcc;
            --secondary: #ff00aa;
            --background: #0a0a0f;
            --surface: #1a1a24;
            --surface-bright: #252535;
            --text: #e0e0e8;
            --text-dim: #8888a0;
            --border: #2a2a3a;
            --success: #00ff88;
            --warning: #ffaa00;
            --danger: #ff3366;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #0a0a0f 0%, #1a1a2e 100%);
            color: var(--text);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            margin-bottom: 40px;
            animation: fadeIn 0.8s ease-out;
        }

        h1 {
            font-family: 'Orbitron', monospace;
            font-size: 2.5rem;
            font-weight: 900;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-transform: uppercase;
            letter-spacing: 4px;
            margin-bottom: 10px;
        }

        .subtitle {
            font-size: 0.9rem;
            color: var(--text-dim);
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        .control-panel {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
            animation: slideUp 0.6s ease-out;
        }

        .status-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .status-card {
            background: var(--surface-bright);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 20px;
            position: relative;
            overflow: hidden;
        }

        .status-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
            background: var(--primary);
            opacity: 0;
            transition: opacity 0.3s;
        }

        .status-card.connected::before {
            opacity: 1;
        }

        .status-label {
            font-size: 0.75rem;
            color: var(--text-dim);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 8px;
        }

        .status-value {
            font-family: 'Orbitron', monospace;
            font-size: 1.1rem;
            color: var(--text);
            font-weight: 600;
        }

        .controls-row {
            display: flex;
            gap: 20px;
            align-items: center;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }

        .control-group {
            flex: 1;
            min-width: 250px;
        }

        label {
            display: block;
            font-size: 0.85rem;
            color: var(--text-dim);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 8px;
        }

        select, input[type="number"] {
            width: 100%;
            padding: 12px 16px;
            background: var(--surface-bright);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text);
            font-family: 'Inter', sans-serif;
            font-size: 1rem;
            transition: all 0.3s;
        }

        select:focus, input[type="number"]:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(0, 255, 204, 0.1);
        }

        select:hover, input[type="number"]:hover {
            border-color: var(--primary);
        }

        .tempo-control {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .tempo-control input {
            flex: 1;
        }

        .tempo-display {
            font-family: 'Orbitron', monospace;
            font-size: 2rem;
            font-weight: 700;
            color: var(--primary);
            min-width: 100px;
            text-align: center;
            transition: all 0.2s ease;
        }

        .btn {
            padding: 12px 24px;
            background: linear-gradient(135deg, var(--primary), #00ddaa);
            color: var(--background);
            border: none;
            border-radius: 8px;
            font-family: 'Orbitron', monospace;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 12px rgba(0, 255, 204, 0.3);
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 255, 204, 0.4);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn.secondary {
            background: linear-gradient(135deg, var(--secondary), #dd0088);
            box-shadow: 0 4px 12px rgba(255, 0, 170, 0.3);
        }

        .btn.secondary:hover {
            box-shadow: 0 6px 20px rgba(255, 0, 170, 0.4);
        }

        .launchpad-grid {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 30px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
            animation: slideUp 0.8s ease-out;
        }

        .grid-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .grid-title {
            font-family: 'Orbitron', monospace;
            font-size: 1.3rem;
            font-weight: 700;
            color: var(--primary);
        }

        .user-mode {
            display: flex;
            gap: 10px;
        }

        .user-btn {
            padding: 8px 20px;
            background: var(--surface-bright);
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--text-dim);
            font-family: 'Orbitron', monospace;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .user-btn.active {
            background: var(--primary);
            color: var(--background);
            border-color: var(--primary);
        }

        .pad-grid {
            display: grid;
            grid-template-columns: repeat(8, 1fr);
            gap: 8px;
            margin-bottom: 20px;
        }

        .pad {
            aspect-ratio: 1;
            border: 2px solid var(--border);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
            overflow: hidden;
        }

        .pad::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            transform: translate(-50%, -50%);
            transition: all 0.4s;
        }

        .pad:active::before {
            width: 100%;
            height: 100%;
        }

        .pad:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 16px rgba(0, 255, 204, 0.3);
        }

        .pad.intro { background: #0066ff; border-color: #0066ff; }
        .pad.main { background: #00aaff; border-color: #00aaff; }
        .pad.variation { background: #ff3366; border-color: #ff3366; }
        .pad.outro { background: #ff6633; border-color: #ff6633; }
        .pad.inactive { background: #ffaa00; border-color: #ffaa00; opacity: 0.6; }
        .pad.off { background: var(--surface-bright); border-color: var(--border); }
        
        .pad.active {
            box-shadow: 0 0 20px currentColor;
            animation: pulse 1s infinite;
        }

        .right-column {
            display: grid;
            grid-template-rows: repeat(8, 1fr);
            gap: 8px;
        }

        .side-btn {
            aspect-ratio: 1;
            border: 2px solid var(--border);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
            font-weight: 600;
            text-align: center;
            padding: 4px;
        }

        .side-btn:hover {
            transform: scale(1.05);
        }

        .side-btn.drumset {
            background: var(--surface-bright);
            color: var(--text-dim);
        }

        .side-btn.drumset.active {
            background: var(--success);
            color: var(--background);
            box-shadow: 0 0 20px var(--success);
        }

        .side-btn.stop {
            background: var(--danger);
            color: white;
        }

        .side-btn.pause {
            background: var(--warning);
            color: var(--background);
        }

        .bottom-row {
            display: grid;
            grid-template-columns: repeat(8, 1fr);
            gap: 8px;
            margin-top: 8px;
        }

        .bottom-btn {
            aspect-ratio: 1;
            border: 2px solid var(--border);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--surface-bright);
            color: var(--text-dim);
            font-size: 1.2rem;
        }

        .bottom-btn:hover {
            transform: scale(1.05);
            background: var(--primary);
            color: var(--background);
        }

        .group-label {
            position: absolute;
            bottom: 4px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 0.6rem;
            font-weight: 600;
            color: rgba(255, 255, 255, 0.8);
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.8);
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideUp {
            from { 
                opacity: 0;
                transform: translateY(20px);
            }
            to { 
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        .info-panel {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 20px;
            margin-top: 20px;
            font-size: 0.85rem;
            color: var(--text-dim);
        }

        .info-panel h3 {
            color: var(--primary);
            font-family: 'Orbitron', monospace;
            margin-bottom: 10px;
        }

        .legend {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            margin-top: 15px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .legend-color {
            width: 24px;
            height: 24px;
            border-radius: 4px;
            border: 2px solid var(--border);
        }

        @media (max-width: 768px) {
            h1 { font-size: 1.8rem; }
            .pad-grid { gap: 4px; }
            .control-panel { padding: 20px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Launchpad Drum Controller</h1>
            <p class="subtitle">CTK-3200 Rhythm System</p>
        </header>

        <div class="control-panel">
            <div class="status-grid">
                <div class="status-card" id="launchpadStatus">
                    <div class="status-label">Launchpad MK2</div>
                    <div class="status-value">D√©connect√©</div>
                </div>
                <div class="status-card" id="ctkStatus">
                    <div class="status-label">CTK-3200</div>
                    <div class="status-value">D√©connect√©</div>
                </div>
                <div class="status-card">
                    <div class="status-label">Drum Set Actuel</div>
                    <div class="status-value" id="currentDrumset">STANDARD</div>
                    <div style="font-size: 0.7rem; color: var(--text-dim); margin-top: 5px;" id="currentDrumsetProgram">Program 0</div>
                </div>
                <div class="status-card">
                    <div class="status-label">√âtat</div>
                    <div class="status-value" id="playbackState">Arr√™t√©</div>
                </div>
            </div>

            <div class="controls-row">
                <div class="control-group">
                    <label for="rhythmSelect">S√©lectionner un groupe de rythme</label>
                    <select id="rhythmSelect">
                        <option value="">-- Choisir --</option>
                    </select>
                </div>

                <div class="control-group">
                    <label for="tempoInput">Tempo (BPM)</label>
                    <div class="tempo-control">
                        <input type="number" id="tempoInput" min="40" max="240" value="120">
                        <div class="tempo-display" id="tempoDisplay">120</div>
                    </div>
                </div>
            </div>

            <div class="controls-row">
                <button class="btn" onclick="connectDevices()">Connecter les appareils</button>
                <button class="btn secondary" onclick="stopAllRhythms()">Arr√™ter tout</button>
                <button class="btn secondary" onclick="togglePause()">Pause/Resume</button>
            </div>

            <div class="controls-row" style="margin-top: 10px;">
                <div style="font-size: 0.85rem; color: var(--text-dim); width: 100%;">
                    <strong>Test rapide des drum sets:</strong> Cliquez sur les boutons ci-dessous pour tester
                </div>
            </div>
            <div class="controls-row" style="flex-wrap: wrap; gap: 10px;">
                <button class="btn" style="padding: 8px 16px; font-size: 0.9rem;" onclick="selectDrumset(0)">DS0: STANDARD</button>
                <button class="btn" style="padding: 8px 16px; font-size: 0.9rem;" onclick="selectDrumset(1)">DS1: ROOM</button>
                <button class="btn" style="padding: 8px 16px; font-size: 0.9rem;" onclick="selectDrumset(2)">DS2: POWER</button>
                <button class="btn" style="padding: 8px 16px; font-size: 0.9rem;" onclick="selectDrumset(3)">DS3: SYNTH</button>
                <button class="btn" style="padding: 8px 16px; font-size: 0.9rem;" onclick="selectDrumset(4)">DS4: BRUSH</button>
                <button class="btn" style="padding: 8px 16px; font-size: 0.9rem;" onclick="selectDrumset(5)">DS5: ORCHESTRA</button>
            </div>
        </div>

        <div class="launchpad-grid">
            <div class="grid-header">
                <div class="grid-title">Contr√¥leur de pads</div>
                <div class="user-mode">
                    <button class="user-btn active" onclick="switchUserMode(1)">USER 1</button>
                    <button class="user-btn" onclick="switchUserMode(2)">USER 2</button>
                </div>
            </div>

            <div style="display: flex; gap: 8px;">
                <div class="pad-grid" id="padGrid"></div>
                <div class="right-column" id="rightColumn"></div>
            </div>

            <div class="bottom-row" id="bottomRow"></div>
        </div>

        <div class="info-panel">
            <h3>Instructions</h3>
            <p style="margin-bottom: 15px;">
                <strong>Connexion:</strong> Cliquez sur "Connecter les appareils" pour connecter votre Launchpad MK2 et CTK-3200. 
                L'application peut √©galement fonctionner en mode simulation si les appareils ne sont pas connect√©s.
            </p>
            <p style="margin-bottom: 15px;">
                <strong>üêõ D√âBOGAGE:</strong> Ouvrez la console du navigateur (F12 ou Ctrl+Shift+I) pour voir les logs d√©taill√©s. 
                Chaque action affiche des messages dans la console pour diagnostiquer les probl√®mes.
                <span style="background: var(--surface-bright); padding: 2px 6px; border-radius: 3px; margin-left: 5px;">
                    Appuyez sur F12 maintenant!
                </span>
            </p>
            <p style="margin-bottom: 15px;">
                <strong>Navigation:</strong> Utilisez le menu d√©roulant pour s√©lectionner un groupe de rythme, 
                ou cliquez directement sur les pads. Basculez entre USER 1 et USER 2 pour acc√©der aux 32 groupes.
            </p>
            <p style="margin-bottom: 15px;">
                <strong>Contr√¥les Launchpad (si connect√©):</strong><br>
                ‚Ä¢ <strong>Pads 8√ó8:</strong> D√©marrer les rythmes (intro/corps/variation/outro)<br>
                ‚Ä¢ <strong>Boutons de droite:</strong> 6 premiers = drum sets, 7e = STOP, 8e = PAUSE<br>
                ‚Ä¢ <strong>Bouton User 1 (haut):</strong> Activer USER 1 (vert = actif, √©teint = inactif)<br>
                ‚Ä¢ <strong>Bouton User 2 (haut):</strong> Activer USER 2 (vert = actif, √©teint = inactif)<br>
                ‚Ä¢ <strong>Bouton Up (haut):</strong> Tempo +5 BPM (bleu)<br>
                ‚Ä¢ <strong>Bouton Down (haut):</strong> Tempo -5 BPM (bleu)
            </p>
            
            <h3>L√©gende des pads</h3>
            <div class="legend">
                <div class="legend-item">
                    <div class="legend-color intro"></div>
                    <span>Intro (16 temps)</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color main"></div>
                    <span>Corps (loop)</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color variation"></div>
                    <span>Variation (loop)</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color outro"></div>
                    <span>Outro (8 temps)</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color inactive"></div>
                    <span>Inactif (autre groupe joue)</span>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Configuration
        const DRUM_SETS = [
            { id: 0, name: 'STANDARD', program: 0 },
            { id: 1, name: 'ROOM', program: 8 },
            { id: 2, name: 'POWER', program: 16 },
            { id: 3, name: 'SYNTH', program: 17 },
            { id: 4, name: 'BRUSH', program: 40 },
            { id: 5, name: 'ORCHESTRA', program: 48 }
        ];

        const RHYTHM_GROUPS = [
            // USER 1 (16 groupes)
            { id: 0, name: 'Rock Standard', user: 1 },
            { id: 1, name: 'Pop Groove', user: 1 },
            { id: 2, name: 'Ballad Soft', user: 1 },
            { id: 3, name: 'Funk Drive', user: 1 },
            { id: 4, name: 'Blues Shuffle', user: 1 },
            { id: 5, name: 'Jazz Swing', user: 1 },
            { id: 6, name: 'Latin Fire', user: 1 },
            { id: 7, name: 'Reggae One', user: 1 },
            { id: 8, name: 'Country Beat', user: 1 },
            { id: 9, name: 'Soul Pocket', user: 1 },
            { id: 10, name: 'Disco Fever', user: 1 },
            { id: 11, name: 'R&B Smooth', user: 1 },
            { id: 12, name: 'Gospel Spirit', user: 1 },
            { id: 13, name: 'Metal Blast', user: 1 },
            { id: 14, name: 'Punk Energy', user: 1 },
            { id: 15, name: 'Indie Alt', user: 1 },
            // USER 2 (16 groupes)
            { id: 16, name: 'Electronic House', user: 2 },
            { id: 17, name: 'Techno Pulse', user: 2 },
            { id: 18, name: 'Dubstep Drop', user: 2 },
            { id: 19, name: 'Trap 808', user: 2 },
            { id: 20, name: 'Hip Hop Boom', user: 2 },
            { id: 21, name: 'Breakbeat', user: 2 },
            { id: 22, name: 'Drum n Bass', user: 2 },
            { id: 23, name: 'Ambient Chill', user: 2 },
            { id: 24, name: 'World Percussion', user: 2 },
            { id: 25, name: 'Afrobeat', user: 2 },
            { id: 26, name: 'Bossa Nova', user: 2 },
            { id: 27, name: 'Samba Heat', user: 2 },
            { id: 28, name: 'Flamenco Fire', user: 2 },
            { id: 29, name: 'Middle Eastern', user: 2 },
            { id: 30, name: 'Industrial', user: 2 },
            { id: 31, name: 'Experimental', user: 2 }
        ];

        // √âtat global
        let midiInputLaunchpad = null;
        let midiOutputLaunchpad = null;
        let midiOutputCTK = null;
        let currentUserMode = 1;
        let currentDrumset = 0;
        let tempo = 120;
        let isPlaying = false;
        let isPaused = false;
        let activeGroup = null;
        let activeSection = null; // 'intro', 'main', 'variation', 'outro'
        let beatPosition = 0;
        let intervalId = null;

        // Patterns de rythmes (notes MIDI pour chaque drum)
        const DRUM_PATTERNS = {
            intro: {
                kick: [0, 4, 8, 12],
                snare: [4, 12],
                hihat: [0, 2, 4, 6, 8, 10, 12, 14],
                length: 16
            },
            main: {
                kick: [0, 6, 8, 14],
                snare: [4, 12],
                hihat: [0, 2, 4, 6, 8, 10, 12, 14],
                length: 16
            },
            variation: {
                kick: [0, 3, 6, 8, 11, 14],
                snare: [4, 10, 12],
                hihat: [0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15],
                length: 16
            },
            outro: {
                kick: [0, 4],
                snare: [2, 6],
                hihat: [0, 1, 2, 3, 4, 5, 6, 7],
                length: 8
            }
        };

        // Notes MIDI (General MIDI Drum Map)
        const DRUM_NOTES = {
            kick: 36,    // Bass Drum 1
            snare: 38,   // Acoustic Snare
            hihat: 42,   // Closed Hi-Hat
            crash: 49    // Crash Cymbal 1
        };

        // Initialisation
        function init() {
            populateRhythmSelect();
            createPadGrid();
            createRightColumn();
            createBottomRow();
            updateTempo(120);
            
            // Initialiser l'affichage du drum set
            document.getElementById('currentDrumset').textContent = DRUM_SETS[0].name;
            document.getElementById('currentDrumsetProgram').textContent = `Program ${DRUM_SETS[0].program}`;
            
            document.getElementById('tempoInput').addEventListener('input', (e) => {
                updateTempo(parseInt(e.target.value));
            });

            document.getElementById('rhythmSelect').addEventListener('change', (e) => {
                if (e.target.value !== '') {
                    highlightGroup(parseInt(e.target.value));
                }
            });
            
            console.log('Application initialis√©e');
            console.log('Drum Set par d√©faut:', DRUM_SETS[0].name);
        }

        function populateRhythmSelect() {
            const select = document.getElementById('rhythmSelect');
            RHYTHM_GROUPS.forEach(group => {
                const option = document.createElement('option');
                option.value = group.id;
                option.textContent = `${group.name} (USER ${group.user})`;
                select.appendChild(option);
            });
        }

        function createPadGrid() {
            const grid = document.getElementById('padGrid');
            grid.innerHTML = '';
            
            for (let row = 0; row < 8; row++) {
                for (let col = 0; col < 8; col++) {
                    const pad = document.createElement('div');
                    pad.className = 'pad off';
                    pad.dataset.row = row;
                    pad.dataset.col = col;
                    pad.addEventListener('click', () => handlePadClick(row, col));
                    
                    // Ajouter le label du groupe
                    if (col % 4 === 0) {
                        const groupIndex = row * 2 + Math.floor(col / 4);
                        const actualGroupId = currentUserMode === 1 ? groupIndex : groupIndex + 16;
                        if (actualGroupId < RHYTHM_GROUPS.length) {
                            const label = document.createElement('div');
                            label.className = 'group-label';
                            label.textContent = `G${actualGroupId + 1}`;
                            pad.appendChild(label);
                        }
                    }
                    
                    grid.appendChild(pad);
                }
            }
            
            updatePadColors();
        }

        function createRightColumn() {
            const column = document.getElementById('rightColumn');
            column.innerHTML = '';
            
            // 6 boutons pour les drum sets (correspondant aux notes 89, 79, 69, 59, 49, 39)
            const drumsetLabels = ['STANDARD', 'ROOM', 'POWER', 'SYNTH', 'BRUSH', 'ORCHESTRA'];
            DRUM_SETS.forEach((drumset, index) => {
                const btn = document.createElement('div');
                btn.className = 'side-btn drumset';
                if (index === currentDrumset) btn.classList.add('active');
                btn.textContent = drumsetLabels[index] || drumset.name;
                btn.title = `${drumset.name} (Note ${[89, 79, 69, 59, 49, 39][index]})`;
                btn.addEventListener('click', () => selectDrumset(index));
                column.appendChild(btn);
            });
            
            // Bouton Stop (note 29 = Solo sur le Launchpad)
            const stopBtn = document.createElement('div');
            stopBtn.className = 'side-btn stop';
            stopBtn.textContent = 'STOP';
            stopBtn.title = 'Arr√™ter le rythme (Note 29)';
            stopBtn.addEventListener('click', stopAllRhythms);
            column.appendChild(stopBtn);
            
            // Bouton Pause (note 19 = Record Arm sur le Launchpad)
            const pauseBtn = document.createElement('div');
            pauseBtn.className = 'side-btn pause';
            pauseBtn.textContent = 'PAUSE';
            pauseBtn.title = 'Pause/Reprendre (Note 19)';
            pauseBtn.addEventListener('click', togglePause);
            column.appendChild(pauseBtn);
        }

        function createBottomRow() {
            const row = document.getElementById('bottomRow');
            row.innerHTML = '';
            
            // 6 boutons vides
            for (let i = 0; i < 6; i++) {
                const btn = document.createElement('div');
                btn.className = 'bottom-btn';
                row.appendChild(btn);
            }
            
            // Up - Tempo + (CC 104)
            const tempoUp = document.createElement('div');
            tempoUp.className = 'bottom-btn';
            tempoUp.textContent = '‚ñ≤';
            tempoUp.title = 'Tempo + (CC 104 = Up)';
            tempoUp.addEventListener('click', () => adjustTempo(5));
            row.appendChild(tempoUp);
            
            // Down - Tempo - (CC 105)
            const tempoDown = document.createElement('div');
            tempoDown.className = 'bottom-btn';
            tempoDown.textContent = '‚ñº';
            tempoDown.title = 'Tempo - (CC 105 = Down)';
            tempoDown.addEventListener('click', () => adjustTempo(-5));
            row.appendChild(tempoDown);
        }

        function updatePadColors() {
            const pads = document.querySelectorAll('.pad');
            pads.forEach(pad => {
                const row = parseInt(pad.dataset.row);
                const col = parseInt(pad.dataset.col);
                const groupIndex = row * 2 + Math.floor(col / 4);
                const actualGroupId = currentUserMode === 1 ? groupIndex : groupIndex + 16;
                const padType = col % 4;
                
                pad.classList.remove('intro', 'main', 'variation', 'outro', 'inactive', 'active', 'off');
                
                if (actualGroupId >= RHYTHM_GROUPS.length) {
                    pad.classList.add('off');
                    return;
                }
                
                if (activeGroup !== null && activeGroup !== actualGroupId) {
                    pad.classList.add('inactive');
                } else {
                    switch (padType) {
                        case 0: pad.classList.add('intro'); break;
                        case 1: pad.classList.add('main'); break;
                        case 2: pad.classList.add('variation'); break;
                        case 3: pad.classList.add('outro'); break;
                    }
                }
                
                // Marquer le pad actif
                if (activeGroup === actualGroupId) {
                    const sectionMap = ['intro', 'main', 'variation', 'outro'];
                    if (sectionMap[padType] === activeSection) {
                        pad.classList.add('active');
                    }
                }
            });
            
            // Synchroniser avec le Launchpad physique
            syncLaunchpadColors();
        }

        function handlePadClick(row, col) {
            const groupIndex = row * 2 + Math.floor(col / 4);
            const actualGroupId = currentUserMode === 1 ? groupIndex : groupIndex + 16;
            const padType = col % 4;
            const sections = ['intro', 'main', 'variation', 'outro'];
            
            if (actualGroupId >= RHYTHM_GROUPS.length) return;
            
            playSection(actualGroupId, sections[padType]);
        }

        function playSection(groupId, section) {
            stopPlayback();
            
            activeGroup = groupId;
            activeSection = section;
            beatPosition = 0;
            isPlaying = true;
            isPaused = false;
            
            updatePadColors();
            updatePlaybackState();
            
            startPlayback();
        }

        function startPlayback() {
            if (!midiOutputCTK) return;
            
            const pattern = DRUM_PATTERNS[activeSection];
            const beatDuration = (60 / tempo) * 1000 / 4; // Dur√©e d'un 16√®me de note en ms
            
            intervalId = setInterval(() => {
                if (isPaused) return;
                
                playBeat(beatPosition, pattern);
                beatPosition++;
                
                // V√©rifier si on doit passer √† la section suivante
                if (beatPosition >= pattern.length) {
                    beatPosition = 0;
                    
                    if (activeSection === 'intro') {
                        // Passer automatiquement au corps
                        activeSection = 'main';
                        updatePadColors();
                    } else if (activeSection === 'outro') {
                        // Arr√™ter apr√®s l'outro
                        stopAllRhythms();
                    }
                    // Les sections main et variation loopent
                }
            }, beatDuration);
        }

        function playBeat(position, pattern) {
            const channel = 9; // Canal 10 (0-indexed) pour les drums
            
            // Jouer les notes actives √† cette position
            Object.keys(DRUM_NOTES).forEach(drumName => {
                if (pattern[drumName] && pattern[drumName].includes(position)) {
                    const note = DRUM_NOTES[drumName];
                    const velocity = 100;
                    
                    if (midiOutputCTK) {
                        // Note ON
                        midiOutputCTK.send([0x90 + channel, note, velocity]);
                        
                        // Note OFF apr√®s 50ms
                        setTimeout(() => {
                            midiOutputCTK.send([0x80 + channel, note, 0]);
                        }, 50);
                    } else {
                        // Mode simulation - afficher dans la console
                        console.log(`Beat ${position}: ${drumName} (note ${note})`);
                    }
                }
            });
        }

        function stopPlayback() {
            if (intervalId) {
                clearInterval(intervalId);
                intervalId = null;
            }
        }

        function stopAllRhythms() {
            console.log('‚ïê‚ïê‚ïê STOP D√âCLENCH√â ‚ïê‚ïê‚ïê');
            console.log('Arr√™t du rythme en cours...');
            
            stopPlayback();
            
            activeGroup = null;
            activeSection = null;
            beatPosition = 0;
            isPlaying = false;
            isPaused = false;
            
            // Envoyer All Notes Off seulement si CTK est connect√©
            if (midiOutputCTK) {
                try {
                    midiOutputCTK.send([0xB9, 123, 0]); // All Notes Off sur canal 10
                    console.log('‚úì All Notes Off envoy√© au CTK-3200');
                } catch (error) {
                    console.error('Erreur lors de l\'envoi de All Notes Off:', error);
                }
            } else {
                console.warn('‚ö†Ô∏è CTK-3200 non connect√©');
            }
            
            updatePadColors();
            updatePlaybackState();
            console.log('‚úì Rythme arr√™t√©');
            console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
        }

        function togglePause() {
            console.log('‚ïê‚ïê‚ïê PAUSE/RESUME D√âCLENCH√â ‚ïê‚ïê‚ïê');
            
            if (!isPlaying) {
                console.log('‚ö†Ô∏è Aucun rythme en cours - PAUSE ignor√©');
                console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
                return;
            }
            
            isPaused = !isPaused;
            console.log(`√âtat: ${isPaused ? 'EN PAUSE' : 'LECTURE'}`);
            
            updatePlaybackState();
            
            // Synchroniser avec le Launchpad
            syncLaunchpadColors();
            console.log('‚úì √âtat mis √† jour');
            console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
        }

        function selectDrumset(index) {
            if (index < 0 || index >= DRUM_SETS.length) {
                console.error(`Index de drum set invalide: ${index}`);
                return;
            }
            
            currentDrumset = index;
            const drumset = DRUM_SETS[index];
            
            console.log(`‚ïê‚ïê‚ïê S√©lection Drum Set ${index} ‚ïê‚ïê‚ïê`);
            console.log(`Nom: ${drumset.name}`);
            console.log(`Program: ${drumset.program}`);
            
            if (midiOutputCTK) {
                // Envoyer Program Change sur canal 10 (drums)
                const channel = 9; // Canal 10 = index 9
                const programChange = [0xC0 + channel, drumset.program];
                console.log(`‚Üí Envoi Program Change: [${programChange[0].toString(16)}, ${programChange[1]}]`);
                midiOutputCTK.send(programChange);
                console.log('‚úì Program Change envoy√© au CTK-3200');
            } else {
                console.warn('‚ö†Ô∏è CTK-3200 non connect√© - mode simulation');
            }
            
            document.getElementById('currentDrumset').textContent = drumset.name;
            document.getElementById('currentDrumsetProgram').textContent = `Program ${drumset.program}`;
            console.log(`Interface mise √† jour: ${drumset.name}`);
            
            // Mettre √† jour les boutons de l'interface
            document.querySelectorAll('.side-btn.drumset').forEach((btn, i) => {
                btn.classList.toggle('active', i === index);
            });
            
            // Synchroniser avec le Launchpad
            console.log('Synchronisation des LEDs du Launchpad...');
            syncLaunchpadColors();
            console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
        }

        function switchUserMode(mode) {
            if (currentUserMode === mode) return;
            
            currentUserMode = mode;
            
            // Mettre √† jour les boutons
            document.querySelectorAll('.user-btn').forEach((btn, i) => {
                btn.classList.toggle('active', i + 1 === mode);
            });
            
            createPadGrid();
            
            // Synchroniser avec le Launchpad
            syncLaunchpadColors();
        }

        function highlightGroup(groupId) {
            const group = RHYTHM_GROUPS.find(g => g.id === groupId);
            if (!group) return;
            
            // Changer de mode USER si n√©cessaire
            if (group.user !== currentUserMode) {
                switchUserMode(group.user);
            }
            
            // Trouver et mettre en √©vidence les pads du groupe
            setTimeout(() => {
                const pads = document.querySelectorAll('.pad');
                pads.forEach(pad => {
                    const row = parseInt(pad.dataset.row);
                    const col = parseInt(pad.dataset.col);
                    const groupIndex = row * 2 + Math.floor(col / 4);
                    const actualGroupId = group.user === 1 ? groupIndex : groupIndex + 16;
                    
                    if (actualGroupId === groupId) {
                        pad.style.animation = 'pulse 0.5s ease-in-out 3';
                        setTimeout(() => {
                            pad.style.animation = '';
                        }, 1500);
                    }
                });
            }, 100);
        }

        function updateTempo(newTempo) {
            tempo = Math.max(40, Math.min(240, newTempo));
            document.getElementById('tempoInput').value = tempo;
            document.getElementById('tempoDisplay').textContent = tempo;
            
            // Red√©marrer le playback si en cours
            if (isPlaying && !isPaused) {
                stopPlayback();
                startPlayback();
            }
        }

        function adjustTempo(delta) {
            const oldTempo = tempo;
            updateTempo(tempo + delta);
            
            // Feedback visuel sur l'affichage du tempo
            const tempoDisplay = document.getElementById('tempoDisplay');
            tempoDisplay.style.transform = 'scale(1.2)';
            tempoDisplay.style.color = delta > 0 ? '#00ff88' : '#ff6600';
            
            setTimeout(() => {
                tempoDisplay.style.transform = 'scale(1)';
                tempoDisplay.style.color = 'var(--primary)';
            }, 200);
        }

        function updatePlaybackState() {
            const stateText = isPaused ? 'En pause' : (isPlaying ? 'Lecture' : 'Arr√™t√©');
            document.getElementById('playbackState').textContent = stateText;
        }

        // Connexion MIDI
        async function connectDevices() {
            if (!navigator.requestMIDIAccess) {
                alert('Web MIDI API non support√©e par ce navigateur');
                return;
            }

            try {
                // Demander l'acc√®s MIDI avec support SysEx
                const midiAccess = await navigator.requestMIDIAccess({ sysex: true });
                
                console.log('Appareils MIDI disponibles:');
                console.log('Inputs:', Array.from(midiAccess.inputs.values()).map(i => i.name));
                console.log('Outputs:', Array.from(midiAccess.outputs.values()).map(o => o.name));
                
                // Trouver le Launchpad
                for (let input of midiAccess.inputs.values()) {
                    if (input.name.toLowerCase().includes('launchpad')) {
                        midiInputLaunchpad = input;
                        midiInputLaunchpad.onmidimessage = handleLaunchpadMessage;
                        document.getElementById('launchpadStatus').classList.add('connected');
                        document.querySelector('#launchpadStatus .status-value').textContent = 'Connect√©';
                        console.log('Launchpad input connect√©:', input.name);
                    }
                }
                
                for (let output of midiAccess.outputs.values()) {
                    if (output.name.toLowerCase().includes('launchpad')) {
                        midiOutputLaunchpad = output;
                        console.log('Launchpad output connect√©:', output.name);
                        initializeLaunchpad();
                    }
                    if (output.name.toLowerCase().includes('ctk') || 
                        output.name.toLowerCase().includes('casio') ||
                        output.name.toLowerCase().includes('keyboard')) {
                        midiOutputCTK = output;
                        document.getElementById('ctkStatus').classList.add('connected');
                        document.querySelector('#ctkStatus .status-value').textContent = 'Connect√©';
                        console.log('CTK-3200 output connect√©:', output.name);
                        selectDrumset(0); // Initialiser avec STANDARD SET
                    }
                }
                
                if (!midiInputLaunchpad || !midiOutputLaunchpad) {
                    console.warn('Launchpad MK2 non trouv√©');
                    alert('Launchpad MK2 non trouv√©. V√©rifiez qu\'il est bien connect√©.');
                }
                if (!midiOutputCTK) {
                    console.warn('CTK-3200 non trouv√©');
                    alert('CTK-3200 non trouv√©. L\'application peut quand m√™me √™tre utilis√©e sans le clavier.');
                }
            } catch (error) {
                console.error('Erreur de connexion MIDI:', error);
                alert('Erreur lors de la connexion MIDI: ' + error.message);
            }
        }

        function initializeLaunchpad() {
            if (!midiOutputLaunchpad) return;
            
            try {
                // Mettre le Launchpad MK2 en mode programmeur (Programmer Mode)
                // SysEx: F0h 00h 20h 29h 02h 18h 0Eh 01h F7h
                midiOutputLaunchpad.send([0xF0, 0x00, 0x20, 0x29, 0x02, 0x18, 0x0E, 0x01, 0xF7]);
                
                console.log('Launchpad initialis√© en mode programmeur');
                
                // Attendre que le Launchpad soit pr√™t, puis effacer et synchroniser
                setTimeout(() => {
                    // Effacer toutes les LEDs des pads (notes 11-88)
                    for (let row = 1; row <= 8; row++) {
                        for (let col = 1; col <= 8; col++) {
                            const note = row * 10 + col;
                            midiOutputLaunchpad.send([0x90, note, 0]);
                        }
                    }
                    
                    // Effacer les boutons de droite (notes 89, 79, 69, 59, 49, 39, 29, 19)
                    [89, 79, 69, 59, 49, 39, 29, 19].forEach(note => {
                        midiOutputLaunchpad.send([0x90, note, 0]);
                    });
                    
                    // Effacer les boutons du haut (CC 104-111)
                    for (let cc = 104; cc <= 111; cc++) {
                        midiOutputLaunchpad.send([0xB0, cc, 0]);
                    }
                    
                    // Synchroniser les couleurs
                    setTimeout(() => syncLaunchpadColors(), 50);
                }, 100);
                
            } catch (error) {
                console.error('Erreur lors de l\'initialisation du Launchpad:', error);
            }
        }

        function syncLaunchpadColors() {
            if (!midiOutputLaunchpad) return;
            
            // D√©finir les couleurs pour le Launchpad MK2
            const COLORS = {
                off: 0,
                intro: 45,      // Bleu
                main: 37,       // Bleu clair
                variation: 5,   // Rouge
                outro: 9,       // Orange
                inactive: 13,   // Jaune
                active: 21      // Vert brillant pour le pad actif
            };
            
            // Mettre √† jour les pads de la grille 8x8
            // Pattern: note = ligne√ó10 + colonne + 1 (ligne 1 = bas, col 1 = gauche)
            for (let row = 0; row < 8; row++) {
                for (let col = 0; col < 8; col++) {
                    const groupIndex = row * 2 + Math.floor(col / 4);
                    const actualGroupId = currentUserMode === 1 ? groupIndex : groupIndex + 16;
                    const padType = col % 4;
                    
                    // Calculer la note MIDI pour ce pad
                    const note = (row + 1) * 10 + (col + 1);
                    
                    let color = COLORS.off;
                    
                    if (actualGroupId < RHYTHM_GROUPS.length) {
                        if (activeGroup !== null && activeGroup !== actualGroupId) {
                            color = COLORS.inactive;
                        } else {
                            switch (padType) {
                                case 0: color = COLORS.intro; break;
                                case 1: color = COLORS.main; break;
                                case 2: color = COLORS.variation; break;
                                case 3: color = COLORS.outro; break;
                            }
                            
                            // Marquer le pad actif
                            if (activeGroup === actualGroupId) {
                                const sections = ['intro', 'main', 'variation', 'outro'];
                                if (sections[padType] === activeSection) {
                                    color = COLORS.active;
                                }
                            }
                        }
                    }
                    
                    // Envoyer la couleur au Launchpad (Note On)
                    midiOutputLaunchpad.send([0x90, note, color]);
                }
            }
            
            // Mettre √† jour les boutons ronds de droite (Note On: 89, 79, 69, 59, 49, 39, 29, 19)
            const rightButtons = [89, 79, 69, 59, 49, 39, 29, 19];
            const rightButtonNames = ['Volume/DS0', 'Pan/DS1', 'SendA/DS2', 'SendB/DS3', 'Stop/DS4', 'Mute/DS5', 'Solo/STOP', 'RecArm/PAUSE'];
            
            console.log('Mise √† jour LEDs boutons droite:');
            for (let i = 0; i < 8; i++) {
                const note = rightButtons[i];
                let color = COLORS.off;
                
                if (i < 6) {
                    // Boutons de drum sets
                    color = (i === currentDrumset) ? COLORS.active : 19; // Vert si actif, sinon gris
                } else if (i === 6) {
                    // Solo = STOP
                    color = 5; // Rouge
                } else if (i === 7) {
                    // Record Arm = PAUSE
                    color = isPaused ? COLORS.active : 9; // Vert si en pause, orange sinon
                }
                
                console.log(`  ${rightButtonNames[i]} (note ${note}): couleur ${color}`);
                // Envoyer un message Note On pour allumer la LED
                midiOutputLaunchpad.send([0x90, note, color]);
            }
            
            // Mettre √† jour les boutons du haut (CC 104-111)
            // 104=Up, 105=Down, 106=Left, 107=Right, 108=Session, 109=User1, 110=User2, 111=Mixer
            for (let i = 0; i < 8; i++) {
                const cc = 104 + i;
                let color = COLORS.off;
                
                // Up (CC 104) - Tempo +
                if (cc === 104) {
                    color = 45; // Bleu
                }
                // Down (CC 105) - Tempo -
                else if (cc === 105) {
                    color = 45; // Bleu
                }
                // User 1 (CC 109) - Allum√© en vert si USER 1 actif, √©teint sinon
                else if (cc === 109) {
                    color = currentUserMode === 1 ? COLORS.active : COLORS.off;
                }
                // User 2 (CC 110) - Allum√© en vert si USER 2 actif, √©teint sinon
                else if (cc === 110) {
                    color = currentUserMode === 2 ? COLORS.active : COLORS.off;
                }
                
                midiOutputLaunchpad.send([0xB0, cc, color]);
            }
        }

        function handleLaunchpadMessage(message) {
            const [status, note, velocity] = message.data;
            
            if (velocity === 0) return; // Ignorer les note off et CC √† 0
            
            console.log('MIDI message re√ßu - Status:', status.toString(16), 'Note/CC:', note, 'Velocity:', velocity);
            
            // Messages Note On (0x90)
            if (status === 0x90) {
                // Pads de la grille principale (notes 11-88)
                // Pattern: ligne√ó10 + colonne + 1 (ligne 1 = bas, col 1 = gauche)
                if (note >= 11 && note <= 88) {
                    const tens = Math.floor(note / 10);
                    const ones = note % 10;
                    
                    // V√©rifier que c'est une note valide (pas de 9, 0 dans les unit√©s)
                    if (ones >= 1 && ones <= 8 && tens >= 1 && tens <= 8) {
                        const row = tens - 1; // Ligne 0-7 (0 = bas)
                        const col = ones - 1; // Colonne 0-7 (0 = gauche)
                        console.log(`‚úì Pad cliqu√© - Note ${note} -> Row: ${row}, Col: ${col}`);
                        handlePadClick(row, col);
                    }
                }
                // Boutons ronds de droite (Note On: 89, 79, 69, 59, 49, 39, 29, 19)
                // 89=Volume(drumset0), 79=Pan(drumset1), 69=SendA(drumset2), 
                // 59=SendB(drumset3), 49=Stop(drumset4), 39=Mute(drumset5),
                // 29=Solo(STOP), 19=RecordArm(PAUSE)
                else if ([89, 79, 69, 59, 49, 39, 29, 19].includes(note)) {
                    const rightButtons = [89, 79, 69, 59, 49, 39, 29, 19];
                    const btnIndex = rightButtons.indexOf(note);
                    const btnNames = ['Volume/STANDARD', 'Pan/ROOM', 'SendA/POWER', 'SendB/SYNTH', 'Stop/BRUSH', 'Mute/ORCHESTRA', 'Solo/STOP', 'RecordArm/PAUSE'];
                    
                    console.log(`‚úì Bouton droit ${btnIndex} cliqu√© - Note ${note} - Fonction: ${btnNames[btnIndex]}`);
                    
                    if (btnIndex < 6) {
                        // Les 6 premiers = drum sets
                        console.log(`‚Üí S√©lection drum set ${btnIndex}`);
                        selectDrumset(btnIndex);
                    } else if (btnIndex === 6) {
                        // Solo = STOP
                        console.log('‚Üí STOP d√©clench√©');
                        stopAllRhythms();
                    } else if (btnIndex === 7) {
                        // Record Arm = PAUSE
                        console.log('‚Üí PAUSE/RESUME d√©clench√©');
                        togglePause();
                    }
                } else {
                    console.log(`‚ö†Ô∏è Note On non g√©r√©e: ${note}`);
                }
            }
            // Messages Control Change (0xB0) - pour les boutons du haut
            else if (status === 0xB0) {
                console.log('CC message - Controller:', note, 'Value:', velocity);
                
                // Boutons du haut (CC 104-111)
                // 104=Up, 105=Down, 106=Left, 107=Right, 108=Session, 109=User1, 110=User2, 111=Mixer
                if (note >= 104 && note <= 111) {
                    const btnIndex = note - 104;
                    const ccNames = ['Up/Tempo+', 'Down/Tempo-', 'Left', 'Right', 'Session', 'User1', 'User2', 'Mixer'];
                    console.log(`‚úì Bouton haut ${btnIndex} cliqu√© - CC ${note} - Fonction: ${ccNames[btnIndex]}`);
                    
                    // Up (CC 104) = Tempo +
                    if (note === 104) {
                        console.log('‚Üí Tempo +5');
                        adjustTempo(5);
                    }
                    // Down (CC 105) = Tempo -
                    else if (note === 105) {
                        console.log('‚Üí Tempo -5');
                        adjustTempo(-5);
                    }
                    // User 1 (CC 109) = Activer USER 1
                    else if (note === 109) {
                        console.log('‚Üí Activation USER 1');
                        switchUserMode(1);
                    }
                    // User 2 (CC 110) = Activer USER 2
                    else if (note === 110) {
                        console.log('‚Üí Activation USER 2');
                        switchUserMode(2);
                    }
                }
            }
        }

        // Initialiser au chargement
        window.addEventListener('load', init);
    </script>
</body>
</html>