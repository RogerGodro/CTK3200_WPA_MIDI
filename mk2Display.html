<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Launchpad MK2 - Display Message</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            color: #fff;
        }
        h1 { margin-bottom: 5px; color: #00ffcc; }
        .subtitle { color: #888; margin-bottom: 20px; font-size: 14px; }
        
        .status {
            background: #2a2a4a;
            padding: 10px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 14px;
        }
        .status.connected { border: 2px solid #00ff88; }
        .status.disconnected { border: 2px solid #ff4444; }
        
        .controls {
            background: #2a2a4a;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            width: 100%;
            max-width: 550px;
        }
        
        .control-row {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
        }
        .control-row:last-child { margin-bottom: 0; }
        
        label {
            width: 100px;
            color: #aaa;
            font-size: 14px;
        }
        
        input[type="text"] {
            flex: 1;
            padding: 12px;
            border-radius: 8px;
            border: 2px solid #444;
            background: #1a1a2e;
            color: #fff;
            font-size: 16px;
        }
        input[type="text"]:focus {
            outline: none;
            border-color: #00ffcc;
        }
        
        input[type="color"] {
            width: 50px;
            height: 40px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
        }
        
        input[type="range"] { flex: 1; }
        
        .speed-value {
            width: 50px;
            text-align: center;
            color: #00ffcc;
        }
        
        .color-preview {
            width: 30px;
            height: 30px;
            border-radius: 4px;
            border: 2px solid #fff;
        }
        
        button {
            padding: 10px 20px;
            border-radius: 8px;
            border: none;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
        }
        button.primary { background: #00ffcc; color: #000; }
        button.primary:hover { background: #00ff99; }
        button.secondary { background: #555; color: #fff; }
        button.secondary:hover { background: #666; }
        button.danger { background: #ff4444; color: #fff; }
        button.danger:hover { background: #ff6666; }
        button.rotate { background: #aa66ff; color: #fff; font-size: 18px; padding: 10px 15px; }
        button.rotate:hover { background: #bb88ff; }
        
        .buttons-row {
            display: flex;
            gap: 10px;
            justify-content: center;
            flex-wrap: wrap;
        }
        
        .rotation-info {
            background: #1a1a2e;
            padding: 8px 15px;
            border-radius: 6px;
            color: #00ffcc;
            font-size: 14px;
        }
        
        .launchpad-container {
            position: relative;
        }
        
        .launchpad {
            background: #1a1a1a;
            border-radius: 12px;
            padding: 15px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.5);
            transition: transform 0.3s;
        }
        
        .grid {
            display: grid;
            grid-template-columns: repeat(8, 45px);
            gap: 6px;
        }
        .pad {
            width: 45px;
            height: 45px;
            border-radius: 6px;
            background: #333;
            transition: background 0.05s;
        }
        
        .info {
            margin-top: 20px;
            color: #666;
            font-size: 12px;
            text-align: center;
        }
    </style>
</head>
<body>
    <h1>üìù Display Message</h1>
    <p class="subtitle">Texte d√©filant sur Launchpad MK2</p>
    
    <button class="primary" onclick="connectMIDI()" id="connectBtn">Connecter MIDI</button>
    
    <div id="status" class="status disconnected">Non connect√©</div>
    
    <div class="controls">
        <div class="control-row">
            <label>Message</label>
            <input type="text" id="message" value="HELLO!" placeholder="Entrez votre message...">
        </div>
        <div class="control-row">
            <label>Couleur texte</label>
            <input type="color" id="textColor" value="#00ff00">
            <div class="color-preview" id="textPreview" style="background:#00ff00"></div>
            <span style="margin-left:10px; color:#666; font-size:12px">Noir = LED off</span>
        </div>
        <div class="control-row">
            <label>Fond</label>
            <input type="color" id="bgColor" value="#000000">
            <div class="color-preview" id="bgPreview" style="background:#000000"></div>
        </div>
        <div class="control-row">
            <label>Vitesse</label>
            <input type="range" id="speed" min="50" max="500" value="150">
            <span class="speed-value" id="speedValue">150ms</span>
        </div>
        <div class="control-row">
            <label>Rotation</label>
            <button class="rotate" onclick="rotate(-90)">‚Ü∂</button>
            <span class="rotation-info" id="rotationInfo">0¬∞</span>
            <button class="rotate" onclick="rotate(90)">‚Ü∑</button>
        </div>
        <div class="control-row buttons-row">
            <button class="primary" onclick="startScroll()">‚ñ∂ D√©marrer</button>
            <button class="secondary" onclick="stopScroll()">‚èπ Stop</button>
            <button class="danger" onclick="clearDisplay()">‚úï Effacer</button>
        </div>
    </div>
    
    <div class="launchpad-container">
        <div class="launchpad" id="launchpad">
            <div class="grid" id="grid"></div>
        </div>
    </div>
    
    <div class="info">
        Caract√®res support√©s: A-Z, 0-9, espace, ! ? . , - + = : ' "
    </div>

    <script>
        let midiOutput = null;
        let mapping = null;
        let scrollInterval = null;
        let scrollPosition = 0;
        let bitmap = [];
        let rotation = 0; // 0, 90, 180, 270
        
        // Police bitmap 8 pixels de haut
        // Chaque valeur = une colonne, bit 0 = bas (row 1), bit 7 = haut (row 8)
        const FONT = {
            'A': [0x7C,0x12,0x11,0x12,0x7C],
            'B': [0x7F,0x49,0x49,0x49,0x36],
            'C': [0x3E,0x41,0x41,0x41,0x22],
            'D': [0x7F,0x41,0x41,0x22,0x1C],
            'E': [0x7F,0x49,0x49,0x49,0x41],
            'F': [0x7F,0x09,0x09,0x09,0x01],
            'G': [0x3E,0x41,0x49,0x49,0x7A],
            'H': [0x7F,0x08,0x08,0x08,0x7F],
            'I': [0x41,0x7F,0x41],
            'J': [0x20,0x40,0x41,0x3F,0x01],
            'K': [0x7F,0x08,0x14,0x22,0x41],
            'L': [0x7F,0x40,0x40,0x40,0x40],
            'M': [0x7F,0x02,0x0C,0x02,0x7F],
            'N': [0x7F,0x04,0x08,0x10,0x7F],
            'O': [0x3E,0x41,0x41,0x41,0x3E],
            'P': [0x7F,0x09,0x09,0x09,0x06],
            'Q': [0x3E,0x41,0x51,0x21,0x5E],
            'R': [0x7F,0x09,0x19,0x29,0x46],
            'S': [0x46,0x49,0x49,0x49,0x31],
            'T': [0x01,0x01,0x7F,0x01,0x01],
            'U': [0x3F,0x40,0x40,0x40,0x3F],
            'V': [0x1F,0x20,0x40,0x20,0x1F],
            'W': [0x3F,0x40,0x38,0x40,0x3F],
            'X': [0x63,0x14,0x08,0x14,0x63],
            'Y': [0x07,0x08,0x70,0x08,0x07],
            'Z': [0x61,0x51,0x49,0x45,0x43],
            '0': [0x3E,0x51,0x49,0x45,0x3E],
            '1': [0x00,0x42,0x7F,0x40,0x00],
            '2': [0x42,0x61,0x51,0x49,0x46],
            '3': [0x21,0x41,0x45,0x4B,0x31],
            '4': [0x18,0x14,0x12,0x7F,0x10],
            '5': [0x27,0x45,0x45,0x45,0x39],
            '6': [0x3C,0x4A,0x49,0x49,0x30],
            '7': [0x01,0x71,0x09,0x05,0x03],
            '8': [0x36,0x49,0x49,0x49,0x36],
            '9': [0x06,0x49,0x49,0x29,0x1E],
            ' ': [0x00,0x00,0x00],
            '!': [0x5F],
            '?': [0x02,0x01,0x51,0x09,0x06],
            '.': [0x60],
            ',': [0x80,0x60],
            '-': [0x08,0x08,0x08],
            '+': [0x08,0x08,0x3E,0x08,0x08],
            '=': [0x14,0x14,0x14],
            ':': [0x36],
            "'": [0x03],
            '"': [0x03,0x00,0x03],
            '(': [0x1C,0x22,0x41],
            ')': [0x41,0x22,0x1C],
            '/': [0x20,0x10,0x08,0x04,0x02],
            '<': [0x08,0x14,0x22,0x41],
            '>': [0x41,0x22,0x14,0x08],
            '*': [0x14,0x08,0x3E,0x08,0x14],
            '#': [0x14,0x7F,0x14,0x7F,0x14],
            '_': [0x40,0x40,0x40,0x40,0x40]
        };

        async function loadMapping() {
            try {
                const response = await fetch('https://rogergodro.github.io/CTK3200_WPA_MIDI/launchpad_mk2_mapping.json');
                mapping = await response.json();
                console.log('Mapping charg√©:', mapping.device.name);
                buildGrid();
            } catch (e) {
                console.error('Erreur chargement mapping:', e);
            }
        }

        function buildGrid() {
            const grid = document.getElementById('grid');
            for (let row = 8; row >= 1; row--) {
                for (let col = 1; col <= 8; col++) {
                    const pad = document.createElement('div');
                    pad.className = 'pad';
                    pad.id = `pad-${row}-${col}`;
                    grid.appendChild(pad);
                }
            }
        }

        async function connectMIDI() {
            try {
                const access = await navigator.requestMIDIAccess({sysex: true});
                
                for (const output of access.outputs.values()) {
                    if (output.name.includes('Launchpad MK2')) {
                        midiOutput = output;
                    }
                }
                
                if (midiOutput) {
                    document.getElementById('status').className = 'status connected';
                    document.getElementById('status').textContent = `‚úì Connect√©: ${midiOutput.name}`;
                    document.getElementById('connectBtn').style.display = 'none';
                    clearDisplay();
                } else {
                    document.getElementById('status').textContent = 'Launchpad MK2 non trouv√©';
                }
            } catch (e) {
                document.getElementById('status').textContent = 'Erreur: ' + e.message;
            }
        }

        function hexToRgb63(hex) {
            const r = parseInt(hex.slice(1, 3), 16);
            const g = parseInt(hex.slice(3, 5), 16);
            const b = parseInt(hex.slice(5, 7), 16);
            // Convertir 0-255 vers 0-63 (max 63, pas 64!)
            return [Math.min(63, Math.floor(r / 4)), Math.min(63, Math.floor(g / 4)), Math.min(63, Math.floor(b / 4))];
        }

        function setLed(note, hex) {
            if (!midiOutput) return;
            const [r, g, b] = hexToRgb63(hex);
            // SysEx RGB: F0 00 20 29 02 18 0B note r g b F7
            midiOutput.send([0xF0, 0x00, 0x20, 0x29, 0x02, 0x18, 0x0B, note, r, g, b, 0xF7]);
        }

        function transformCoords(row, col) {
            // Applique la rotation pour le MK2
            let newRow, newCol;
            switch (rotation) {
                case 90: // 90¬∞ horaire
                    newRow = col;
                    newCol = 9 - row;
                    break;
                case 180:
                    newRow = 9 - row;
                    newCol = 9 - col;
                    break;
                case 270: // 90¬∞ anti-horaire
                    newRow = 9 - col;
                    newCol = row;
                    break;
                default: // 0
                    newRow = row;
                    newCol = col;
            }
            return [newRow, newCol];
        }

        function setPixel(logicalRow, logicalCol, isLit) {
            const textHex = document.getElementById('textColor').value;
            const bgHex = document.getElementById('bgColor').value;
            const color = isLit ? textHex : bgHex;
            
            // Appliquer rotation pour le Launchpad physique
            const [physRow, physCol] = transformCoords(logicalRow, logicalCol);
            
            if (physRow >= 1 && physRow <= 8 && physCol >= 1 && physCol <= 8) {
                const note = mapping.lookup.positionToNote[`${physRow}-${physCol}`];
                if (note) setLed(note, color);
            }
            
            // UI: affiche toujours sans rotation (pour voir le texte lisible)
            const pad = document.getElementById(`pad-${logicalRow}-${logicalCol}`);
            if (pad) pad.style.background = color;
        }

        function textToBitmap(text) {
            const result = [];
            text = text.toUpperCase();
            
            for (const char of text) {
                const charData = FONT[char] || FONT['?'];
                for (const col of charData) {
                    result.push(col);
                }
                result.push(0x00); // Espace entre caract√®res
            }
            
            for (let i = 0; i < 8; i++) result.push(0x00);
            return result;
        }

        function renderFrame(offset) {
            for (let col = 1; col <= 8; col++) {
                const bitmapCol = offset + col - 1;
                const colData = bitmapCol >= 0 && bitmapCol < bitmap.length ? bitmap[bitmapCol] : 0;
                
                for (let row = 1; row <= 8; row++) {
                    // Police: bit 0 = haut de lettre, bit 6 = bas de lettre
                    // √âcran: row 8 = haut, row 1 = bas
                    // Donc bit 0 ‚Üí row 8, bit 7 ‚Üí row 1
                    const isLit = (colData & (1 << (8 - row))) !== 0;
                    setPixel(row, col, isLit);
                }
            }
        }

        function startScroll() {
            stopScroll();
            
            const text = document.getElementById('message').value || 'HELLO!';
            bitmap = textToBitmap(text);
            scrollPosition = -8;
            
            const speed = parseInt(document.getElementById('speed').value);
            
            scrollInterval = setInterval(() => {
                renderFrame(scrollPosition);
                scrollPosition++;
                if (scrollPosition >= bitmap.length) scrollPosition = -8;
            }, speed);
        }

        function stopScroll() {
            if (scrollInterval) {
                clearInterval(scrollInterval);
                scrollInterval = null;
            }
        }

        function clearDisplay() {
            stopScroll();
            const bgHex = document.getElementById('bgColor').value;
            
            for (let row = 1; row <= 8; row++) {
                for (let col = 1; col <= 8; col++) {
                    const note = mapping.lookup.positionToNote[`${row}-${col}`];
                    if (note) setLed(note, bgHex);
                    const pad = document.getElementById(`pad-${row}-${col}`);
                    if (pad) pad.style.background = bgHex;
                }
            }
        }

        function rotate(degrees) {
            rotation = (rotation + degrees + 360) % 360;
            document.getElementById('rotationInfo').textContent = rotation + '¬∞';
            // Rotation visuelle de la preview
            document.getElementById('launchpad').style.transform = `rotate(${rotation}deg)`;
        }

        // Event listeners
        document.getElementById('textColor').addEventListener('input', (e) => {
            document.getElementById('textPreview').style.background = e.target.value;
        });
        
        document.getElementById('bgColor').addEventListener('input', (e) => {
            document.getElementById('bgPreview').style.background = e.target.value;
        });
        
        document.getElementById('speed').addEventListener('input', (e) => {
            document.getElementById('speedValue').textContent = e.target.value + 'ms';
            if (scrollInterval) startScroll();
        });
        
        document.getElementById('message').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') startScroll();
        });

        loadMapping();
    </script>
</body>
</html>
