<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="description" content="CTK-3200 V8 REVISED - Full Launchpad MK2 Integration">
    <meta name="theme-color" content="#0a0a0f">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="CTK V8">
    <meta name="format-detection" content="telephone=no">
    <title>CTK-3200 V8 REVISED - LAUNCHPAD MK2</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            user-select: none;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
        }

        :root {
            --primary: #00ff88;
            --secondary: #ff00aa;
            --accent: #00aaff;
            --warning: #ff8800;
            --danger: #ff3333;
            --success: #00ff00;
            
            --bg-dark: #0a0a0f;
            --bg-medium: #14141a;
            --bg-light: #1f1f28;
            --bg-lighter: #2a2a35;
            
            --text-primary: #ffffff;
            --text-secondary: #aaaaaa;
            --text-dim: #666666;
            
            /* Launchpad Colors - Using Novation's actual color values */
            --lp-off: #1e1e1e;
            --lp-red: #ff3333;
            --lp-orange: #ff8800;
            --lp-amber: #ffbb00;
            --lp-yellow: #ffff00;
            --lp-lime: #88ff00;
            --lp-green: #00ff00;
            --lp-turquoise: #00ff88;
            --lp-cyan: #00ffff;
            --lp-sky: #00aaff;
            --lp-blue: #0088ff;
            --lp-orchid: #5500ff;
            --lp-purple: #aa00ff;
            --lp-pink: #ff00aa;
            --lp-magenta: #ff0088;
            --lp-white: #ffffff;
        }

        body {
            background: var(--bg-dark);
            color: var(--text-primary);
            overflow: hidden;
            height: 100vh;
            width: 100vw;
            position: fixed;
            touch-action: none;
        }

        .app-container {
            height: 100vh;
            display: grid;
            grid-template-rows: 70px 1fr;
            background: radial-gradient(ellipse at center, #14141a 0%, #0a0a0f 100%);
        }

        /* Header */
        .header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 25px;
            background: linear-gradient(180deg, rgba(31,31,40,0.95) 0%, rgba(20,20,26,0.95) 100%);
            border-bottom: 1px solid var(--primary);
        }

        .logo {
            font-size: 24px;
            font-weight: 900;
            background: linear-gradient(135deg, var(--primary) 0%, var(--accent) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            letter-spacing: -1px;
        }

        .status-group {
            display: flex;
            gap: 20px;
            align-items: center;
            flex: 1;
            justify-content: center;
        }

        .status-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 5px 15px;
            background: var(--bg-light);
            border-radius: 12px;
            border: 1px solid var(--bg-lighter);
        }

        .status-label {
            font-size: 10px;
            color: var(--text-dim);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .status-value {
            font-size: 16px;
            font-weight: 700;
            color: var(--primary);
            margin-top: 2px;
        }

        .tempo-controls {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 16px;
            background: var(--bg-light);
            border-radius: 25px;
            border: 1px solid var(--accent);
        }

        .tempo-display {
            font-size: 22px;
            font-weight: 800;
            color: var(--accent);
            min-width: 60px;
            text-align: center;
        }

        .tempo-btn {
            width: 24px;
            height: 24px;
            background: var(--bg-lighter);
            border: 1px solid var(--accent);
            border-radius: 4px;
            color: var(--accent);
            cursor: pointer;
            transition: all 0.1s;
            font-size: 12px;
        }

        .tempo-btn:hover {
            background: var(--accent);
            color: var(--bg-dark);
        }

        .tap-btn {
            padding: 10px 20px;
            background: var(--bg-lighter);
            border: 2px solid var(--warning);
            border-radius: 25px;
            color: var(--warning);
            font-weight: 700;
            cursor: pointer;
            transition: all 0.1s;
            text-transform: uppercase;
        }

        .tap-btn:active {
            background: var(--warning);
            color: var(--bg-dark);
            transform: scale(0.95);
        }

        .midi-status {
            display: flex;
            gap: 10px;
        }

        .midi-device {
            padding: 6px 12px;
            background: var(--bg-light);
            border-radius: 20px;
            font-size: 11px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .midi-led {
            width: 8px;
            height: 8px;
            background: #444;
            border-radius: 50%;
            transition: all 0.2s;
        }

        .midi-led.active {
            background: var(--success);
            box-shadow: 0 0 8px var(--success);
        }

        .connect-btn {
            padding: 10px 20px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--accent) 100%);
            border: none;
            border-radius: 25px;
            color: var(--bg-dark);
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s;
        }

        .connect-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 255, 136, 0.3);
        }

        .fullscreen-btn {
            width: 44px;
            height: 44px;
            background: var(--bg-light);
            border: 2px solid var(--accent);
            border-radius: 50%;
            color: var(--accent);
            font-size: 20px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .fullscreen-btn:hover {
            background: var(--accent);
            color: var(--bg-dark);
            transform: scale(1.1);
            box-shadow: 0 0 15px rgba(0, 170, 255, 0.4);
        }

        /* Main Content */
        .main-content {
            display: grid;
            grid-template-columns: 260px 1fr 360px;
            gap: 20px;
            padding: 20px;
            height: calc(100vh - 70px);
        }

        /* Left Panel - Rhythm & Style */
        .left-panel {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .panel-section {
            background: var(--bg-medium);
            border-radius: 12px;
            padding: 15px;
            border: 1px solid var(--bg-lighter);
        }

        .section-title {
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 2px;
            color: var(--text-dim);
            margin-bottom: 12px;
            padding-left: 8px;
            border-left: 3px solid var(--primary);
        }

        .style-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
        }

        .style-btn {
            padding: 10px;
            background: var(--bg-light);
            border: 2px solid var(--bg-lighter);
            border-radius: 8px;
            color: var(--text-secondary);
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.15s;
        }

        .style-btn:hover {
            border-color: var(--primary);
            color: var(--primary);
        }

        .style-btn.active {
            background: var(--primary);
            color: var(--bg-dark);
            border-color: var(--primary);
        }

        .section-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 6px;
        }

        .section-btn {
            padding: 12px 8px;
            background: var(--bg-light);
            border: 2px solid var(--bg-lighter);
            border-radius: 8px;
            color: var(--text-secondary);
            font-size: 10px;
            font-weight: 700;
            cursor: pointer;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            transition: all 0.15s;
        }

        .section-btn:hover {
            border-color: var(--accent);
            color: var(--accent);
        }

        .section-btn.active {
            background: var(--accent);
            color: var(--bg-dark);
            border-color: var(--accent);
        }

        .variation-row {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 6px;
        }

        .var-btn {
            aspect-ratio: 1;
            background: var(--bg-light);
            border: 2px solid var(--bg-lighter);
            border-radius: 8px;
            font-size: 14px;
            font-weight: 700;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.15s;
        }

        .var-btn:hover {
            border-color: var(--secondary);
            color: var(--secondary);
        }

        .var-btn.active {
            background: var(--secondary);
            color: var(--bg-dark);
            border-color: var(--secondary);
        }

        /* Center Panel */
        .center-panel {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        /* Current Chord Display */
        .chord-display {
            height: auto;
            min-height: 100px;
            background: linear-gradient(135deg, var(--bg-medium) 0%, var(--bg-light) 50%);
            border-radius: 16px;
            border: 2px solid var(--bg-lighter);
            display: flex;
            flex-direction: column;
            padding: 10px;
            position: relative;
            overflow: hidden;
        }
        
        .chord-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            z-index: 10;
        }
        
        .instrument-select {
            background: var(--bg-dark);
            color: var(--primary);
            border: 2px solid var(--primary);
            border-radius: 10px;
            padding: 5px 10px;
            font-size: 12px;
            cursor: pointer;
            outline: none;
            transition: all 0.2s;
            font-family: inherit;
        }
        
        .instrument-select:hover {
            background: rgba(0, 255, 136, 0.1);
        }
        
        .chord-velocity-control {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .chord-velocity-control label {
            color: var(--accent);
            font-size: 11px;
            font-weight: 600;
        }
        
        .chord-velocity-control input {
            width: 60px;
            height: 4px;
        }
        
        .chord-velocity-control span {
            color: var(--primary);
            font-size: 11px;
            font-weight: 700;
            min-width: 25px;
        }

        .chord-display::before {
            content: '';
            position: absolute;
            top: -100%;
            left: -100%;
            width: 300%;
            height: 300%;
            background: radial-gradient(circle, rgba(0, 255, 136, 0.1) 0%, transparent 70%);
            animation: chordGlow 4s ease-in-out infinite;
        }

        @keyframes chordGlow {
            0%, 100% { transform: rotate(0deg); }
            50% { transform: rotate(180deg); }
        }

        .chord-text {
            font-size: 36px;
            font-weight: 900;
            background: linear-gradient(135deg, var(--primary) 0%, var(--accent) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            z-index: 1;
            margin: 5px 0;
        }

        /* Chord Pads */
        .chord-grid-container {
            flex: 1;
            background: var(--bg-medium);
            border-radius: 16px;
            border: 1px solid var(--bg-lighter);
            padding: 15px;
        }

        .chord-grid {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            grid-template-rows: repeat(4, 1fr);
            gap: 8px;
            height: 100%;
        }

        .chord-pad {
            background: linear-gradient(145deg, var(--bg-light) 0%, var(--bg-lighter) 100%);
            border: 2px solid var(--bg-lighter);
            border-radius: 10px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.15s;
        }

        .chord-pad:hover {
            transform: translateY(-2px);
            border-color: var(--primary);
            box-shadow: 0 4px 12px rgba(0, 255, 136, 0.2);
        }

        .chord-pad.active {
            background: linear-gradient(135deg, var(--primary) 0%, var(--accent) 100%);
            border-color: var(--primary);
            transform: scale(0.95);
        }

        .chord-name {
            font-size: 20px;
            font-weight: 700;
            color: var(--text-primary);
        }

        .chord-type {
            font-size: 10px;
            color: var(--text-dim);
            margin-top: 2px;
            text-transform: uppercase;
        }

        .chord-pad.active .chord-name,
        .chord-pad.active .chord-type {
            color: var(--bg-dark);
        }
        
        /* Harmony coloring based on circle of fifths */
        .chord-pad.harmony-perfect {
            background: linear-gradient(145deg, rgba(0, 255, 0, 0.2) 0%, rgba(0, 255, 0, 0.1) 100%) !important;
            border-color: rgba(0, 255, 0, 0.8) !important;
            box-shadow: 0 0 10px rgba(0, 255, 0, 0.3);
        }
        
        .chord-pad.harmony-good {
            background: linear-gradient(145deg, rgba(255, 255, 0, 0.2) 0%, rgba(255, 255, 0, 0.1) 100%) !important;
            border-color: rgba(255, 255, 0, 0.8) !important;
            box-shadow: 0 0 10px rgba(255, 255, 0, 0.3);
        }
        
        .chord-pad.harmony-clash {
            background: linear-gradient(145deg, rgba(255, 0, 0, 0.2) 0%, rgba(255, 0, 0, 0.1) 100%) !important;
            border-color: rgba(255, 0, 0, 0.8) !important;
            box-shadow: 0 0 10px rgba(255, 0, 0, 0.3);
        }

        /* Pattern Sequencer */
        .pattern-container {
            background: var(--bg-medium);
            border-radius: 16px;
            border: 1px solid var(--bg-lighter);
            padding: 15px;
        }

        .pattern-grid {
            display: grid;
            grid-template-rows: repeat(4, 30px);
            gap: 4px;
        }

        .pattern-row {
            display: grid;
            grid-template-columns: repeat(16, 1fr);
            gap: 2px;
        }

        .pattern-cell {
            background: var(--bg-light);
            border: 1px solid var(--bg-lighter);
            border-radius: 3px;
            cursor: pointer;
            transition: all 0.1s;
            position: relative;
        }

        .pattern-cell:hover {
            background: var(--bg-lighter);
            border-color: var(--primary);
        }

        .pattern-cell.active {
            background: var(--primary);
            border-color: var(--primary);
        }

        .pattern-cell.playing {
            background: var(--accent) !important;
            border-color: var(--accent) !important;
            animation: beatPulse 0.1s;
        }

        @keyframes beatPulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.2); }
            100% { transform: scale(1); }
        }

        /* Beat markers */
        .pattern-cell:nth-child(4n+1) {
            border-left: 2px solid var(--accent);
        }

        /* Right Panel - Launchpad */
        .right-panel {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        /* Transport */
        .transport-container {
            background: var(--bg-medium);
            border-radius: 16px;
            padding: 20px;
            display: flex;
            justify-content: center;
            gap: 15px;
        }

        .transport-btn {
            width: 70px;
            height: 70px;
            background: var(--bg-light);
            border: 3px solid var(--bg-lighter);
            border-radius: 50%;
            font-size: 28px;
            cursor: pointer;
            transition: all 0.15s;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-secondary);
        }

        .transport-btn:hover {
            transform: scale(1.1);
            border-color: var(--primary);
        }

        #playBtn {
            background: linear-gradient(135deg, var(--primary) 0%, var(--accent) 100%);
            color: var(--bg-dark);
            border-color: var(--primary);
        }

        #playBtn.playing {
            background: linear-gradient(135deg, var(--warning) 0%, var(--danger) 100%);
            animation: playingPulse 1s infinite;
        }

        @keyframes playingPulse {
            0%, 100% { box-shadow: 0 0 15px rgba(255, 136, 0, 0.4); }
            50% { box-shadow: 0 0 25px rgba(255, 136, 0, 0.6); }
        }

        #stopBtn:hover {
            background: var(--danger);
            border-color: var(--danger);
            color: white;
        }

        #recBtn.recording {
            background: var(--danger);
            border-color: var(--danger);
            color: white;
            animation: recPulse 1s infinite;
        }

        @keyframes recPulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }

        /* Launchpad View */
        .launchpad-container {
            background: var(--bg-medium);
            border-radius: 16px;
            padding: 15px;
            flex: 1;
        }

        /* Top buttons */
        .lp-top-buttons {
            display: grid;
            grid-template-columns: repeat(8, 1fr);
            gap: 4px;
            margin-bottom: 10px;
        }

        .lp-top-btn {
            padding: 6px;
            background: var(--bg-light);
            border: 2px solid var(--bg-lighter);
            border-radius: 6px;
            font-size: 9px;
            font-weight: 700;
            color: var(--text-dim);
            cursor: pointer;
            text-align: center;
            transition: all 0.1s;
        }

        .lp-top-btn:hover {
            border-color: var(--primary);
            color: var(--primary);
        }

        .lp-top-btn.active {
            background: var(--primary);
            border-color: var(--primary);
            color: var(--bg-dark);
        }

        /* Main launchpad area */
        .lp-main-area {
            display: flex;
            gap: 8px;
        }

        .lp-grid {
            display: grid;
            grid-template-columns: repeat(8, 1fr);
            grid-template-rows: repeat(8, 1fr);
            gap: 3px;
            aspect-ratio: 1;
            flex: 1;
        }

        .lp-pad {
            background: var(--bg-light);
            border: 1px solid var(--bg-lighter);
            border-radius: 4px;
            transition: all 0.1s;
            cursor: pointer;
            position: relative;
        }

        .lp-pad::after {
            content: '';
            position: absolute;
            inset: 2px;
            border-radius: 2px;
            opacity: 0;
            transition: opacity 0.1s;
        }

        .lp-pad.active::after {
            opacity: 1;
        }

        /* Launchpad pad colors */
        .lp-pad[data-color="red"] { background: var(--lp-red) !important; }
        .lp-pad[data-color="orange"] { background: var(--lp-orange) !important; }
        .lp-pad[data-color="amber"] { background: var(--lp-amber) !important; }
        .lp-pad[data-color="yellow"] { background: var(--lp-yellow) !important; }
        .lp-pad[data-color="lime"] { background: var(--lp-lime) !important; }
        .lp-pad[data-color="green"] { background: var(--lp-green) !important; }
        .lp-pad[data-color="turquoise"] { background: var(--lp-turquoise) !important; }
        .lp-pad[data-color="cyan"] { background: var(--lp-cyan) !important; }
        .lp-pad[data-color="sky"] { background: var(--lp-sky) !important; }
        .lp-pad[data-color="blue"] { background: var(--lp-blue) !important; }
        .lp-pad[data-color="orchid"] { background: var(--lp-orchid) !important; }
        .lp-pad[data-color="purple"] { background: var(--lp-purple) !important; }
        .lp-pad[data-color="pink"] { background: var(--lp-pink) !important; }
        .lp-pad[data-color="magenta"] { background: var(--lp-magenta) !important; }
        .lp-pad[data-color="white"] { background: var(--lp-white) !important; }

        .lp-pad.playing {
            animation: padFlash 0.1s;
        }

        @keyframes padFlash {
            0% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.2); opacity: 0.8; }
            100% { transform: scale(1); opacity: 1; }
        }

        /* Right buttons */
        .lp-right-buttons {
            display: flex;
            flex-direction: column;
            gap: 3px;
            width: 35px;
        }

        .lp-right-btn {
            aspect-ratio: 1;
            background: var(--bg-light);
            border: 2px solid var(--bg-lighter);
            border-radius: 50%;
            font-size: 8px;
            font-weight: 700;
            color: var(--text-dim);
            cursor: pointer;
            transition: all 0.1s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .lp-right-btn:hover {
            border-color: var(--primary);
            transform: scale(1.1);
        }

        .lp-right-btn.active {
            background: var(--primary);
            border-color: var(--primary);
            color: var(--bg-dark);
        }

        .lp-right-btn[data-function="play"] { 
            background: var(--success) !important; 
            border-color: var(--success) !important; 
            color: white !important;
        }
        .lp-right-btn[data-function="play"].active { 
            background: var(--warning) !important; 
            border-color: var(--warning) !important; 
            animation: playingPulse 1s infinite;
        }
        .lp-right-btn[data-function="stop"] { 
            background: var(--danger) !important; 
            border-color: var(--danger) !important; 
            color: white !important;
        }

        /* Controls */
        .controls-container {
            background: var(--bg-medium);
            border-radius: 16px;
            padding: 15px;
        }

        .controls-row {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
        }

        .control-item {
            text-align: center;
        }

        .control-knob {
            width: 50px;
            height: 50px;
            background: radial-gradient(circle at 30% 30%, var(--bg-lighter) 0%, var(--bg-light) 100%);
            border: 3px solid var(--bg-lighter);
            border-radius: 50%;
            margin: 0 auto 6px;
            position: relative;
            cursor: ew-resize;
            transition: all 0.15s;
        }

        .control-knob:hover {
            border-color: var(--primary);
        }

        .control-indicator {
            position: absolute;
            top: 6px;
            left: 50%;
            transform: translateX(-50%);
            width: 3px;
            height: 18px;
            background: var(--primary);
            border-radius: 2px;
            pointer-events: none;
        }

        .control-label {
            font-size: 10px;
            color: var(--text-dim);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .control-value {
            font-size: 14px;
            font-weight: 700;
            color: var(--primary);
            margin-top: 2px;
        }

        /* Loading */
        .loading {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--bg-dark);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            transition: opacity 0.3s;
        }

        .loading.hidden {
            opacity: 0;
            pointer-events: none;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 3px solid var(--bg-lighter);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Message Toast */
        .toast {
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(135deg, var(--primary) 0%, var(--accent) 100%);
            color: var(--bg-dark);
            padding: 12px 24px;
            border-radius: 25px;
            font-weight: 700;
            font-size: 14px;
            z-index: 5000;
            box-shadow: 0 5px 15px rgba(0, 255, 136, 0.3);
            animation: slideUp 0.3s ease;
        }

        @keyframes slideUp {
            from { transform: translate(-50%, 100px); opacity: 0; }
            to { transform: translate(-50%, 0); opacity: 1; }
        }

        /* Fullscreen adjustments */
        :fullscreen .app-container,
        :-webkit-full-screen .app-container,
        :-moz-full-screen .app-container,
        :-ms-fullscreen .app-container {
            height: 100vh;
            width: 100vw;
        }

        :fullscreen .header,
        :-webkit-full-screen .header,
        :-moz-full-screen .header,
        :-ms-fullscreen .header {
            padding: 0 20px;
            height: 60px;
        }

        :fullscreen .main-content,
        :-webkit-full-screen .main-content,
        :-moz-full-screen .main-content,
        :-ms-fullscreen .main-content {
            padding: 15px;
            height: calc(100vh - 60px);
        }

        /* Landscape optimization for tablets */
        @media (orientation: landscape) and (max-width: 1366px) {
            .app-container {
                grid-template-rows: 60px 1fr;
            }
            
            .header {
                padding: 0 15px;
            }
            
            .main-content {
                grid-template-columns: 220px 1fr 320px;
                gap: 15px;
                padding: 15px;
            }
            
            .chord-display {
                height: 100px;
            }
            
            .chord-text {
                font-size: 48px;
            }
        }

        /* Hide scrollbars in fullscreen */
        :fullscreen *::-webkit-scrollbar,
        :-webkit-full-screen *::-webkit-scrollbar,
        :-moz-full-screen *::-webkit-scrollbar,
        :-ms-fullscreen *::-webkit-scrollbar {
            display: none;
        }

        :fullscreen *,
        :-webkit-full-screen *,
        :-moz-full-screen *,
        :-ms-fullscreen * {
            scrollbar-width: none;
        }
        /* Voice to MIDI Styles */
        .voice-controls {
            padding: 15px 10px;
        }
        
        .voice-control-group {
            margin-bottom: 20px;
        }
        
        .voice-control-group .control-label {
            display: block;
            color: var(--accent);
            font-size: 11px;
            font-weight: 600;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .voice-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 10px;
        }
        
        .voice-btn {
            background: linear-gradient(135deg, var(--bg-medium) 0%, var(--bg-light) 100%);
            border: 2px solid var(--bg-lighter);
            color: var(--text-primary);
            padding: 8px 12px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
        }
        
        .voice-btn:hover:not(:disabled) {
            background: linear-gradient(135deg, var(--primary) 0%, var(--accent) 100%);
            border-color: var(--primary);
            color: var(--bg-dark);
            transform: translateY(-2px);
        }
        
        .voice-btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }
        
        .voice-btn.active {
            background: linear-gradient(135deg, var(--primary) 0%, var(--accent) 100%);
            border-color: var(--primary);
            color: var(--bg-dark);
        }
        
        .voice-status {
            text-align: center;
            padding: 8px;
            background: var(--bg-medium);
            border-radius: 8px;
            font-size: 11px;
            color: var(--text-secondary);
            transition: all 0.3s;
        }
        
        .voice-status.active {
            background: linear-gradient(135deg, rgba(0, 255, 136, 0.1) 0%, rgba(0, 170, 255, 0.1) 100%);
            color: var(--primary);
            animation: voicePulse 2s infinite;
        }
        
        .tone-select, .voice-select {
            width: 100%;
            padding: 8px;
            background: var(--bg-medium);
            border: 2px solid var(--bg-lighter);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
            margin-bottom: 8px;
        }
        
        .tone-select:hover, .voice-select:hover {
            border-color: var(--primary);
            background: var(--bg-light);
        }
        
        .tone-select option, .voice-select option {
            background: var(--bg-dark);
            color: var(--text-primary);
        }
        
        .tone-select optgroup, .voice-select optgroup {
            background: var(--bg-medium);
            color: var(--accent);
            font-weight: 600;
        }
        
        .voice-sliders {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .voice-slider-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .voice-slider-item label {
            color: var(--text-secondary);
            font-size: 11px;
            min-width: 60px;
        }
        
        .voice-slider-item input[type="range"] {
            flex: 1;
            height: 4px;
            background: var(--bg-medium);
            border-radius: 2px;
            outline: none;
            -webkit-appearance: none;
        }
        
        .voice-slider-item input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 12px;
            height: 12px;
            background: var(--primary);
            border-radius: 50%;
            cursor: pointer;
        }
        
        .voice-slider-item span {
            color: var(--primary);
            font-size: 11px;
            font-weight: 700;
            min-width: 30px;
            text-align: right;
        }
        
        .voice-pitch-display {
            background: linear-gradient(135deg, var(--bg-medium) 0%, var(--bg-light) 100%);
            border-radius: 12px;
            padding: 15px;
            text-align: center;
            border: 2px solid var(--bg-lighter);
        }
        
        .voice-pitch-note {
            font-size: 32px;
            font-weight: 900;
            background: linear-gradient(135deg, var(--primary) 0%, var(--accent) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .voice-pitch-info {
            display: flex;
            justify-content: space-around;
            margin-top: 10px;
            font-size: 11px;
            color: var(--text-secondary);
        }
        
        @keyframes voicePulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
    </style>
</head>
<body>
    <div class="loading" id="loading">
        <div class="spinner"></div>
    </div>

    <div class="app-container">
        <!-- Header -->
        <header class="header">
            <h1 class="logo">CTK V8 REVISED</h1>
            
            <div class="status-group">
                <div class="status-item">
                    <span class="status-label">Style</span>
                    <span class="status-value" id="styleDisplay">8 BEAT</span>
                </div>
                <div class="status-item">
                    <span class="status-label">Section</span>
                    <span class="status-value" id="sectionDisplay">MAIN</span>
                </div>
                <div class="status-item">
                    <span class="status-label">Variation</span>
                    <span class="status-value" id="varDisplay">A</span>
                </div>
                <div class="status-item" id="bassStatus" style="display: none;">
                    <span class="status-label">Bass</span>
                    <span class="status-value" id="bassDisplay">ACOUSTIC</span>
                </div>
            </div>
            
            <div class="tempo-controls">
                <button class="tempo-btn" onclick="changeTempo(-1)">‚àí</button>
                <div class="tempo-display" id="tempoDisplay">120</div>
                <button class="tempo-btn" onclick="changeTempo(1)">+</button>
            </div>
            
            <button class="tap-btn" onclick="tapTempo()">TAP</button>
            
            <div class="midi-status">
                <div class="midi-device">
                    <span class="midi-led" id="ctkLed"></span>
                    <span>CTK-3200</span>
                </div>
                <div class="midi-device">
                    <span class="midi-led" id="lpLed"></span>
                    <span>LAUNCHPAD</span>
                </div>
            </div>
            
            <button class="connect-btn" onclick="connectMIDI()">CONNECT</button>
            <button class="fullscreen-btn" onclick="toggleFullscreen()" title="Fullscreen (F)">‚§¢</button>
        </header>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Left Panel -->
            <aside class="left-panel">
                <!-- Style Selection -->
                <div class="panel-section">
                    <div class="section-title">RHYTHM STYLES</div>
                    <div class="style-grid" id="styleGrid"></div>
                </div>
                
                <!-- Sections -->
                <div class="panel-section">
                    <div class="section-title">SECTIONS</div>
                    <div class="section-grid" id="sectionGrid"></div>
                </div>
                
                <!-- Variations -->
                <div class="panel-section">
                    <div class="section-title">VARIATIONS</div>
                    <div class="variation-row" id="variationRow"></div>
                </div>
                
                <!-- Voice to MIDI Section -->
                <div class="panel-section" id="voiceToMidiSection">
                    <div class="section-title">VOICE TO MIDI</div>
                    
                    <div class="voice-controls">
                        <!-- Main Controls -->
                        <div class="voice-control-group">
                            <label class="control-label">Contr√¥les</label>
                            <div class="voice-buttons">
                                <button class="voice-btn" id="voiceStartBtn">
                                    <span>üéôÔ∏è D√©marrer</span>
                                </button>
                                <button class="voice-btn" id="voiceStopBtn" disabled>
                                    <span>‚èπÔ∏è Arr√™ter</span>
                                </button>
                            </div>
                            <div id="voiceStatus" class="voice-status inactive">
                                ‚ö´ Inactif
                            </div>
                        </div>
                        
                        <!-- Tone Selector -->
                        <div class="voice-control-group">
                            <label class="control-label">Tonalit√©</label>
                            <select id="voiceToneSelect" class="tone-select">
                                <option value="0">Chargement...</option>
                            </select>
                        </div>
                        
                        <!-- MIDI Effects -->
                        <div class="voice-control-group">
                            <label class="control-label">Effets MIDI</label>
                            <div class="voice-sliders">
                                <div class="voice-slider-item">
                                    <label>Reverb</label>
                                    <input type="range" id="voiceReverb" min="0" max="127" value="40">
                                    <span id="voiceReverbValue">40</span>
                                </div>
                                <div class="voice-slider-item">
                                    <label>Vibrato</label>
                                    <input type="range" id="voiceVibrato" min="0" max="127" value="0">
                                    <span id="voiceVibratoValue">0</span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Mode & Scale -->
                        <div class="voice-control-group">
                            <label class="control-label">Mode et Gamme</label>
                            <select id="voicePlayMode" class="voice-select">
                                <option value="single">Note seule</option>
                                <option value="major">Accord majeur</option>
                                <option value="minor">Accord mineur</option>
                                <option value="arp3">Arp√®ge 3 notes</option>
                                <option value="arp4">Arp√®ge 4 notes</option>
                            </select>
                            <select id="voiceScale" class="voice-select">
                                <option value="chromatic">Chromatique</option>
                                <optgroup label="Gammes majeures">
                                    <option value="C-major">Do majeur</option>
                                    <option value="G-major">Sol majeur</option>
                                    <option value="D-major">R√© majeur</option>
                                    <option value="A-major">La majeur</option>
                                    <option value="E-major">Mi majeur</option>
                                    <option value="F-major">Fa majeur</option>
                                </optgroup>
                                <optgroup label="Gammes mineures">
                                    <option value="A-minor">La mineur</option>
                                    <option value="E-minor">Mi mineur</option>
                                    <option value="D-minor">R√© mineur</option>
                                </optgroup>
                            </select>
                        </div>
                        
                        <!-- Audio Parameters -->
                        <div class="voice-control-group">
                            <label class="control-label">Param√®tres Audio</label>
                            <div class="voice-sliders">
                                <div class="voice-slider-item">
                                    <label>Sensibilit√©</label>
                                    <input type="range" id="voiceSensitivity" min="0.1" max="0.9" step="0.1" value="0.3">
                                    <span id="voiceSensitivityValue">0.3</span>
                                </div>
                                <div class="voice-slider-item">
                                    <label>Transpose</label>
                                    <input type="range" id="voiceTranspose" min="-3" max="3" step="1" value="0">
                                    <span id="voiceTransposeValue">0</span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Pitch Display -->
                        <div class="voice-pitch-display" id="voicePitchDisplay" style="display: none;">
                            <div class="voice-pitch-note" id="voicePitchNote">--</div>
                            <div class="voice-pitch-info">
                                <span id="voicePitchFreq">-- Hz</span>
                                <span id="voicePitchConf">--%</span>
                            </div>
                        </div>
                    </div>
                </div>
            </aside>

            <!-- Center Panel -->
            <div class="center-panel">
                <!-- Current Chord Display -->
                <div class="chord-display">
                    <div class="chord-controls">
                        <select id="chordInstrument" class="instrument-select tone-select">
                            <!-- Will be populated by buildToneSelector -->
                        </select>
                        <div class="chord-velocity-control">
                            <label>Chord Vol</label>
                            <input type="range" id="chordVelocity" min="1" max="127" value="80">
                            <span id="chordVelValue">80</span>
                        </div>
                    </div>
                    <div class="chord-text" id="currentChord">C</div>
                </div>
                
                <!-- Chord Grid -->
                <div class="chord-grid-container">
                    <div class="chord-grid" id="chordGrid"></div>
                </div>
                
                <!-- Pattern Sequencer -->
                <div class="pattern-container">
                    <div class="section-title">PATTERN SEQUENCER</div>
                    <div class="pattern-grid" id="patternGrid"></div>
                </div>
            </div>

            <!-- Right Panel -->
            <aside class="right-panel">
                <!-- Transport -->
                <div class="transport-container">
                    <button class="transport-btn" id="stopBtn" onclick="stopPlayback()">‚óº</button>
                    <button class="transport-btn" id="playBtn" onclick="togglePlay()">‚ñ∂</button>
                    <button class="transport-btn" id="recBtn" onclick="toggleRecord()">‚óè</button>
                </div>
                
                <!-- Launchpad View -->
                <div class="launchpad-container">
                    <div class="section-title">LAUNCHPAD MK2</div>
                    
                    <!-- Top buttons -->
                    <div class="lp-top-buttons" id="lpTopButtons"></div>
                    
                    <!-- Main area -->
                    <div class="lp-main-area">
                        <!-- 8x8 Grid -->
                        <div class="lp-grid" id="lpGrid"></div>
                        
                        <!-- Right buttons -->
                        <div class="lp-right-buttons" id="lpRightButtons"></div>
                    </div>
                </div>
                
                <!-- Controls -->
                <div class="controls-container">
                    <div class="controls-row">
                        <div class="control-item">
                            <div class="control-label">Swing</div>
                            <div class="control-knob" id="swingKnob" data-value="50" data-min="0" data-max="100">
                                <div class="control-indicator"></div>
                            </div>
                            <div class="control-value" id="swingValue">50%</div>
                        </div>
                        
                        <div class="control-item">
                            <div class="control-label">Velocity</div>
                            <div class="control-knob" id="velocityKnob" data-value="100" data-min="1" data-max="127">
                                <div class="control-indicator"></div>
                            </div>
                            <div class="control-value" id="velocityValue">100</div>
                        </div>
                        
                        <div class="control-item">
                            <div class="control-label">Humanize</div>
                            <div class="control-knob" id="humanizeKnob" data-value="0" data-min="0" data-max="100">
                                <div class="control-indicator"></div>
                            </div>
                            <div class="control-value" id="humanizeValue">0%</div>
                        </div>
                    </div>
                </div>
            </aside>
        </main>
    </div>

    <script>
        // ==========================================
        // CTK-3200 COMPLETE TONE DATA (414 Tones)
        // ==========================================
        const CTK3200_TONES = [
            // PIANO (001-014)
            { id: 1, name: 'STEREO GRAND PIANO', category: 'PIANO', pc: 0, msb: 2 },
            { id: 2, name: 'GRAND PIANO', category: 'PIANO', pc: 0, msb: 1 },
            { id: 3, name: 'BRIGHT PIANO', category: 'PIANO', pc: 1, msb: 2 },
            { id: 4, name: 'MODERN PIANO', category: 'PIANO', pc: 1, msb: 3 },
            { id: 5, name: 'DANCE PIANO', category: 'PIANO', pc: 1, msb: 1 },
            { id: 6, name: 'MELLOW PIANO', category: 'PIANO', pc: 0, msb: 3 },
            { id: 7, name: 'STRINGS PIANO', category: 'PIANO', pc: 0, msb: 8 },
            { id: 8, name: 'HONKY-TONK', category: 'PIANO', pc: 3, msb: 2 },
            { id: 9, name: 'OCTAVE PIANO', category: 'PIANO', pc: 3, msb: 9 },
            { id: 10, name: 'ELEC.GRAND PIANO', category: 'PIANO', pc: 2, msb: 2 },
            { id: 11, name: 'MODERN E.G.PIANO', category: 'PIANO', pc: 2, msb: 3 },
            { id: 12, name: 'HARPSICHORD', category: 'PIANO', pc: 6, msb: 2 },
            { id: 13, name: 'COUPLED HARPSICHORD', category: 'PIANO', pc: 6, msb: 8 },
            { id: 14, name: 'HARPSICHORD & STRINGS', category: 'PIANO', pc: 6, msb: 1 },
            
            // ELECTRIC PIANO (015-028)
            { id: 15, name: 'ELEC.PIANO', category: 'ELECTRIC PIANO', pc: 4, msb: 2 },
            { id: 16, name: 'FM E.PIANO', category: 'ELECTRIC PIANO', pc: 5, msb: 5 },
            { id: 17, name: "60's E.PIANO", category: 'ELECTRIC PIANO', pc: 4, msb: 5 },
            { id: 18, name: 'CHORUS E.PIANO 1', category: 'ELECTRIC PIANO', pc: 4, msb: 9 },
            { id: 19, name: 'CHORUS E.PIANO 2', category: 'ELECTRIC PIANO', pc: 4, msb: 6 },
            { id: 20, name: 'MODERN E.PIANO', category: 'ELECTRIC PIANO', pc: 5, msb: 2 },
            { id: 21, name: 'SOFT E.PIANO', category: 'ELECTRIC PIANO', pc: 4, msb: 8 },
            { id: 22, name: 'SYNTH-STR.E.PIANO', category: 'ELECTRIC PIANO', pc: 4, msb: 3 },
            { id: 23, name: 'CLEAN E.PIANO', category: 'ELECTRIC PIANO', pc: 4, msb: 4 },
            { id: 24, name: 'CLAVI 1', category: 'ELECTRIC PIANO', pc: 7, msb: 2 },
            { id: 25, name: 'CLAVI 2', category: 'ELECTRIC PIANO', pc: 7, msb: 3 },
            { id: 26, name: 'SOFT CLAVI', category: 'ELECTRIC PIANO', pc: 7, msb: 1 },
            { id: 27, name: 'DETUNE CLAVI', category: 'ELECTRIC PIANO', pc: 7, msb: 8 },
            { id: 28, name: 'SEQUENCE CLAVI', category: 'ELECTRIC PIANO', pc: 7, msb: 9 },
            
            // CHROMATIC PERC. (029-042)
            { id: 29, name: 'VIBRAPHONE 1', category: 'CHROMATIC PERC', pc: 11, msb: 2 },
            { id: 30, name: 'VIBRAPHONE 2', category: 'CHROMATIC PERC', pc: 11, msb: 1 },
            { id: 31, name: 'SOFT VIBRAPHONE 1', category: 'CHROMATIC PERC', pc: 11, msb: 3 },
            { id: 32, name: 'SOFT VIBRAPHONE 2', category: 'CHROMATIC PERC', pc: 11, msb: 4 },
            { id: 33, name: 'MARIMBA', category: 'CHROMATIC PERC', pc: 12, msb: 2 },
            { id: 34, name: 'SOFT MARIMBA', category: 'CHROMATIC PERC', pc: 12, msb: 1 },
            { id: 35, name: 'CELESTA 1', category: 'CHROMATIC PERC', pc: 8, msb: 2 },
            { id: 36, name: 'CELESTA 2', category: 'CHROMATIC PERC', pc: 8, msb: 1 },
            { id: 37, name: 'GLOCKENSPIEL', category: 'CHROMATIC PERC', pc: 9, msb: 2 },
            { id: 38, name: 'MUSIC BOX 1', category: 'CHROMATIC PERC', pc: 10, msb: 2 },
            { id: 39, name: 'MUSIC BOX 2', category: 'CHROMATIC PERC', pc: 10, msb: 1 },
            { id: 40, name: 'XYLOPHONE', category: 'CHROMATIC PERC', pc: 13, msb: 2 },
            { id: 41, name: 'TUBULAR BELL', category: 'CHROMATIC PERC', pc: 14, msb: 2 },
            { id: 42, name: 'DULCIMER', category: 'CHROMATIC PERC', pc: 15, msb: 2 },
            
            // ORGAN (043-068)
            { id: 43, name: 'DRAWBAR ORGAN 1', category: 'ORGAN', pc: 16, msb: 2 },
            { id: 44, name: 'DRAWBAR ORGAN 2', category: 'ORGAN', pc: 16, msb: 1 },
            { id: 45, name: 'PERC.ORGAN 1', category: 'ORGAN', pc: 17, msb: 2 },
            { id: 46, name: 'PERC.ORGAN 2', category: 'ORGAN', pc: 17, msb: 3 },
            { id: 47, name: 'ELEC.ORGAN 1', category: 'ORGAN', pc: 16, msb: 8 },
            { id: 48, name: 'ELEC.ORGAN 2', category: 'ORGAN', pc: 16, msb: 4 },
            { id: 49, name: 'JAZZ ORGAN 1', category: 'ORGAN', pc: 17, msb: 4 },
            { id: 50, name: 'JAZZ ORGAN 2', category: 'ORGAN', pc: 17, msb: 6 },
            { id: 51, name: 'ROCK ORGAN 1', category: 'ORGAN', pc: 18, msb: 2 },
            { id: 52, name: 'ROCK ORGAN 2', category: 'ORGAN', pc: 18, msb: 1 },
            { id: 53, name: 'FULL DRAWBAR', category: 'ORGAN', pc: 16, msb: 9 },
            { id: 54, name: 'CLICK ORGAN', category: 'ORGAN', pc: 18, msb: 7 },
            { id: 55, name: "8'ORGAN", category: 'ORGAN', pc: 17, msb: 5 },
            { id: 56, name: 'CHURCH ORGAN 1', category: 'ORGAN', pc: 19, msb: 2 },
            { id: 57, name: 'CHURCH ORGAN 2', category: 'ORGAN', pc: 19, msb: 3 },
            { id: 58, name: 'CHAPEL ORGAN', category: 'ORGAN', pc: 19, msb: 8 },
            { id: 59, name: 'THEATER ORGAN', category: 'ORGAN', pc: 19, msb: 6 },
            { id: 60, name: 'REED ORGAN', category: 'ORGAN', pc: 20, msb: 2 },
            { id: 61, name: 'ACCORDION 1', category: 'ORGAN', pc: 21, msb: 2 },
            { id: 62, name: 'ACCORDION 2', category: 'ORGAN', pc: 21, msb: 3 },
            { id: 63, name: 'BANDONEON 1', category: 'ORGAN', pc: 23, msb: 2 },
            { id: 64, name: 'BANDONEON 2', category: 'ORGAN', pc: 23, msb: 1 },
            { id: 65, name: 'HARMONICA 1', category: 'ORGAN', pc: 22, msb: 2 },
            { id: 66, name: 'HARMONICA 2', category: 'ORGAN', pc: 22, msb: 8 },
            { id: 67, name: 'HARMONIUM 1', category: 'ORGAN', pc: 20, msb: 8 },
            { id: 68, name: 'HARMONIUM 2', category: 'ORGAN', pc: 20, msb: 9 },
            
            // GUITAR (069-082)
            { id: 69, name: 'NYLON STR.GUITAR', category: 'GUITAR', pc: 24, msb: 2 },
            { id: 70, name: 'STEEL STR.GUITAR', category: 'GUITAR', pc: 25, msb: 2 },
            { id: 71, name: '12 STR.GUITAR', category: 'GUITAR', pc: 25, msb: 8 },
            { id: 72, name: 'CHORUS STEEL GT', category: 'GUITAR', pc: 25, msb: 9 },
            { id: 73, name: 'JAZZ GUITAR', category: 'GUITAR', pc: 26, msb: 2 },
            { id: 74, name: 'OCT.JAZZ GUITAR', category: 'GUITAR', pc: 26, msb: 8 },
            { id: 75, name: 'CLEAN GUITAR 1', category: 'GUITAR', pc: 27, msb: 2 },
            { id: 76, name: 'CLEAN GUITAR 2', category: 'GUITAR', pc: 27, msb: 1 },
            { id: 77, name: 'MUTE GUITAR', category: 'GUITAR', pc: 28, msb: 2 },
            { id: 78, name: 'OVERDRIVE GT', category: 'GUITAR', pc: 29, msb: 2 },
            { id: 79, name: 'DISTORTION GT', category: 'GUITAR', pc: 30, msb: 2 },
            { id: 80, name: 'POWER DIST.GT', category: 'GUITAR', pc: 30, msb: 5 },
            { id: 81, name: 'FEEDBACK GT', category: 'GUITAR', pc: 31, msb: 8 },
            { id: 82, name: 'DIST.GT & BASS', category: 'GUITAR', pc: 30, msb: 6 },
            
            // BASS (083-094)
            { id: 83, name: 'ACOUSTIC BASS', category: 'BASS', pc: 32, msb: 2 },
            { id: 84, name: 'RIDE BASS', category: 'BASS', pc: 32, msb: 32 },
            { id: 85, name: 'FINGERED BASS', category: 'BASS', pc: 33, msb: 2 },
            { id: 86, name: 'PICKED BASS', category: 'BASS', pc: 34, msb: 2 },
            { id: 87, name: 'FRETLESS BASS', category: 'BASS', pc: 35, msb: 2 },
            { id: 88, name: 'SLAP BASS', category: 'BASS', pc: 37, msb: 2 },
            { id: 89, name: 'SAW SYNTH-BASS', category: 'BASS', pc: 38, msb: 2 },
            { id: 90, name: 'SQUARE SYNTH-BASS', category: 'BASS', pc: 39, msb: 2 },
            { id: 91, name: 'DIGI ROCK BASS', category: 'BASS', pc: 39, msb: 1 },
            { id: 92, name: 'TRANCE BASS', category: 'BASS', pc: 38, msb: 4 },
            { id: 93, name: 'SINE BASS', category: 'BASS', pc: 39, msb: 6 },
            { id: 94, name: 'BASS & KICK', category: 'BASS', pc: 39, msb: 3 },
            
            // STR/ORCHESTRA (095-106)
            { id: 95, name: 'VIOLIN', category: 'STR/ORCHESTRA', pc: 40, msb: 2 },
            { id: 96, name: 'SLOW VIOLIN', category: 'STR/ORCHESTRA', pc: 40, msb: 8 },
            { id: 97, name: 'VIOLA', category: 'STR/ORCHESTRA', pc: 41, msb: 2 },
            { id: 98, name: 'CELLO', category: 'STR/ORCHESTRA', pc: 42, msb: 2 },
            { id: 99, name: 'SLOW CELLO', category: 'STR/ORCHESTRA', pc: 42, msb: 1 },
            { id: 100, name: 'CONTRABASS', category: 'STR/ORCHESTRA', pc: 43, msb: 2 },
            { id: 101, name: 'VIOLIN & CELLO', category: 'STR/ORCHESTRA', pc: 40, msb: 3 },
            { id: 102, name: 'CELLO SECTION', category: 'STR/ORCHESTRA', pc: 42, msb: 4 },
            { id: 103, name: 'PIZZICATO STRINGS', category: 'STR/ORCHESTRA', pc: 45, msb: 2 },
            { id: 104, name: 'HARP 1', category: 'STR/ORCHESTRA', pc: 46, msb: 2 },
            { id: 105, name: 'CHORUS HARP', category: 'STR/ORCHESTRA', pc: 46, msb: 8 },
            { id: 106, name: 'HARP 2', category: 'STR/ORCHESTRA', pc: 46, msb: 1 },
            
            // ENSEMBLE (107-126)
            { id: 107, name: 'STRINGS', category: 'ENSEMBLE', pc: 48, msb: 2 },
            { id: 108, name: 'SLOW STRINGS', category: 'ENSEMBLE', pc: 49, msb: 2 },
            { id: 109, name: 'WIDE STRINGS', category: 'ENSEMBLE', pc: 48, msb: 16 },
            { id: 110, name: 'CHAMBER', category: 'ENSEMBLE', pc: 48, msb: 3 },
            { id: 111, name: 'OCTAVE STRINGS', category: 'ENSEMBLE', pc: 48, msb: 32 },
            { id: 112, name: 'STRINGS SFZ', category: 'ENSEMBLE', pc: 48, msb: 8 },
            { id: 113, name: 'TREMOLO STRINGS', category: 'ENSEMBLE', pc: 49, msb: 1 },
            { id: 114, name: 'FLUTE & STRINGS', category: 'ENSEMBLE', pc: 49, msb: 3 },
            { id: 115, name: 'CHOIR STRINGS', category: 'ENSEMBLE', pc: 52, msb: 3 },
            { id: 116, name: 'SYNTH-STRINGS 1', category: 'ENSEMBLE', pc: 50, msb: 2 },
            { id: 117, name: 'SYNTH-STRINGS 2', category: 'ENSEMBLE', pc: 51, msb: 2 },
            { id: 118, name: 'SYNTH-STRINGS 3', category: 'ENSEMBLE', pc: 51, msb: 3 },
            { id: 119, name: 'FAST SYNTH-STRINGS', category: 'ENSEMBLE', pc: 50, msb: 3 },
            { id: 120, name: 'CHOIR AAHS', category: 'ENSEMBLE', pc: 52, msb: 2 },
            { id: 121, name: 'VOICE DOO', category: 'ENSEMBLE', pc: 53, msb: 2 },
            { id: 122, name: 'SYNTH-VOICE', category: 'ENSEMBLE', pc: 54, msb: 2 },
            { id: 123, name: 'SYNTH-VOICE PAD', category: 'ENSEMBLE', pc: 54, msb: 8 },
            { id: 124, name: 'CHORUS SYNTH-VOICE', category: 'ENSEMBLE', pc: 54, msb: 9 },
            { id: 125, name: 'ORCHESTRA HIT 1', category: 'ENSEMBLE', pc: 55, msb: 2 },
            { id: 126, name: 'ORCHESTRA HIT 2', category: 'ENSEMBLE', pc: 55, msb: 1 },
            
            // BRASS (127-146)
            { id: 127, name: 'TRUMPET', category: 'BRASS', pc: 56, msb: 2 },
            { id: 128, name: 'MELLOW TRUMPET', category: 'BRASS', pc: 56, msb: 8 },
            { id: 129, name: 'TRUMPET SFZ', category: 'BRASS', pc: 56, msb: 1 },
            { id: 130, name: 'TROMBONE', category: 'BRASS', pc: 57, msb: 2 },
            { id: 131, name: 'TUBA', category: 'BRASS', pc: 58, msb: 2 },
            { id: 132, name: 'MUTE TRUMPET', category: 'BRASS', pc: 59, msb: 2 },
            { id: 133, name: 'FRENCH HORN', category: 'BRASS', pc: 60, msb: 2 },
            { id: 134, name: 'FRENCH HORN SECTION', category: 'BRASS', pc: 60, msb: 1 },
            { id: 135, name: 'BRASS', category: 'BRASS', pc: 61, msb: 2 },
            { id: 136, name: 'BRASS SECTION 1', category: 'BRASS', pc: 61, msb: 3 },
            { id: 137, name: 'BRASS SECTION 2', category: 'BRASS', pc: 61, msb: 6 },
            { id: 138, name: 'BRASS SECTION 3', category: 'BRASS', pc: 61, msb: 7 },
            { id: 139, name: 'MELLOW BRASS', category: 'BRASS', pc: 61, msb: 1 },
            { id: 140, name: 'HARD BRASS', category: 'BRASS', pc: 61, msb: 5 },
            { id: 141, name: 'BRASS SFZ', category: 'BRASS', pc: 61, msb: 8 },
            { id: 142, name: 'BRASS & STRINGS', category: 'BRASS', pc: 61, msb: 4 },
            { id: 143, name: 'SYNTH-BRASS 1', category: 'BRASS', pc: 62, msb: 2 },
            { id: 144, name: 'SYNTH-BRASS 2', category: 'BRASS', pc: 63, msb: 2 },
            { id: 145, name: 'ANALOG SYNTH-BRASS 1', category: 'BRASS', pc: 62, msb: 8 },
            { id: 146, name: 'ANALOG SYNTH-BRASS 2', category: 'BRASS', pc: 62, msb: 9 },
            
            // REED/PIPE (147-174)
            { id: 147, name: 'ALTO SAX 1', category: 'REED/PIPE', pc: 65, msb: 1 },
            { id: 148, name: 'ALTO SAX 2', category: 'REED/PIPE', pc: 65, msb: 2 },
            { id: 149, name: 'HARD A.SAX', category: 'REED/PIPE', pc: 65, msb: 3 },
            { id: 150, name: 'BREATHY A.SAX', category: 'REED/PIPE', pc: 65, msb: 8 },
            { id: 151, name: 'TENOR SAX', category: 'REED/PIPE', pc: 66, msb: 1 },
            { id: 152, name: 'SOFT T.SAX', category: 'REED/PIPE', pc: 66, msb: 5 },
            { id: 153, name: 'BREATHY T.SAX', category: 'REED/PIPE', pc: 66, msb: 8 },
            { id: 154, name: 'SOPRANO SAX 1', category: 'REED/PIPE', pc: 64, msb: 2 },
            { id: 155, name: 'SOPRANO SAX 2', category: 'REED/PIPE', pc: 64, msb: 1 },
            { id: 156, name: 'BARITONE SAX 1', category: 'REED/PIPE', pc: 67, msb: 2 },
            { id: 157, name: 'BARITONE SAX 2', category: 'REED/PIPE', pc: 67, msb: 1 },
            { id: 158, name: 'SAX SECTION', category: 'REED/PIPE', pc: 65, msb: 9 },
            { id: 159, name: 'CLARINET', category: 'REED/PIPE', pc: 71, msb: 2 },
            { id: 160, name: 'OBOE', category: 'REED/PIPE', pc: 68, msb: 2 },
            { id: 161, name: 'SOLO OBOE', category: 'REED/PIPE', pc: 68, msb: 4 },
            { id: 162, name: 'BASSOON', category: 'REED/PIPE', pc: 70, msb: 5 },
            { id: 163, name: 'FLUTE 1', category: 'REED/PIPE', pc: 73, msb: 2 },
            { id: 164, name: 'FLUTE 2', category: 'REED/PIPE', pc: 73, msb: 1 },
            { id: 165, name: 'PURE FLUTE', category: 'REED/PIPE', pc: 73, msb: 8 },
            { id: 166, name: 'PICCOLO', category: 'REED/PIPE', pc: 72, msb: 2 },
            { id: 167, name: 'RECORDER', category: 'REED/PIPE', pc: 74, msb: 2 },
            { id: 168, name: 'PAN FLUTE', category: 'REED/PIPE', pc: 75, msb: 2 },
            { id: 169, name: 'BOTTLE BLOW 1', category: 'REED/PIPE', pc: 76, msb: 2 },
            { id: 170, name: 'BOTTLE BLOW 2', category: 'REED/PIPE', pc: 76, msb: 1 },
            { id: 171, name: 'WHISTLE', category: 'REED/PIPE', pc: 78, msb: 2 },
            { id: 172, name: 'OCARINA', category: 'REED/PIPE', pc: 79, msb: 2 },
            { id: 173, name: 'SHAKUHACHI', category: 'REED/PIPE', pc: 77, msb: 2 },
            { id: 174, name: 'FLUTE & OBOE', category: 'REED/PIPE', pc: 73, msb: 3 },
            
            // SYNTH-LEAD (175-205)
            { id: 175, name: 'SQUARE LEAD 1', category: 'SYNTH-LEAD', pc: 80, msb: 2 },
            { id: 176, name: 'SQUARE LEAD 2', category: 'SYNTH-LEAD', pc: 80, msb: 3 },
            { id: 177, name: 'SQUARE LEAD 3', category: 'SYNTH-LEAD', pc: 80, msb: 1 },
            { id: 178, name: 'SAW LEAD 1', category: 'SYNTH-LEAD', pc: 81, msb: 2 },
            { id: 179, name: 'SAW LEAD 2', category: 'SYNTH-LEAD', pc: 81, msb: 1 },
            { id: 180, name: 'SAW LEAD 3', category: 'SYNTH-LEAD', pc: 81, msb: 5 },
            { id: 181, name: 'MELLOW SAW LEAD', category: 'SYNTH-LEAD', pc: 81, msb: 8 },
            { id: 182, name: 'SQUARE PULSE LEAD', category: 'SYNTH-LEAD', pc: 80, msb: 5 },
            { id: 183, name: 'SEQUENCE SAW', category: 'SYNTH-LEAD', pc: 81, msb: 32 },
            { id: 184, name: 'SEQUENCE SINE', category: 'SYNTH-LEAD', pc: 80, msb: 9 },
            { id: 185, name: 'SINE LEAD', category: 'SYNTH-LEAD', pc: 80, msb: 8 },
            { id: 186, name: 'SS LEAD', category: 'SYNTH-LEAD', pc: 81, msb: 3 },
            { id: 187, name: 'SEQUENCE SQUARE', category: 'SYNTH-LEAD', pc: 80, msb: 7 },
            { id: 188, name: 'SEQUENCE PULSE', category: 'SYNTH-LEAD', pc: 80, msb: 16 },
            { id: 189, name: 'SLOW SAW LEAD', category: 'SYNTH-LEAD', pc: 81, msb: 4 },
            { id: 190, name: 'CALLIOPE', category: 'SYNTH-LEAD', pc: 82, msb: 2 },
            { id: 191, name: 'VENT LEAD', category: 'SYNTH-LEAD', pc: 82, msb: 5 },
            { id: 192, name: 'VENT SYNTH', category: 'SYNTH-LEAD', pc: 82, msb: 1 },
            { id: 193, name: 'CHIFF LEAD', category: 'SYNTH-LEAD', pc: 83, msb: 2 },
            { id: 194, name: 'SEQUENCE LEAD 1', category: 'SYNTH-LEAD', pc: 83, msb: 5 },
            { id: 195, name: 'SEQUENCE LEAD 2', category: 'SYNTH-LEAD', pc: 83, msb: 3 },
            { id: 196, name: 'VOICE LEAD', category: 'SYNTH-LEAD', pc: 85, msb: 2 },
            { id: 197, name: 'DISTORTION LEAD', category: 'SYNTH-LEAD', pc: 84, msb: 8 },
            { id: 198, name: 'CHARANG', category: 'SYNTH-LEAD', pc: 84, msb: 2 },
            { id: 199, name: 'CHURCH LEAD', category: 'SYNTH-LEAD', pc: 85, msb: 4 },
            { id: 200, name: 'SYNTH-VOICE LEAD', category: 'SYNTH-LEAD', pc: 85, msb: 7 },
            { id: 201, name: 'FIFTH LEAD', category: 'SYNTH-LEAD', pc: 86, msb: 4 },
            { id: 202, name: 'FIFTH SAW LEAD', category: 'SYNTH-LEAD', pc: 86, msb: 2 },
            { id: 203, name: 'FIFTH SQUARE LEAD', category: 'SYNTH-LEAD', pc: 86, msb: 3 },
            { id: 204, name: 'FIFTH SEQUENCE', category: 'SYNTH-LEAD', pc: 86, msb: 1 },
            { id: 205, name: 'BASS+LEAD', category: 'SYNTH-LEAD', pc: 87, msb: 2 },
            
            // SYNTH-PAD (206-244)
            { id: 206, name: 'FANTASY 1', category: 'SYNTH-PAD', pc: 88, msb: 2 },
            { id: 207, name: 'FANTASY 2', category: 'SYNTH-PAD', pc: 88, msb: 3 },
            { id: 208, name: 'NEW AGE PAD', category: 'SYNTH-PAD', pc: 88, msb: 1 },
            { id: 209, name: 'WARM VOX', category: 'SYNTH-PAD', pc: 89, msb: 8 },
            { id: 210, name: 'WARM PAD', category: 'SYNTH-PAD', pc: 89, msb: 2 },
            { id: 211, name: 'SINE PAD', category: 'SYNTH-PAD', pc: 89, msb: 3 },
            { id: 212, name: 'SOFT PAD', category: 'SYNTH-PAD', pc: 89, msb: 4 },
            { id: 213, name: 'OLD TAPE PAD', category: 'SYNTH-PAD', pc: 89, msb: 6 },
            { id: 214, name: 'POLYSYNTH 1', category: 'SYNTH-PAD', pc: 90, msb: 2 },
            { id: 215, name: 'POLYSYNTH 2', category: 'SYNTH-PAD', pc: 90, msb: 1 },
            { id: 216, name: 'POLY SAW', category: 'SYNTH-PAD', pc: 90, msb: 8 },
            { id: 217, name: 'SPACE CHOIR', category: 'SYNTH-PAD', pc: 91, msb: 1 },
            { id: 218, name: 'HEAVEN', category: 'SYNTH-PAD', pc: 91, msb: 2 },
            { id: 219, name: 'SPACE STRINGS PAD', category: 'SYNTH-PAD', pc: 91, msb: 3 },
            { id: 220, name: 'SQUARE PAD', category: 'SYNTH-PAD', pc: 92, msb: 1 },
            { id: 221, name: 'BOWED PAD', category: 'SYNTH-PAD', pc: 92, msb: 2 },
            { id: 222, name: 'GLASS PAD', category: 'SYNTH-PAD', pc: 92, msb: 3 },
            { id: 223, name: 'ETHNIC PAD', category: 'SYNTH-PAD', pc: 93, msb: 2 },
            { id: 224, name: 'HARD METAL PAD', category: 'SYNTH-PAD', pc: 93, msb: 4 },
            { id: 225, name: 'CHORUS PAD', category: 'SYNTH-PAD', pc: 94, msb: 1 },
            { id: 226, name: 'HALO PAD', category: 'SYNTH-PAD', pc: 94, msb: 2 },
            { id: 227, name: 'SWEEP PAD', category: 'SYNTH-PAD', pc: 95, msb: 2 },
            { id: 228, name: 'RAIN DROP', category: 'SYNTH-PAD', pc: 96, msb: 2 },
            { id: 229, name: 'SPACE VOICE', category: 'SYNTH-PAD', pc: 97, msb: 1 },
            { id: 230, name: 'SOUND TRACK 1', category: 'SYNTH-PAD', pc: 97, msb: 2 },
            { id: 231, name: 'SOUND TRACK 2', category: 'SYNTH-PAD', pc: 97, msb: 3 },
            { id: 232, name: 'RAVE', category: 'SYNTH-PAD', pc: 97, msb: 8 },
            { id: 233, name: 'CRYSTAL', category: 'SYNTH-PAD', pc: 98, msb: 2 },
            { id: 234, name: 'CHORAL BELL', category: 'SYNTH-PAD', pc: 98, msb: 16 },
            { id: 235, name: 'CELESTA PAD', category: 'SYNTH-PAD', pc: 99, msb: 1 },
            { id: 236, name: 'ATMOSPHERE', category: 'SYNTH-PAD', pc: 99, msb: 2 },
            { id: 237, name: 'BRIGHT BELL PAD', category: 'SYNTH-PAD', pc: 100, msb: 1 },
            { id: 238, name: 'BRIGHTNESS', category: 'SYNTH-PAD', pc: 100, msb: 2 },
            { id: 239, name: 'GOBLIN', category: 'SYNTH-PAD', pc: 101, msb: 2 },
            { id: 240, name: 'ECHO PAD', category: 'SYNTH-PAD', pc: 102, msb: 2 },
            { id: 241, name: 'ECHO DROP', category: 'SYNTH-PAD', pc: 102, msb: 3 },
            { id: 242, name: 'POLY DROP', category: 'SYNTH-PAD', pc: 102, msb: 4 },
            { id: 243, name: 'STAR THEME', category: 'SYNTH-PAD', pc: 103, msb: 2 },
            { id: 244, name: 'SPACE PAD', category: 'SYNTH-PAD', pc: 103, msb: 8 },
            
            // ETHNIC (245-266)
            { id: 245, name: 'ER HU 1', category: 'ETHNIC', pc: 110, msb: 8 },
            { id: 246, name: 'ER HU 2', category: 'ETHNIC', pc: 110, msb: 9 },
            { id: 247, name: 'YANG QIN 1', category: 'ETHNIC', pc: 15, msb: 8 },
            { id: 248, name: 'YANG QIN 2', category: 'ETHNIC', pc: 15, msb: 9 },
            { id: 249, name: 'DI ZI', category: 'ETHNIC', pc: 72, msb: 16 },
            { id: 250, name: 'ZHENG', category: 'ETHNIC', pc: 107, msb: 1 },
            { id: 251, name: 'SHENG', category: 'ETHNIC', pc: 109, msb: 8 },
            { id: 252, name: 'SUO NA', category: 'ETHNIC', pc: 111, msb: 32 },
            { id: 253, name: 'XIAO', category: 'ETHNIC', pc: 77, msb: 32 },
            { id: 254, name: 'PI PA', category: 'ETHNIC', pc: 105, msb: 32 },
            { id: 255, name: 'SITAR 1', category: 'ETHNIC', pc: 104, msb: 2 },
            { id: 256, name: 'SITAR 2', category: 'ETHNIC', pc: 104, msb: 1 },
            { id: 257, name: 'SITAR PAD', category: 'ETHNIC', pc: 104, msb: 4 },
            { id: 258, name: 'SANTUR', category: 'ETHNIC', pc: 15, msb: 16 },
            { id: 259, name: 'SHANAI', category: 'ETHNIC', pc: 111, msb: 2 },
            { id: 260, name: 'BANJO', category: 'ETHNIC', pc: 105, msb: 2 },
            { id: 261, name: 'THUMB PIANO', category: 'ETHNIC', pc: 108, msb: 2 },
            { id: 262, name: 'STEEL DRUMS', category: 'ETHNIC', pc: 114, msb: 2 },
            { id: 263, name: 'RABAB', category: 'ETHNIC', pc: 105, msb: 8 },
            { id: 264, name: 'SHAMISEN', category: 'ETHNIC', pc: 106, msb: 2 },
            { id: 265, name: 'TSUGARU', category: 'ETHNIC', pc: 106, msb: 1 },
            { id: 266, name: 'KOTO', category: 'ETHNIC', pc: 107, msb: 2 },
            
            // GM TONES (267-394)
            { id: 267, name: 'GM PIANO 1', category: 'GM TONES', pc: 0, msb: 0 },
            { id: 268, name: 'GM PIANO 2', category: 'GM TONES', pc: 1, msb: 0 },
            { id: 269, name: 'GM PIANO 3', category: 'GM TONES', pc: 2, msb: 0 },
            { id: 270, name: 'GM HONKY-TONK', category: 'GM TONES', pc: 3, msb: 0 },
            { id: 271, name: 'GM E.PIANO 1', category: 'GM TONES', pc: 4, msb: 0 },
            { id: 272, name: 'GM E.PIANO 2', category: 'GM TONES', pc: 5, msb: 0 },
            { id: 273, name: 'GM HARPSICHORD', category: 'GM TONES', pc: 6, msb: 0 },
            { id: 274, name: 'GM CLAVI', category: 'GM TONES', pc: 7, msb: 0 },
            { id: 275, name: 'GM CELESTA', category: 'GM TONES', pc: 8, msb: 0 },
            { id: 276, name: 'GM GLOCKENSPIEL', category: 'GM TONES', pc: 9, msb: 0 },
            { id: 277, name: 'GM MUSIC BOX', category: 'GM TONES', pc: 10, msb: 0 },
            { id: 278, name: 'GM VIBRAPHONE', category: 'GM TONES', pc: 11, msb: 0 },
            { id: 279, name: 'GM MARIMBA', category: 'GM TONES', pc: 12, msb: 0 },
            { id: 280, name: 'GM XYLOPHONE', category: 'GM TONES', pc: 13, msb: 0 },
            { id: 281, name: 'GM TUBULAR BELL', category: 'GM TONES', pc: 14, msb: 0 },
            { id: 282, name: 'GM DULCIMER', category: 'GM TONES', pc: 15, msb: 0 },
            { id: 283, name: 'GM ORGAN 1', category: 'GM TONES', pc: 16, msb: 0 },
            { id: 284, name: 'GM ORGAN 2', category: 'GM TONES', pc: 17, msb: 0 },
            { id: 285, name: 'GM ORGAN 3', category: 'GM TONES', pc: 18, msb: 0 },
            { id: 286, name: 'GM PIPE ORGAN', category: 'GM TONES', pc: 19, msb: 0 },
            { id: 287, name: 'GM REED ORGAN', category: 'GM TONES', pc: 20, msb: 0 },
            { id: 288, name: 'GM ACCORDION', category: 'GM TONES', pc: 21, msb: 0 },
            { id: 289, name: 'GM HARMONICA', category: 'GM TONES', pc: 22, msb: 0 },
            { id: 290, name: 'GM BANDONEON', category: 'GM TONES', pc: 23, msb: 0 },
            { id: 291, name: 'GM NYLON STR.GUITAR', category: 'GM TONES', pc: 24, msb: 0 },
            { id: 292, name: 'GM STEEL STR.GUITAR', category: 'GM TONES', pc: 25, msb: 0 },
            { id: 293, name: 'GM JAZZ GUITAR', category: 'GM TONES', pc: 26, msb: 0 },
            { id: 294, name: 'GM CLEAN GUITAR', category: 'GM TONES', pc: 27, msb: 0 },
            { id: 295, name: 'GM MUTE GUITAR', category: 'GM TONES', pc: 28, msb: 0 },
            { id: 296, name: 'GM OVERDRIVE GT', category: 'GM TONES', pc: 29, msb: 0 },
            { id: 297, name: 'GM DISTORTION GT', category: 'GM TONES', pc: 30, msb: 0 },
            { id: 298, name: 'GM GT HARMONICS', category: 'GM TONES', pc: 31, msb: 0 },
            { id: 299, name: 'GM ACOUSTIC BASS', category: 'GM TONES', pc: 32, msb: 0 },
            { id: 300, name: 'GM FINGERED BASS', category: 'GM TONES', pc: 33, msb: 0 },
            { id: 301, name: 'GM PICKED BASS', category: 'GM TONES', pc: 34, msb: 0 },
            { id: 302, name: 'GM FRETLESS BASS', category: 'GM TONES', pc: 35, msb: 0 },
            { id: 303, name: 'GM SLAP BASS 1', category: 'GM TONES', pc: 36, msb: 0 },
            { id: 304, name: 'GM SLAP BASS 2', category: 'GM TONES', pc: 37, msb: 0 },
            { id: 305, name: 'GM SYNTH-BASS 1', category: 'GM TONES', pc: 38, msb: 0 },
            { id: 306, name: 'GM SYNTH-BASS 2', category: 'GM TONES', pc: 39, msb: 0 },
            { id: 307, name: 'GM VIOLIN', category: 'GM TONES', pc: 40, msb: 0 },
            { id: 308, name: 'GM VIOLA', category: 'GM TONES', pc: 41, msb: 0 },
            { id: 309, name: 'GM CELLO', category: 'GM TONES', pc: 42, msb: 0 },
            { id: 310, name: 'GM CONTRABASS', category: 'GM TONES', pc: 43, msb: 0 },
            { id: 311, name: 'GM TREMOLO STRINGS', category: 'GM TONES', pc: 44, msb: 0 },
            { id: 312, name: 'GM PIZZICATO', category: 'GM TONES', pc: 45, msb: 0 },
            { id: 313, name: 'GM HARP', category: 'GM TONES', pc: 46, msb: 0 },
            { id: 314, name: 'GM TIMPANI', category: 'GM TONES', pc: 47, msb: 0 },
            { id: 315, name: 'GM STRINGS 1', category: 'GM TONES', pc: 48, msb: 0 },
            { id: 316, name: 'GM STRINGS 2', category: 'GM TONES', pc: 49, msb: 0 },
            { id: 317, name: 'GM SYNTH-STRINGS 1', category: 'GM TONES', pc: 50, msb: 0 },
            { id: 318, name: 'GM SYNTH-STRINGS 2', category: 'GM TONES', pc: 51, msb: 0 },
            { id: 319, name: 'GM CHOIR AAHS', category: 'GM TONES', pc: 52, msb: 0 },
            { id: 320, name: 'GM VOICE DOO', category: 'GM TONES', pc: 53, msb: 0 },
            { id: 321, name: 'GM SYNTH-VOICE', category: 'GM TONES', pc: 54, msb: 0 },
            { id: 322, name: 'GM ORCHESTRA HIT', category: 'GM TONES', pc: 55, msb: 0 },
            { id: 323, name: 'GM TRUMPET', category: 'GM TONES', pc: 56, msb: 0 },
            { id: 324, name: 'GM TROMBONE', category: 'GM TONES', pc: 57, msb: 0 },
            { id: 325, name: 'GM TUBA', category: 'GM TONES', pc: 58, msb: 0 },
            { id: 326, name: 'GM MUTE TRUMPET', category: 'GM TONES', pc: 59, msb: 0 },
            { id: 327, name: 'GM FRENCH HORN', category: 'GM TONES', pc: 60, msb: 0 },
            { id: 328, name: 'GM BRASS', category: 'GM TONES', pc: 61, msb: 0 },
            { id: 329, name: 'GM SYNTH-BRASS 1', category: 'GM TONES', pc: 62, msb: 0 },
            { id: 330, name: 'GM SYNTH-BRASS 2', category: 'GM TONES', pc: 63, msb: 0 },
            { id: 331, name: 'GM SOPRANO SAX', category: 'GM TONES', pc: 64, msb: 0 },
            { id: 332, name: 'GM ALTO SAX', category: 'GM TONES', pc: 65, msb: 0 },
            { id: 333, name: 'GM TENOR SAX', category: 'GM TONES', pc: 66, msb: 0 },
            { id: 334, name: 'GM BARITONE SAX', category: 'GM TONES', pc: 67, msb: 0 },
            { id: 335, name: 'GM OBOE', category: 'GM TONES', pc: 68, msb: 0 },
            { id: 336, name: 'GM ENGLISH HORN', category: 'GM TONES', pc: 69, msb: 0 },
            { id: 337, name: 'GM BASSOON', category: 'GM TONES', pc: 70, msb: 0 },
            { id: 338, name: 'GM CLARINET', category: 'GM TONES', pc: 71, msb: 0 },
            { id: 339, name: 'GM PICCOLO', category: 'GM TONES', pc: 72, msb: 0 },
            { id: 340, name: 'GM FLUTE', category: 'GM TONES', pc: 73, msb: 0 },
            { id: 341, name: 'GM RECORDER', category: 'GM TONES', pc: 74, msb: 0 },
            { id: 342, name: 'GM PAN FLUTE', category: 'GM TONES', pc: 75, msb: 0 },
            { id: 343, name: 'GM BOTTLE BLOW', category: 'GM TONES', pc: 76, msb: 0 },
            { id: 344, name: 'GM SHAKUHACHI', category: 'GM TONES', pc: 77, msb: 0 },
            { id: 345, name: 'GM WHISTLE', category: 'GM TONES', pc: 78, msb: 0 },
            { id: 346, name: 'GM OCARINA', category: 'GM TONES', pc: 79, msb: 0 },
            { id: 347, name: 'GM SQUARE LEAD', category: 'GM TONES', pc: 80, msb: 0 },
            { id: 348, name: 'GM SAW LEAD', category: 'GM TONES', pc: 81, msb: 0 },
            { id: 349, name: 'GM CALLIOPE', category: 'GM TONES', pc: 82, msb: 0 },
            { id: 350, name: 'GM CHIFF LEAD', category: 'GM TONES', pc: 83, msb: 0 },
            { id: 351, name: 'GM CHARANG', category: 'GM TONES', pc: 84, msb: 0 },
            { id: 352, name: 'GM VOICE LEAD', category: 'GM TONES', pc: 85, msb: 0 },
            { id: 353, name: 'GM FIFTH LEAD', category: 'GM TONES', pc: 86, msb: 0 },
            { id: 354, name: 'GM BASS+LEAD', category: 'GM TONES', pc: 87, msb: 0 },
            { id: 355, name: 'GM FANTASY', category: 'GM TONES', pc: 88, msb: 0 },
            { id: 356, name: 'GM WARM PAD', category: 'GM TONES', pc: 89, msb: 0 },
            { id: 357, name: 'GM POLYSYNTH', category: 'GM TONES', pc: 90, msb: 0 },
            { id: 358, name: 'GM SPACE CHOIR', category: 'GM TONES', pc: 91, msb: 0 },
            { id: 359, name: 'GM BOWED GLASS', category: 'GM TONES', pc: 92, msb: 0 },
            { id: 360, name: 'GM METAL PAD', category: 'GM TONES', pc: 93, msb: 0 },
            { id: 361, name: 'GM HALO PAD', category: 'GM TONES', pc: 94, msb: 0 },
            { id: 362, name: 'GM SWEEP PAD', category: 'GM TONES', pc: 95, msb: 0 },
            { id: 363, name: 'GM RAIN DROP', category: 'GM TONES', pc: 96, msb: 0 },
            { id: 364, name: 'GM SOUND TRACK', category: 'GM TONES', pc: 97, msb: 0 },
            { id: 365, name: 'GM CRYSTAL', category: 'GM TONES', pc: 98, msb: 0 },
            { id: 366, name: 'GM ATMOSPHERE', category: 'GM TONES', pc: 99, msb: 0 },
            { id: 367, name: 'GM BRIGHTNESS', category: 'GM TONES', pc: 100, msb: 0 },
            { id: 368, name: 'GM GOBLINS', category: 'GM TONES', pc: 101, msb: 0 },
            { id: 369, name: 'GM ECHOES', category: 'GM TONES', pc: 102, msb: 0 },
            { id: 370, name: 'GM SF', category: 'GM TONES', pc: 103, msb: 0 },
            { id: 371, name: 'GM SITAR', category: 'GM TONES', pc: 104, msb: 0 },
            { id: 372, name: 'GM BANJO', category: 'GM TONES', pc: 105, msb: 0 },
            { id: 373, name: 'GM SHAMISEN', category: 'GM TONES', pc: 106, msb: 0 },
            { id: 374, name: 'GM KOTO', category: 'GM TONES', pc: 107, msb: 0 },
            { id: 375, name: 'GM THUMB PIANO', category: 'GM TONES', pc: 108, msb: 0 },
            { id: 376, name: 'GM BAGPIPE', category: 'GM TONES', pc: 109, msb: 0 },
            { id: 377, name: 'GM FIDDLE', category: 'GM TONES', pc: 110, msb: 0 },
            { id: 378, name: 'GM SHANAI', category: 'GM TONES', pc: 111, msb: 0 },
            { id: 379, name: 'GM TINKLE BELL', category: 'GM TONES', pc: 112, msb: 0 },
            { id: 380, name: 'GM AGOGO', category: 'GM TONES', pc: 113, msb: 0 },
            { id: 381, name: 'GM STEEL DRUMS', category: 'GM TONES', pc: 114, msb: 0 },
            { id: 382, name: 'GM WOOD BLOCK', category: 'GM TONES', pc: 115, msb: 0 },
            { id: 383, name: 'GM TAIKO', category: 'GM TONES', pc: 116, msb: 0 },
            { id: 384, name: 'GM MELODIC TOM', category: 'GM TONES', pc: 117, msb: 0 },
            { id: 385, name: 'GM SYNTH-DRUM', category: 'GM TONES', pc: 118, msb: 0 },
            { id: 386, name: 'GM REVERSE CYMBAL', category: 'GM TONES', pc: 119, msb: 0 },
            { id: 387, name: 'GM GT FRET NOISE', category: 'GM TONES', pc: 120, msb: 0 },
            { id: 388, name: 'GM BREATH NOISE', category: 'GM TONES', pc: 121, msb: 0 },
            { id: 389, name: 'GM SEASHORE', category: 'GM TONES', pc: 122, msb: 0 },
            { id: 390, name: 'GM BIRD', category: 'GM TONES', pc: 123, msb: 0 },
            { id: 391, name: 'GM TELEPHONE', category: 'GM TONES', pc: 124, msb: 0 },
            { id: 392, name: 'GM HELICOPTER', category: 'GM TONES', pc: 125, msb: 0 },
            { id: 393, name: 'GM APPLAUSE', category: 'GM TONES', pc: 126, msb: 0 },
            { id: 394, name: 'GM GUNSHOT', category: 'GM TONES', pc: 127, msb: 0 },
            
            // DRUM SET (395-400)
            { id: 395, name: 'STANDARD SET', category: 'DRUM SET', pc: 0, msb: 120 },
            { id: 396, name: 'ROOM SET', category: 'DRUM SET', pc: 8, msb: 120 },
            { id: 397, name: 'POWER SET', category: 'DRUM SET', pc: 16, msb: 120 },
            { id: 398, name: 'SYNTH SET', category: 'DRUM SET', pc: 25, msb: 120 },
            { id: 399, name: 'BRUSH SET', category: 'DRUM SET', pc: 40, msb: 120 },
            { id: 400, name: 'ORCHESTRA SET', category: 'DRUM SET', pc: 48, msb: 120 },
            
            // SAMPLED TONES (401-414)
            { id: 401, name: 'ORIGINAL', category: 'SAMPLED TONES', pc: 0, msb: 63 },
            { id: 402, name: 'VOICE PAD 1', category: 'SAMPLED TONES', pc: 1, msb: 63 },
            { id: 403, name: 'VOICE PAD 2', category: 'SAMPLED TONES', pc: 2, msb: 63 },
            { id: 404, name: 'VOICE PAD 3', category: 'SAMPLED TONES', pc: 3, msb: 63 },
            { id: 405, name: 'LOOP 1', category: 'SAMPLED TONES', pc: 4, msb: 63 },
            { id: 406, name: 'LOOP 2', category: 'SAMPLED TONES', pc: 5, msb: 63 },
            { id: 407, name: 'LOOP 3', category: 'SAMPLED TONES', pc: 6, msb: 63 },
            { id: 408, name: 'PITCH 1', category: 'SAMPLED TONES', pc: 7, msb: 63 },
            { id: 409, name: 'PITCH 2', category: 'SAMPLED TONES', pc: 8, msb: 63 },
            { id: 410, name: 'PITCH 3', category: 'SAMPLED TONES', pc: 9, msb: 63 },
            { id: 411, name: 'TREMOLO', category: 'SAMPLED TONES', pc: 10, msb: 63 },
            { id: 412, name: 'FUNNY 1', category: 'SAMPLED TONES', pc: 11, msb: 63 },
            { id: 413, name: 'FUNNY 2', category: 'SAMPLED TONES', pc: 12, msb: 63 },
            { id: 414, name: 'FUNNY 3', category: 'SAMPLED TONES', pc: 13, msb: 63 }
        ];

        // ==========================================
        // TONE SELECTOR BUILDER
        // ==========================================
        function buildToneSelector(selectElement) {
            if (!selectElement) return;
            
            // Clear existing options
            selectElement.innerHTML = '';
            
            // Group tones by category
            const categorizedTones = {};
            CTK3200_TONES.forEach(tone => {
                const category = tone.category || 'OTHER';
                if (!categorizedTones[category]) {
                    categorizedTones[category] = [];
                }
                categorizedTones[category].push(tone);
            });
            
            // Sort categories by first tone ID
            const sortedCategories = Object.keys(categorizedTones).sort((a, b) => {
                const firstNumA = categorizedTones[a][0].id || 0;
                const firstNumB = categorizedTones[b][0].id || 0;
                return firstNumA - firstNumB;
            });
            
            // Create optgroups
            sortedCategories.forEach(category => {
                const optgroup = document.createElement('optgroup');
                
                // Format category label with number range
                const firstNum = categorizedTones[category][0].id;
                const lastNum = categorizedTones[category][categorizedTones[category].length - 1].id;
                optgroup.label = `${category} (${String(firstNum).padStart(3, '0')}-${String(lastNum).padStart(3, '0')})`;
                
                // Add tones in this group
                categorizedTones[category].forEach(tone => {
                    const option = document.createElement('option');
                    option.value = tone.pc; // Use program change as value
                    option.dataset.msb = tone.msb; // Store MSB in data attribute
                    option.dataset.id = tone.id; // Store ID for reference
                    
                    // Format text: "001 NAME"
                    option.textContent = `${String(tone.id).padStart(3, '0')} ${tone.name}`;
                    optgroup.appendChild(option);
                });
                
                selectElement.appendChild(optgroup);
            });
        }

        // ==========================================
        // GLOBAL STATE & CONFIGURATION
        // ==========================================
        
        const state = {
            // MIDI Devices
            midiOutCTK: null,
            midiOutLP: null,
            midiInLP: null,
            
            // Playback State  
            isPlaying: false,
            isRecording: false,
            currentBeat: 0,
            currentMeasure: 0,
            
            // Musical Parameters
            tempo: 120,
            swing: 50,
            velocity: 100,
            humanize: 0,
            
            // Style & Sections
            currentStyle: '8BEAT',
            currentSection: 'main',
            currentVariation: 'A',
            
            // Chord State
            currentChord: 'C',
            chordProgression: [],
            chordInstrument: 0,  // Grand Piano default
            chordVelocity: 80,   // Chord velocity default
            
            // Pattern Data (per style/section/variation)
            patterns: {},
            currentPattern: null,
            
            // Launchpad Mode
            launchpadMode: 'session', // session, user1, user2
            
            // Session Mode Pattern
            drumPattern: Array(16).fill(null).map(() => ({
                kick: false,
                snare: false,
                hihat: false,
                open: false
            })),
            
            // User1 Mode - Drum Kit
            currentDrumSet: 0,
            
            // User2 Mode - Bass Sequencer
            currentBassProgram: 83, // Acoustic Bass
            bassPattern: Array(16).fill(null).map(() => Array(8).fill(false)),
            bassUpActive: true, // UP button state for beats 1-8 (default true)
            
            // Sequencer
            sequencerInterval: null,
            nextBeatTime: 0,
            
            // Tap Tempo
            tapTimes: [],
            
            // Touch/Mouse Tracking
            isDragging: false,
            dragMode: null,
            lastTouchedCell: null,
            
            // Voice to MIDI State
            voiceToMidi: {
                isRunning: false,
                audioContext: null,
                analyser: null,
                microphone: null,
                scriptProcessor: null,
                currentNote: null,
                currentFrequency: 0,
                confidence: 0,
                playMode: 'single',
                scale: 'chromatic',
                transpose: 0,
                sensitivity: 0.3,
                reverb: 40,
                vibrato: 0,
                voiceTone: 0,
                noteBuffer: [],
                lastNoteTime: 0,
                currentChordNotes: [],
                arpeggiatorInterval: null,
                arpeggiatorIndex: 0,
                currentArpNotes: []
            }
        };

        // ==========================================
        // LAUNCHPAD MK2 MIDI MAPPING
        // ==========================================
        
        const LP_MAPPING = {
            // Pad notes (8x8 grid) - Row 8 (top) to Row 1 (bottom)
            pads: [
                [81, 82, 83, 84, 85, 86, 87, 88], // Row 8 (top)
                [71, 72, 73, 74, 75, 76, 77, 78], // Row 7
                [61, 62, 63, 64, 65, 66, 67, 68], // Row 6
                [51, 52, 53, 54, 55, 56, 57, 58], // Row 5
                [41, 42, 43, 44, 45, 46, 47, 48], // Row 4
                [31, 32, 33, 34, 35, 36, 37, 38], // Row 3
                [21, 22, 23, 24, 25, 26, 27, 28], // Row 2
                [11, 12, 13, 14, 15, 16, 17, 18]  // Row 1 (bottom)
            ],
            
            // Right button notes (index 0-7 = bottom to top physically)
            // Index 0 = Bottom button (note 89), Index 7 = Top button (note 19)
            rightButtons: [89, 79, 69, 59, 49, 39, 29, 19],
            
            // Top button CCs
            topButtons: {
                up: 104,
                down: 105,
                left: 106,
                right: 107,
                session: 108,
                user1: 109,
                user2: 110,
                mixer: 111
            },
            
            // Color velocity values (from Novation's programmer's reference)
            colors: {
                off: 0,
                red: 5,
                orange: 9,
                amber: 13,
                yellow: 21,
                lime: 29,
                green: 25,
                turquoise: 33,
                cyan: 37,
                sky: 41,
                blue: 45,
                orchid: 49,
                purple: 53,
                pink: 57,
                magenta: 60,
                white: 3
            }
        };

        // CTK-3200 Program Numbers for Bass (83-94)
        const BASS_PROGRAMS = [
            'Acoustic Bass',   // 83
            'Ride Bass',       // 84
            'Electric Bass',   // 85
            'Bass & Cymbal',   // 86
            'Slap Bass 1',     // 87
            'Slap Bass 2',     // 88
            'Synth Bass 1',    // 89
            'Synth Bass 2',    // 90
            'Synth Bass 3',    // 91
            'Synth Bass 4',    // 92
            'Sine Bass',       // 93
            'Saw Bass'         // 94
        ];

        // CTK-3200 Drum Mapping (Channel 10)
        const DRUM_MAP = {
            // Standard Kit
            35: 'Acoustic Bass Drum',
            36: 'Bass Drum 1',
            37: 'Side Stick',
            38: 'Acoustic Snare',
            39: 'Hand Clap',
            40: 'Electric Snare',
            41: 'Low Floor Tom',
            42: 'Closed Hi-Hat',
            43: 'High Floor Tom',
            44: 'Pedal Hi-Hat',
            45: 'Low Tom',
            46: 'Open Hi-Hat',
            47: 'Low-Mid Tom',
            48: 'Hi-Mid Tom',
            49: 'Crash Cymbal 1',
            50: 'High Tom',
            51: 'Ride Cymbal 1',
            52: 'Chinese Cymbal',
            53: 'Ride Bell',
            54: 'Tambourine',
            55: 'Splash Cymbal',
            56: 'Cowbell',
            57: 'Crash Cymbal 2',
            58: 'Vibraslap',
            59: 'Ride Cymbal 2',
            60: 'Hi Bongo',
            61: 'Low Bongo',
            62: 'Mute Hi Conga',
            63: 'Open Hi Conga',
            64: 'Low Conga',
            65: 'High Timbale',
            66: 'Low Timbale',
            67: 'High Agogo',
            68: 'Low Agogo',
            69: 'Cabasa',
            70: 'Maracas',
            71: 'Short Whistle',
            72: 'Long Whistle',
            73: 'Short Guiro',
            74: 'Long Guiro',
            75: 'Claves',
            76: 'Hi Wood Block',
            77: 'Low Wood Block',
            78: 'Mute Cuica',
            79: 'Open Cuica',
            80: 'Mute Triangle',
            81: 'Open Triangle'
        };

        // Drum color groups for User1 mode
        const DRUM_COLORS = [
            { notes: [35, 36], color: 'red' },        // Kicks
            { notes: [37, 38, 39, 40], color: 'orange' }, // Snares
            { notes: [42, 44, 46], color: 'yellow' },  // Hi-hats
            { notes: [49, 51, 52, 55, 57, 59], color: 'green' }, // Cymbals
            { notes: [41, 43, 45, 47, 48, 50], color: 'cyan' }, // Toms
            { notes: [60, 61, 62, 63, 64], color: 'blue' }, // Congas/Bongos
            { notes: [65, 66, 67, 68], color: 'purple' }, // Timbale/Agogo
            { notes: [69, 70, 71, 72, 73, 74, 75, 76, 77, 78, 79, 80, 81], color: 'pink' } // Percussion
        ];

        // Rhythm Patterns (6 styles √ó 6 sections √ó 4 variations)
        const RHYTHM_PATTERNS = {
            '8BEAT': {
                intro: {
                    A: { kick: '1000100010001000', snare: '0000100000001000', hihat: '1010101010101010', open: '0000000000000001' },
                    B: { kick: '1000100010001000', snare: '0000100000001000', hihat: '1111111111111111', open: '0000000000000001' },
                    C: { kick: '1010101010101010', snare: '0000100000001000', hihat: '1111111111111111', open: '0000000000000001' },
                    D: { kick: '1010101010101010', snare: '0010100100101001', hihat: '1111111111111111', open: '0001000100010001' }
                },
                main: {
                    A: { kick: '1000100010001000', snare: '0000100000001000', hihat: '1010101010101010', open: '0000000000000000' },
                    B: { kick: '1000100010001000', snare: '0000100000001000', hihat: '1111111111111111', open: '0000000000000000' },
                    C: { kick: '1010100010101000', snare: '0000100000001000', hihat: '1111111111111111', open: '0000000000000000' },
                    D: { kick: '1010101010101010', snare: '0000100100001001', hihat: '1111111111111111', open: '0000000100000001' }
                },
                chorus: {
                    A: { kick: '1010101010101010', snare: '0000100000001000', hihat: '1111111111111111', open: '0000000000000001' },
                    B: { kick: '1010101010101010', snare: '0000100100001001', hihat: '1111111111111111', open: '0000000000000001' },
                    C: { kick: '1111101011111010', snare: '0000100100001001', hihat: '1111111111111111', open: '0001000000010000' },
                    D: { kick: '1111111111111111', snare: '0010100100101001', hihat: '1111111111111111', open: '0001000100010001' }
                },
                fill: {
                    A: { kick: '1000100010001111', snare: '0000000011111111', hihat: '0000000000000000', open: '0000000000000001' },
                    B: { kick: '1010101010101111', snare: '0000001111111111', hihat: '1111110000000000', open: '0000000000000001' },
                    C: { kick: '1111111111111111', snare: '0101010110101011', hihat: '0000000000000000', open: '0000000000000001' },
                    D: { kick: '1111111111111111', snare: '1111111111111111', hihat: '0000000000000000', open: '0000000000000001' }
                },
                break: {
                    A: { kick: '1000000000000000', snare: '0000000000000000', hihat: '0000000000000000', open: '0000000000000001' },
                    B: { kick: '1000000010000000', snare: '0000100000001000', hihat: '0000000000000000', open: '0000000000000000' },
                    C: { kick: '1000100010001000', snare: '0000000000000000', hihat: '0000100000001000', open: '0000000000000000' },
                    D: { kick: '0000000000000000', snare: '0000000000000000', hihat: '1010101010101010', open: '0000000000000000' }
                },
                ending: {
                    A: { kick: '1000100010001111', snare: '0000100011111111', hihat: '0000000000000000', open: '0000000000000001' },
                    B: { kick: '1010101011111111', snare: '0101010111111111', hihat: '0000000000000000', open: '0000000000000001' },
                    C: { kick: '1111111111111111', snare: '1010101011111111', hihat: '0101010100000000', open: '0000000000000001' },
                    D: { kick: '1111111111111111', snare: '1111111111111111', hihat: '1111111111111111', open: '0000000000000001' }
                }
            },
            '16BEAT': {
                intro: {
                    A: { kick: '1000100010001000', snare: '0000100000001000', hihat: '1010101010101010', open: '0000000000000001' },
                    B: { kick: '1001100110011001', snare: '0000100000001000', hihat: '1111111111111111', open: '0000000000000001' },
                    C: { kick: '1001100110011001', snare: '0000100100001000', hihat: '1111111111111111', open: '0001000000000001' },
                    D: { kick: '1011101110111011', snare: '0000100100001001', hihat: '1111111111111111', open: '0001000100010001' }
                },
                main: {
                    A: { kick: '1000001010000010', snare: '0000100000001000', hihat: '1111111111111111', open: '0000000000000000' },
                    B: { kick: '1001001010010010', snare: '0000100000001000', hihat: '1111111111111111', open: '0000100000000000' },
                    C: { kick: '1001001110010011', snare: '0000100100001000', hihat: '1111111111111111', open: '0000100000001000' },
                    D: { kick: '1011101110111011', snare: '0000100100101001', hihat: '1111111111111111', open: '0001001000100010' }
                },
                chorus: {
                    A: { kick: '1010001010100010', snare: '0000100000001000', hihat: '1111111111111111', open: '0000001000000100' },
                    B: { kick: '1010101010101010', snare: '0000100100001000', hihat: '1111111111111111', open: '0000100000001000' },
                    C: { kick: '1011101110111011', snare: '0000100100001001', hihat: '1111111111111111', open: '0001000100010001' },
                    D: { kick: '1111101111111011', snare: '0010100100101001', hihat: '1111111111111111', open: '0100010001000100' }
                },
                fill: {
                    A: { kick: '1000100010001111', snare: '0000000011111111', hihat: '1111111100000000', open: '0000000000000001' },
                    B: { kick: '1010101010101111', snare: '0000111111111111', hihat: '1111000000000000', open: '0000000000000001' },
                    C: { kick: '1111111111111111', snare: '0101010110101011', hihat: '1010101010101010', open: '0000000000000001' },
                    D: { kick: '1111111111111111', snare: '1111111111111111', hihat: '0000000000000000', open: '0000000000000001' }
                },
                break: {
                    A: { kick: '1000000010000000', snare: '0000000000000000', hihat: '1010101010101010', open: '0000000000000000' },
                    B: { kick: '1000001010000010', snare: '0000100000001000', hihat: '0000000000000000', open: '0000000000000000' },
                    C: { kick: '1001001010010010', snare: '0000000000000000', hihat: '1111111111111111', open: '0000000000000000' },
                    D: { kick: '0000000000000000', snare: '0000000000000000', hihat: '1010101010101010', open: '0101010101010101' }
                },
                ending: {
                    A: { kick: '1001001010011111', snare: '0000100011111111', hihat: '1111111100000000', open: '0000000000000001' },
                    B: { kick: '1010101011111111', snare: '0101010111111111', hihat: '0000000000000000', open: '0000000000000001' },
                    C: { kick: '1111111111111111', snare: '1010101011111111', hihat: '0101010100000000', open: '0000000000000001' },
                    D: { kick: '1111111111111111', snare: '1111111111111111', hihat: '1111111111111111', open: '0000000000000001' }
                }
            },
            'POP': {
                intro: {
                    A: { kick: '1000100010001000', snare: '0000100000001000', hihat: '1010101010101010', open: '0000000000000000' },
                    B: { kick: '1001100010011000', snare: '0000100000001000', hihat: '1111111111111111', open: '0000000000000000' },
                    C: { kick: '1001100110011001', snare: '0000100100001000', hihat: '1111111111111111', open: '0000100000001000' },
                    D: { kick: '1011101110111011', snare: '0010100100101001', hihat: '1111111111111111', open: '0001000100010001' }
                },
                main: {
                    A: { kick: '1001000010010000', snare: '0000100000001000', hihat: '1111111111111111', open: '0000000000000000' },
                    B: { kick: '1001001010010010', snare: '0000100000001000', hihat: '1111111111111111', open: '0000100000000100' },
                    C: { kick: '1011001010110010', snare: '0000100100001000', hihat: '1111111111111111', open: '0100001000000100' },
                    D: { kick: '1011101110111011', snare: '0000100100001001', hihat: '1111111111111111', open: '0100010001000100' }
                },
                chorus: {
                    A: { kick: '1010100010101000', snare: '0000100000001000', hihat: '1111111111111111', open: '0000001000000010' },
                    B: { kick: '1010101010101010', snare: '0000100100001000', hihat: '1111111111111111', open: '0001000100010001' },
                    C: { kick: '1111101110111011', snare: '0000100100001001', hihat: '1111111111111111', open: '0010001000100010' },
                    D: { kick: '1111111111111111', snare: '0010100100101001', hihat: '1111111111111111', open: '0100010001000100' }
                },
                fill: {
                    A: { kick: '1000100010001111', snare: '0000000011111111', hihat: '0000000000000000', open: '0000000000000001' },
                    B: { kick: '1001001010011111', snare: '0000001111111111', hihat: '1111110000000000', open: '0000000000000001' },
                    C: { kick: '1111111111111111', snare: '0101010110101011', hihat: '0000000000000000', open: '0000000000000001' },
                    D: { kick: '1111111111111111', snare: '1111111111111111', hihat: '0000000000000000', open: '0000000000000001' }
                },
                break: {
                    A: { kick: '1000000000000000', snare: '0000000000000000', hihat: '0000000000000000', open: '0000000000000000' },
                    B: { kick: '1000000010000000', snare: '0000100000001000', hihat: '0000000000000000', open: '0000000000000000' },
                    C: { kick: '1001000010010000', snare: '0000000000000000', hihat: '1111111111111111', open: '0000000000000000' },
                    D: { kick: '0000000000000000', snare: '0000100000001000', hihat: '1010101010101010', open: '0000000000000000' }
                },
                ending: {
                    A: { kick: '1001000010011111', snare: '0000100011111111', hihat: '0000000000000000', open: '0000000000000001' },
                    B: { kick: '1010101011111111', snare: '0101010111111111', hihat: '0000000000000000', open: '0000000000000001' },
                    C: { kick: '1111111111111111', snare: '1010101011111111', hihat: '0101010100000000', open: '0000000000000001' },
                    D: { kick: '1111111111111111', snare: '1111111111111111', hihat: '1111111111111111', open: '0000000000000001' }
                }
            },
            'ROCK': {
                intro: {
                    A: { kick: '1000100010001000', snare: '0000100000001000', hihat: '0000000000000000', open: '1111111111111111' },
                    B: { kick: '1010100010101000', snare: '0000100000001000', hihat: '0000000000000000', open: '1111111111111111' },
                    C: { kick: '1010101010101010', snare: '0000100100001000', hihat: '0000000000000000', open: '1111111111111111' },
                    D: { kick: '1111101111111011', snare: '0010100100101001', hihat: '0000000000000000', open: '1111111111111111' }
                },
                main: {
                    A: { kick: '1000100010001000', snare: '0000100000001000', hihat: '0000000000000000', open: '1010101010101010' },
                    B: { kick: '1010100010101000', snare: '0000100000001000', hihat: '0000000000000000', open: '1111111111111111' },
                    C: { kick: '1010101010101010', snare: '0000100100001000', hihat: '0000000000000000', open: '1111111111111111' },
                    D: { kick: '1111101111111011', snare: '0010100100101001', hihat: '1111111111111111', open: '0000000000000000' }
                },
                chorus: {
                    A: { kick: '1010100010101000', snare: '0000100000001000', hihat: '0000000000000000', open: '1111111111111111' },
                    B: { kick: '1010101010101010', snare: '0000100100001000', hihat: '0000000000000000', open: '1111111111111111' },
                    C: { kick: '1111101110111011', snare: '0010100100101001', hihat: '0000000000000000', open: '1111111111111111' },
                    D: { kick: '1111111111111111', snare: '0010100100101001', hihat: '1111111111111111', open: '0000000000000000' }
                },
                fill: {
                    A: { kick: '1000100010001111', snare: '0000000011111111', hihat: '0000000000000000', open: '1111111111111111' },
                    B: { kick: '1010101010101111', snare: '0000111111111111', hihat: '0000000000000000', open: '1111111111111111' },
                    C: { kick: '1111111111111111', snare: '0101010110101011', hihat: '0000000000000000', open: '1111111111111111' },
                    D: { kick: '1111111111111111', snare: '1111111111111111', hihat: '1111111111111111', open: '1111111111111111' }
                },
                break: {
                    A: { kick: '1000000000000000', snare: '0000000000000000', hihat: '0000000000000000', open: '1000000000000000' },
                    B: { kick: '1000000010000000', snare: '0000100000001000', hihat: '0000000000000000', open: '0000000000000000' },
                    C: { kick: '1000100010001000', snare: '0000000000000000', hihat: '0000000000000000', open: '1111111111111111' },
                    D: { kick: '0000000000000000', snare: '0000100000001000', hihat: '0000000000000000', open: '1010101010101010' }
                },
                ending: {
                    A: { kick: '1000100010001111', snare: '0000100011111111', hihat: '0000000000000000', open: '1111111111111111' },
                    B: { kick: '1010101011111111', snare: '0101010111111111', hihat: '0000000000000000', open: '1111111111111111' },
                    C: { kick: '1111111111111111', snare: '1010101011111111', hihat: '0101010100000000', open: '1111111111111111' },
                    D: { kick: '1111111111111111', snare: '1111111111111111', hihat: '1111111111111111', open: '1111111111111111' }
                }
            },
            'JAZZ': {
                intro: {
                    A: { kick: '1000001000100010', snare: '0010001000001000', hihat: '1010100010101000', open: '0000000000000000' },
                    B: { kick: '1000100000100010', snare: '0010001001001000', hihat: '1011101010111010', open: '0000000000000000' },
                    C: { kick: '1001001000100100', snare: '0010001001001000', hihat: '1111101111111011', open: '0000000000000000' },
                    D: { kick: '1011001010110010', snare: '0010101001001010', hihat: '1111111111111111', open: '0000000000000000' }
                },
                main: {
                    A: { kick: '1000001000100000', snare: '0010000000100100', hihat: '1010101010101010', open: '0000000000000000' },
                    B: { kick: '1000100000100010', snare: '0010001000100100', hihat: '1011101110111011', open: '0000000000000000' },
                    C: { kick: '1001001000100100', snare: '0010001001001000', hihat: '1111101111111011', open: '0000000000000000' },
                    D: { kick: '1011001010110010', snare: '0010101001001010', hihat: '1111111111111111', open: '0000000000000000' }
                },
                chorus: {
                    A: { kick: '1000100010001000', snare: '0010000100100010', hihat: '1111111111111111', open: '0000000000000000' },
                    B: { kick: '1001001001001001', snare: '0010010100100101', hihat: '1111111111111111', open: '0000000000000000' },
                    C: { kick: '1011001010110010', snare: '0010101001001010', hihat: '1111111111111111', open: '0000000000000000' },
                    D: { kick: '1111101111111011', snare: '0010101010101010', hihat: '1111111111111111', open: '0000000000000000' }
                },
                fill: {
                    A: { kick: '1000001000001111', snare: '0010101011111111', hihat: '1111111100000000', open: '0000000000000000' },
                    B: { kick: '1001001001001111', snare: '0010111111111111', hihat: '1111110000000000', open: '0000000000000000' },
                    C: { kick: '1111111111111111', snare: '0101010110101011', hihat: '1010101010101010', open: '0000000000000000' },
                    D: { kick: '1111111111111111', snare: '1111111111111111', hihat: '0000000000000000', open: '0000000000000001' }
                },
                break: {
                    A: { kick: '1000000000000000', snare: '0010000000000000', hihat: '1010101010101010', open: '0000000000000000' },
                    B: { kick: '1000001000000000', snare: '0010000000100000', hihat: '0000000000000000', open: '0000000000000000' },
                    C: { kick: '1000001000100010', snare: '0000000000000000', hihat: '1111111111111111', open: '0000000000000000' },
                    D: { kick: '0000000000000000', snare: '0010001000100010', hihat: '1010101010101010', open: '0000000000000000' }
                },
                ending: {
                    A: { kick: '1000001000001111', snare: '0010001011111111', hihat: '0000000000000000', open: '0000000000000001' },
                    B: { kick: '1001001011111111', snare: '0010101111111111', hihat: '0000000000000000', open: '0000000000000001' },
                    C: { kick: '1111111111111111', snare: '1010101011111111', hihat: '0101010100000000', open: '0000000000000001' },
                    D: { kick: '1111111111111111', snare: '1111111111111111', hihat: '1111111111111111', open: '0000000000000001' }
                }
            },
            'LATIN': {
                intro: {
                    A: { kick: '1001000010010000', snare: '0000001000000010', hihat: '1010101010101010', open: '0100010001000100' },
                    B: { kick: '1001001010010010', snare: '0001001000010010', hihat: '1111111111111111', open: '0100010001000100' },
                    C: { kick: '1011001010110010', snare: '0001001000010010', hihat: '1111111111111111', open: '1000100010001000' },
                    D: { kick: '1011101110111011', snare: '0001101100011011', hihat: '1111111111111111', open: '1000100010001000' }
                },
                main: {
                    A: { kick: '1001000010010000', snare: '0001000000010000', hihat: '1010101010101010', open: '0100010001000100' },
                    B: { kick: '1001001010010010', snare: '0001001000010010', hihat: '1111111111111111', open: '0100010001000100' },
                    C: { kick: '1011001010110010', snare: '0001001000010010', hihat: '1111111111111111', open: '1000100010001000' },
                    D: { kick: '1011101110111011', snare: '0001101100011011', hihat: '1111111111111111', open: '1000100010001000' }
                },
                chorus: {
                    A: { kick: '1010100010101000', snare: '0001001000010010', hihat: '1111111111111111', open: '0100010001000100' },
                    B: { kick: '1010101010101010', snare: '0001001000010010', hihat: '1111111111111111', open: '1000100010001000' },
                    C: { kick: '1011101110111011', snare: '0001101100011011', hihat: '1111111111111111', open: '1000100010001000' },
                    D: { kick: '1111111111111111', snare: '0011011001101100', hihat: '1111111111111111', open: '1000100010001000' }
                },
                fill: {
                    A: { kick: '1001000010011111', snare: '0001000011111111', hihat: '0000000000000000', open: '0100010000000001' },
                    B: { kick: '1001001010011111', snare: '0001111111111111', hihat: '1111000000000000', open: '0000000000000001' },
                    C: { kick: '1111111111111111', snare: '0101010110101011', hihat: '0000000000000000', open: '0000000000000001' },
                    D: { kick: '1111111111111111', snare: '1111111111111111', hihat: '0000000000000000', open: '0000000000000001' }
                },
                break: {
                    A: { kick: '1001000000000000', snare: '0001000000000000', hihat: '0000000000000000', open: '0100010000000000' },
                    B: { kick: '1001000010010000', snare: '0001000000010000', hihat: '0000000000000000', open: '0100010001000100' },
                    C: { kick: '1001001010010010', snare: '0000000000000000', hihat: '1111111111111111', open: '0000000000000000' },
                    D: { kick: '0000000000000000', snare: '0001001000010010', hihat: '1010101010101010', open: '0100010001000100' }
                },
                ending: {
                    A: { kick: '1001000010011111', snare: '0001000011111111', hihat: '0000000000000000', open: '0100010000000001' },
                    B: { kick: '1010101011111111', snare: '0001010111111111', hihat: '0000000000000000', open: '0000000000000001' },
                    C: { kick: '1111111111111111', snare: '1010101011111111', hihat: '0101010100000000', open: '0000000000000001' },
                    D: { kick: '1111111111111111', snare: '1111111111111111', hihat: '1111111111111111', open: '0000000000000001' }
                }
            }
        };

        // CTK-3200 Complete Tones List (414 tones) - All tones from the PDF
        const CTK_TONES = [
            // PIANO (001-014)
            { id: 1, name: "STEREO GRAND PIANO", category: "PIANO", program: 0 },
            { id: 2, name: "GRAND PIANO", category: "PIANO", program: 0 },
            { id: 3, name: "BRIGHT PIANO", category: "PIANO", program: 1 },
            { id: 4, name: "MODERN PIANO", category: "PIANO", program: 1 },
            { id: 5, name: "DANCE PIANO", category: "PIANO", program: 1 },
            { id: 6, name: "MELLOW PIANO", category: "PIANO", program: 0 },
            { id: 7, name: "STRINGS PIANO", category: "PIANO", program: 0 },
            { id: 8, name: "HONKY-TONK", category: "PIANO", program: 3 },
            { id: 9, name: "OCTAVE PIANO", category: "PIANO", program: 3 },
            { id: 10, name: "ELEC.GRAND PIANO", category: "PIANO", program: 2 },
            { id: 11, name: "MODERN E.G.PIANO", category: "PIANO", program: 2 },
            { id: 12, name: "HARPSICHORD", category: "PIANO", program: 6 },
            { id: 13, name: "COUPLED HARPSICHORD", category: "PIANO", program: 6 },
            { id: 14, name: "HARPSICHORD & STRINGS", category: "PIANO", program: 6 },
            
            // ELECTRIC PIANO (015-028)
            { id: 15, name: "ELEC.PIANO", category: "ELECTRIC PIANO", program: 4 },
            { id: 16, name: "FM E.PIANO", category: "ELECTRIC PIANO", program: 5 },
            { id: 17, name: "60's E.PIANO", category: "ELECTRIC PIANO", program: 4 },
            { id: 18, name: "CHORUS E.PIANO 1", category: "ELECTRIC PIANO", program: 4 },
            { id: 19, name: "CHORUS E.PIANO 2", category: "ELECTRIC PIANO", program: 4 },
            { id: 20, name: "MODERN E.PIANO", category: "ELECTRIC PIANO", program: 5 },
            { id: 21, name: "SOFT E.PIANO", category: "ELECTRIC PIANO", program: 4 },
            { id: 22, name: "SYNTH-STR.E.PIANO", category: "ELECTRIC PIANO", program: 4 },
            { id: 23, name: "CLEAN E.PIANO", category: "ELECTRIC PIANO", program: 4 },
            { id: 24, name: "CLAVI 1", category: "ELECTRIC PIANO", program: 7 },
            { id: 25, name: "CLAVI 2", category: "ELECTRIC PIANO", program: 7 },
            { id: 26, name: "SOFT CLAVI", category: "ELECTRIC PIANO", program: 7 },
            { id: 27, name: "DETUNE CLAVI", category: "ELECTRIC PIANO", program: 7 },
            { id: 28, name: "SEQUENCE CLAVI", category: "ELECTRIC PIANO", program: 7 }
        ];
        
        // Voice to MIDI scales definition
        const VOICE_SCALES = {
            'chromatic': [0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11],
            'C-major': [0, 2, 4, 5, 7, 9, 11],
            'G-major': [7, 9, 11, 0, 2, 4, 6],
            'D-major': [2, 4, 6, 7, 9, 11, 1],
            'A-major': [9, 11, 1, 2, 4, 6, 8],
            'E-major': [4, 6, 8, 9, 11, 1, 3],
            'F-major': [5, 7, 9, 10, 0, 2, 4],
            'A-minor': [9, 11, 0, 2, 4, 5, 7],
            'E-minor': [4, 6, 7, 9, 11, 0, 2],
            'D-minor': [2, 4, 5, 7, 9, 10, 0]
        };

        // Chord definitions
        const CHORDS = [
            // Row 1 - Major
            { name: 'C', type: 'Major', notes: [60, 64, 67] },
            { name: 'D', type: 'Major', notes: [62, 66, 69] },
            { name: 'E', type: 'Major', notes: [64, 68, 71] },
            { name: 'F', type: 'Major', notes: [65, 69, 72] },
            { name: 'G', type: 'Major', notes: [67, 71, 74] },
            { name: 'A', type: 'Major', notes: [69, 73, 76] },
            
            // Row 2 - Minor
            { name: 'Cm', type: 'Minor', notes: [60, 63, 67] },
            { name: 'Dm', type: 'Minor', notes: [62, 65, 69] },
            { name: 'Em', type: 'Minor', notes: [64, 67, 71] },
            { name: 'Fm', type: 'Minor', notes: [65, 68, 72] },
            { name: 'Gm', type: 'Minor', notes: [67, 70, 74] },
            { name: 'Am', type: 'Minor', notes: [69, 72, 76] },
            
            // Row 3 - 7th
            { name: 'C7', type: '7th', notes: [60, 64, 67, 70] },
            { name: 'D7', type: '7th', notes: [62, 66, 69, 72] },
            { name: 'E7', type: '7th', notes: [64, 68, 71, 74] },
            { name: 'F7', type: '7th', notes: [65, 69, 72, 75] },
            { name: 'G7', type: '7th', notes: [67, 71, 74, 77] },
            { name: 'A7', type: '7th', notes: [69, 73, 76, 79] },
            
            // Row 4 - Special
            { name: 'B¬∞', type: 'Dim', notes: [71, 74, 77] },
            { name: 'Csus4', type: 'Sus4', notes: [60, 65, 67] },
            { name: 'Dsus2', type: 'Sus2', notes: [62, 64, 69] },
            { name: 'FM7', type: 'Maj7', notes: [65, 69, 72, 76] },
            { name: 'Gsus4', type: 'Sus4', notes: [67, 72, 74] },
            { name: 'Am7', type: 'Min7', notes: [69, 72, 76, 79] }
        ];

        // ==========================================
        // INITIALIZATION
        // ==========================================
        
        document.addEventListener('DOMContentLoaded', () => {
            initializeUI();
            
            // Initialize Tone Selectors
            const chordInstrumentSelect = document.getElementById('chordInstrument');
            if (chordInstrumentSelect) {
                buildToneSelector(chordInstrumentSelect);
                chordInstrumentSelect.value = '0'; // Default to Grand Piano
            }
            
            const voiceToneSelect = document.getElementById('voiceToneSelect');
            if (voiceToneSelect) {
                buildToneSelector(voiceToneSelect);
                voiceToneSelect.value = '0'; // Default to Grand Piano
            }
            
            setupEventListeners();
            initializePatterns();
            
            // Set initial states
            document.getElementById('lpTopSESSION').classList.add('active');
            
            // Hide loading
            setTimeout(() => {
                document.getElementById('loading').classList.add('hidden');
            }, 500);
        });

        function initializeUI() {
            // Initialize Style Grid
            const styles = ['8BEAT', '16BEAT', 'POP', 'ROCK', 'JAZZ', 'LATIN'];
            const styleGrid = document.getElementById('styleGrid');
            styles.forEach(style => {
                const btn = document.createElement('button');
                btn.className = 'style-btn';
                btn.textContent = style;
                btn.onclick = () => selectStyle(style);
                if (style === state.currentStyle) btn.classList.add('active');
                styleGrid.appendChild(btn);
            });
            
            // Initialize Section Grid
            const sections = ['INTRO', 'MAIN', 'CHORUS', 'FILL', 'BREAK', 'ENDING'];
            const sectionGrid = document.getElementById('sectionGrid');
            sections.forEach(section => {
                const btn = document.createElement('button');
                btn.className = 'section-btn';
                btn.textContent = section;
                btn.onclick = () => selectSection(section.toLowerCase());
                if (section.toLowerCase() === state.currentSection) btn.classList.add('active');
                sectionGrid.appendChild(btn);
            });
            
            // Initialize Variation Row
            const variations = ['A', 'B', 'C', 'D'];
            const varRow = document.getElementById('variationRow');
            variations.forEach(variation => {
                const btn = document.createElement('button');
                btn.className = 'var-btn';
                btn.textContent = variation;
                btn.onclick = () => selectVariation(variation);
                if (variation === state.currentVariation) btn.classList.add('active');
                varRow.appendChild(btn);
            });
            
            // Initialize Chord Grid
            const chordGrid = document.getElementById('chordGrid');
            CHORDS.forEach((chord, index) => {
                const pad = document.createElement('div');
                pad.className = 'chord-pad';
                pad.dataset.index = index;
                
                const nameDiv = document.createElement('div');
                nameDiv.className = 'chord-name';
                nameDiv.textContent = chord.name;
                
                const typeDiv = document.createElement('div');
                typeDiv.className = 'chord-type';
                typeDiv.textContent = chord.type;
                
                pad.appendChild(nameDiv);
                pad.appendChild(typeDiv);
                
                pad.addEventListener('mousedown', () => playChord(chord));
                pad.addEventListener('mouseup', () => stopChord());
                pad.addEventListener('touchstart', (e) => {
                    e.preventDefault();
                    playChord(chord);
                }, { passive: false });
                pad.addEventListener('touchend', (e) => {
                    e.preventDefault();
                    stopChord();
                }, { passive: false });
                
                chordGrid.appendChild(pad);
            });
            
            // Initialize Pattern Grid
            const patternGrid = document.getElementById('patternGrid');
            const instruments = ['KICK', 'SNARE', 'HIHAT', 'OPEN'];
            
            instruments.forEach((inst, row) => {
                const rowDiv = document.createElement('div');
                rowDiv.className = 'pattern-row';
                
                for (let step = 0; step < 16; step++) {
                    const cell = document.createElement('div');
                    cell.className = 'pattern-cell';
                    cell.dataset.row = row;
                    cell.dataset.step = step;
                    
                    cell.addEventListener('mousedown', handlePatternCellMouseDown);
                    cell.addEventListener('mouseenter', handlePatternCellMouseEnter);
                    cell.addEventListener('touchstart', handlePatternCellTouchStart, { passive: false });
                    cell.addEventListener('touchmove', handlePatternCellTouchMove, { passive: false });
                    
                    rowDiv.appendChild(cell);
                }
                
                patternGrid.appendChild(rowDiv);
            });
            
            // Initialize Launchpad Top Buttons
            const topButtons = ['UP', 'DOWN', 'LEFT', 'RIGHT', 'SESSION', 'USER 1', 'USER 2', 'MIXER'];
            const topBtnContainer = document.getElementById('lpTopButtons');
            
            topButtons.forEach((btn, index) => {
                const button = document.createElement('button');
                button.className = 'lp-top-btn';
                button.textContent = btn;
                button.id = `lpTop${btn.replace(' ', '')}`;
                
                switch(btn) {
                    case 'UP':
                        button.onclick = () => handleLPTopButton('up');
                        break;
                    case 'DOWN':
                        button.onclick = () => handleLPTopButton('down');
                        break;
                    case 'LEFT':
                        button.onclick = () => handleLPTopButton('left');
                        break;
                    case 'RIGHT':
                        button.onclick = () => handleLPTopButton('right');
                        break;
                    case 'SESSION':
                        button.onclick = () => setLaunchpadMode('session');
                        button.classList.add('active');
                        break;
                    case 'USER 1':
                        button.onclick = () => setLaunchpadMode('user1');
                        break;
                    case 'USER 2':
                        button.onclick = () => setLaunchpadMode('user2');
                        break;
                    case 'MIXER':
                        button.onclick = () => handleMixerButton();
                        break;
                }
                
                topBtnContainer.appendChild(button);
            });
            
            // Initialize Launchpad Grid
            const lpGrid = document.getElementById('lpGrid');
            for (let row = 0; row < 8; row++) { // Row 0 = top (Row 8 physique), Row 7 = bottom (Row 1 physique)
                for (let col = 0; col < 8; col++) {
                    const pad = document.createElement('div');
                    pad.className = 'lp-pad';
                    pad.dataset.row = row;
                    pad.dataset.col = col;
                    pad.dataset.note = LP_MAPPING.pads[row][col];
                    pad.id = `lp-${row}-${col}`;
                    
                    pad.addEventListener('mousedown', () => handleLPPadPress(row, col));
                    pad.addEventListener('mouseup', () => {
                        // Only handle release in User1 mode
                        if (state.launchpadMode === 'user1') {
                            handleLPPadRelease(row, col);
                        }
                    });
                    pad.addEventListener('touchstart', (e) => {
                        e.preventDefault();
                        handleLPPadPress(row, col);
                    }, { passive: false });
                    pad.addEventListener('touchend', (e) => {
                        e.preventDefault();
                        // Only handle release in User1 mode
                        if (state.launchpadMode === 'user1') {
                            handleLPPadRelease(row, col);
                        }
                    }, { passive: false });
                    
                    lpGrid.appendChild(pad);
                }
            }
            
            // Initialize Launchpad Right Buttons
            const rightBtnContainer = document.getElementById('lpRightButtons');
            // Bottom to top (index 0-7): First 6 for selections, then Stop, then Play
            const rightLabels = ['DS1', 'DS2', 'DS3', 'DS4', 'DS5', 'DS6', 'STOP', 'PLAY'];
            
            for (let i = 0; i < 8; i++) {
                const btn = document.createElement('button');
                btn.className = 'lp-right-btn';
                btn.textContent = rightLabels[i];
                btn.dataset.index = i;
                btn.id = `lpRight${i}`;
                
                btn.addEventListener('mousedown', () => handleLPRightButton(i));
                // NO mouseup listener - buttons act on press only
                btn.addEventListener('touchstart', (e) => {
                    e.preventDefault();
                    handleLPRightButton(i);
                }, { passive: false });
                // NO touchend listener - buttons act on press only
                
                rightBtnContainer.appendChild(btn);
            }
            
            // Initialize control knobs
            setupKnobControl('swingKnob', 'swingValue', value => {
                state.swing = value;
                document.getElementById('swingValue').textContent = value + '%';
            });
            
            setupKnobControl('velocityKnob', 'velocityValue', value => {
                state.velocity = value;
                document.getElementById('velocityValue').textContent = value;
            });
            
            setupKnobControl('humanizeKnob', 'humanizeValue', value => {
                state.humanize = value;
                document.getElementById('humanizeValue').textContent = value + '%';
            });
        }

        function setupEventListeners() {
            // Global mouse/touch up to stop dragging
            document.addEventListener('mouseup', () => {
                state.isDragging = false;
                state.lastTouchedCell = null;
            });
            
            document.addEventListener('touchend', () => {
                state.isDragging = false;
                state.lastTouchedCell = null;
            });
            
            // Keyboard shortcuts
            document.addEventListener('keydown', (e) => {
                switch(e.key) {
                    case ' ':
                        e.preventDefault();
                        togglePlay();
                        break;
                    case 'Escape':
                        stopPlayback();
                        break;
                    case 'r':
                        toggleRecord();
                        break;
                    case '1':
                        setLaunchpadMode('session');
                        break;
                    case '2':
                        setLaunchpadMode('user1');
                        break;
                    case '3':
                        setLaunchpadMode('user2');
                        break;
                    case 'f':
                    case 'F':
                        e.preventDefault();
                        toggleFullscreen();
                        break;
                    case 'F11':
                        e.preventDefault();
                        toggleFullscreen();
                        break;
                }
            });
            
            // Chord instrument selector
            const chordInstrumentSelect = document.getElementById('chordInstrument');
            if (chordInstrumentSelect) {
                chordInstrumentSelect.addEventListener('change', (e) => {
                    state.chordInstrument = parseInt(e.target.value);
                    showMessage(`Chord instrument: ${e.target.options[e.target.selectedIndex].text}`);
                });
            }
            
            // Chord velocity control
            const chordVelocitySlider = document.getElementById('chordVelocity');
            if (chordVelocitySlider) {
                chordVelocitySlider.addEventListener('input', (e) => {
                    state.chordVelocity = parseInt(e.target.value);
                    document.getElementById('chordVelValue').textContent = e.target.value;
                });
            }
            
            // Voice to MIDI Event Listeners
            const startVoiceBtn = document.getElementById('startVoiceBtn');
            if (startVoiceBtn) {
                startVoiceBtn.addEventListener('click', startVoiceToMidi);
            }
            
            const stopVoiceBtn = document.getElementById('stopVoiceBtn');
            if (stopVoiceBtn) {
                stopVoiceBtn.addEventListener('click', stopVoiceToMidi);
            }
            
            // Voice tone selector
            const voiceToneSelect = document.getElementById('voiceToneSelect');
            if (voiceToneSelect) {
                voiceToneSelect.addEventListener('change', (e) => {
                    const selectedOption = e.target.options[e.target.selectedIndex];
                    showMessage(`Voice instrument: ${selectedOption.textContent}`);
                });
            }
            
            // Voice play mode
            const voicePlayMode = document.getElementById('voicePlayMode');
            if (voicePlayMode) {
                voicePlayMode.addEventListener('change', (e) => {
                    state.voiceToMidi.playMode = e.target.value;
                });
            }
            
            // Voice scale
            const voiceScale = document.getElementById('voiceScale');
            if (voiceScale) {
                voiceScale.addEventListener('change', (e) => {
                    state.voiceToMidi.scale = e.target.value;
                });
            }
            
            // Voice reverb
            const voiceReverb = document.getElementById('voiceReverb');
            if (voiceReverb) {
                voiceReverb.addEventListener('input', (e) => {
                    state.voiceToMidi.reverb = parseInt(e.target.value);
                    document.getElementById('voiceReverbValue').textContent = e.target.value;
                });
            }
            
            // Voice vibrato
            const voiceVibrato = document.getElementById('voiceVibrato');
            if (voiceVibrato) {
                voiceVibrato.addEventListener('input', (e) => {
                    state.voiceToMidi.vibrato = parseInt(e.target.value);
                    document.getElementById('voiceVibratoValue').textContent = e.target.value;
                });
            }
            
            // Voice sensitivity
            const voiceSensitivity = document.getElementById('voiceSensitivity');
            if (voiceSensitivity) {
                voiceSensitivity.addEventListener('input', (e) => {
                    state.voiceToMidi.sensitivity = parseInt(e.target.value);
                    document.getElementById('voiceSensitivityValue').textContent = e.target.value;
                });
            }
            
            // Voice smoothing
            const voiceSmoothing = document.getElementById('voiceSmoothing');
            if (voiceSmoothing) {
                voiceSmoothing.addEventListener('input', (e) => {
                    state.voiceToMidi.smoothing = parseInt(e.target.value);
                    document.getElementById('voiceSmoothingValue').textContent = e.target.value + 'ms';
                });
            }
            
            // Voice transpose
            const voiceTranspose = document.getElementById('voiceTranspose');
            if (voiceTranspose) {
                voiceTranspose.addEventListener('input', (e) => {
                    state.voiceToMidi.transpose = parseInt(e.target.value);
                    const val = parseInt(e.target.value);
                    const sign = val > 0 ? '+' : '';
                    document.getElementById('voiceTransposeValue').textContent = sign + val;
                });
            }
        }

        function setupKnobControl(knobId, valueId, callback) {
            const knob = document.getElementById(knobId);
            const indicator = knob.querySelector('.control-indicator');
            let startX = 0;
            let startValue = 0;
            
            const updateKnob = (value) => {
                const min = parseInt(knob.dataset.min);
                const max = parseInt(knob.dataset.max);
                value = Math.max(min, Math.min(max, value));
                
                knob.dataset.value = value;
                const angle = ((value - min) / (max - min)) * 270 - 135;
                indicator.style.transform = `translateX(-50%) rotate(${angle}deg)`;
                
                callback(value);
            };
            
            const handleStart = (e) => {
                e.preventDefault();
                startX = e.type.includes('touch') ? e.touches[0].clientX : e.clientX;
                startValue = parseInt(knob.dataset.value);
                
                const handleMove = (e) => {
                    const currentX = e.type.includes('touch') ? e.touches[0].clientX : e.clientX;
                    const diff = currentX - startX;
                    const min = parseInt(knob.dataset.min);
                    const max = parseInt(knob.dataset.max);
                    const range = max - min;
                    const newValue = startValue + Math.round(diff / 100 * range);
                    updateKnob(newValue);
                };
                
                const handleEnd = () => {
                    document.removeEventListener('mousemove', handleMove);
                    document.removeEventListener('touchmove', handleMove);
                    document.removeEventListener('mouseup', handleEnd);
                    document.removeEventListener('touchend', handleEnd);
                };
                
                document.addEventListener('mousemove', handleMove);
                document.addEventListener('touchmove', handleMove, { passive: false });
                document.addEventListener('mouseup', handleEnd);
                document.addEventListener('touchend', handleEnd);
            };
            
            knob.addEventListener('mousedown', handleStart);
            knob.addEventListener('touchstart', handleStart, { passive: false });
            
            // Initialize value
            updateKnob(parseInt(knob.dataset.value));
        }

        // ==========================================
        // PATTERN MANAGEMENT
        // ==========================================
        
        function initializePatterns() {
            // Initialize with default pattern
            loadPattern(state.currentStyle, state.currentSection, state.currentVariation);
        }

        function loadPattern(style, section, variation) {
            const patterns = RHYTHM_PATTERNS[style];
            if (patterns && patterns[section] && patterns[section][variation]) {
                const pattern = patterns[section][variation];
                
                // Convert string patterns to drum pattern array
                for (let i = 0; i < 16; i++) {
                    state.drumPattern[i] = {
                        kick: pattern.kick[i] === '1',
                        snare: pattern.snare[i] === '1',
                        hihat: pattern.hihat[i] === '1',
                        open: pattern.open[i] === '1'
                    };
                }
                
                updatePatternDisplay();
                updateLaunchpadDisplay();
            }
        }

        function updatePatternDisplay() {
            const instruments = ['kick', 'snare', 'hihat', 'open'];
            
            instruments.forEach((inst, row) => {
                for (let step = 0; step < 16; step++) {
                    const cell = document.querySelector(`.pattern-cell[data-row="${row}"][data-step="${step}"]`);
                    if (cell) {
                        if (state.drumPattern[step][inst]) {
                            cell.classList.add('active');
                        } else {
                            cell.classList.remove('active');
                        }
                    }
                }
            });
        }

        // ==========================================
        // PATTERN EDITING
        // ==========================================
        
        function handlePatternCellMouseDown(e) {
            const row = parseInt(e.target.dataset.row);
            const step = parseInt(e.target.dataset.step);
            const instruments = ['kick', 'snare', 'hihat', 'open'];
            const instrument = instruments[row];
            
            // Toggle cell state
            state.drumPattern[step][instrument] = !state.drumPattern[step][instrument];
            e.target.classList.toggle('active');
            
            // Start drag mode - set dragMode to the NEW state we just set
            state.isDragging = true;
            state.dragMode = state.drumPattern[step][instrument];
            state.lastTouchedCell = e.target;
            
            // Update Launchpad display
            updateLaunchpadDisplay();
        }

        function handlePatternCellMouseEnter(e) {
            if (state.isDragging) {
                const row = parseInt(e.target.dataset.row);
                const step = parseInt(e.target.dataset.step);
                const instruments = ['kick', 'snare', 'hihat', 'open'];
                const instrument = instruments[row];
                
                // Apply drag mode
                state.drumPattern[step][instrument] = state.dragMode;
                
                if (state.dragMode) {
                    e.target.classList.add('active');
                } else {
                    e.target.classList.remove('active');
                }
                
                updateLaunchpadDisplay();
            }
        }

        function handlePatternCellTouchStart(e) {
            e.preventDefault();
            handlePatternCellMouseDown(e);
        }

        function handlePatternCellTouchMove(e) {
            e.preventDefault();
            const touch = e.touches[0];
            const element = document.elementFromPoint(touch.clientX, touch.clientY);
            
            if (element && element.classList.contains('pattern-cell') && element !== state.lastTouchedCell) {
                state.lastTouchedCell = element;
                
                const row = parseInt(element.dataset.row);
                const step = parseInt(element.dataset.step);
                const instruments = ['kick', 'snare', 'hihat', 'open'];
                const instrument = instruments[row];
                
                // Apply drag mode
                state.drumPattern[step][instrument] = state.dragMode;
                
                if (state.dragMode) {
                    element.classList.add('active');
                } else {
                    element.classList.remove('active');
                }
                
                updateLaunchpadDisplay();
            }
        }

        // ==========================================
        // LAUNCHPAD CONTROL
        // ==========================================
        
        function setLaunchpadMode(mode) {
            state.launchpadMode = mode;
            
            // Clear ALL mode buttons first
            document.getElementById('lpTopSESSION').classList.remove('active');
            document.getElementById('lpTopUSER1').classList.remove('active');
            document.getElementById('lpTopUSER2').classList.remove('active');
            
            // Update bass status visibility
            const bassStatus = document.getElementById('bassStatus');
            if (mode === 'user2') {
                bassStatus.style.display = 'flex';
                const bassName = BASS_PROGRAMS[state.currentBassProgram - 83];
                document.getElementById('bassDisplay').textContent = bassName.toUpperCase().substring(0, 10);
            } else {
                bassStatus.style.display = 'none';
            }
            
            // Set only the active mode button
            switch(mode) {
                case 'session':
                    document.getElementById('lpTopSESSION').classList.add('active');
                    break;
                case 'user1':
                    document.getElementById('lpTopUSER1').classList.add('active');
                    break;
                case 'user2':
                    document.getElementById('lpTopUSER2').classList.add('active');
                    // Ensure UP or DOWN is active
                    if (!state.bassUpActive && !document.getElementById('lpTopDOWN').classList.contains('active')) {
                        state.bassUpActive = true;
                    }
                    // Show current bass tone
                    showMessage(`Bass: ${BASS_PROGRAMS[state.currentBassProgram - 83]}`);
                    break;
            }
            
            // Update Launchpad display
            updateLaunchpadDisplay();
            
            // Send mode change to physical Launchpad
            if (state.midiOutLP) {
                // Clear all mode buttons first
                state.midiOutLP.send([0xB0, LP_MAPPING.topButtons.session, 0]);
                state.midiOutLP.send([0xB0, LP_MAPPING.topButtons.user1, 0]);
                state.midiOutLP.send([0xB0, LP_MAPPING.topButtons.user2, 0]);
                
                // Set the active mode button
                const ccMap = {
                    'session': LP_MAPPING.topButtons.session,
                    'user1': LP_MAPPING.topButtons.user1,
                    'user2': LP_MAPPING.topButtons.user2
                };
                
                state.midiOutLP.send([0xB0, ccMap[mode], 127]);
                
                // Update all pads and buttons
                sendLaunchpadUpdate();
            }
        }

        function updateLaunchpadDisplay() {
            // Clear all pads first
            for (let row = 0; row < 8; row++) {
                for (let col = 0; col < 8; col++) {
                    const pad = document.getElementById(`lp-${row}-${col}`);
                    if (pad) {
                        pad.dataset.color = '';
                        pad.classList.remove('active', 'playing');
                    }
                }
            }
            
            // Update right button labels based on mode
            const rightButtons = document.querySelectorAll('.lp-right-btn');
            if (state.launchpadMode === 'session') {
                const labels = ['DS1', 'DS2', 'DS3', 'DS4', 'DS5', 'DS6', 'STOP', 'PLAY'];
                rightButtons.forEach((btn, i) => {
                    btn.textContent = labels[i];
                });
            } else if (state.launchpadMode === 'user1') {
                const labels = ['', '', '', '', '', '', 'STOP', 'PLAY'];
                rightButtons.forEach((btn, i) => {
                    btn.textContent = labels[i];
                    btn.classList.remove('active');
                    btn.dataset.function = '';
                    
                    // Only set function for Play/Stop
                    if (i === 7) {
                        btn.dataset.function = 'play';
                        btn.classList.toggle('active', state.isPlaying);
                    } else if (i === 6) {
                        btn.dataset.function = 'stop';
                    }
                });
            } else if (state.launchpadMode === 'user2') {
                const isLeftActive = state.currentBassProgram < 89;
                const baseIndex = isLeftActive ? 0 : 6;
                // Show abbreviated bass names
                const bassLabels = [
                    'ACO', 'RID', 'ELE', 'B&C', 'SL1', 'SL2',  // 83-88
                    'SY1', 'SY2', 'SY3', 'SY4', 'SIN', 'SAW'   // 89-94
                ];
                const labels = bassLabels.slice(baseIndex, baseIndex + 6).concat(['STOP', 'PLAY']);
                rightButtons.forEach((btn, i) => {
                    btn.textContent = labels[i];
                });
            }
            
            // Update based on mode
            switch(state.launchpadMode) {
                case 'session':
                    updateLaunchpadSession();
                    break;
                case 'user1':
                    updateLaunchpadUser1();
                    break;
                case 'user2':
                    updateLaunchpadUser2();
                    break;
            }
            
            // Update physical Launchpad if connected
            if (state.midiOutLP) {
                sendLaunchpadUpdate();
            }
        }

        function updateLaunchpadSession() {
            // Session mode - Show drum pattern with rhythm advancing
            // Top 4 rows (0-3) = beats 1-8 (rows physiques 8-5)
            // Bottom 4 rows (4-7) = beats 9-16 (rows physiques 4-1)
            
            const colors = {
                kick: 'red',
                snare: 'yellow',
                hihat: 'cyan',
                open: 'purple'
            };
            
            // Display pattern on grid
            for (let beat = 0; beat < 16; beat++) {
                const col = beat < 8 ? beat : beat - 8;
                
                const pattern = state.drumPattern[beat];
                
                // Kick on row 0/4 (top row of each half)
                if (pattern.kick) {
                    const row = beat < 8 ? 0 : 4;
                    const pad = document.getElementById(`lp-${row}-${col}`);
                    if (pad) pad.dataset.color = colors.kick;
                }
                
                // Snare on row 1/5
                if (pattern.snare) {
                    const row = beat < 8 ? 1 : 5;
                    const pad = document.getElementById(`lp-${row}-${col}`);
                    if (pad) pad.dataset.color = colors.snare;
                }
                
                // HiHat on row 2/6
                if (pattern.hihat) {
                    const row = beat < 8 ? 2 : 6;
                    const pad = document.getElementById(`lp-${row}-${col}`);
                    if (pad) pad.dataset.color = colors.hihat;
                }
                
                // Open HH on row 3/7
                if (pattern.open) {
                    const row = beat < 8 ? 3 : 7;
                    const pad = document.getElementById(`lp-${row}-${col}`);
                    if (pad) pad.dataset.color = colors.open;
                }
            }
            
            // Highlight current beat if playing
            if (state.isPlaying) {
                const col = state.currentBeat < 8 ? state.currentBeat : state.currentBeat - 8;
                const rowStart = state.currentBeat < 8 ? 0 : 4;
                
                for (let i = 0; i < 4; i++) {
                    const pad = document.getElementById(`lp-${rowStart + i}-${col}`);
                    if (pad) pad.classList.add('playing');
                }
            }
            
            // Update right buttons for drum set selection
            for (let i = 0; i < 6; i++) {
                const btn = document.getElementById(`lpRight${i}`); // Buttons 0-5 for drum sets
                if (btn) {
                    btn.classList.toggle('active', i === state.currentDrumSet);
                }
            }
            
            // Play/Stop buttons
            const playBtn = document.getElementById('lpRight7'); // Top button for Play
            const stopBtn = document.getElementById('lpRight6'); // Second button for Stop
            
            if (playBtn) {
                playBtn.dataset.function = 'play';
                // Play button visual state changes but always shows green on physical pad
                playBtn.classList.toggle('active', state.isPlaying);
            }
            
            if (stopBtn) {
                stopBtn.dataset.function = 'stop';
            }
        }

        function updateLaunchpadUser1() {
            // User1 mode - Drum pad mode with color grouping
            let padIndex = 0;
            
            DRUM_COLORS.forEach((group, groupIndex) => {
                group.notes.forEach(note => {
                    if (padIndex < 64) {
                        const row = Math.floor(padIndex / 8);
                        const col = padIndex % 8;
                        const pad = document.getElementById(`lp-${row}-${col}`);
                        
                        if (pad) {
                            pad.dataset.color = group.color;
                            pad.dataset.drumNote = note;
                        }
                        
                        padIndex++;
                    }
                });
            });
        }

        function updateLaunchpadUser2() {
            // User2 mode - Bass sequencer
            // Note layout (top to bottom pads): D2, E2, C2, A1, G1, D1, E1, C1
            // Show current half (UP = beats 1-8, DOWN = beats 9-16)
            const startBeat = state.bassUpActive ? 0 : 8;
            
            for (let beat = 0; beat < 8; beat++) {
                const actualBeat = startBeat + beat;
                const pattern = state.bassPattern[actualBeat];
                
                for (let note = 0; note < 8; note++) {
                    const row = note; // Row 0 = D1 (top), Row 7 = C0 (bottom)
                    const pad = document.getElementById(`lp-${row}-${beat}`);
                    
                    if (pad) {
                        if (pattern[note]) {
                            pad.dataset.color = 'blue';
                            pad.classList.add('active');
                        } else {
                            pad.dataset.color = '';
                            pad.classList.remove('active');
                        }
                    }
                }
            }
            
            // Highlight current beat column if playing
            if (state.isPlaying) {
                const displayBeat = state.bassUpActive ? 
                    (state.currentBeat < 8 ? state.currentBeat : -1) :
                    (state.currentBeat >= 8 ? state.currentBeat - 8 : -1);
                
                if (displayBeat >= 0) {
                    for (let row = 0; row < 8; row++) {
                        const pad = document.getElementById(`lp-${row}-${displayBeat}`);
                        if (pad) pad.classList.add('playing');
                    }
                }
            }
            
            // ALWAYS show one of UP/DOWN as active
            document.getElementById('lpTopUP').classList.toggle('active', state.bassUpActive);
            document.getElementById('lpTopDOWN').classList.toggle('active', !state.bassUpActive);
            
            // Update LEFT/RIGHT for bass tone selection
            const isLeftActive = state.currentBassProgram < 89;
            document.getElementById('lpTopLEFT').classList.toggle('active', isLeftActive);
            document.getElementById('lpTopRIGHT').classList.toggle('active', !isLeftActive);
            
            // Update right buttons for bass tone selection (buttons 0-5)
            const baseIndex = isLeftActive ? 83 : 89;
            const selectedIndex = state.currentBassProgram - baseIndex;
            
            for (let i = 0; i < 6; i++) {
                const btn = document.getElementById(`lpRight${i}`); // Buttons 0-5
                if (btn) {
                    btn.classList.toggle('active', i === selectedIndex);
                }
            }
            
            // Play/Stop buttons
            const playBtn = document.getElementById('lpRight7');
            const stopBtn = document.getElementById('lpRight6');
            
            if (playBtn) {
                playBtn.dataset.function = 'play';
                playBtn.classList.toggle('active', state.isPlaying);
            }
            
            if (stopBtn) {
                stopBtn.dataset.function = 'stop';
            }
        }

        // ==========================================
        // LAUNCHPAD PAD AND BUTTON HANDLERS
        // All actions occur on PRESS (mousedown/noteOn)
        // Release (mouseup/noteOff) only stops drum sounds in User1
        // ==========================================
        
        function handleLPPadPress(row, col) {
            // Called on pad PRESS (both web click and MIDI noteOn)
            switch(state.launchpadMode) {
                case 'session':
                    handleSessionPadPress(row, col);
                    break;
                case 'user1':
                    handleUser1PadPress(row, col);
                    break;
                case 'user2':
                    handleUser2PadPress(row, col);
                    break;
            }
        }

        function handleLPPadRelease(row, col) {
            // ONLY handle release in User1 mode for stopping drum sounds
            if (state.launchpadMode === 'user1') {
                // Stop drum sound on release
                const pad = document.getElementById(`lp-${row}-${col}`);
                if (pad && pad.dataset.drumNote) {
                    if (state.midiOutCTK) {
                        state.midiOutCTK.send([0x89, parseInt(pad.dataset.drumNote), 0]);
                    }
                    // Do NOT remove active class - it toggles on press, not release
                }
            }
            // Session and User2: DO NOTHING on release - toggle already happened on press
        }

        function handleSessionPadPress(row, col) {
            // Determine beat and instrument
            let beat, instrument;
            
            if (row < 4) {
                // Top half (rows 0-3) - beats 1-8
                beat = col;
                instrument = row; // 0=kick, 1=snare, 2=hihat, 3=open
            } else {
                // Bottom half (rows 4-7) - beats 9-16
                beat = col + 8;
                instrument = row - 4;
            }
            
            const instruments = ['kick', 'snare', 'hihat', 'open'];
            const inst = instruments[instrument];
            
            if (inst && beat >= 0 && beat < 16) {
                // Toggle the pattern - this is the key change
                state.drumPattern[beat][inst] = !state.drumPattern[beat][inst];
                updatePatternDisplay();
                updateLaunchpadDisplay();
            }
        }

        function handleUser1PadPress(row, col) {
            // Play drum sound and toggle visual
            const pad = document.getElementById(`lp-${row}-${col}`);
            if (pad && pad.dataset.drumNote) {
                const note = parseInt(pad.dataset.drumNote);
                
                if (state.midiOutCTK) {
                    state.midiOutCTK.send([0x99, note, state.velocity]);
                }
                
                // Toggle visual state - pad stays lit after release
                pad.classList.toggle('active');
            }
        }

        function handleUser2PadPress(row, col) {
            // Toggle bass note - stays toggled after release
            // Note layout (top to bottom pads): D2, E2, C2, A1, G1, D1, E1, C1
            const noteIndex = row; // Row 0 = D2 (highest), Row 7 = C1 (lowest)
            const beat = state.bassUpActive ? col : col + 8;
            
            // Toggle the note
            state.bassPattern[beat][noteIndex] = !state.bassPattern[beat][noteIndex];
            
            // Visual feedback - flash the pad
            const pad = document.getElementById(`lp-${row}-${col}`);
            if (pad) {
                pad.classList.add('playing');
                setTimeout(() => {
                    pad.classList.remove('playing');
                    updateLaunchpadDisplay();
                }, 100);
            } else {
                updateLaunchpadDisplay();
            }
        }

        function handleLPRightButton(index) {
            // Called on button PRESS (both web click and MIDI noteOn)
            // All buttons trigger their action immediately on press
            switch(state.launchpadMode) {
                case 'session':
                    if (index >= 0 && index <= 5) {
                        // Drum set selection (buttons 0-5)
                        state.currentDrumSet = index;
                        updateLaunchpadDisplay();
                    } else if (index === 7) {
                        // Play button (top)
                        togglePlay();
                    } else if (index === 6) {
                        // Stop button (second from top)
                        stopPlayback();
                    }
                    break;
                    
                case 'user1':
                    if (index === 7) {
                        // Play button
                        togglePlay();
                    } else if (index === 6) {
                        // Stop button
                        stopPlayback();
                    }
                    break;
                    
                case 'user2':
                    if (index >= 0 && index <= 5) {
                        // Bass tone selection (buttons 0-5)
                        const isLeftActive = state.currentBassProgram < 89;
                        const baseIndex = isLeftActive ? 83 : 89;
                        state.currentBassProgram = baseIndex + index;
                        
                        // Update bass display
                        const bassName = BASS_PROGRAMS[state.currentBassProgram - 83];
                        const bassStatusDisplay = document.getElementById('bassDisplay');
                        if (bassStatusDisplay) {
                            bassStatusDisplay.textContent = bassName.toUpperCase().substring(0, 10);
                        }
                        
                        // Send program change IMMEDIATELY
                        if (state.midiOutCTK) {
                            // Program change on channel 1 (0x00)
                            state.midiOutCTK.send([0xC0, state.currentBassProgram - 1]); // CTK-3200 uses 0-based program numbers
                            showMessage(`Bass: ${bassName}`);
                        }
                        
                        updateLaunchpadDisplay();
                    } else if (index === 7) {
                        togglePlay();
                    } else if (index === 6) {
                        stopPlayback();
                    }
                    break;
            }
        }

        function handleLPTopButton(button) {
            switch(button) {
                case 'up':
                    if (state.launchpadMode === 'user2') {
                        state.bassUpActive = true;
                        updateLaunchpadDisplay();
                    }
                    break;
                    
                case 'down':
                    if (state.launchpadMode === 'user2') {
                        state.bassUpActive = false;
                        updateLaunchpadDisplay();
                    }
                    break;
                    
                case 'left':
                    if (state.launchpadMode === 'user2') {
                        // Select bass tones 83-88
                        if (state.currentBassProgram > 88) {
                            const offset = state.currentBassProgram - 89; // Keep same relative position
                            state.currentBassProgram = 83 + Math.min(offset, 5);
                        }
                        
                        // Update display
                        const bassName = BASS_PROGRAMS[state.currentBassProgram - 83];
                        document.getElementById('bassDisplay').textContent = bassName.toUpperCase().substring(0, 10);
                        
                        // Send program change
                        if (state.midiOutCTK) {
                            state.midiOutCTK.send([0xC0, state.currentBassProgram - 1]);
                            showMessage(`Bass: ${bassName}`);
                        }
                        
                        updateLaunchpadDisplay();
                    }
                    break;
                    
                case 'right':
                    if (state.launchpadMode === 'user2') {
                        // Select bass tones 89-94
                        if (state.currentBassProgram < 89) {
                            const offset = state.currentBassProgram - 83; // Keep same relative position
                            state.currentBassProgram = 89 + Math.min(offset, 5);
                        }
                        
                        // Update display
                        const bassName = BASS_PROGRAMS[state.currentBassProgram - 83];
                        document.getElementById('bassDisplay').textContent = bassName.toUpperCase().substring(0, 10);
                        
                        // Send program change
                        if (state.midiOutCTK) {
                            state.midiOutCTK.send([0xC0, state.currentBassProgram - 1]);
                            showMessage(`Bass: ${bassName}`);
                        }
                        
                        updateLaunchpadDisplay();
                    }
                    break;
            }
        }

        function handleMixerButton() {
            // Clear patterns based on current mode
            if (state.launchpadMode === 'session') {
                // Clear drum pattern
                for (let i = 0; i < 16; i++) {
                    state.drumPattern[i] = {
                        kick: false,
                        snare: false,
                        hihat: false,
                        open: false
                    };
                }
                updatePatternDisplay();
            } else if (state.launchpadMode === 'user2') {
                // Clear bass pattern
                state.bassPattern = Array(16).fill(null).map(() => Array(8).fill(false));
            }
            
            updateLaunchpadDisplay();
            showMessage('Pattern cleared');
        }

        function sendLaunchpadUpdate() {
            if (!state.midiOutLP) return;
            
            // Update all pads
            for (let row = 0; row < 8; row++) {
                for (let col = 0; col < 8; col++) {
                    const pad = document.getElementById(`lp-${row}-${col}`);
                    const note = LP_MAPPING.pads[row][col];
                    
                    let velocity = 0;
                    if (pad) {
                        const color = pad.dataset.color;
                        if (color && LP_MAPPING.colors[color]) {
                            velocity = LP_MAPPING.colors[color];
                        }
                        
                        if (pad.classList.contains('playing')) {
                            velocity = LP_MAPPING.colors.white;
                        }
                    }
                    
                    state.midiOutLP.send([0x90, note, velocity]);
                }
            }
            
            // Update right buttons
            for (let i = 0; i < 8; i++) {
                const note = LP_MAPPING.rightButtons[i];
                let velocity = 0;
                
                if (i === 7) {
                    // Play button - ALWAYS GREEN
                    velocity = state.isPlaying ? LP_MAPPING.colors.lime : LP_MAPPING.colors.green;
                } else if (i === 6) {
                    // Stop button - ALWAYS RED
                    velocity = LP_MAPPING.colors.red;
                } else {
                    // Other buttons - check if active
                    const btn = document.getElementById(`lpRight${i}`);
                    if (btn && btn.classList.contains('active')) {
                        velocity = LP_MAPPING.colors.white;
                    }
                }
                
                state.midiOutLP.send([0x90, note, velocity]);
            }
            
            // Update top buttons - ensure only one mode button is active
            const topButtonStates = {
                up: state.launchpadMode === 'user2' && state.bassUpActive,
                down: state.launchpadMode === 'user2' && !state.bassUpActive,
                left: state.launchpadMode === 'user2' && state.currentBassProgram < 89,
                right: state.launchpadMode === 'user2' && state.currentBassProgram >= 89,
                session: state.launchpadMode === 'session',
                user1: state.launchpadMode === 'user1',
                user2: state.launchpadMode === 'user2',
                mixer: false
            };
            
            Object.entries(topButtonStates).forEach(([button, active]) => {
                const cc = LP_MAPPING.topButtons[button];
                state.midiOutLP.send([0xB0, cc, active ? 127 : 0]);
            });
        }

        // ==========================================
        // MIDI HANDLING
        // ==========================================
        
        function connectMIDI() {
            if (navigator.requestMIDIAccess) {
                navigator.requestMIDIAccess()
                    .then(onMIDISuccess, onMIDIFailure);
            } else {
                showMessage('WebMIDI not supported in this browser');
            }
        }

        function onMIDISuccess(midiAccess) {
            // Find devices
            const inputs = Array.from(midiAccess.inputs.values());
            const outputs = Array.from(midiAccess.outputs.values());
            
            // CTK-3200
            const ctkOut = outputs.find(device => 
                device.name.includes('CTK') || 
                device.name.includes('CASIO') ||
                device.name.includes('3200')
            );
            
            if (ctkOut) {
                state.midiOutCTK = ctkOut;
                document.getElementById('ctkLed').classList.add('active');
                showMessage(`Connected: ${ctkOut.name}`);
            }
            
            // Launchpad MK2
            const lpOut = outputs.find(device => 
                device.name.includes('Launchpad') || 
                device.name.includes('MK2') ||
                device.name.includes('MIDIOUT2')
            );
            
            const lpIn = inputs.find(device => 
                device.name.includes('Launchpad') || 
                device.name.includes('MK2') ||
                device.name.includes('MIDIIN2')
            );
            
            if (lpOut && lpIn) {
                state.midiOutLP = lpOut;
                state.midiInLP = lpIn;
                document.getElementById('lpLed').classList.add('active');
                
                // Setup input handler
                lpIn.onmidimessage = handleLaunchpadMIDI;
                
                // Initialize Launchpad
                initializeLaunchpad();
                
                showMessage(`Connected: ${lpOut.name}`);
            }
            
            if (!ctkOut && !lpOut) {
                showMessage('No MIDI devices found');
            }
        }

        function onMIDIFailure() {
            showMessage('Failed to access MIDI devices');
        }

        function initializeLaunchpad() {
            if (!state.midiOutLP) return;
            
            // Reset Launchpad
            state.midiOutLP.send([0xB0, 0, 0]);
            
            // Set initial mode after a short delay
            setTimeout(() => {
                // Clear all mode buttons first
                state.midiOutLP.send([0xB0, LP_MAPPING.topButtons.session, 0]);
                state.midiOutLP.send([0xB0, LP_MAPPING.topButtons.user1, 0]);
                state.midiOutLP.send([0xB0, LP_MAPPING.topButtons.user2, 0]);
                
                // Set Session mode active
                state.midiOutLP.send([0xB0, LP_MAPPING.topButtons.session, 127]);
                
                // Update all pads and buttons
                sendLaunchpadUpdate();
            }, 100);
        }

        function handleLaunchpadMIDI(message) {
            const [status, data1, data2] = message.data;
            
            if (status === 0x90) {
                // Note on - BUT if velocity is 0, treat as Note Off
                if (data2 === 0) {
                    // Velocity 0 = Note Off (common MIDI convention)
                    handleLaunchpadNoteOff(data1);
                } else {
                    // Actual Note On with velocity > 0
                    handleLaunchpadNoteOn(data1, data2);
                }
            } else if (status === 0x80) {
                // Explicit Note off
                handleLaunchpadNoteOff(data1);
            } else if (status === 0xB0) {
                // Control change (top buttons)
                handleLaunchpadCC(data1, data2);
            }
        }

        function handleLaunchpadNoteOn(note, velocity) {
            // Find which pad or button
            for (let row = 0; row < 8; row++) {
                for (let col = 0; col < 8; col++) {
                    if (LP_MAPPING.pads[row][col] === note) {
                        handleLPPadPress(row, col);
                        return;
                    }
                }
            }
            
            // Check right buttons
            const rightIndex = LP_MAPPING.rightButtons.indexOf(note);
            if (rightIndex !== -1) {
                handleLPRightButton(rightIndex);
            }
        }

        function handleLaunchpadNoteOff(note) {
            // Only handle pad releases for User1 mode (drum note off)
            // Do NOT handle right button releases
            for (let row = 0; row < 8; row++) {
                for (let col = 0; col < 8; col++) {
                    if (LP_MAPPING.pads[row][col] === note) {
                        handleLPPadRelease(row, col);
                        return;
                    }
                }
            }
            
            // DO NOT handle right button releases - Play/Stop should only trigger on press
        }

        function handleLaunchpadCC(cc, value) {
            if (value === 0) return; // Ignore button release
            
            switch(cc) {
                case LP_MAPPING.topButtons.up:
                    handleLPTopButton('up');
                    break;
                case LP_MAPPING.topButtons.down:
                    handleLPTopButton('down');
                    break;
                case LP_MAPPING.topButtons.left:
                    handleLPTopButton('left');
                    break;
                case LP_MAPPING.topButtons.right:
                    handleLPTopButton('right');
                    break;
                case LP_MAPPING.topButtons.session:
                    setLaunchpadMode('session');
                    break;
                case LP_MAPPING.topButtons.user1:
                    setLaunchpadMode('user1');
                    break;
                case LP_MAPPING.topButtons.user2:
                    setLaunchpadMode('user2');
                    break;
                case LP_MAPPING.topButtons.mixer:
                    handleMixerButton();
                    break;
            }
        }

        // ==========================================
        // PLAYBACK ENGINE
        // ==========================================
        
        function togglePlay() {
            if (state.isPlaying) {
                stopPlayback();
            } else {
                startPlayback();
            }
        }

        let sequencerTimeout = null;
        
        function startPlayback() {
            if (state.isPlaying) return;
            
            state.isPlaying = true;
            document.getElementById('playBtn').classList.add('playing');
            document.getElementById('playBtn').textContent = '‚ùö‚ùö';
            
            // Start playing
            playNextBeat();
        }
        
        function playNextBeat() {
            if (!state.isPlaying) return;
            
            // Play current beat
            playCurrentBeat();
            updateBeatDisplay();
            
            // Move to next beat
            state.currentBeat = (state.currentBeat + 1) % 16;
            
            // Calculate delay with swing
            const beatDuration = 60000 / state.tempo / 4;
            let delay = beatDuration;
            
            // Apply swing to odd beats
            if (state.swing > 50 && (state.currentBeat % 2) === 1) {
                const swingFactor = (state.swing - 50) / 50;
                delay = beatDuration * (1 + swingFactor * 0.5);
            }
            
            // Schedule next beat
            sequencerTimeout = setTimeout(() => {
                playNextBeat();
            }, delay);
        }

        function stopPlayback() {
            state.isPlaying = false;
            state.currentBeat = 0;
            
            // Clear any scheduled beats
            if (sequencerTimeout) {
                clearTimeout(sequencerTimeout);
                sequencerTimeout = null;
            }
            
            document.getElementById('playBtn').classList.remove('playing');
            document.getElementById('playBtn').textContent = '‚ñ∂';
            
            // Stop all sounds with reverb effect
            if (state.midiOutCTK) {
                // Add reverb
                state.midiOutCTK.send([0xB0, 91, 64]); // Reverb effect
                
                // Gradual volume fade
                let volume = state.velocity;
                const fadeInterval = setInterval(() => {
                    volume -= 10;
                    if (volume <= 0) {
                        clearInterval(fadeInterval);
                        // All notes off
                        state.midiOutCTK.send([0xB0, 123, 0]);
                        // Reset reverb
                        state.midiOutCTK.send([0xB0, 91, 0]);
                        // Reset volume
                        state.midiOutCTK.send([0xB0, 7, state.velocity]);
                    } else {
                        state.midiOutCTK.send([0xB0, 7, volume]);
                    }
                }, 100);
            }
            
            // Clear beat display
            document.querySelectorAll('.pattern-cell').forEach(cell => {
                cell.classList.remove('playing');
            });
            
            // Update Launchpad display to clear playing indicators
            updateLaunchpadDisplay();
        }

        function playCurrentBeat() {
            // Get pattern with fallback
            const pattern = state.drumPattern[state.currentBeat] || {
                kick: false,
                snare: false, 
                hihat: false,
                open: false
            };
            
            // Apply humanize
            const humanizeAmount = state.humanize / 100;
            const velocityVariation = Math.round((Math.random() - 0.5) * humanizeAmount * 40);
            const finalVelocity = Math.max(1, Math.min(127, state.velocity + velocityVariation));
            
            // Only send MIDI if connected
            if (state.midiOutCTK) {
                // Play drums (channel 10)
                if (pattern && pattern.kick) {
                    state.midiOutCTK.send([0x99, 36, finalVelocity]);
                }
                if (pattern && pattern.snare) {
                    state.midiOutCTK.send([0x99, 38, finalVelocity]);
                }
                if (pattern && pattern.hihat) {
                    state.midiOutCTK.send([0x99, 42, finalVelocity]);
                }
                if (pattern && pattern.open) {
                    state.midiOutCTK.send([0x99, 46, finalVelocity]);
                }
                
                // ALWAYS play bass if there are notes programmed (regardless of current mode)
                const bassNotes = state.bassPattern[state.currentBeat];
                if (bassNotes) {
                    // Inverted order (top to bottom pads): D2, E2, C2, A1, G1, D1, E1, C1
                    // Using bass octave (24-52 range for proper bass sound)
                    const noteOffsets = [50, 52, 48, 45, 43, 38, 40, 36];
                    
                    // Ensure correct bass program is set
                    state.midiOutCTK.send([0xC0, state.currentBassProgram - 1]); // Program change
                    
                    bassNotes.forEach((active, index) => {
                        if (active) {
                            const note = noteOffsets[index];
                            state.midiOutCTK.send([0x90, note, finalVelocity]);
                            
                            // Note off after duration
                            setTimeout(() => {
                                if (state.midiOutCTK) {
                                    state.midiOutCTK.send([0x80, note, 0]);
                                }
                            }, 100);
                        }
                    });
                }
            }
        }

        function updateBeatDisplay() {
            // Update pattern sequencer
            document.querySelectorAll('.pattern-cell').forEach(cell => {
                cell.classList.remove('playing');
            });
            
            document.querySelectorAll(`.pattern-cell[data-step="${state.currentBeat}"]`).forEach(cell => {
                cell.classList.add('playing');
            });
            
            // Always update Launchpad display to show beat movement
            updateLaunchpadDisplay();
        }

        function toggleRecord() {
            state.isRecording = !state.isRecording;
            document.getElementById('recBtn').classList.toggle('recording', state.isRecording);
            
            if (state.isRecording) {
                state.chordProgression = [];
                showMessage('Recording chord progression...');
            } else {
                showMessage(`Recorded ${state.chordProgression.length} chords`);
            }
        }

        // ==========================================
        // CHORD HANDLING
        // ==========================================
        
        function playChord(chord) {
            state.currentChord = chord.name;
            document.getElementById('currentChord').textContent = chord.name;
            
            if (state.midiOutCTK) {
                // Send program change for chord instrument (channel 1)
                state.midiOutCTK.send([0xC0, state.chordInstrument]);
                
                // Play chord notes with chord velocity
                chord.notes.forEach(note => {
                    state.midiOutCTK.send([0x90, note, state.chordVelocity]);
                });
            }
            
            // Record if recording
            if (state.isRecording) {
                state.chordProgression.push({
                    chord: chord.name,
                    beat: state.currentBeat
                });
            }
            
            // Update harmony coloring for all pads
            updateChordHarmony(chord.name);
            
            // Visual feedback
            document.querySelectorAll('.chord-pad').forEach(pad => {
                pad.classList.remove('active');
            });
            event.currentTarget.classList.add('active');
        }

        function stopChord() {
            if (state.midiOutCTK) {
                // Send note off for all possible chord notes
                for (let note = 48; note < 84; note++) {
                    state.midiOutCTK.send([0x80, note, 0]);
                }
            }
            
            document.querySelectorAll('.chord-pad').forEach(pad => {
                pad.classList.remove('active');
            });
        }

        // ==========================================
        // CHORD HARMONY SYSTEM (Circle of Fifths)
        // ==========================================
        
        function updateChordHarmony(currentChord) {
            // Define the circle of fifths relationships
            const circleOfFifths = {
                'C': { perfect: ['G', 'F', 'Am'], good: ['Em', 'Dm'], relative: 'Am' },
                'G': { perfect: ['D', 'C', 'Em'], good: ['Bm', 'Am'], relative: 'Em' },
                'D': { perfect: ['A', 'G', 'Bm'], good: ['F#m', 'Em'], relative: 'Bm' },
                'A': { perfect: ['E', 'D', 'F#m'], good: ['C#m', 'Bm'], relative: 'F#m' },
                'E': { perfect: ['B', 'A', 'C#m'], good: ['G#m', 'F#m'], relative: 'C#m' },
                'F': { perfect: ['C', 'Bb', 'Dm'], good: ['Am', 'Gm'], relative: 'Dm' },
                'Am': { perfect: ['Dm', 'Em', 'C'], good: ['F', 'G'], relative: 'C' },
                'Em': { perfect: ['Am', 'Bm', 'G'], good: ['C', 'D'], relative: 'G' },
                'Bm': { perfect: ['Em', 'F#m', 'D'], good: ['G', 'A'], relative: 'D' },
                'Dm': { perfect: ['Gm', 'Am', 'F'], good: ['Bb', 'C'], relative: 'F' },
                'Gm': { perfect: ['Cm', 'Dm', 'Bb'], good: ['Eb', 'F'], relative: 'Bb' },
                'Cm': { perfect: ['Fm', 'Gm', 'Eb'], good: ['Ab', 'Bb'], relative: 'Eb' },
                'Fm': { perfect: ['Bbm', 'Cm', 'Ab'], good: ['Db', 'Eb'], relative: 'Ab' },
                // Add 7th chord variants
                'C7': { perfect: ['G7', 'F', 'Am'], good: ['Em', 'Dm7'], relative: 'Am' },
                'G7': { perfect: ['D7', 'C', 'Em'], good: ['Bm', 'Am7'], relative: 'Em' },
                'D7': { perfect: ['A7', 'G', 'Bm'], good: ['F#m', 'Em7'], relative: 'Bm' },
                'A7': { perfect: ['E7', 'D', 'F#m'], good: ['C#m', 'Bm7'], relative: 'F#m' },
                'E7': { perfect: ['B7', 'A', 'C#m'], good: ['G#m', 'F#m7'], relative: 'C#m' },
                'F7': { perfect: ['C7', 'Bb', 'Dm'], good: ['Am', 'Gm7'], relative: 'Dm' }
            };
            
            // Get base chord name for lookup
            const baseChord = currentChord.replace(/maj7|m7|sus|dim|aug/g, '');
            const harmonyInfo = circleOfFifths[baseChord] || {};
            
            // Clear previous harmony classes
            document.querySelectorAll('.chord-pad').forEach(pad => {
                pad.classList.remove('harmony-perfect', 'harmony-good', 'harmony-clash');
            });
            
            // Apply harmony coloring
            document.querySelectorAll('.chord-pad').forEach(pad => {
                if (pad.classList.contains('active')) return; // Skip current chord
                
                const padChord = pad.querySelector('.chord-name').textContent;
                const basePadChord = padChord.replace(/maj7|m7|sus|dim|aug/g, '');
                
                if (harmonyInfo.perfect && harmonyInfo.perfect.includes(basePadChord)) {
                    // Perfect harmony (V, IV, relative) - GREEN
                    pad.classList.add('harmony-perfect');
                } else if (harmonyInfo.good && harmonyInfo.good.includes(basePadChord)) {
                    // Good harmony (iii, vi) - YELLOW
                    pad.classList.add('harmony-good');
                } else if (isDissonant(baseChord, basePadChord)) {
                    // Dissonant (semitone, tritone) - RED
                    pad.classList.add('harmony-clash');
                }
            });
        }
        
        function isDissonant(chord1, chord2) {
            const roots = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'];
            
            // Extract root notes
            const root1 = chord1.replace(/m|7/, '').replace('b', '‚ô≠').replace('#', '#');
            const root2 = chord2.replace(/m|7/, '').replace('b', '‚ô≠').replace('#', '#');
            
            const idx1 = roots.indexOf(root1);
            const idx2 = roots.indexOf(root2);
            
            if (idx1 === -1 || idx2 === -1) return false;
            
            const interval = Math.abs(idx1 - idx2);
            const normalizedInterval = Math.min(interval, 12 - interval);
            
            // Semitone (1) or tritone (6) are dissonant
            return normalizedInterval === 1 || normalizedInterval === 6;
        }

        // ==========================================
        // STYLE & SECTION CONTROLS
        // ==========================================
        
        function selectStyle(style) {
            state.currentStyle = style;
            document.getElementById('styleDisplay').textContent = style;
            
            document.querySelectorAll('.style-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.textContent === style) {
                    btn.classList.add('active');
                }
            });
            
            loadPattern(style, state.currentSection, state.currentVariation);
        }

        function selectSection(section) {
            state.currentSection = section;
            document.getElementById('sectionDisplay').textContent = section.toUpperCase();
            
            document.querySelectorAll('.section-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.textContent.toLowerCase() === section) {
                    btn.classList.add('active');
                }
            });
            
            loadPattern(state.currentStyle, section, state.currentVariation);
            
            // Handle special sections
            switch(section) {
                case 'intro':
                    // After intro, go to main
                    setTimeout(() => {
                        if (state.isPlaying) {
                            selectSection('main');
                        }
                    }, 4000);
                    break;
                    
                case 'fill':
                    // After fill, return to previous
                    setTimeout(() => {
                        if (state.isPlaying) {
                            selectSection('main');
                        }
                    }, 1000);
                    break;
                    
                case 'ending':
                    // After ending, stop
                    setTimeout(() => {
                        stopPlayback();
                    }, 4000);
                    break;
            }
        }

        function selectVariation(variation) {
            state.currentVariation = variation;
            document.getElementById('varDisplay').textContent = variation;
            
            document.querySelectorAll('.var-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.textContent === variation) {
                    btn.classList.add('active');
                }
            });
            
            loadPattern(state.currentStyle, state.currentSection, variation);
        }

        // ==========================================
        // TEMPO CONTROL
        // ==========================================
        
        function changeTempo(delta) {
            state.tempo = Math.max(40, Math.min(240, state.tempo + delta));
            document.getElementById('tempoDisplay').textContent = state.tempo;
        }

        function tapTempo() {
            const now = Date.now();
            state.tapTimes.push(now);
            
            if (state.tapTimes.length > 4) {
                state.tapTimes.shift();
            }
            
            if (state.tapTimes.length >= 2) {
                const intervals = [];
                for (let i = 1; i < state.tapTimes.length; i++) {
                    intervals.push(state.tapTimes[i] - state.tapTimes[i - 1]);
                }
                
                const avgInterval = intervals.reduce((a, b) => a + b) / intervals.length;
                const newTempo = Math.round(60000 / avgInterval);
                
                if (newTempo >= 40 && newTempo <= 240) {
                    state.tempo = newTempo;
                    document.getElementById('tempoDisplay').textContent = state.tempo;
                }
            }
            
            // Visual feedback
            event.target.style.transform = 'scale(0.95)';
            setTimeout(() => {
                event.target.style.transform = 'scale(1)';
            }, 100);
        }

        // ==========================================
        // UTILITY FUNCTIONS
        // ==========================================
        
        function toggleFullscreen() {
            if (!document.fullscreenElement && 
                !document.mozFullScreenElement && 
                !document.webkitFullscreenElement && 
                !document.msFullscreenElement) {
                
                // Enter fullscreen
                const elem = document.documentElement;
                
                if (elem.requestFullscreen) {
                    elem.requestFullscreen();
                } else if (elem.webkitRequestFullscreen) {
                    elem.webkitRequestFullscreen();
                } else if (elem.mozRequestFullScreen) {
                    elem.mozRequestFullScreen();
                } else if (elem.msRequestFullscreen) {
                    elem.msRequestFullscreen();
                }
                
                // Update button
                const btn = document.querySelector('.fullscreen-btn');
                if (btn) {
                    btn.innerHTML = '‚§ì'; // Exit fullscreen symbol
                    btn.style.background = 'var(--accent)';
                    btn.style.color = 'var(--bg-dark)';
                }
                
                // Force landscape on mobile
                if (screen.orientation && screen.orientation.lock) {
                    screen.orientation.lock('landscape').catch(() => {});
                }
                
                showMessage('Fullscreen mode activated');
                
            } else {
                // Exit fullscreen
                if (document.exitFullscreen) {
                    document.exitFullscreen();
                } else if (document.webkitExitFullscreen) {
                    document.webkitExitFullscreen();
                } else if (document.mozCancelFullScreen) {
                    document.mozCancelFullScreen();
                } else if (document.msExitFullscreen) {
                    document.msExitFullscreen();
                }
                
                // Update button
                const btn = document.querySelector('.fullscreen-btn');
                if (btn) {
                    btn.innerHTML = '‚§¢'; // Enter fullscreen symbol
                    btn.style.background = '';
                    btn.style.color = '';
                }
                
                showMessage('Exited fullscreen mode');
            }
        }
        
        // Listen for fullscreen changes
        document.addEventListener('fullscreenchange', handleFullscreenChange);
        document.addEventListener('webkitfullscreenchange', handleFullscreenChange);
        document.addEventListener('mozfullscreenchange', handleFullscreenChange);
        document.addEventListener('MSFullscreenChange', handleFullscreenChange);
        
        function handleFullscreenChange() {
            const isFullscreen = !!(document.fullscreenElement || 
                                   document.webkitFullscreenElement || 
                                   document.mozFullScreenElement ||
                                   document.msFullscreenElement);
            
            const btn = document.querySelector('.fullscreen-btn');
            if (btn) {
                if (isFullscreen) {
                    btn.innerHTML = '‚§ì'; // Exit fullscreen symbol
                    btn.style.background = 'var(--accent)';
                    btn.style.color = 'var(--bg-dark)';
                } else {
                    btn.innerHTML = '‚§¢'; // Enter fullscreen symbol
                    btn.style.background = '';
                    btn.style.color = '';
                }
            }
        }
        
        // ==========================================
        // VOICE TO MIDI FUNCTIONS
        // ==========================================
        
        let audioContext = null;
        let analyser = null;
        let microphone = null;
        let scriptProcessor = null;
        
        async function startVoiceToMidi() {
            if (state.voiceToMidi.isActive) return;
            
            try {
                // Initialize audio context
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                
                // Get microphone access
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    audio: {
                        echoCancellation: true,
                        noiseSuppression: true,
                        autoGainControl: true
                    }
                });
                
                microphone = audioContext.createMediaStreamSource(stream);
                analyser = audioContext.createAnalyser();
                analyser.fftSize = 2048;
                
                scriptProcessor = audioContext.createScriptProcessor(2048, 1, 1);
                
                microphone.connect(analyser);
                analyser.connect(scriptProcessor);
                scriptProcessor.connect(audioContext.destination);
                
                scriptProcessor.onaudioprocess = function(e) {
                    if (!state.voiceToMidi.isActive) return;
                    
                    const buffer = new Float32Array(analyser.fftSize);
                    analyser.getFloatTimeDomainData(buffer);
                    
                    // Simple pitch detection using autocorrelation
                    const pitch = detectPitch(buffer, audioContext.sampleRate);
                    
                    if (pitch && pitch > 0) {
                        const midiNote = frequencyToMidiNote(pitch);
                        const quantizedNote = quantizeToScale(midiNote);
                        
                        playVoiceMidiNote(quantizedNote);
                        
                        // Update status display
                        const noteInfo = getNoteInfo(quantizedNote);
                        document.getElementById('voiceStatus').textContent = `üéµ ${noteInfo.name}${noteInfo.octave}`;
                        document.getElementById('voiceStatus').className = 'voice-status active';
                    }
                };
                
                state.voiceToMidi.isActive = true;
                
                // Update UI
                document.getElementById('startVoiceBtn').classList.add('active');
                document.getElementById('startVoiceBtn').disabled = true;
                document.getElementById('stopVoiceBtn').disabled = false;
                
                showMessage('Voice to MIDI d√©marr√©');
                
            } catch (error) {
                console.error('Erreur lors du d√©marrage:', error);
                showMessage('Erreur: ' + error.message);
            }
        }
        
        function stopVoiceToMidi() {
            if (!state.voiceToMidi.isActive) return;
            
            state.voiceToMidi.isActive = false;
            
            // Stop all current notes
            if (state.voiceToMidi.currentNote && state.midiOutCTK) {
                state.midiOutCTK.send([0x80, state.voiceToMidi.currentNote, 0]);
            }
            
            // Clear arpeggiator
            if (state.voiceToMidi.arpeggiatorInterval) {
                clearInterval(state.voiceToMidi.arpeggiatorInterval);
                state.voiceToMidi.arpeggiatorInterval = null;
            }
            
            // Clean up audio
            if (scriptProcessor) scriptProcessor.disconnect();
            if (analyser) analyser.disconnect();
            if (microphone) microphone.disconnect();
            if (audioContext) audioContext.close();
            
            // Update UI
            document.getElementById('startVoiceBtn').classList.remove('active');
            document.getElementById('startVoiceBtn').disabled = false;
            document.getElementById('stopVoiceBtn').disabled = true;
            document.getElementById('voiceStatus').textContent = '‚ö´ Inactif';
            document.getElementById('voiceStatus').className = 'voice-status inactive';
            
            showMessage('Voice to MIDI arr√™t√©');
        }
        
        function detectPitch(buffer, sampleRate) {
            const SIZE = buffer.length;
            const threshold = state.voiceToMidi.sensitivity / 100;
            let rms = 0;
            
            // Calculate RMS (volume)
            for (let i = 0; i < SIZE; i++) {
                rms += buffer[i] * buffer[i];
            }
            rms = Math.sqrt(rms / SIZE);
            
            if (rms < threshold * 0.01) return -1;
            
            // Simple autocorrelation
            let r1 = 0, r2 = 0;
            for (let i = 0; i < SIZE / 2; i++) {
                r1 += buffer[i] * buffer[i];
                r2 += buffer[i + SIZE / 2] * buffer[i + SIZE / 2];
            }
            
            let correlation = [];
            for (let lag = 20; lag < 1000 && lag < SIZE - 1; lag++) {
                let sum = 0;
                for (let i = 0; i < SIZE - lag; i++) {
                    sum += Math.abs(buffer[i] - buffer[i + lag]);
                }
                correlation.push({
                    lag: lag,
                    val: sum
                });
            }
            
            // Find minimum
            let minVal = 1000;
            let minLag = 0;
            for (let i = 0; i < correlation.length; i++) {
                if (correlation[i].val < minVal) {
                    minVal = correlation[i].val;
                    minLag = correlation[i].lag;
                }
            }
            
            const frequency = sampleRate / minLag;
            
            // Filter out unlikely frequencies
            if (frequency < 80 || frequency > 2000) return -1;
            
            return frequency;
        }
        
        function frequencyToMidiNote(frequency) {
            return Math.round(69 + 12 * Math.log2(frequency / 440));
        }
        
        function quantizeToScale(midiNote) {
            const selectedScale = state.voiceToMidi.scale;
            
            if (selectedScale === 'chromatic') {
                return midiNote;
            }
            
            const scaleIntervals = voiceScales[selectedScale];
            if (!scaleIntervals) return midiNote;
            
            const noteInOctave = midiNote % 12;
            const octave = Math.floor(midiNote / 12);
            
            // Find closest note in scale
            let closestNote = scaleIntervals[0];
            let minDistance = Math.abs(noteInOctave - scaleIntervals[0]);
            
            for (const interval of scaleIntervals) {
                const distance = Math.abs(noteInOctave - interval);
                if (distance < minDistance) {
                    minDistance = distance;
                    closestNote = interval;
                }
            }
            
            return octave * 12 + closestNote + state.voiceToMidi.transpose;
        }
        
        function playVoiceMidiNote(note) {
            if (!state.midiOutCTK) return;
            
            const now = performance.now();
            const smoothing = state.voiceToMidi.smoothing;
            
            // Apply smoothing
            if (now - state.voiceToMidi.lastNoteTime < smoothing) return;
            
            // Stop previous note
            if (state.voiceToMidi.currentNote && state.voiceToMidi.currentNote !== note) {
                state.midiOutCTK.send([0x80, state.voiceToMidi.currentNote, 0]);
            }
            
            // Set instrument if changed
            const toneSelect = document.getElementById('voiceToneSelect');
            if (toneSelect) {
                const selectedOption = toneSelect.options[toneSelect.selectedIndex];
                if (selectedOption && selectedOption.dataset.msb) {
                    // Send bank select MSB
                    state.midiOutCTK.send([0xB0 + state.voiceToMidi.channel - 1, 0, parseInt(selectedOption.dataset.msb)]);
                }
                // Send program change
                state.midiOutCTK.send([0xC0 + state.voiceToMidi.channel - 1, parseInt(toneSelect.value)]);
            }
            
            // Apply effects
            if (state.voiceToMidi.reverb > 0) {
                state.midiOutCTK.send([0xB0 + state.voiceToMidi.channel - 1, 91, state.voiceToMidi.reverb]);
            }
            if (state.voiceToMidi.vibrato > 0) {
                state.midiOutCTK.send([0xB0 + state.voiceToMidi.channel - 1, 1, state.voiceToMidi.vibrato]);
            }
            
            // Play based on mode
            const mode = state.voiceToMidi.playMode;
            const velocity = state.voiceToMidi.velocity;
            
            switch(mode) {
                case 'single':
                    state.midiOutCTK.send([0x90 + state.voiceToMidi.channel - 1, note, velocity]);
                    state.voiceToMidi.currentNote = note;
                    break;
                    
                case 'major':
                    playChord(note, [0, 4, 7]); // Major triad
                    break;
                    
                case 'minor':
                    playChord(note, [0, 3, 7]); // Minor triad
                    break;
                    
                case 'arp3':
                    startArpeggiator(note, [0, 4, 7]);
                    break;
                    
                case 'arp4':
                    startArpeggiator(note, [0, 4, 7, 10]);
                    break;
            }
            
            state.voiceToMidi.lastNoteTime = now;
        }
        
        function playChord(root, intervals) {
            if (!state.midiOutCTK) return;
            
            // Stop previous chord
            state.voiceToMidi.currentChordNotes.forEach(note => {
                state.midiOutCTK.send([0x80 + state.voiceToMidi.channel - 1, note, 0]);
            });
            
            // Play new chord
            state.voiceToMidi.currentChordNotes = [];
            intervals.forEach(interval => {
                const note = root + interval;
                state.midiOutCTK.send([0x90 + state.voiceToMidi.channel - 1, note, state.voiceToMidi.velocity]);
                state.voiceToMidi.currentChordNotes.push(note);
            });
        }
        
        function startArpeggiator(root, intervals) {
            if (state.voiceToMidi.arpeggiatorInterval) {
                clearInterval(state.voiceToMidi.arpeggiatorInterval);
            }
            
            state.voiceToMidi.currentArpNotes = intervals.map(i => root + i);
            state.voiceToMidi.arpeggiatorIndex = 0;
            
            const tempo = state.voiceToMidi.tempo || 120;
            const delay = 60000 / (tempo * 4); // 16th notes
            
            state.voiceToMidi.arpeggiatorInterval = setInterval(() => {
                if (!state.voiceToMidi.isActive) {
                    clearInterval(state.voiceToMidi.arpeggiatorInterval);
                    return;
                }
                
                // Stop previous note
                if (state.voiceToMidi.currentNote) {
                    state.midiOutCTK.send([0x80 + state.voiceToMidi.channel - 1, state.voiceToMidi.currentNote, 0]);
                }
                
                // Play next note
                const note = state.voiceToMidi.currentArpNotes[state.voiceToMidi.arpeggiatorIndex];
                state.midiOutCTK.send([0x90 + state.voiceToMidi.channel - 1, note, state.voiceToMidi.velocity]);
                state.voiceToMidi.currentNote = note;
                
                // Move to next note
                state.voiceToMidi.arpeggiatorIndex = (state.voiceToMidi.arpeggiatorIndex + 1) % state.voiceToMidi.currentArpNotes.length;
            }, delay);
        }
        
        function getNoteInfo(midiNote) {
            const noteNames = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'];
            const octave = Math.floor(midiNote / 12) - 1;
            const noteIndex = midiNote % 12;
            return {
                name: noteNames[noteIndex],
                octave: octave
            };
        }
        
        // ==========================================
        // UI MESSAGE DISPLAY
        // ==========================================
        
        function showMessage(text) {
            const existing = document.querySelector('.toast');
            if (existing) existing.remove();
            
            const toast = document.createElement('div');
            toast.className = 'toast';
            toast.textContent = text;
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.style.animation = 'slideDown 0.3s';
                setTimeout(() => toast.remove(), 300);
            }, 2000);
        }
    </script>
</body>
</html>
