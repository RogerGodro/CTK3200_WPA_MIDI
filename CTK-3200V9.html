<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>CTK-3200 V10 - LAUNCHPAD MK2</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; user-select: none; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif; }
        :root {
            --primary: #00ff88; --secondary: #ff00aa; --accent: #00aaff; --warning: #ff8800; --danger: #ff3333; --success: #00ff00;
            --bg-dark: #0a0a0f; --bg-medium: #14141a; --bg-light: #1f1f28; --bg-lighter: #2a2a35;
            --text-primary: #ffffff; --text-secondary: #aaaaaa; --text-dim: #666666;
        }
        body { background: var(--bg-dark); color: var(--text-primary); overflow: hidden; height: 100vh; width: 100vw; position: fixed; touch-action: none; }
        .app-container { height: 100vh; display: grid; grid-template-rows: 55px 1fr; background: radial-gradient(ellipse at center, #14141a 0%, #0a0a0f 100%); }
        .header { display: flex; align-items: center; justify-content: space-between; padding: 0 15px; background: linear-gradient(180deg, rgba(31,31,40,0.95) 0%, rgba(20,20,26,0.95) 100%); border-bottom: 1px solid var(--primary); gap: 10px; }
        .logo { font-size: 18px; font-weight: 900; background: linear-gradient(135deg, var(--primary) 0%, var(--accent) 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .status-group { display: flex; gap: 10px; align-items: center; }
        .status-item { display: flex; flex-direction: column; align-items: center; padding: 3px 10px; background: var(--bg-light); border-radius: 8px; border: 1px solid var(--bg-lighter); }
        .status-label { font-size: 8px; color: var(--text-dim); text-transform: uppercase; }
        .status-value { font-size: 12px; font-weight: 700; color: var(--primary); }
        .tempo-controls { display: flex; align-items: center; gap: 6px; padding: 4px 10px; background: var(--bg-light); border-radius: 20px; border: 1px solid var(--accent); }
        .tempo-display { font-size: 16px; font-weight: 800; color: var(--accent); min-width: 40px; text-align: center; }
        .tempo-btn { width: 20px; height: 20px; background: var(--bg-lighter); border: 1px solid var(--accent); border-radius: 4px; color: var(--accent); cursor: pointer; font-size: 10px; }
        .tap-btn { padding: 6px 12px; background: var(--bg-lighter); border: 2px solid var(--warning); border-radius: 20px; color: var(--warning); font-weight: 700; font-size: 10px; cursor: pointer; }
        .midi-status { display: flex; gap: 8px; }
        .midi-device { padding: 4px 8px; background: var(--bg-light); border-radius: 15px; font-size: 9px; display: flex; align-items: center; gap: 4px; }
        .midi-led { width: 6px; height: 6px; background: #444; border-radius: 50%; }
        .midi-led.active { background: var(--success); box-shadow: 0 0 6px var(--success); }
        .connect-btn { padding: 6px 12px; background: linear-gradient(135deg, var(--primary) 0%, var(--accent) 100%); border: none; border-radius: 20px; color: var(--bg-dark); font-weight: 700; font-size: 10px; cursor: pointer; }
        .fullscreen-btn { width: 32px; height: 32px; background: var(--bg-light); border: 2px solid var(--accent); border-radius: 50%; color: var(--accent); font-size: 14px; cursor: pointer; display: flex; align-items: center; justify-content: center; }
        .main-content { display: grid; grid-template-columns: 220px 1fr 300px; gap: 10px; padding: 10px; height: calc(100vh - 55px); overflow: hidden; }
        .left-panel { display: flex; flex-direction: column; gap: 8px; overflow-y: auto; overflow-x: hidden; }
        .panel-section { background: var(--bg-medium); border-radius: 10px; padding: 10px; border: 1px solid var(--bg-lighter); flex-shrink: 0; }
        .section-title { font-size: 9px; text-transform: uppercase; letter-spacing: 1.5px; color: var(--text-dim); margin-bottom: 8px; padding-left: 6px; border-left: 2px solid var(--primary); }
        .style-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 4px; }
        .style-btn { padding: 6px; background: var(--bg-light); border: 2px solid var(--bg-lighter); border-radius: 6px; color: var(--text-secondary); font-size: 10px; font-weight: 600; cursor: pointer; }
        .style-btn.active { background: var(--primary); color: var(--bg-dark); border-color: var(--primary); }
        .section-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 4px; }
        .section-btn { padding: 8px 4px; background: var(--bg-light); border: 2px solid var(--bg-lighter); border-radius: 6px; color: var(--text-secondary); font-size: 8px; font-weight: 700; cursor: pointer; text-transform: uppercase; }
        .section-btn.active { background: var(--accent); color: var(--bg-dark); border-color: var(--accent); }
        .variation-row { display: grid; grid-template-columns: repeat(4, 1fr); gap: 4px; }
        .var-btn { aspect-ratio: 1; background: var(--bg-light); border: 2px solid var(--bg-lighter); border-radius: 6px; font-size: 12px; font-weight: 700; color: var(--text-secondary); cursor: pointer; }
        .var-btn.active { background: var(--secondary); color: var(--bg-dark); border-color: var(--secondary); }
        .voice-section { background: var(--bg-medium); border-radius: 10px; padding: 10px; border: 1px solid var(--accent); }
        .voice-buttons { display: grid; grid-template-columns: 1fr 1fr; gap: 6px; margin-bottom: 8px; }
        .voice-btn { background: var(--bg-light); border: 2px solid var(--bg-lighter); color: var(--text-primary); padding: 6px 8px; border-radius: 8px; cursor: pointer; font-size: 10px; font-weight: 600; }
        .voice-btn:hover:not(:disabled) { background: linear-gradient(135deg, var(--primary) 0%, var(--accent) 100%); border-color: var(--primary); color: var(--bg-dark); }
        .voice-btn:disabled { opacity: 0.4; cursor: not-allowed; }
        .voice-btn.active { background: linear-gradient(135deg, var(--primary) 0%, var(--accent) 100%); border-color: var(--primary); color: var(--bg-dark); }
        .voice-status { text-align: center; padding: 4px; background: var(--bg-light); border-radius: 6px; font-size: 10px; color: var(--text-secondary); margin-bottom: 8px; }
        .voice-status.active { background: rgba(0, 255, 136, 0.15); color: var(--primary); animation: voicePulse 2s infinite; }
        @keyframes voicePulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.6; } }
        .vu-meter-container { margin: 8px 0; padding: 6px; background: var(--bg-dark); border-radius: 6px; }
        .vu-meter-label { font-size: 8px; color: var(--text-dim); text-transform: uppercase; margin-bottom: 4px; }
        .vu-meter { height: 12px; background: var(--bg-lighter); border-radius: 6px; overflow: hidden; position: relative; }
        .vu-meter-bar { height: 100%; width: 0%; background: linear-gradient(90deg, var(--primary) 0%, var(--warning) 70%, var(--danger) 100%); border-radius: 6px; transition: width 0.05s ease-out; }
        .vu-meter-value { position: absolute; right: 4px; top: 50%; transform: translateY(-50%); font-size: 8px; color: var(--text-primary); font-weight: 700; }
        .voice-control-row { display: grid; grid-template-columns: 1fr 1fr; gap: 6px; margin-bottom: 6px; }
        .voice-select { width: 100%; padding: 4px 6px; background: var(--bg-light); border: 1px solid var(--bg-lighter); border-radius: 6px; color: var(--text-primary); font-size: 10px; cursor: pointer; }
        .voice-slider-row { display: flex; align-items: center; gap: 6px; margin-bottom: 4px; }
        .voice-slider-row label { font-size: 9px; color: var(--text-dim); min-width: 50px; }
        .voice-slider-row input { flex: 1; height: 4px; }
        .voice-slider-row span { font-size: 9px; color: var(--primary); min-width: 25px; text-align: right; }
        .voice-pitch-display { background: var(--bg-dark); border-radius: 8px; padding: 8px; text-align: center; margin-top: 8px; display: none; }
        .voice-pitch-note { font-size: 24px; font-weight: 900; color: var(--primary); }
        .voice-pitch-info { display: flex; justify-content: center; gap: 10px; font-size: 10px; color: var(--text-dim); }
        .center-panel { display: flex; flex-direction: column; gap: 8px; overflow: hidden; }
        .chord-display { height: 70px; min-height: 70px; background: linear-gradient(135deg, var(--bg-medium) 0%, var(--bg-light) 50%); border-radius: 12px; border: 2px solid var(--bg-lighter); display: flex; align-items: center; justify-content: space-between; padding: 8px 15px; position: relative; overflow: hidden; }
        .chord-text { font-size: 32px; font-weight: 900; background: linear-gradient(135deg, var(--primary) 0%, var(--accent) 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .chord-controls { display: flex; align-items: center; gap: 10px; }
        .instrument-select { background: var(--bg-dark); color: var(--primary); border: 1px solid var(--primary); border-radius: 6px; padding: 4px 8px; font-size: 9px; cursor: pointer; width: 180px; max-width: 180px; }
        .chord-velocity-control { display: flex; align-items: center; gap: 4px; }
        .chord-velocity-control label { color: var(--accent); font-size: 9px; }
        .chord-velocity-control input { width: 50px; height: 4px; }
        .chord-velocity-control span { color: var(--primary); font-size: 9px; min-width: 20px; }
        .chord-grid-container { flex: 1; background: var(--bg-medium); border-radius: 12px; border: 1px solid var(--bg-lighter); padding: 8px; min-height: 0; }
        .chord-grid-header { display: grid; grid-template-columns: repeat(6, 1fr); gap: 6px; margin-bottom: 6px; }
        .chord-header-cell { text-align: center; font-size: 12px; font-weight: 800; color: var(--accent); padding: 4px; background: var(--bg-light); border-radius: 4px; }
        .chord-grid { display: grid; grid-template-columns: repeat(6, 1fr); grid-template-rows: repeat(4, 1fr); gap: 6px; height: calc(100% - 30px); }
        .chord-pad { background: linear-gradient(145deg, var(--bg-light) 0%, var(--bg-lighter) 100%); border: 2px solid var(--bg-lighter); border-radius: 8px; display: flex; flex-direction: column; align-items: center; justify-content: center; cursor: pointer; transition: all 0.1s; min-height: 40px; }
        .chord-pad:hover { transform: translateY(-1px); border-color: var(--primary); box-shadow: 0 2px 8px rgba(0, 255, 136, 0.2); }
        .chord-pad:active, .chord-pad.active { background: linear-gradient(135deg, var(--primary) 0%, var(--accent) 100%); border-color: var(--primary); transform: scale(0.95); }
        .chord-name { font-size: 14px; font-weight: 700; color: var(--text-primary); }
        .chord-type { font-size: 8px; color: var(--text-dim); text-transform: uppercase; }
        .chord-pad.active .chord-name, .chord-pad.active .chord-type { color: var(--bg-dark); }
        .chord-pad.harmony-perfect { background: linear-gradient(145deg, rgba(0, 255, 0, 0.2) 0%, rgba(0, 255, 0, 0.1) 100%) !important; border-color: rgba(0, 255, 0, 0.8) !important; }
        .chord-pad.harmony-good { background: linear-gradient(145deg, rgba(255, 255, 0, 0.2) 0%, rgba(255, 255, 0, 0.1) 100%) !important; border-color: rgba(255, 255, 0, 0.8) !important; }
        .pattern-container { background: var(--bg-medium); border-radius: 12px; border: 1px solid var(--bg-lighter); padding: 8px; height: 100px; min-height: 100px; }
        .pattern-grid { display: grid; grid-template-rows: repeat(4, 1fr); gap: 3px; height: calc(100% - 20px); }
        .pattern-row { display: grid; grid-template-columns: repeat(16, 1fr); gap: 2px; }
        .pattern-cell { background: var(--bg-light); border: 1px solid var(--bg-lighter); border-radius: 2px; cursor: pointer; }
        .pattern-cell:nth-child(4n+1) { border-left: 2px solid var(--accent); }
        .pattern-cell.active { background: var(--primary); border-color: var(--primary); }
        .pattern-cell.playing { background: var(--accent) !important; border-color: var(--accent) !important; }
        .right-panel { display: flex; flex-direction: column; gap: 8px; }
        .transport-container { background: var(--bg-medium); border-radius: 12px; padding: 10px; display: flex; justify-content: center; gap: 12px; }
        .transport-btn { width: 50px; height: 50px; background: var(--bg-light); border: 2px solid var(--bg-lighter); border-radius: 50%; font-size: 20px; cursor: pointer; color: var(--text-secondary); }
        #playBtn { background: linear-gradient(135deg, var(--primary) 0%, var(--accent) 100%); color: var(--bg-dark); border-color: var(--primary); }
        #playBtn.playing { background: linear-gradient(135deg, var(--warning) 0%, var(--danger) 100%); animation: playingPulse 1s infinite; }
        @keyframes playingPulse { 0%, 100% { box-shadow: 0 0 10px rgba(255, 136, 0, 0.4); } 50% { box-shadow: 0 0 20px rgba(255, 136, 0, 0.6); } }
        #recBtn.recording { background: var(--danger); border-color: var(--danger); color: white; animation: recPulse 1s infinite; }
        @keyframes recPulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.6; } }
        .launchpad-container { background: var(--bg-medium); border-radius: 12px; padding: 10px; flex: 1; display: flex; flex-direction: column; }
        .lp-top-buttons { display: grid; grid-template-columns: repeat(8, 1fr); gap: 3px; margin-bottom: 8px; }
        .lp-top-btn { padding: 4px; background: var(--bg-light); border: 2px solid var(--bg-lighter); border-radius: 4px; font-size: 7px; font-weight: 700; color: var(--text-dim); cursor: pointer; text-align: center; }
        .lp-top-btn.active { background: var(--primary); border-color: var(--primary); color: var(--bg-dark); }
        .lp-main-area { display: flex; gap: 6px; flex: 1; }
        .lp-grid { display: grid; grid-template-columns: repeat(8, 1fr); grid-template-rows: repeat(8, 1fr); gap: 2px; flex: 1; }
        .lp-pad { background: var(--bg-light); border: 1px solid var(--bg-lighter); border-radius: 3px; cursor: pointer; }
        .lp-pad[data-color="red"] { background: #ff3333 !important; }
        .lp-pad[data-color="orange"] { background: #ff8800 !important; }
        .lp-pad[data-color="yellow"] { background: #ffff00 !important; }
        .lp-pad[data-color="green"] { background: #00ff00 !important; }
        .lp-pad[data-color="cyan"] { background: #00ffff !important; }
        .lp-pad[data-color="blue"] { background: #0088ff !important; }
        .lp-pad[data-color="purple"] { background: #aa00ff !important; }
        .lp-pad[data-color="pink"] { background: #ff00aa !important; }
        .lp-pad[data-color="white"] { background: #ffffff !important; }
        .lp-right-buttons { display: flex; flex-direction: column; gap: 2px; width: 28px; }
        .lp-right-btn { flex: 1; background: var(--bg-light); border: 2px solid var(--bg-lighter); border-radius: 50%; font-size: 7px; font-weight: 700; color: var(--text-dim); cursor: pointer; display: flex; align-items: center; justify-content: center; }
        .lp-right-btn.active { background: var(--primary); border-color: var(--primary); color: var(--bg-dark); }
        .lp-right-btn[data-function="play"] { background: var(--success) !important; border-color: var(--success) !important; color: white !important; }
        .lp-right-btn[data-function="stop"] { background: var(--danger) !important; border-color: var(--danger) !important; color: white !important; }
        .controls-container { background: var(--bg-medium); border-radius: 12px; padding: 10px; }
        .controls-row { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; }
        .control-item { text-align: center; }
        .control-knob { width: 40px; height: 40px; background: radial-gradient(circle at 30% 30%, var(--bg-lighter) 0%, var(--bg-light) 100%); border: 2px solid var(--bg-lighter); border-radius: 50%; margin: 0 auto 4px; position: relative; cursor: ew-resize; }
        .control-knob:hover { border-color: var(--primary); }
        .control-indicator { position: absolute; top: 4px; left: 50%; transform: translateX(-50%); width: 2px; height: 14px; background: var(--primary); border-radius: 2px; }
        .control-label { font-size: 8px; color: var(--text-dim); text-transform: uppercase; }
        .control-value { font-size: 12px; font-weight: 700; color: var(--primary); }
        .loading { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: var(--bg-dark); display: flex; align-items: center; justify-content: center; z-index: 10000; }
        .loading.hidden { opacity: 0; pointer-events: none; }
        .spinner { width: 40px; height: 40px; border: 3px solid var(--bg-lighter); border-top-color: var(--primary); border-radius: 50%; animation: spin 0.8s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .toast { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background: linear-gradient(135deg, var(--primary) 0%, var(--accent) 100%); color: var(--bg-dark); padding: 10px 20px; border-radius: 20px; font-weight: 700; font-size: 12px; z-index: 5000; animation: slideUp 0.3s ease; }
        @keyframes slideUp { from { transform: translate(-50%, 100px); opacity: 0; } to { transform: translate(-50%, 0); opacity: 1; } }
    </style>
</head>
<body>
    <div class="loading" id="loading"><div class="spinner"></div></div>
    <div class="app-container">
        <header class="header">
            <div class="logo">CTK-3200 V10</div>
            <div class="status-group">
                <div class="status-item"><span class="status-label">Style</span><span class="status-value" id="styleDisplay">8BEAT</span></div>
                <div class="status-item"><span class="status-label">Section</span><span class="status-value" id="sectionDisplay">MAIN</span></div>
                <div class="status-item"><span class="status-label">Var</span><span class="status-value" id="varDisplay">A</span></div>
            </div>
            <div class="tempo-controls">
                <button class="tempo-btn" onclick="changeTempo(-1)">‚àí</button>
                <div class="tempo-display" id="tempoDisplay">120</div>
                <button class="tempo-btn" onclick="changeTempo(1)">+</button>
            </div>
            <button class="tap-btn" onclick="tapTempo()">TAP</button>
            <div class="midi-status">
                <div class="midi-device"><span class="midi-led" id="ctkLed"></span><span>CTK</span></div>
                <div class="midi-device"><span class="midi-led" id="lpLed"></span><span>LP</span></div>
                <div class="midi-device"><span class="midi-led" id="micLed"></span><span>MIC</span></div>
            </div>
            <button class="connect-btn" onclick="connectMIDI()">MIDI</button>
            <button class="connect-btn" onclick="requestMicPermission()" style="background: linear-gradient(135deg, var(--warning) 0%, var(--danger) 100%);">üéôÔ∏è MIC</button>
            <button class="fullscreen-btn" onclick="toggleFullscreen()">‚§¢</button>
        </header>
        <main class="main-content">
            <aside class="left-panel">
                <div class="panel-section"><div class="section-title">RHYTHM STYLES</div><div class="style-grid" id="styleGrid"></div></div>
                <div class="panel-section"><div class="section-title">SECTIONS</div><div class="section-grid" id="sectionGrid"></div></div>
                <div class="panel-section"><div class="section-title">VARIATIONS</div><div class="variation-row" id="variationRow"></div></div>
                <div class="panel-section voice-section">
                    <div class="section-title">üéôÔ∏è VOICE TO MIDI</div>
                    <div class="voice-buttons">
                        <button class="voice-btn" id="voiceStartBtn" onclick="startVoiceToMidi()">üéôÔ∏è Start</button>
                        <button class="voice-btn" id="voiceStopBtn" onclick="stopVoiceToMidi()" disabled>‚èπÔ∏è Stop</button>
                    </div>
                    <div id="voiceStatus" class="voice-status">‚ö´ Cliquez MIC pour autoriser</div>
                    <div class="vu-meter-container"><div class="vu-meter-label">Volume Micro</div><div class="vu-meter"><div class="vu-meter-bar" id="vuMeterBar"></div><span class="vu-meter-value" id="vuMeterValue">0%</span></div></div>
                    <div class="voice-control-row"><select id="voiceToneSelect" class="voice-select" style="width: 100%;"></select></div>
                    <div class="voice-control-row">
                        <select id="voicePlayMode" class="voice-select"><option value="single">Note seule</option><option value="major">Accord majeur</option><option value="minor">Accord mineur</option><option value="arp3">Arp√®ge 3</option><option value="arp4">Arp√®ge 4</option></select>
                        <select id="voiceScale" class="voice-select"><option value="chromatic">Chromatique</option><option value="C-major">Do majeur</option><option value="G-major">Sol majeur</option><option value="A-minor">La mineur</option><option value="E-minor">Mi mineur</option></select>
                    </div>
                    <div class="voice-slider-row"><label>Sensibilit√©</label><input type="range" id="voiceSensitivity" min="1" max="100" value="30"><span id="voiceSensitivityValue">30</span></div>
                    <div class="voice-slider-row"><label>Reverb</label><input type="range" id="voiceReverb" min="0" max="127" value="40"><span id="voiceReverbValue">40</span></div>
                    <div class="voice-slider-row"><label>Transpose</label><input type="range" id="voiceTranspose" min="-24" max="24" value="0"><span id="voiceTransposeValue">0</span></div>
                    <div class="voice-pitch-display" id="voicePitchDisplay"><div class="voice-pitch-note" id="voicePitchNote">--</div><div class="voice-pitch-info"><span id="voicePitchFreq">-- Hz</span></div></div>
                </div>
            </aside>
            <div class="center-panel">
                <div class="chord-display">
                    <div class="chord-text" id="currentChord">C</div>
                    <div class="chord-controls">
                        <select id="chordInstrument" class="instrument-select"></select>
                        <div class="chord-velocity-control"><label>Vol</label><input type="range" id="chordVelocity" min="1" max="127" value="80"><span id="chordVelValue">80</span></div>
                    </div>
                </div>
                <div class="chord-grid-container">
                    <div class="chord-grid-header" id="chordGridHeader"><div class="chord-header-cell">C</div><div class="chord-header-cell">D</div><div class="chord-header-cell">E</div><div class="chord-header-cell">F</div><div class="chord-header-cell">G</div><div class="chord-header-cell">A</div></div>
                    <div class="chord-grid" id="chordGrid"></div>
                </div>
                <div class="pattern-container"><div class="section-title">PATTERN SEQUENCER</div><div class="pattern-grid" id="patternGrid"></div></div>
            </div>
            <aside class="right-panel">
                <div class="transport-container">
                    <button class="transport-btn" id="stopBtn" onclick="stopPlayback()">‚óº</button>
                    <button class="transport-btn" id="playBtn" onclick="togglePlay()">‚ñ∂</button>
                    <button class="transport-btn" id="recBtn" onclick="toggleRecord()">‚óè</button>
                </div>
                <div class="launchpad-container">
                    <div class="section-title">LAUNCHPAD MK2</div>
                    <div class="lp-top-buttons" id="lpTopButtons"></div>
                    <div class="lp-main-area"><div class="lp-grid" id="lpGrid"></div><div class="lp-right-buttons" id="lpRightButtons"></div></div>
                </div>
                <div class="controls-container">
                    <div class="controls-row">
                        <div class="control-item"><div class="control-knob" id="swingKnob" data-value="50" data-min="0" data-max="100"><div class="control-indicator"></div></div><div class="control-label">Swing</div><div class="control-value" id="swingValue">50%</div></div>
                        <div class="control-item"><div class="control-knob" id="velocityKnob" data-value="100" data-min="1" data-max="127"><div class="control-indicator"></div></div><div class="control-label">Velocity</div><div class="control-value" id="velocityValue">100</div></div>
                        <div class="control-item"><div class="control-knob" id="humanizeKnob" data-value="0" data-min="0" data-max="100"><div class="control-indicator"></div></div><div class="control-label">Humanize</div><div class="control-value" id="humanizeValue">0%</div></div>
                    </div>
                </div>
            </aside>
        </main>
    </div>
<script>
// CTK-3200 414 TONES (Grouped by category)
const CTK3200_TONES = [
    {id:1,name:'STEREO GRAND PIANO',category:'PIANO',pc:0,msb:2},{id:2,name:'GRAND PIANO',category:'PIANO',pc:0,msb:1},{id:3,name:'BRIGHT PIANO',category:'PIANO',pc:1,msb:2},{id:4,name:'MODERN PIANO',category:'PIANO',pc:1,msb:3},{id:5,name:'DANCE PIANO',category:'PIANO',pc:1,msb:1},{id:6,name:'MELLOW PIANO',category:'PIANO',pc:0,msb:3},{id:7,name:'STRINGS PIANO',category:'PIANO',pc:0,msb:8},{id:8,name:'HONKY-TONK',category:'PIANO',pc:3,msb:2},{id:9,name:'OCTAVE PIANO',category:'PIANO',pc:3,msb:9},{id:10,name:'ELEC.GRAND PIANO',category:'PIANO',pc:2,msb:2},{id:11,name:'MODERN E.G.PIANO',category:'PIANO',pc:2,msb:3},{id:12,name:'HARPSICHORD',category:'PIANO',pc:6,msb:2},{id:13,name:'COUPLED HARPSICHORD',category:'PIANO',pc:6,msb:8},{id:14,name:'HARPSICHORD & STR',category:'PIANO',pc:6,msb:1},
    {id:15,name:'ELEC.PIANO',category:'E.PIANO',pc:4,msb:2},{id:16,name:'FM E.PIANO',category:'E.PIANO',pc:5,msb:5},{id:17,name:"60's E.PIANO",category:'E.PIANO',pc:4,msb:5},{id:18,name:'CHORUS E.PIANO 1',category:'E.PIANO',pc:4,msb:9},{id:19,name:'CHORUS E.PIANO 2',category:'E.PIANO',pc:4,msb:6},{id:20,name:'MODERN E.PIANO',category:'E.PIANO',pc:5,msb:2},{id:21,name:'SOFT E.PIANO',category:'E.PIANO',pc:4,msb:8},{id:22,name:'SYNTH-STR.E.PIANO',category:'E.PIANO',pc:4,msb:3},{id:23,name:'CLEAN E.PIANO',category:'E.PIANO',pc:4,msb:4},{id:24,name:'CLAVI 1',category:'E.PIANO',pc:7,msb:2},{id:25,name:'CLAVI 2',category:'E.PIANO',pc:7,msb:3},{id:26,name:'SOFT CLAVI',category:'E.PIANO',pc:7,msb:1},{id:27,name:'DETUNE CLAVI',category:'E.PIANO',pc:7,msb:8},{id:28,name:'SEQUENCE CLAVI',category:'E.PIANO',pc:7,msb:9},
    {id:29,name:'VIBRAPHONE 1',category:'CHROMATIC',pc:11,msb:2},{id:30,name:'VIBRAPHONE 2',category:'CHROMATIC',pc:11,msb:1},{id:31,name:'SOFT VIBRAPHONE 1',category:'CHROMATIC',pc:11,msb:3},{id:32,name:'SOFT VIBRAPHONE 2',category:'CHROMATIC',pc:11,msb:4},{id:33,name:'MARIMBA',category:'CHROMATIC',pc:12,msb:2},{id:34,name:'SOFT MARIMBA',category:'CHROMATIC',pc:12,msb:1},{id:35,name:'CELESTA 1',category:'CHROMATIC',pc:8,msb:2},{id:36,name:'CELESTA 2',category:'CHROMATIC',pc:8,msb:1},{id:37,name:'GLOCKENSPIEL',category:'CHROMATIC',pc:9,msb:2},{id:38,name:'MUSIC BOX 1',category:'CHROMATIC',pc:10,msb:2},{id:39,name:'MUSIC BOX 2',category:'CHROMATIC',pc:10,msb:1},{id:40,name:'XYLOPHONE',category:'CHROMATIC',pc:13,msb:2},{id:41,name:'TUBULAR BELL',category:'CHROMATIC',pc:14,msb:2},{id:42,name:'DULCIMER',category:'CHROMATIC',pc:15,msb:2},
    {id:43,name:'DRAWBAR ORGAN 1',category:'ORGAN',pc:16,msb:2},{id:44,name:'DRAWBAR ORGAN 2',category:'ORGAN',pc:16,msb:1},{id:45,name:'PERC.ORGAN 1',category:'ORGAN',pc:17,msb:2},{id:46,name:'PERC.ORGAN 2',category:'ORGAN',pc:17,msb:3},{id:47,name:'ELEC.ORGAN 1',category:'ORGAN',pc:16,msb:8},{id:48,name:'ELEC.ORGAN 2',category:'ORGAN',pc:16,msb:4},{id:49,name:'JAZZ ORGAN 1',category:'ORGAN',pc:17,msb:4},{id:50,name:'JAZZ ORGAN 2',category:'ORGAN',pc:17,msb:6},{id:51,name:'ROCK ORGAN 1',category:'ORGAN',pc:18,msb:2},{id:52,name:'ROCK ORGAN 2',category:'ORGAN',pc:18,msb:1},{id:53,name:'FULL DRAWBAR',category:'ORGAN',pc:16,msb:9},{id:54,name:'CLICK ORGAN',category:'ORGAN',pc:18,msb:7},{id:55,name:"8'ORGAN",category:'ORGAN',pc:17,msb:5},{id:56,name:'CHURCH ORGAN 1',category:'ORGAN',pc:19,msb:2},{id:57,name:'CHURCH ORGAN 2',category:'ORGAN',pc:19,msb:3},{id:58,name:'CHAPEL ORGAN',category:'ORGAN',pc:19,msb:8},{id:59,name:'THEATER ORGAN',category:'ORGAN',pc:19,msb:6},{id:60,name:'REED ORGAN',category:'ORGAN',pc:20,msb:2},{id:61,name:'ACCORDION 1',category:'ORGAN',pc:21,msb:2},{id:62,name:'ACCORDION 2',category:'ORGAN',pc:21,msb:3},{id:63,name:'BANDONEON 1',category:'ORGAN',pc:23,msb:2},{id:64,name:'BANDONEON 2',category:'ORGAN',pc:23,msb:1},{id:65,name:'HARMONICA 1',category:'ORGAN',pc:22,msb:2},{id:66,name:'HARMONICA 2',category:'ORGAN',pc:22,msb:8},{id:67,name:'HARMONIUM 1',category:'ORGAN',pc:20,msb:8},{id:68,name:'HARMONIUM 2',category:'ORGAN',pc:20,msb:9},
    {id:69,name:'NYLON STR.GUITAR',category:'GUITAR',pc:24,msb:2},{id:70,name:'STEEL STR.GUITAR',category:'GUITAR',pc:25,msb:2},{id:71,name:'12 STR.GUITAR',category:'GUITAR',pc:25,msb:8},{id:72,name:'CHORUS STEEL GT',category:'GUITAR',pc:25,msb:9},{id:73,name:'JAZZ GUITAR',category:'GUITAR',pc:26,msb:2},{id:74,name:'OCT.JAZZ GUITAR',category:'GUITAR',pc:26,msb:8},{id:75,name:'CLEAN GUITAR 1',category:'GUITAR',pc:27,msb:2},{id:76,name:'CLEAN GUITAR 2',category:'GUITAR',pc:27,msb:1},{id:77,name:'MUTE GUITAR',category:'GUITAR',pc:28,msb:2},{id:78,name:'OVERDRIVE GT',category:'GUITAR',pc:29,msb:2},{id:79,name:'DISTORTION GT',category:'GUITAR',pc:30,msb:2},{id:80,name:'POWER DIST.GT',category:'GUITAR',pc:30,msb:5},{id:81,name:'FEEDBACK GT',category:'GUITAR',pc:31,msb:8},{id:82,name:'DIST.GT & BASS',category:'GUITAR',pc:30,msb:6},
    {id:83,name:'ACOUSTIC BASS',category:'BASS',pc:32,msb:2},{id:84,name:'RIDE BASS',category:'BASS',pc:32,msb:32},{id:85,name:'FINGERED BASS',category:'BASS',pc:33,msb:2},{id:86,name:'PICKED BASS',category:'BASS',pc:34,msb:2},{id:87,name:'FRETLESS BASS',category:'BASS',pc:35,msb:2},{id:88,name:'SLAP BASS',category:'BASS',pc:37,msb:2},{id:89,name:'SAW SYNTH-BASS',category:'BASS',pc:38,msb:2},{id:90,name:'SQUARE SYNTH-BASS',category:'BASS',pc:38,msb:3},{id:91,name:'TECHNO SYNTH-BASS',category:'BASS',pc:38,msb:4},{id:92,name:'RESONANT BASS',category:'BASS',pc:38,msb:8},{id:93,name:'RUBBER BASS',category:'BASS',pc:39,msb:2},{id:94,name:'ATTACK BASS',category:'BASS',pc:39,msb:8},
    {id:95,name:'VIOLIN 1',category:'STRINGS',pc:40,msb:2},{id:96,name:'VIOLIN 2',category:'STRINGS',pc:40,msb:8},{id:97,name:'SLOW VIOLIN',category:'STRINGS',pc:40,msb:9},{id:98,name:'VIOLA',category:'STRINGS',pc:41,msb:2},{id:99,name:'CELLO 1',category:'STRINGS',pc:42,msb:2},{id:100,name:'CELLO 2',category:'STRINGS',pc:42,msb:8},{id:101,name:'CONTRABASS',category:'STRINGS',pc:43,msb:2},{id:102,name:'TREMOLO',category:'STRINGS',pc:44,msb:2},{id:103,name:'PIZZICATO',category:'STRINGS',pc:45,msb:2},{id:104,name:'HARP 1',category:'STRINGS',pc:46,msb:2},{id:105,name:'HARP 2',category:'STRINGS',pc:46,msb:1},{id:106,name:'TIMPANI',category:'STRINGS',pc:47,msb:2},{id:107,name:'STRINGS 1',category:'STRINGS',pc:48,msb:2},{id:108,name:'STRINGS 2',category:'STRINGS',pc:49,msb:2},{id:109,name:'SLOW STRINGS 1',category:'STRINGS',pc:48,msb:8},{id:110,name:'SLOW STRINGS 2',category:'STRINGS',pc:49,msb:8},{id:111,name:'SYNTH-STRINGS 1',category:'STRINGS',pc:50,msb:2},{id:112,name:'SYNTH-STRINGS 2',category:'STRINGS',pc:51,msb:2},{id:113,name:'CHOIR 1',category:'STRINGS',pc:52,msb:2},{id:114,name:'CHOIR 2',category:'STRINGS',pc:52,msb:8},{id:115,name:'VOICE OOHS',category:'STRINGS',pc:53,msb:2},{id:116,name:'HUMMING',category:'STRINGS',pc:53,msb:8},{id:117,name:'SYNTH-VOICE',category:'STRINGS',pc:54,msb:2},{id:118,name:'ORCHESTRA HIT 1',category:'STRINGS',pc:55,msb:2},{id:119,name:'ORCHESTRA HIT 2',category:'STRINGS',pc:55,msb:8},{id:120,name:'BASS HIT',category:'STRINGS',pc:55,msb:9},{id:121,name:'6TH HIT',category:'STRINGS',pc:55,msb:10},{id:122,name:'EURO HIT',category:'STRINGS',pc:55,msb:11},{id:123,name:'PHILLY HIT',category:'STRINGS',pc:55,msb:12},{id:124,name:'DOUBLE HIT',category:'STRINGS',pc:55,msb:13},{id:125,name:'TECHNO HIT',category:'STRINGS',pc:55,msb:14},{id:126,name:'IMPACT',category:'STRINGS',pc:55,msb:1},
    {id:127,name:'TRUMPET',category:'BRASS',pc:56,msb:2},{id:128,name:'MELLOW TRUMPET',category:'BRASS',pc:56,msb:8},{id:129,name:'TRUMPET SFZ',category:'BRASS',pc:56,msb:1},{id:130,name:'TROMBONE',category:'BRASS',pc:57,msb:2},{id:131,name:'TUBA',category:'BRASS',pc:58,msb:2},{id:132,name:'MUTE TRUMPET',category:'BRASS',pc:59,msb:2},{id:133,name:'FRENCH HORN',category:'BRASS',pc:60,msb:2},{id:134,name:'FRENCH HORN SEC',category:'BRASS',pc:60,msb:1},{id:135,name:'BRASS',category:'BRASS',pc:61,msb:2},{id:136,name:'BRASS SECTION 1',category:'BRASS',pc:61,msb:3},{id:137,name:'BRASS SECTION 2',category:'BRASS',pc:61,msb:6},{id:138,name:'BRASS SECTION 3',category:'BRASS',pc:61,msb:7},{id:139,name:'MELLOW BRASS',category:'BRASS',pc:61,msb:1},{id:140,name:'HARD BRASS',category:'BRASS',pc:61,msb:5},{id:141,name:'BRASS SFZ',category:'BRASS',pc:61,msb:8},{id:142,name:'BRASS & STRINGS',category:'BRASS',pc:61,msb:4},{id:143,name:'SYNTH-BRASS 1',category:'BRASS',pc:62,msb:2},{id:144,name:'SYNTH-BRASS 2',category:'BRASS',pc:63,msb:2},{id:145,name:'ANALOG SYNTH-BRASS1',category:'BRASS',pc:62,msb:8},{id:146,name:'ANALOG SYNTH-BRASS2',category:'BRASS',pc:62,msb:9},
    {id:147,name:'ALTO SAX 1',category:'SAX/WIND',pc:65,msb:1},{id:148,name:'ALTO SAX 2',category:'SAX/WIND',pc:65,msb:2},{id:149,name:'HARD A.SAX',category:'SAX/WIND',pc:65,msb:3},{id:150,name:'BREATHY A.SAX',category:'SAX/WIND',pc:65,msb:8},{id:151,name:'TENOR SAX',category:'SAX/WIND',pc:66,msb:1},{id:152,name:'SOFT T.SAX',category:'SAX/WIND',pc:66,msb:5},{id:153,name:'BREATHY T.SAX',category:'SAX/WIND',pc:66,msb:8},{id:154,name:'SOPRANO SAX 1',category:'SAX/WIND',pc:64,msb:2},{id:155,name:'SOPRANO SAX 2',category:'SAX/WIND',pc:64,msb:1},{id:156,name:'BARITONE SAX 1',category:'SAX/WIND',pc:67,msb:2},{id:157,name:'BARITONE SAX 2',category:'SAX/WIND',pc:67,msb:1},{id:158,name:'SAX SECTION',category:'SAX/WIND',pc:65,msb:9},{id:159,name:'CLARINET',category:'SAX/WIND',pc:71,msb:2},{id:160,name:'OBOE',category:'SAX/WIND',pc:68,msb:2},{id:161,name:'SOLO OBOE',category:'SAX/WIND',pc:68,msb:4},{id:162,name:'BASSOON',category:'SAX/WIND',pc:70,msb:5},{id:163,name:'FLUTE 1',category:'SAX/WIND',pc:73,msb:2},{id:164,name:'FLUTE 2',category:'SAX/WIND',pc:73,msb:1},{id:165,name:'PURE FLUTE',category:'SAX/WIND',pc:73,msb:8},{id:166,name:'PICCOLO',category:'SAX/WIND',pc:72,msb:2},{id:167,name:'RECORDER',category:'SAX/WIND',pc:74,msb:2},{id:168,name:'PAN FLUTE',category:'SAX/WIND',pc:75,msb:2},{id:169,name:'BOTTLE BLOW 1',category:'SAX/WIND',pc:76,msb:2},{id:170,name:'BOTTLE BLOW 2',category:'SAX/WIND',pc:76,msb:1},{id:171,name:'WHISTLE',category:'SAX/WIND',pc:78,msb:2},{id:172,name:'OCARINA',category:'SAX/WIND',pc:79,msb:2},{id:173,name:'SHAKUHACHI',category:'SAX/WIND',pc:77,msb:2},{id:174,name:'FLUTE & OBOE',category:'SAX/WIND',pc:73,msb:3},
    {id:175,name:'SQUARE LEAD 1',category:'SYNTH LEAD',pc:80,msb:2},{id:176,name:'SQUARE LEAD 2',category:'SYNTH LEAD',pc:80,msb:3},{id:177,name:'SQUARE LEAD 3',category:'SYNTH LEAD',pc:80,msb:1},{id:178,name:'SAW LEAD 1',category:'SYNTH LEAD',pc:81,msb:2},{id:179,name:'SAW LEAD 2',category:'SYNTH LEAD',pc:81,msb:1},{id:180,name:'SAW LEAD 3',category:'SYNTH LEAD',pc:81,msb:5},{id:181,name:'MELLOW SAW LEAD',category:'SYNTH LEAD',pc:81,msb:8},{id:182,name:'SQUARE PULSE LEAD',category:'SYNTH LEAD',pc:80,msb:5},{id:183,name:'SEQUENCE SAW',category:'SYNTH LEAD',pc:81,msb:32},{id:184,name:'SEQUENCE SINE',category:'SYNTH LEAD',pc:80,msb:9},{id:185,name:'SINE LEAD',category:'SYNTH LEAD',pc:80,msb:8},{id:186,name:'SS LEAD',category:'SYNTH LEAD',pc:81,msb:3},{id:187,name:'SEQUENCE SQUARE',category:'SYNTH LEAD',pc:80,msb:7},{id:188,name:'SEQUENCE PULSE',category:'SYNTH LEAD',pc:80,msb:16},{id:189,name:'SLOW SAW LEAD',category:'SYNTH LEAD',pc:81,msb:4},{id:190,name:'CALLIOPE',category:'SYNTH LEAD',pc:82,msb:2},{id:191,name:'VENT LEAD',category:'SYNTH LEAD',pc:82,msb:5},{id:192,name:'VENT SYNTH',category:'SYNTH LEAD',pc:82,msb:1},{id:193,name:'CHIFF LEAD',category:'SYNTH LEAD',pc:83,msb:2},{id:194,name:'SEQUENCE LEAD 1',category:'SYNTH LEAD',pc:83,msb:5},{id:195,name:'SEQUENCE LEAD 2',category:'SYNTH LEAD',pc:83,msb:3},{id:196,name:'VOICE LEAD',category:'SYNTH LEAD',pc:85,msb:2},{id:197,name:'DISTORTION LEAD',category:'SYNTH LEAD',pc:84,msb:8},{id:198,name:'CHARANG',category:'SYNTH LEAD',pc:84,msb:2},{id:199,name:'CHURCH LEAD',category:'SYNTH LEAD',pc:85,msb:4},{id:200,name:'SYNTH-VOICE LEAD',category:'SYNTH LEAD',pc:85,msb:7},{id:201,name:'FIFTH LEAD',category:'SYNTH LEAD',pc:86,msb:4},{id:202,name:'FIFTH SAW LEAD',category:'SYNTH LEAD',pc:86,msb:2},{id:203,name:'FIFTH SQUARE LEAD',category:'SYNTH LEAD',pc:86,msb:3},{id:204,name:'FIFTH SEQUENCE',category:'SYNTH LEAD',pc:86,msb:1},{id:205,name:'BASS+LEAD',category:'SYNTH LEAD',pc:87,msb:2},
    {id:206,name:'FANTASY 1',category:'SYNTH PAD',pc:88,msb:2},{id:207,name:'FANTASY 2',category:'SYNTH PAD',pc:88,msb:3},{id:208,name:'NEW AGE PAD',category:'SYNTH PAD',pc:88,msb:1},{id:209,name:'WARM VOX',category:'SYNTH PAD',pc:89,msb:8},{id:210,name:'WARM PAD',category:'SYNTH PAD',pc:89,msb:2},{id:211,name:'SINE PAD',category:'SYNTH PAD',pc:89,msb:3},{id:212,name:'SOFT PAD',category:'SYNTH PAD',pc:89,msb:4},{id:213,name:'OLD TAPE PAD',category:'SYNTH PAD',pc:89,msb:6},{id:214,name:'POLYSYNTH 1',category:'SYNTH PAD',pc:90,msb:2},{id:215,name:'POLYSYNTH 2',category:'SYNTH PAD',pc:90,msb:1},{id:216,name:'POLY SAW',category:'SYNTH PAD',pc:90,msb:8},{id:217,name:'SPACE CHOIR',category:'SYNTH PAD',pc:91,msb:1},{id:218,name:'HEAVEN',category:'SYNTH PAD',pc:91,msb:2},{id:219,name:'SPACE STRINGS PAD',category:'SYNTH PAD',pc:91,msb:3},{id:220,name:'SQUARE PAD',category:'SYNTH PAD',pc:92,msb:1},{id:221,name:'BOWED PAD',category:'SYNTH PAD',pc:92,msb:2},{id:222,name:'GLASS PAD',category:'SYNTH PAD',pc:92,msb:3},{id:223,name:'ETHNIC PAD',category:'SYNTH PAD',pc:93,msb:2},{id:224,name:'HARD METAL PAD',category:'SYNTH PAD',pc:93,msb:4},{id:225,name:'CHORUS PAD',category:'SYNTH PAD',pc:94,msb:1},{id:226,name:'HALO PAD',category:'SYNTH PAD',pc:94,msb:2},{id:227,name:'SWEEP PAD',category:'SYNTH PAD',pc:95,msb:2},{id:228,name:'RAIN DROP',category:'SYNTH PAD',pc:96,msb:2},{id:229,name:'SPACE VOICE',category:'SYNTH PAD',pc:97,msb:1},{id:230,name:'SOUND TRACK 1',category:'SYNTH PAD',pc:97,msb:2},{id:231,name:'SOUND TRACK 2',category:'SYNTH PAD',pc:97,msb:3},{id:232,name:'RAVE',category:'SYNTH PAD',pc:97,msb:8},{id:233,name:'CRYSTAL',category:'SYNTH PAD',pc:98,msb:2},{id:234,name:'CHORAL BELL',category:'SYNTH PAD',pc:98,msb:16},{id:235,name:'CELESTA PAD',category:'SYNTH PAD',pc:99,msb:1},{id:236,name:'ATMOSPHERE',category:'SYNTH PAD',pc:99,msb:2},{id:237,name:'BRIGHT BELL PAD',category:'SYNTH PAD',pc:100,msb:1},{id:238,name:'BRIGHTNESS',category:'SYNTH PAD',pc:100,msb:2},{id:239,name:'GOBLIN',category:'SYNTH PAD',pc:101,msb:2},{id:240,name:'ECHO PAD',category:'SYNTH PAD',pc:102,msb:2},{id:241,name:'ECHO DROP',category:'SYNTH PAD',pc:102,msb:3},{id:242,name:'POLY DROP',category:'SYNTH PAD',pc:102,msb:4},{id:243,name:'STAR THEME',category:'SYNTH PAD',pc:103,msb:2},{id:244,name:'SPACE PAD',category:'SYNTH PAD',pc:103,msb:8},
    {id:245,name:'ER HU 1',category:'ETHNIC',pc:110,msb:8},{id:246,name:'ER HU 2',category:'ETHNIC',pc:110,msb:9},{id:247,name:'YANG QIN 1',category:'ETHNIC',pc:15,msb:8},{id:248,name:'YANG QIN 2',category:'ETHNIC',pc:15,msb:9},{id:249,name:'DI ZI',category:'ETHNIC',pc:72,msb:16},{id:250,name:'ZHENG',category:'ETHNIC',pc:107,msb:1},{id:251,name:'SHENG',category:'ETHNIC',pc:109,msb:8},{id:252,name:'SUO NA',category:'ETHNIC',pc:111,msb:32},{id:253,name:'XIAO',category:'ETHNIC',pc:77,msb:32},{id:254,name:'PI PA',category:'ETHNIC',pc:105,msb:32},{id:255,name:'SITAR 1',category:'ETHNIC',pc:104,msb:2},{id:256,name:'SITAR 2',category:'ETHNIC',pc:104,msb:1},{id:257,name:'SITAR PAD',category:'ETHNIC',pc:104,msb:4},{id:258,name:'SANTUR',category:'ETHNIC',pc:15,msb:16},{id:259,name:'SHANAI',category:'ETHNIC',pc:111,msb:2},{id:260,name:'BANJO',category:'ETHNIC',pc:105,msb:2},{id:261,name:'THUMB PIANO',category:'ETHNIC',pc:108,msb:2},{id:262,name:'STEEL DRUMS',category:'ETHNIC',pc:114,msb:2},{id:263,name:'RABAB',category:'ETHNIC',pc:105,msb:8},{id:264,name:'SHAMISEN',category:'ETHNIC',pc:106,msb:2},{id:265,name:'TSUGARU',category:'ETHNIC',pc:106,msb:1},{id:266,name:'KOTO',category:'ETHNIC',pc:107,msb:2},
    {id:267,name:'GM PIANO 1',category:'GM TONES',pc:0,msb:0},{id:268,name:'GM PIANO 2',category:'GM TONES',pc:1,msb:0},{id:269,name:'GM PIANO 3',category:'GM TONES',pc:2,msb:0},{id:270,name:'GM HONKY-TONK',category:'GM TONES',pc:3,msb:0},{id:271,name:'GM E.PIANO 1',category:'GM TONES',pc:4,msb:0},{id:272,name:'GM E.PIANO 2',category:'GM TONES',pc:5,msb:0},{id:273,name:'GM HARPSICHORD',category:'GM TONES',pc:6,msb:0},{id:274,name:'GM CLAVI',category:'GM TONES',pc:7,msb:0},{id:275,name:'GM CELESTA',category:'GM TONES',pc:8,msb:0},{id:276,name:'GM GLOCKENSPIEL',category:'GM TONES',pc:9,msb:0},{id:277,name:'GM MUSIC BOX',category:'GM TONES',pc:10,msb:0},{id:278,name:'GM VIBRAPHONE',category:'GM TONES',pc:11,msb:0},{id:279,name:'GM MARIMBA',category:'GM TONES',pc:12,msb:0},{id:280,name:'GM XYLOPHONE',category:'GM TONES',pc:13,msb:0},{id:281,name:'GM TUBULAR BELL',category:'GM TONES',pc:14,msb:0},{id:282,name:'GM DULCIMER',category:'GM TONES',pc:15,msb:0},{id:283,name:'GM ORGAN 1',category:'GM TONES',pc:16,msb:0},{id:284,name:'GM ORGAN 2',category:'GM TONES',pc:17,msb:0},{id:285,name:'GM ORGAN 3',category:'GM TONES',pc:18,msb:0},{id:286,name:'GM PIPE ORGAN',category:'GM TONES',pc:19,msb:0},{id:287,name:'GM REED ORGAN',category:'GM TONES',pc:20,msb:0},{id:288,name:'GM ACCORDION',category:'GM TONES',pc:21,msb:0},{id:289,name:'GM HARMONICA',category:'GM TONES',pc:22,msb:0},{id:290,name:'GM BANDONEON',category:'GM TONES',pc:23,msb:0},{id:291,name:'GM NYLON GUITAR',category:'GM TONES',pc:24,msb:0},{id:292,name:'GM STEEL GUITAR',category:'GM TONES',pc:25,msb:0},{id:293,name:'GM JAZZ GUITAR',category:'GM TONES',pc:26,msb:0},{id:294,name:'GM CLEAN GUITAR',category:'GM TONES',pc:27,msb:0},{id:295,name:'GM MUTE GUITAR',category:'GM TONES',pc:28,msb:0},{id:296,name:'GM OVERDRIVE GT',category:'GM TONES',pc:29,msb:0},{id:297,name:'GM DISTORTION GT',category:'GM TONES',pc:30,msb:0},{id:298,name:'GM GT HARMONICS',category:'GM TONES',pc:31,msb:0},{id:299,name:'GM ACOUSTIC BASS',category:'GM TONES',pc:32,msb:0},{id:300,name:'GM FINGERED BASS',category:'GM TONES',pc:33,msb:0},{id:301,name:'GM PICKED BASS',category:'GM TONES',pc:34,msb:0},{id:302,name:'GM FRETLESS BASS',category:'GM TONES',pc:35,msb:0},{id:303,name:'GM SLAP BASS 1',category:'GM TONES',pc:36,msb:0},{id:304,name:'GM SLAP BASS 2',category:'GM TONES',pc:37,msb:0},{id:305,name:'GM SYNTH-BASS 1',category:'GM TONES',pc:38,msb:0},{id:306,name:'GM SYNTH-BASS 2',category:'GM TONES',pc:39,msb:0},{id:307,name:'GM VIOLIN',category:'GM TONES',pc:40,msb:0},{id:308,name:'GM VIOLA',category:'GM TONES',pc:41,msb:0},{id:309,name:'GM CELLO',category:'GM TONES',pc:42,msb:0},{id:310,name:'GM CONTRABASS',category:'GM TONES',pc:43,msb:0},{id:311,name:'GM TREMOLO',category:'GM TONES',pc:44,msb:0},{id:312,name:'GM PIZZICATO',category:'GM TONES',pc:45,msb:0},{id:313,name:'GM HARP',category:'GM TONES',pc:46,msb:0},{id:314,name:'GM TIMPANI',category:'GM TONES',pc:47,msb:0},{id:315,name:'GM STRINGS 1',category:'GM TONES',pc:48,msb:0},{id:316,name:'GM STRINGS 2',category:'GM TONES',pc:49,msb:0},{id:317,name:'GM SYNTH-STRINGS1',category:'GM TONES',pc:50,msb:0},{id:318,name:'GM SYNTH-STRINGS2',category:'GM TONES',pc:51,msb:0},{id:319,name:'GM CHOIR',category:'GM TONES',pc:52,msb:0},{id:320,name:'GM VOICE DOO',category:'GM TONES',pc:53,msb:0},{id:321,name:'GM SYNTH-VOICE',category:'GM TONES',pc:54,msb:0},{id:322,name:'GM ORCHESTRA HIT',category:'GM TONES',pc:55,msb:0},{id:323,name:'GM TRUMPET',category:'GM TONES',pc:56,msb:0},{id:324,name:'GM TROMBONE',category:'GM TONES',pc:57,msb:0},{id:325,name:'GM TUBA',category:'GM TONES',pc:58,msb:0},{id:326,name:'GM MUTE TRUMPET',category:'GM TONES',pc:59,msb:0},{id:327,name:'GM FRENCH HORN',category:'GM TONES',pc:60,msb:0},{id:328,name:'GM BRASS',category:'GM TONES',pc:61,msb:0},{id:329,name:'GM SYNTH-BRASS 1',category:'GM TONES',pc:62,msb:0},{id:330,name:'GM SYNTH-BRASS 2',category:'GM TONES',pc:63,msb:0},{id:331,name:'GM SOPRANO SAX',category:'GM TONES',pc:64,msb:0},{id:332,name:'GM ALTO SAX',category:'GM TONES',pc:65,msb:0},{id:333,name:'GM TENOR SAX',category:'GM TONES',pc:66,msb:0},{id:334,name:'GM BARITONE SAX',category:'GM TONES',pc:67,msb:0},{id:335,name:'GM OBOE',category:'GM TONES',pc:68,msb:0},{id:336,name:'GM ENGLISH HORN',category:'GM TONES',pc:69,msb:0},{id:337,name:'GM BASSOON',category:'GM TONES',pc:70,msb:0},{id:338,name:'GM CLARINET',category:'GM TONES',pc:71,msb:0},{id:339,name:'GM PICCOLO',category:'GM TONES',pc:72,msb:0},{id:340,name:'GM FLUTE',category:'GM TONES',pc:73,msb:0},{id:341,name:'GM RECORDER',category:'GM TONES',pc:74,msb:0},{id:342,name:'GM PAN FLUTE',category:'GM TONES',pc:75,msb:0},{id:343,name:'GM BOTTLE BLOW',category:'GM TONES',pc:76,msb:0},{id:344,name:'GM SHAKUHACHI',category:'GM TONES',pc:77,msb:0},{id:345,name:'GM WHISTLE',category:'GM TONES',pc:78,msb:0},{id:346,name:'GM OCARINA',category:'GM TONES',pc:79,msb:0},{id:347,name:'GM SQUARE LEAD',category:'GM TONES',pc:80,msb:0},{id:348,name:'GM SAW LEAD',category:'GM TONES',pc:81,msb:0},{id:349,name:'GM CALLIOPE',category:'GM TONES',pc:82,msb:0},{id:350,name:'GM CHIFF LEAD',category:'GM TONES',pc:83,msb:0},{id:351,name:'GM CHARANG',category:'GM TONES',pc:84,msb:0},{id:352,name:'GM VOICE LEAD',category:'GM TONES',pc:85,msb:0},{id:353,name:'GM FIFTH LEAD',category:'GM TONES',pc:86,msb:0},{id:354,name:'GM BASS+LEAD',category:'GM TONES',pc:87,msb:0},{id:355,name:'GM FANTASY',category:'GM TONES',pc:88,msb:0},{id:356,name:'GM WARM PAD',category:'GM TONES',pc:89,msb:0},{id:357,name:'GM POLYSYNTH',category:'GM TONES',pc:90,msb:0},{id:358,name:'GM SPACE CHOIR',category:'GM TONES',pc:91,msb:0},{id:359,name:'GM BOWED GLASS',category:'GM TONES',pc:92,msb:0},{id:360,name:'GM METAL PAD',category:'GM TONES',pc:93,msb:0},{id:361,name:'GM HALO PAD',category:'GM TONES',pc:94,msb:0},{id:362,name:'GM SWEEP PAD',category:'GM TONES',pc:95,msb:0},{id:363,name:'GM RAIN DROP',category:'GM TONES',pc:96,msb:0},{id:364,name:'GM SOUND TRACK',category:'GM TONES',pc:97,msb:0},{id:365,name:'GM CRYSTAL',category:'GM TONES',pc:98,msb:0},{id:366,name:'GM ATMOSPHERE',category:'GM TONES',pc:99,msb:0},{id:367,name:'GM BRIGHTNESS',category:'GM TONES',pc:100,msb:0},{id:368,name:'GM GOBLINS',category:'GM TONES',pc:101,msb:0},{id:369,name:'GM ECHOES',category:'GM TONES',pc:102,msb:0},{id:370,name:'GM SF',category:'GM TONES',pc:103,msb:0},{id:371,name:'GM SITAR',category:'GM TONES',pc:104,msb:0},{id:372,name:'GM BANJO',category:'GM TONES',pc:105,msb:0},{id:373,name:'GM SHAMISEN',category:'GM TONES',pc:106,msb:0},{id:374,name:'GM KOTO',category:'GM TONES',pc:107,msb:0},{id:375,name:'GM THUMB PIANO',category:'GM TONES',pc:108,msb:0},{id:376,name:'GM BAGPIPE',category:'GM TONES',pc:109,msb:0},{id:377,name:'GM FIDDLE',category:'GM TONES',pc:110,msb:0},{id:378,name:'GM SHANAI',category:'GM TONES',pc:111,msb:0},{id:379,name:'GM TINKLE BELL',category:'GM TONES',pc:112,msb:0},{id:380,name:'GM AGOGO',category:'GM TONES',pc:113,msb:0},{id:381,name:'GM STEEL DRUMS',category:'GM TONES',pc:114,msb:0},{id:382,name:'GM WOOD BLOCK',category:'GM TONES',pc:115,msb:0},{id:383,name:'GM TAIKO',category:'GM TONES',pc:116,msb:0},{id:384,name:'GM MELODIC TOM',category:'GM TONES',pc:117,msb:0},{id:385,name:'GM SYNTH-DRUM',category:'GM TONES',pc:118,msb:0},{id:386,name:'GM REVERSE CYMBAL',category:'GM TONES',pc:119,msb:0},{id:387,name:'GM FRET NOISE',category:'GM TONES',pc:120,msb:0},{id:388,name:'GM BREATH NOISE',category:'GM TONES',pc:121,msb:0},{id:389,name:'GM SEASHORE',category:'GM TONES',pc:122,msb:0},{id:390,name:'GM BIRD',category:'GM TONES',pc:123,msb:0},{id:391,name:'GM TELEPHONE',category:'GM TONES',pc:124,msb:0},{id:392,name:'GM HELICOPTER',category:'GM TONES',pc:125,msb:0},{id:393,name:'GM APPLAUSE',category:'GM TONES',pc:126,msb:0},{id:394,name:'GM GUNSHOT',category:'GM TONES',pc:127,msb:0},
    {id:395,name:'STANDARD SET',category:'DRUM SET',pc:0,msb:120},{id:396,name:'ROOM SET',category:'DRUM SET',pc:8,msb:120},{id:397,name:'POWER SET',category:'DRUM SET',pc:16,msb:120},{id:398,name:'SYNTH SET',category:'DRUM SET',pc:25,msb:120},{id:399,name:'BRUSH SET',category:'DRUM SET',pc:40,msb:120},{id:400,name:'ORCHESTRA SET',category:'DRUM SET',pc:48,msb:120},
    {id:401,name:'ORIGINAL',category:'SAMPLED',pc:0,msb:63},{id:402,name:'VOICE PAD 1',category:'SAMPLED',pc:1,msb:63},{id:403,name:'VOICE PAD 2',category:'SAMPLED',pc:2,msb:63},{id:404,name:'VOICE PAD 3',category:'SAMPLED',pc:3,msb:63},{id:405,name:'LOOP 1',category:'SAMPLED',pc:4,msb:63},{id:406,name:'LOOP 2',category:'SAMPLED',pc:5,msb:63},{id:407,name:'LOOP 3',category:'SAMPLED',pc:6,msb:63},{id:408,name:'PITCH 1',category:'SAMPLED',pc:7,msb:63},{id:409,name:'PITCH 2',category:'SAMPLED',pc:8,msb:63},{id:410,name:'PITCH 3',category:'SAMPLED',pc:9,msb:63},{id:411,name:'TREMOLO',category:'SAMPLED',pc:10,msb:63},{id:412,name:'FUNNY 1',category:'SAMPLED',pc:11,msb:63},{id:413,name:'FUNNY 2',category:'SAMPLED',pc:12,msb:63},{id:414,name:'FUNNY 3',category:'SAMPLED',pc:13,msb:63}
];

function buildToneSelector(selectElement) {
    if (!selectElement) return;
    selectElement.innerHTML = '';
    const categorized = {};
    CTK3200_TONES.forEach(t => { if (!categorized[t.category]) categorized[t.category] = []; categorized[t.category].push(t); });
    Object.keys(categorized).sort((a,b) => (categorized[a][0]?.id||0)-(categorized[b][0]?.id||0)).forEach(cat => {
        const og = document.createElement('optgroup');
        const first = categorized[cat][0].id, last = categorized[cat][categorized[cat].length-1].id;
        og.label = cat + ' (' + String(first).padStart(3,'0') + '-' + String(last).padStart(3,'0') + ')';
        categorized[cat].forEach(t => {
            const opt = document.createElement('option');
            opt.value = t.id; opt.dataset.pc = t.pc; opt.dataset.msb = t.msb;
            opt.textContent = String(t.id).padStart(3,'0') + ' ' + t.name;
            og.appendChild(opt);
        });
        selectElement.appendChild(og);
    });
}

// STATE & MAPPINGS
const state = {
    midiOutCTK: null, midiOutLP: null, midiInLP: null,
    isPlaying: false, isRecording: false, currentBeat: 0, tempo: 120, swing: 50, velocity: 100, humanize: 0,
    currentStyle: '8BEAT', currentSection: 'main', currentVariation: 'A',
    currentChord: 'C', chordInstrument: {pc:0,msb:2}, chordVelocity: 80,
    launchpadMode: 'session',
    drumPattern: Array(16).fill(null).map(() => ({ kick: false, snare: false, hihat: false, open: false })),
    bassPattern: Array(16).fill(null).map(() => Array(8).fill(false)),
    tapTimes: [], isDragging: false, dragMode: false, lastTouchedCell: null,
    micPermissionGranted: false,
    voiceToMidi: { isActive: false, audioContext: null, analyser: null, mediaStream: null, currentNote: null, lastNoteTime: 0, sensitivity: 30, transpose: 0, reverb: 40, velocity: 100, channel: 2, scale: 'chromatic', playMode: 'single', currentChordNotes: [], arpeggiatorInterval: null, arpeggiatorIndex: 0 }
};

const LP_MAPPING = {
    pads: [[81,82,83,84,85,86,87,88],[71,72,73,74,75,76,77,78],[61,62,63,64,65,66,67,68],[51,52,53,54,55,56,57,58],[41,42,43,44,45,46,47,48],[31,32,33,34,35,36,37,38],[21,22,23,24,25,26,27,28],[11,12,13,14,15,16,17,18]],
    rightButtons: [89, 79, 69, 59, 49, 39, 29, 19],
    topButtons: { up: 104, down: 105, left: 106, right: 107, session: 108, user1: 109, user2: 110, mixer: 111 },
    colors: { off: 0, red: 5, orange: 9, amber: 13, yellow: 21, lime: 29, green: 25, cyan: 37, blue: 45, purple: 53, pink: 57, white: 3 }
};

const voiceScales = { 'chromatic': [0,1,2,3,4,5,6,7,8,9,10,11], 'C-major': [0,2,4,5,7,9,11], 'G-major': [7,9,11,0,2,4,6], 'A-minor': [9,11,0,2,4,5,7], 'E-minor': [4,6,7,9,11,0,2] };

const RHYTHM_PATTERNS = {
    '8BEAT': { main: { A: { kick: '1000100010001000', snare: '0000100000001000', hihat: '1010101010101010', open: '0000000000000000' }, B: { kick: '1000100010001010', snare: '0000100000001000', hihat: '1010101010101010', open: '0000000000100000' }, C: { kick: '1010100010101000', snare: '0000100000001000', hihat: '1111111111111111', open: '0000000000000000' }, D: { kick: '1010101010101010', snare: '0000100000001000', hihat: '1111111111111111', open: '0000000100000001' } }, intro: { A: { kick: '1000000010000000', snare: '0000000000000000', hihat: '1010101010101010', open: '0000000000000000' }, B: { kick: '1000000010000000', snare: '0000100000000000', hihat: '1010101010101010', open: '0000000000000000' }, C: { kick: '1000100010001000', snare: '0000100000001000', hihat: '1010101010101010', open: '0000000000000000' }, D: { kick: '1000100010001000', snare: '0000100000001000', hihat: '1111111111111111', open: '0000000000000000' } }, fill: { A: { kick: '1000100010001000', snare: '0010001000100010', hihat: '1010101010101010', open: '0000000000000000' }, B: { kick: '1000100010001000', snare: '0010001000101010', hihat: '1010101010101010', open: '0000000000000010' }, C: { kick: '1000100010001010', snare: '0010001000101010', hihat: '1010101010101010', open: '0000000000000010' }, D: { kick: '1010101010101010', snare: '0010001000101111', hihat: '1111111111111111', open: '0000000000000001' } }, ending: { A: { kick: '1000100010000000', snare: '0000100000001000', hihat: '1010101010100000', open: '0000000000000000' }, B: { kick: '1000100010000000', snare: '0000100000001000', hihat: '1010101010100000', open: '0000000000000000' }, C: { kick: '1000100010000000', snare: '0000100000001000', hihat: '1010101010100000', open: '0000000000000000' }, D: { kick: '1000100010001000', snare: '0000100010001000', hihat: '1010101010101000', open: '0000000000000001' } }, chorus: { A: { kick: '1010100010101000', snare: '0000100000001000', hihat: '1111111111111111', open: '0000000000000000' }, B: { kick: '1010100010101000', snare: '0000100000001000', hihat: '1111111111111111', open: '0000000100000001' }, C: { kick: '1010101010101010', snare: '0000100000001000', hihat: '1111111111111111', open: '0000000100000001' }, D: { kick: '1010101010101010', snare: '0100100001001000', hihat: '1111111111111111', open: '0000000100000001' } }, break: { A: { kick: '1000000000000000', snare: '0000000000000000', hihat: '0000000000000000', open: '0000000000000000' }, B: { kick: '1000000010000000', snare: '0000000000000000', hihat: '1010000010100000', open: '0000000000000000' }, C: { kick: '1000000010000000', snare: '0000100000001000', hihat: '1010101010101010', open: '0000000000000000' }, D: { kick: '1000100010001000', snare: '0000100000001000', hihat: '1010101010101010', open: '0000000000000000' } } },
    '16BEAT': { main: { A: { kick: '1000100000101000', snare: '0000100000001000', hihat: '1111111111111111', open: '0000000000000000' }, B: { kick: '1000100000101010', snare: '0000100000001000', hihat: '1111111111111111', open: '0000000000100000' }, C: { kick: '1010100010101000', snare: '0000100100001001', hihat: '1111111111111111', open: '0000000000000000' }, D: { kick: '1010101010101010', snare: '0000100100001001', hihat: '1111111111111111', open: '0000000100000001' } }, intro: { A: { kick: '1000000010000000', snare: '0000000000000000', hihat: '1111111111111111', open: '0000000000000000' }, B: { kick: '1000000010000000', snare: '0000100000000000', hihat: '1111111111111111', open: '0000000000000000' }, C: { kick: '1000100010001000', snare: '0000100000001000', hihat: '1111111111111111', open: '0000000000000000' }, D: { kick: '1000100010001000', snare: '0000100000001000', hihat: '1111111111111111', open: '0000000000000000' } }, fill: { A: { kick: '1000100010001000', snare: '0001000100010001', hihat: '1111111111111111', open: '0000000000000000' }, B: { kick: '1000100010001000', snare: '0001000100011111', hihat: '1111111111111111', open: '0000000000000010' }, C: { kick: '1000100010001010', snare: '0001000100011111', hihat: '1111111111111111', open: '0000000000000010' }, D: { kick: '1010101010101010', snare: '0001000100011111', hihat: '1111111111111111', open: '0000000000000001' } }, ending: { A: { kick: '1000100010000000', snare: '0000100000001000', hihat: '1111111111110000', open: '0000000000000000' }, B: { kick: '1000100010000000', snare: '0000100000001000', hihat: '1111111111110000', open: '0000000000000000' }, C: { kick: '1000100010000000', snare: '0000100000001000', hihat: '1111111111110000', open: '0000000000000000' }, D: { kick: '1000100010001000', snare: '0000100010001000', hihat: '1111111111111000', open: '0000000000000001' } }, chorus: { A: { kick: '1010100010101000', snare: '0000100100001001', hihat: '1111111111111111', open: '0000000000000000' }, B: { kick: '1010100010101000', snare: '0000100100001001', hihat: '1111111111111111', open: '0000000100000001' }, C: { kick: '1010101010101010', snare: '0000100100001001', hihat: '1111111111111111', open: '0000000100000001' }, D: { kick: '1010101010101010', snare: '0100100101001001', hihat: '1111111111111111', open: '0000000100000001' } }, break: { A: { kick: '1000000000000000', snare: '0000000000000000', hihat: '0000000000000000', open: '0000000000000000' }, B: { kick: '1000000010000000', snare: '0000000000000000', hihat: '1111000011110000', open: '0000000000000000' }, C: { kick: '1000000010000000', snare: '0000100000001000', hihat: '1111111111111111', open: '0000000000000000' }, D: { kick: '1000100010001000', snare: '0000100000001000', hihat: '1111111111111111', open: '0000000000000000' } } },
    'POP': { main: { A: { kick: '1000100010001000', snare: '0000100000001000', hihat: '1010101010101010', open: '0000000000000000' }, B: { kick: '1000100010001010', snare: '0000100000001000', hihat: '1010101010101010', open: '0000000000100000' }, C: { kick: '1010100010101000', snare: '0000100000001000', hihat: '1111111111111111', open: '0000000000000000' }, D: { kick: '1010101010101010', snare: '0000100000001000', hihat: '1111111111111111', open: '0000000100000001' } }, intro: { A: { kick: '1000000010000000', snare: '0000000000000000', hihat: '1010101010101010', open: '0000000000000000' }, B: { kick: '1000000010000000', snare: '0000100000000000', hihat: '1010101010101010', open: '0000000000000000' }, C: { kick: '1000100010001000', snare: '0000100000001000', hihat: '1010101010101010', open: '0000000000000000' }, D: { kick: '1000100010001000', snare: '0000100000001000', hihat: '1111111111111111', open: '0000000000000000' } }, fill: { A: { kick: '1000100010001000', snare: '0010001000100010', hihat: '1010101010101010', open: '0000000000000000' }, B: { kick: '1000100010001000', snare: '0010001000101010', hihat: '1010101010101010', open: '0000000000000010' }, C: { kick: '1000100010001010', snare: '0010001000101010', hihat: '1010101010101010', open: '0000000000000010' }, D: { kick: '1010101010101010', snare: '0010001000101111', hihat: '1111111111111111', open: '0000000000000001' } }, ending: { A: { kick: '1000100010000000', snare: '0000100000001000', hihat: '1010101010100000', open: '0000000000000000' }, B: { kick: '1000100010000000', snare: '0000100000001000', hihat: '1010101010100000', open: '0000000000000000' }, C: { kick: '1000100010000000', snare: '0000100000001000', hihat: '1010101010100000', open: '0000000000000000' }, D: { kick: '1000100010001000', snare: '0000100010001000', hihat: '1010101010101000', open: '0000000000000001' } }, chorus: { A: { kick: '1010100010101000', snare: '0000100000001000', hihat: '1111111111111111', open: '0000000000000000' }, B: { kick: '1010100010101000', snare: '0000100000001000', hihat: '1111111111111111', open: '0000000100000001' }, C: { kick: '1010101010101010', snare: '0000100000001000', hihat: '1111111111111111', open: '0000000100000001' }, D: { kick: '1010101010101010', snare: '0100100001001000', hihat: '1111111111111111', open: '0000000100000001' } }, break: { A: { kick: '1000000000000000', snare: '0000000000000000', hihat: '0000000000000000', open: '0000000000000000' }, B: { kick: '1000000010000000', snare: '0000000000000000', hihat: '1010000010100000', open: '0000000000000000' }, C: { kick: '1000000010000000', snare: '0000100000001000', hihat: '1010101010101010', open: '0000000000000000' }, D: { kick: '1000100010001000', snare: '0000100000001000', hihat: '1010101010101010', open: '0000000000000000' } } },
    'ROCK': { main: { A: { kick: '1000100010001000', snare: '0000100000001000', hihat: '1010101010101010', open: '0000000000000000' }, B: { kick: '1000100010001010', snare: '0000100000001000', hihat: '1010101010101010', open: '0000000000100000' }, C: { kick: '1010100010101000', snare: '0000100000001000', hihat: '1111111111111111', open: '0000000000000000' }, D: { kick: '1010101010101010', snare: '0000100000001000', hihat: '1111111111111111', open: '0000000100000001' } }, intro: { A: { kick: '1000000010000000', snare: '0000000000000000', hihat: '1010101010101010', open: '0000000000000000' }, B: { kick: '1000000010000000', snare: '0000100000000000', hihat: '1010101010101010', open: '0000000000000000' }, C: { kick: '1000100010001000', snare: '0000100000001000', hihat: '1010101010101010', open: '0000000000000000' }, D: { kick: '1000100010001000', snare: '0000100000001000', hihat: '1111111111111111', open: '0000000000000000' } }, fill: { A: { kick: '1000100010001000', snare: '0010001000100010', hihat: '1010101010101010', open: '0000000000000000' }, B: { kick: '1000100010001000', snare: '0010001000101010', hihat: '1010101010101010', open: '0000000000000010' }, C: { kick: '1000100010001010', snare: '0010001000101010', hihat: '1010101010101010', open: '0000000000000010' }, D: { kick: '1010101010101010', snare: '0010001000101111', hihat: '1111111111111111', open: '0000000000000001' } }, ending: { A: { kick: '1000100010000000', snare: '0000100000001000', hihat: '1010101010100000', open: '0000000000000000' }, B: { kick: '1000100010000000', snare: '0000100000001000', hihat: '1010101010100000', open: '0000000000000000' }, C: { kick: '1000100010000000', snare: '0000100000001000', hihat: '1010101010100000', open: '0000000000000000' }, D: { kick: '1000100010001000', snare: '0000100010001000', hihat: '1010101010101000', open: '0000000000000001' } }, chorus: { A: { kick: '1010100010101000', snare: '0000100000001000', hihat: '1111111111111111', open: '0000000000000000' }, B: { kick: '1010100010101000', snare: '0000100000001000', hihat: '1111111111111111', open: '0000000100000001' }, C: { kick: '1010101010101010', snare: '0000100000001000', hihat: '1111111111111111', open: '0000000100000001' }, D: { kick: '1010101010101010', snare: '0100100001001000', hihat: '1111111111111111', open: '0000000100000001' } }, break: { A: { kick: '1000000000000000', snare: '0000000000000000', hihat: '0000000000000000', open: '0000000000000000' }, B: { kick: '1000000010000000', snare: '0000000000000000', hihat: '1010000010100000', open: '0000000000000000' }, C: { kick: '1000000010000000', snare: '0000100000001000', hihat: '1010101010101010', open: '0000000000000000' }, D: { kick: '1000100010001000', snare: '0000100000001000', hihat: '1010101010101010', open: '0000000000000000' } } },
    'JAZZ': { main: { A: { kick: '1000001000100000', snare: '0000100000001000', hihat: '1001001001001001', open: '0010010010010010' }, B: { kick: '1000001000100010', snare: '0000100000001000', hihat: '1001001001001001', open: '0010010010010010' }, C: { kick: '1001001000100100', snare: '0000100100001001', hihat: '1001001001001001', open: '0010010010010010' }, D: { kick: '1001001001001001', snare: '0000100100001001', hihat: '1001001001001001', open: '0010010010010010' } }, intro: { A: { kick: '1000000010000000', snare: '0000000000000000', hihat: '1001001001001001', open: '0010010010010010' }, B: { kick: '1000000010000000', snare: '0000100000000000', hihat: '1001001001001001', open: '0010010010010010' }, C: { kick: '1000001000100000', snare: '0000100000001000', hihat: '1001001001001001', open: '0010010010010010' }, D: { kick: '1000001000100000', snare: '0000100000001000', hihat: '1001001001001001', open: '0010010010010010' } }, fill: { A: { kick: '1000001000100000', snare: '0010001000100010', hihat: '1001001001001001', open: '0010010010010010' }, B: { kick: '1000001000100000', snare: '0010001000101010', hihat: '1001001001001001', open: '0010010010010010' }, C: { kick: '1000001000100010', snare: '0010001000101010', hihat: '1001001001001001', open: '0010010010010010' }, D: { kick: '1001001001001001', snare: '0010001000101111', hihat: '1001001001001001', open: '0010010010010010' } }, ending: { A: { kick: '1000001000100000', snare: '0000100000001000', hihat: '1001001001000000', open: '0010010010000000' }, B: { kick: '1000001000100000', snare: '0000100000001000', hihat: '1001001001000000', open: '0010010010000000' }, C: { kick: '1000001000100000', snare: '0000100000001000', hihat: '1001001001000000', open: '0010010010000000' }, D: { kick: '1000001000100010', snare: '0000100010001000', hihat: '1001001001001000', open: '0010010010010001' } }, chorus: { A: { kick: '1001001000100100', snare: '0000100100001001', hihat: '1001001001001001', open: '0010010010010010' }, B: { kick: '1001001000100100', snare: '0000100100001001', hihat: '1001001001001001', open: '0010010010010010' }, C: { kick: '1001001001001001', snare: '0000100100001001', hihat: '1001001001001001', open: '0010010010010010' }, D: { kick: '1001001001001001', snare: '0100100101001001', hihat: '1001001001001001', open: '0010010010010010' } }, break: { A: { kick: '1000000000000000', snare: '0000000000000000', hihat: '0000000000000000', open: '0000000000000000' }, B: { kick: '1000000010000000', snare: '0000000000000000', hihat: '1001000010010000', open: '0010000001000000' }, C: { kick: '1000000010000000', snare: '0000100000001000', hihat: '1001001001001001', open: '0010010010010010' }, D: { kick: '1000001000100000', snare: '0000100000001000', hihat: '1001001001001001', open: '0010010010010010' } } },
    'LATIN': { main: { A: { kick: '1000100100001001', snare: '0001000100010001', hihat: '1010101010101010', open: '0100010001000100' }, B: { kick: '1000100100001001', snare: '0001000100010001', hihat: '1010101010101010', open: '0100010001000100' }, C: { kick: '1001001000100100', snare: '0001000100010001', hihat: '1111111111111111', open: '0100010001000100' }, D: { kick: '1001001001001001', snare: '0001000100010001', hihat: '1111111111111111', open: '0100010001000100' } }, intro: { A: { kick: '1000000010000000', snare: '0000000000000000', hihat: '1010101010101010', open: '0100010001000100' }, B: { kick: '1000100100001001', snare: '0000000000000000', hihat: '1010101010101010', open: '0100010001000100' }, C: { kick: '1000100100001001', snare: '0001000100010001', hihat: '1010101010101010', open: '0100010001000100' }, D: { kick: '1000100100001001', snare: '0001000100010001', hihat: '1010101010101010', open: '0100010001000100' } }, fill: { A: { kick: '1000100100001001', snare: '0010001000100010', hihat: '1010101010101010', open: '0100010001000100' }, B: { kick: '1000100100001001', snare: '0010001000101010', hihat: '1010101010101010', open: '0100010001000100' }, C: { kick: '1001001000100100', snare: '0010001000101010', hihat: '1010101010101010', open: '0100010001000100' }, D: { kick: '1001001001001001', snare: '0010001000101111', hihat: '1111111111111111', open: '0100010001000101' } }, ending: { A: { kick: '1000100100001000', snare: '0001000100010001', hihat: '1010101010100000', open: '0100010001000000' }, B: { kick: '1000100100001000', snare: '0001000100010001', hihat: '1010101010100000', open: '0100010001000000' }, C: { kick: '1000100100001000', snare: '0001000100010001', hihat: '1010101010100000', open: '0100010001000000' }, D: { kick: '1000100100001001', snare: '0001000100010001', hihat: '1010101010101000', open: '0100010001000101' } }, chorus: { A: { kick: '1001001000100100', snare: '0001000100010001', hihat: '1111111111111111', open: '0100010001000100' }, B: { kick: '1001001000100100', snare: '0001000100010001', hihat: '1111111111111111', open: '0100010001000100' }, C: { kick: '1001001001001001', snare: '0001000100010001', hihat: '1111111111111111', open: '0100010001000100' }, D: { kick: '1001001001001001', snare: '0101010101010101', hihat: '1111111111111111', open: '0100010001000100' } }, break: { A: { kick: '1000000000000000', snare: '0000000000000000', hihat: '0000000000000000', open: '0000000000000000' }, B: { kick: '1000000010000000', snare: '0000000000000000', hihat: '1010000010100000', open: '0100000001000000' }, C: { kick: '1000100100001001', snare: '0000000000000000', hihat: '1010101010101010', open: '0100010001000100' }, D: { kick: '1000100100001001', snare: '0001000100010001', hihat: '1010101010101010', open: '0100010001000100' } } }
};

const CHORDS = [
    { name: 'C', type: 'Major', notes: [60, 64, 67] }, { name: 'D', type: 'Major', notes: [62, 66, 69] }, { name: 'E', type: 'Major', notes: [64, 68, 71] },
    { name: 'F', type: 'Major', notes: [65, 69, 72] }, { name: 'G', type: 'Major', notes: [67, 71, 74] }, { name: 'A', type: 'Major', notes: [69, 73, 76] },
    { name: 'Cm', type: 'Minor', notes: [60, 63, 67] }, { name: 'Dm', type: 'Minor', notes: [62, 65, 69] }, { name: 'Em', type: 'Minor', notes: [64, 67, 71] },
    { name: 'Fm', type: 'Minor', notes: [65, 68, 72] }, { name: 'Gm', type: 'Minor', notes: [67, 70, 74] }, { name: 'Am', type: 'Minor', notes: [69, 72, 76] },
    { name: 'C7', type: '7th', notes: [60, 64, 67, 70] }, { name: 'D7', type: '7th', notes: [62, 66, 69, 72] }, { name: 'E7', type: '7th', notes: [64, 68, 71, 74] },
    { name: 'F7', type: '7th', notes: [65, 69, 72, 75] }, { name: 'G7', type: '7th', notes: [67, 71, 74, 77] }, { name: 'A7', type: '7th', notes: [69, 73, 76, 79] },
    { name: 'B¬∞', type: 'Dim', notes: [71, 74, 77] }, { name: 'Csus4', type: 'Sus4', notes: [60, 65, 67] }, { name: 'Dsus2', type: 'Sus2', notes: [62, 64, 69] },
    { name: 'FM7', type: 'Maj7', notes: [65, 69, 72, 76] }, { name: 'Gsus4', type: 'Sus4', notes: [67, 72, 74] }, { name: 'Am7', type: 'Min7', notes: [69, 72, 76, 79] }
];

let sequencerTimeout = null;

// INITIALIZATION
document.addEventListener('DOMContentLoaded', () => {
    initializeUI();
    buildToneSelector(document.getElementById('chordInstrument'));
    buildToneSelector(document.getElementById('voiceToneSelect'));
    setupEventListeners();
    loadPattern(state.currentStyle, state.currentSection, state.currentVariation);
    document.getElementById('lpTopSESSION').classList.add('active');
    setTimeout(() => document.getElementById('loading').classList.add('hidden'), 500);
});

function initializeUI() {
    // Styles
    const styles = ['8BEAT', '16BEAT', 'POP', 'ROCK', 'JAZZ', 'LATIN'];
    const styleGrid = document.getElementById('styleGrid');
    styles.forEach(style => {
        const btn = document.createElement('button');
        btn.className = 'style-btn' + (style === state.currentStyle ? ' active' : '');
        btn.textContent = style;
        btn.onclick = () => selectStyle(style);
        styleGrid.appendChild(btn);
    });
    
    // Sections
    ['INTRO', 'MAIN', 'CHORUS', 'FILL', 'BREAK', 'ENDING'].forEach(section => {
        const btn = document.createElement('button');
        btn.className = 'section-btn' + (section.toLowerCase() === state.currentSection ? ' active' : '');
        btn.textContent = section;
        btn.onclick = () => selectSection(section.toLowerCase());
        document.getElementById('sectionGrid').appendChild(btn);
    });
    
    // Variations
    ['A', 'B', 'C', 'D'].forEach(v => {
        const btn = document.createElement('button');
        btn.className = 'var-btn' + (v === state.currentVariation ? ' active' : '');
        btn.textContent = v;
        btn.onclick = () => selectVariation(v);
        document.getElementById('variationRow').appendChild(btn);
    });
    
    // Chord Grid
    CHORDS.forEach(chord => {
        const pad = document.createElement('div');
        pad.className = 'chord-pad';
        pad.innerHTML = '<div class="chord-name">' + chord.name + '</div><div class="chord-type">' + chord.type + '</div>';
        pad.addEventListener('mousedown', function(e) { e.preventDefault(); playChordFromPad(chord, this); });
        pad.addEventListener('mouseup', function() { stopChord(); });
        pad.addEventListener('mouseleave', function() { if (this.classList.contains('active')) stopChord(); });
        pad.addEventListener('touchstart', function(e) { e.preventDefault(); playChordFromPad(chord, this); }, { passive: false });
        pad.addEventListener('touchend', function(e) { e.preventDefault(); stopChord(); }, { passive: false });
        document.getElementById('chordGrid').appendChild(pad);
    });
    
    // Pattern Grid
    const patternGrid = document.getElementById('patternGrid');
    for (let row = 0; row < 4; row++) {
        const rowDiv = document.createElement('div');
        rowDiv.className = 'pattern-row';
        for (let step = 0; step < 16; step++) {
            const cell = document.createElement('div');
            cell.className = 'pattern-cell';
            cell.dataset.row = row;
            cell.dataset.step = step;
            cell.addEventListener('mousedown', handlePatternCellMouseDown);
            cell.addEventListener('mouseenter', handlePatternCellMouseEnter);
            cell.addEventListener('touchstart', handlePatternCellMouseDown, { passive: false });
            rowDiv.appendChild(cell);
        }
        patternGrid.appendChild(rowDiv);
    }
    
    // Launchpad UI
    const topButtons = ['UP', 'DOWN', 'LEFT', 'RIGHT', 'SESSION', 'USER 1', 'USER 2', 'MIXER'];
    topButtons.forEach(btn => {
        const button = document.createElement('button');
        button.className = 'lp-top-btn';
        button.textContent = btn;
        button.id = 'lpTop' + btn.replace(' ', '');
        switch(btn) {
            case 'SESSION': button.onclick = () => setLaunchpadMode('session'); break;
            case 'USER 1': button.onclick = () => setLaunchpadMode('user1'); break;
            case 'USER 2': button.onclick = () => setLaunchpadMode('user2'); break;
            default: button.onclick = () => showMessage('LP: ' + btn);
        }
        document.getElementById('lpTopButtons').appendChild(button);
    });
    
    for (let row = 0; row < 8; row++) {
        for (let col = 0; col < 8; col++) {
            const pad = document.createElement('div');
            pad.className = 'lp-pad';
            pad.dataset.row = row;
            pad.dataset.col = col;
            pad.id = 'lp-' + row + '-' + col;
            pad.addEventListener('mousedown', () => handleLPPadPress(row, col));
            pad.addEventListener('touchstart', (e) => { e.preventDefault(); handleLPPadPress(row, col); }, { passive: false });
            document.getElementById('lpGrid').appendChild(pad);
        }
    }
    
    const rightLabels = ['DS1', 'DS2', 'DS3', 'DS4', 'DS5', 'DS6', 'STOP', 'PLAY'];
    rightLabels.forEach((lbl, i) => {
        const btn = document.createElement('button');
        btn.className = 'lp-right-btn';
        btn.textContent = lbl;
        if (i === 7) { btn.dataset.function = 'play'; btn.onclick = () => togglePlay(); }
        else if (i === 6) { btn.dataset.function = 'stop'; btn.onclick = () => stopPlayback(); }
        document.getElementById('lpRightButtons').appendChild(btn);
    });
}

function setupEventListeners() {
    document.addEventListener('mouseup', () => state.isDragging = false);
    document.addEventListener('touchend', () => state.isDragging = false);
    document.addEventListener('keydown', (e) => { if (e.code === 'Space') { e.preventDefault(); togglePlay(); } });
    
    document.getElementById('chordVelocity').addEventListener('input', (e) => { state.chordVelocity = parseInt(e.target.value); document.getElementById('chordVelValue').textContent = e.target.value; });
    document.getElementById('chordInstrument').addEventListener('change', (e) => {
        const opt = e.target.options[e.target.selectedIndex];
        state.chordInstrument = { pc: parseInt(opt.dataset.pc), msb: parseInt(opt.dataset.msb) };
    });
    
    document.getElementById('voicePlayMode').addEventListener('change', (e) => state.voiceToMidi.playMode = e.target.value);
    document.getElementById('voiceScale').addEventListener('change', (e) => state.voiceToMidi.scale = e.target.value);
    document.getElementById('voiceSensitivity').addEventListener('input', (e) => { state.voiceToMidi.sensitivity = parseInt(e.target.value); document.getElementById('voiceSensitivityValue').textContent = e.target.value; });
    document.getElementById('voiceReverb').addEventListener('input', (e) => { state.voiceToMidi.reverb = parseInt(e.target.value); document.getElementById('voiceReverbValue').textContent = e.target.value; });
    document.getElementById('voiceTranspose').addEventListener('input', (e) => { state.voiceToMidi.transpose = parseInt(e.target.value); document.getElementById('voiceTransposeValue').textContent = (parseInt(e.target.value) > 0 ? '+' : '') + e.target.value; });
    
    setupKnobControl('swingKnob', v => { state.swing = v; document.getElementById('swingValue').textContent = v + '%'; });
    setupKnobControl('velocityKnob', v => { state.velocity = v; document.getElementById('velocityValue').textContent = v; });
    setupKnobControl('humanizeKnob', v => { state.humanize = v; document.getElementById('humanizeValue').textContent = v + '%'; });
}

function setupKnobControl(knobId, callback) {
    const knob = document.getElementById(knobId);
    const indicator = knob.querySelector('.control-indicator');
    const updateKnob = (value) => {
        const min = parseInt(knob.dataset.min), max = parseInt(knob.dataset.max);
        value = Math.max(min, Math.min(max, value));
        knob.dataset.value = value;
        indicator.style.transform = 'translateX(-50%) rotate(' + (((value - min) / (max - min)) * 270 - 135) + 'deg)';
        callback(value);
    };
    const handleStart = (e) => {
        e.preventDefault();
        let startX = e.type.includes('touch') ? e.touches[0].clientX : e.clientX;
        let startValue = parseInt(knob.dataset.value);
        const handleMove = (e) => { const currentX = e.type.includes('touch') ? e.touches[0].clientX : e.clientX; updateKnob(startValue + Math.round((currentX - startX) / 100 * (parseInt(knob.dataset.max) - parseInt(knob.dataset.min)))); };
        const handleEnd = () => { document.removeEventListener('mousemove', handleMove); document.removeEventListener('touchmove', handleMove); document.removeEventListener('mouseup', handleEnd); document.removeEventListener('touchend', handleEnd); };
        document.addEventListener('mousemove', handleMove);
        document.addEventListener('touchmove', handleMove, { passive: false });
        document.addEventListener('mouseup', handleEnd);
        document.addEventListener('touchend', handleEnd);
    };
    knob.addEventListener('mousedown', handleStart);
    knob.addEventListener('touchstart', handleStart, { passive: false });
    updateKnob(parseInt(knob.dataset.value));
}

// CHORD HANDLING
function playChordFromPad(chord, padElement) {
    state.currentChord = chord.name;
    document.getElementById('currentChord').textContent = chord.name;
    if (state.midiOutCTK) {
        state.midiOutCTK.send([0xB0, 0, state.chordInstrument.msb || 0]);
        state.midiOutCTK.send([0xC0, state.chordInstrument.pc || 0]);
        chord.notes.forEach(note => state.midiOutCTK.send([0x90, note, state.chordVelocity]));
    }
    updateChordHarmony(chord.name);
    document.querySelectorAll('.chord-pad').forEach(pad => pad.classList.remove('active'));
    padElement.classList.add('active');
}

function stopChord() {
    if (state.midiOutCTK) for (let note = 48; note < 84; note++) state.midiOutCTK.send([0x80, note, 0]);
    document.querySelectorAll('.chord-pad').forEach(pad => pad.classList.remove('active'));
}

function updateChordHarmony(currentChord) {
    const circleOfFifths = {
        'C': { perfect: ['G', 'F', 'Am'], good: ['Em', 'Dm'] }, 'G': { perfect: ['D', 'C', 'Em'], good: ['Bm', 'Am'] },
        'D': { perfect: ['A', 'G', 'Bm'], good: ['Em'] }, 'A': { perfect: ['E', 'D'], good: ['Bm'] },
        'F': { perfect: ['C', 'Dm'], good: ['Am', 'Gm'] }, 'Am': { perfect: ['Dm', 'Em', 'C'], good: ['F', 'G'] },
        'Em': { perfect: ['Am', 'G'], good: ['C', 'D'] }, 'Dm': { perfect: ['Gm', 'Am', 'F'], good: ['C'] }
    };
    const baseChord = currentChord.replace(/7|m7|maj7|sus|dim|aug|¬∞/g, '');
    const harmonyInfo = circleOfFifths[baseChord] || {};
    document.querySelectorAll('.chord-pad').forEach(pad => { pad.classList.remove('harmony-perfect', 'harmony-good'); });
    document.querySelectorAll('.chord-pad').forEach(pad => {
        if (pad.classList.contains('active')) return;
        const padChord = pad.querySelector('.chord-name').textContent;
        const basePadChord = padChord.replace(/7|m7|maj7|sus|dim|aug|¬∞/g, '');
        if (harmonyInfo.perfect && harmonyInfo.perfect.some(c => basePadChord === c || padChord === c)) pad.classList.add('harmony-perfect');
        else if (harmonyInfo.good && harmonyInfo.good.some(c => basePadChord === c || padChord === c)) pad.classList.add('harmony-good');
    });
}

// LAUNCHPAD - MODE SESSION CORRIG√â: 4 lignes haut = temps 1-8, 4 lignes bas = temps 9-16
function updateLaunchpadDisplay() {
    // Clear all pads
    for (let row = 0; row < 8; row++) {
        for (let col = 0; col < 8; col++) {
            const pad = document.getElementById('lp-' + row + '-' + col);
            if (pad) pad.removeAttribute('data-color');
            if (state.midiOutLP) state.midiOutLP.send([0x90, LP_MAPPING.pads[row][col], 0]);
        }
    }
    if (state.launchpadMode === 'session') updateSessionMode();
    if (state.midiOutLP) {
        state.midiOutLP.send([0xB0, LP_MAPPING.topButtons.session, state.launchpadMode === 'session' ? 127 : 0]);
        state.midiOutLP.send([0xB0, LP_MAPPING.topButtons.user1, state.launchpadMode === 'user1' ? 127 : 0]);
        state.midiOutLP.send([0xB0, LP_MAPPING.topButtons.user2, state.launchpadMode === 'user2' ? 127 : 0]);
    }
}

function updateSessionMode() {
    const instruments = ['kick', 'snare', 'hihat', 'open'];
    const colors = ['red', 'orange', 'yellow', 'cyan'];
    const lpColors = [LP_MAPPING.colors.red, LP_MAPPING.colors.orange, LP_MAPPING.colors.yellow, LP_MAPPING.colors.cyan];
    
    // TOP 4 rows (0-3) = Steps 1-8 (indices 0-7)
    // BOTTOM 4 rows (4-7) = Steps 9-16 (indices 8-15)
    for (let instIndex = 0; instIndex < 4; instIndex++) {
        const inst = instruments[instIndex];
        // Steps 1-8 on top rows
        for (let col = 0; col < 8; col++) {
            const step = col;
            const row = instIndex;
            const pad = document.getElementById('lp-' + row + '-' + col);
            if (state.drumPattern[step] && state.drumPattern[step][inst]) {
                if (pad) pad.setAttribute('data-color', colors[instIndex]);
                if (state.midiOutLP) state.midiOutLP.send([0x90, LP_MAPPING.pads[row][col], lpColors[instIndex]]);
            }
        }
        // Steps 9-16 on bottom rows
        for (let col = 0; col < 8; col++) {
            const step = col + 8;
            const row = instIndex + 4;
            const pad = document.getElementById('lp-' + row + '-' + col);
            if (state.drumPattern[step] && state.drumPattern[step][inst]) {
                if (pad) pad.setAttribute('data-color', colors[instIndex]);
                if (state.midiOutLP) state.midiOutLP.send([0x90, LP_MAPPING.pads[row][col], lpColors[instIndex]]);
            }
        }
    }
    // Current beat indicator
    if (state.isPlaying) {
        const beatCol = state.currentBeat % 8;
        const beatRowOffset = state.currentBeat < 8 ? 0 : 4;
        for (let instIndex = 0; instIndex < 4; instIndex++) {
            const row = instIndex + beatRowOffset;
            const pad = document.getElementById('lp-' + row + '-' + beatCol);
            if (pad) pad.setAttribute('data-color', 'white');
            if (state.midiOutLP) state.midiOutLP.send([0x90, LP_MAPPING.pads[row][beatCol], LP_MAPPING.colors.white]);
        }
    }
}

function setLaunchpadMode(mode) {
    state.launchpadMode = mode;
    document.getElementById('lpTopSESSION').classList.toggle('active', mode === 'session');
    document.getElementById('lpTopUSER1').classList.toggle('active', mode === 'user1');
    document.getElementById('lpTopUSER2').classList.toggle('active', mode === 'user2');
    updateLaunchpadDisplay();
}

function handleLPPadPress(row, col) {
    if (state.launchpadMode === 'session') {
        let step, instIndex;
        if (row < 4) { step = col; instIndex = row; }
        else { step = col + 8; instIndex = row - 4; }
        const instruments = ['kick', 'snare', 'hihat', 'open'];
        if (instIndex >= 0 && instIndex < 4 && step >= 0 && step < 16) {
            state.drumPattern[step][instruments[instIndex]] = !state.drumPattern[step][instruments[instIndex]];
            updatePatternDisplay();
            updateLaunchpadDisplay();
        }
    } else if (state.launchpadMode === 'user1' && row >= 4 && state.midiOutCTK) {
        const drumNotes = [36, 38, 42, 46, 35, 37, 44, 49];
        const noteIndex = (row - 4) * 2 + Math.floor(col / 4);
        state.midiOutCTK.send([0x99, drumNotes[noteIndex % 8], state.velocity]);
    }
}

// PATTERN MANAGEMENT
function loadPattern(style, section, variation) {
    const patterns = RHYTHM_PATTERNS[style];
    if (patterns && patterns[section] && patterns[section][variation]) {
        const pattern = patterns[section][variation];
        for (let i = 0; i < 16; i++) {
            state.drumPattern[i] = { kick: pattern.kick[i] === '1', snare: pattern.snare[i] === '1', hihat: pattern.hihat[i] === '1', open: pattern.open[i] === '1' };
        }
        updatePatternDisplay();
        updateLaunchpadDisplay();
    }
}

function updatePatternDisplay() {
    const instruments = ['kick', 'snare', 'hihat', 'open'];
    instruments.forEach((inst, row) => {
        for (let step = 0; step < 16; step++) {
            const cell = document.querySelector('.pattern-cell[data-row="' + row + '"][data-step="' + step + '"]');
            if (cell) cell.classList.toggle('active', state.drumPattern[step] && state.drumPattern[step][inst]);
        }
    });
}

function handlePatternCellMouseDown(e) {
    e.preventDefault();
    const row = parseInt(e.target.dataset.row), step = parseInt(e.target.dataset.step);
    const instruments = ['kick', 'snare', 'hihat', 'open'];
    state.drumPattern[step][instruments[row]] = !state.drumPattern[step][instruments[row]];
    e.target.classList.toggle('active');
    state.isDragging = true;
    state.dragMode = state.drumPattern[step][instruments[row]];
    updateLaunchpadDisplay();
}

function handlePatternCellMouseEnter(e) {
    if (state.isDragging) {
        const row = parseInt(e.target.dataset.row), step = parseInt(e.target.dataset.step);
        const instruments = ['kick', 'snare', 'hihat', 'open'];
        state.drumPattern[step][instruments[row]] = state.dragMode;
        e.target.classList.toggle('active', state.dragMode);
        updateLaunchpadDisplay();
    }
}

// PLAYBACK
function togglePlay() { if (state.isPlaying) stopPlayback(); else startPlayback(); }

function startPlayback() {
    if (state.isPlaying) return;
    state.isPlaying = true;
    document.getElementById('playBtn').classList.add('playing');
    document.getElementById('playBtn').textContent = '‚ùö‚ùö';
    playNextBeat();
}

function playNextBeat() {
    if (!state.isPlaying) return;
    playCurrentBeat();
    updateBeatDisplay();
    state.currentBeat = (state.currentBeat + 1) % 16;
    const beatDuration = 60000 / state.tempo / 4;
    let delay = beatDuration;
    if (state.swing > 50 && (state.currentBeat % 2) === 1) delay = beatDuration * (1 + (state.swing - 50) / 50 * 0.5);
    sequencerTimeout = setTimeout(playNextBeat, delay);
}

function stopPlayback() {
    state.isPlaying = false;
    state.currentBeat = 0;
    if (sequencerTimeout) { clearTimeout(sequencerTimeout); sequencerTimeout = null; }
    document.getElementById('playBtn').classList.remove('playing');
    document.getElementById('playBtn').textContent = '‚ñ∂';
    if (state.midiOutCTK) [35, 36, 38, 42, 46].forEach(note => state.midiOutCTK.send([0x89, note, 0]));
    document.querySelectorAll('.pattern-cell').forEach(cell => cell.classList.remove('playing'));
    updateLaunchpadDisplay();
}

function playCurrentBeat() {
    const pattern = state.drumPattern[state.currentBeat] || { kick: false, snare: false, hihat: false, open: false };
    const humanizeAmount = state.humanize / 100;
    const velocityVariation = Math.round((Math.random() - 0.5) * humanizeAmount * 40);
    const finalVelocity = Math.max(1, Math.min(127, state.velocity + velocityVariation));
    if (state.midiOutCTK) {
        if (pattern.kick) state.midiOutCTK.send([0x99, 36, finalVelocity]);
        if (pattern.snare) state.midiOutCTK.send([0x99, 38, finalVelocity]);
        if (pattern.hihat) state.midiOutCTK.send([0x99, 42, finalVelocity]);
        if (pattern.open) state.midiOutCTK.send([0x99, 46, finalVelocity]);
    }
}

function updateBeatDisplay() {
    document.querySelectorAll('.pattern-cell').forEach(cell => cell.classList.remove('playing'));
    for (let row = 0; row < 4; row++) {
        const cell = document.querySelector('.pattern-cell[data-row="' + row + '"][data-step="' + state.currentBeat + '"]');
        if (cell) cell.classList.add('playing');
    }
    if (state.launchpadMode === 'session') updateLaunchpadDisplay();
}

function toggleRecord() {
    state.isRecording = !state.isRecording;
    document.getElementById('recBtn').classList.toggle('recording');
    showMessage(state.isRecording ? 'Recording...' : 'Stopped');
}

// STYLE & CONTROLS
function selectStyle(style) {
    state.currentStyle = style;
    document.getElementById('styleDisplay').textContent = style;
    document.querySelectorAll('.style-btn').forEach(btn => btn.classList.toggle('active', btn.textContent === style));
    loadPattern(style, state.currentSection, state.currentVariation);
}

function selectSection(section) {
    state.currentSection = section;
    document.getElementById('sectionDisplay').textContent = section.toUpperCase();
    document.querySelectorAll('.section-btn').forEach(btn => btn.classList.toggle('active', btn.textContent.toLowerCase() === section));
    loadPattern(state.currentStyle, section, state.currentVariation);
}

function selectVariation(variation) {
    state.currentVariation = variation;
    document.getElementById('varDisplay').textContent = variation;
    document.querySelectorAll('.var-btn').forEach(btn => btn.classList.toggle('active', btn.textContent === variation));
    loadPattern(state.currentStyle, state.currentSection, variation);
}

function changeTempo(delta) { state.tempo = Math.max(40, Math.min(240, state.tempo + delta)); document.getElementById('tempoDisplay').textContent = state.tempo; }

function tapTempo() {
    const now = Date.now();
    state.tapTimes.push(now);
    if (state.tapTimes.length > 4) state.tapTimes.shift();
    if (state.tapTimes.length >= 2) {
        const intervals = [];
        for (let i = 1; i < state.tapTimes.length; i++) intervals.push(state.tapTimes[i] - state.tapTimes[i - 1]);
        const avgInterval = intervals.reduce((a, b) => a + b) / intervals.length;
        const newTempo = Math.round(60000 / avgInterval);
        if (newTempo >= 40 && newTempo <= 240) { state.tempo = newTempo; document.getElementById('tempoDisplay').textContent = state.tempo; }
    }
}

// MIDI CONNECTION
function connectMIDI() {
    if (navigator.requestMIDIAccess) navigator.requestMIDIAccess({ sysex: true }).then(onMIDISuccess).catch(() => showMessage('MIDI access failed'));
    else showMessage('WebMIDI not supported');
}

function onMIDISuccess(midiAccess) {
    const outputs = Array.from(midiAccess.outputs.values());
    const inputs = Array.from(midiAccess.inputs.values());
    const ctkOut = outputs.find(d => d.name.includes('CTK') || d.name.includes('CASIO') || d.name.includes('USB MIDI'));
    if (ctkOut) { state.midiOutCTK = ctkOut; document.getElementById('ctkLed').classList.add('active'); showMessage('CTK: ' + ctkOut.name); }
    const lpOut = outputs.find(d => d.name.includes('Launchpad') || d.name.includes('MK2'));
    const lpIn = inputs.find(d => d.name.includes('Launchpad') || d.name.includes('MK2'));
    if (lpOut && lpIn) {
        state.midiOutLP = lpOut;
        state.midiInLP = lpIn;
        document.getElementById('lpLed').classList.add('active');
        lpIn.onmidimessage = handleLaunchpadMIDI;
        setTimeout(() => { state.midiOutLP.send([0xB0, LP_MAPPING.topButtons.session, 127]); updateLaunchpadDisplay(); }, 100);
        showMessage('LP: ' + lpOut.name);
    }
    if (!ctkOut && !lpOut) showMessage('No MIDI devices found');
}

function handleLaunchpadMIDI(message) {
    const [status, data1, data2] = message.data;
    if (status === 0x90 && data2 > 0) {
        for (let row = 0; row < 8; row++) {
            for (let col = 0; col < 8; col++) {
                if (LP_MAPPING.pads[row][col] === data1) { handleLPPadPress(row, col); return; }
            }
        }
        if (LP_MAPPING.rightButtons.indexOf(data1) === 7) togglePlay();
        else if (LP_MAPPING.rightButtons.indexOf(data1) === 6) stopPlayback();
    } else if (status === 0xB0 && data2 > 0) {
        if (data1 === LP_MAPPING.topButtons.session) setLaunchpadMode('session');
        else if (data1 === LP_MAPPING.topButtons.user1) setLaunchpadMode('user1');
        else if (data1 === LP_MAPPING.topButtons.user2) setLaunchpadMode('user2');
    }
}

// MICROPHONE PERMISSION & VOICE TO MIDI
async function requestMicPermission() {
    try {
        const stream = await navigator.mediaDevices.getUserMedia({ audio: { echoCancellation: false, noiseSuppression: false, autoGainControl: false } });
        state.micPermissionGranted = true;
        state.voiceToMidi.mediaStream = stream;
        document.getElementById('micLed').classList.add('active');
        document.getElementById('voiceStatus').textContent = '‚úÖ Micro autoris√© - Cliquez Start';
        showMessage('Microphone autoris√©!');
    } catch (error) {
        state.micPermissionGranted = false;
        if (error.name === 'NotAllowedError') showMessage('Permission refus√©e');
        else if (error.name === 'NotFoundError') showMessage('Aucun micro d√©tect√©');
        else showMessage('Erreur: ' + error.message);
        document.getElementById('voiceStatus').textContent = '‚ùå ' + error.message;
    }
}

async function startVoiceToMidi() {
    if (!state.micPermissionGranted) {
        await requestMicPermission();
        if (!state.micPermissionGranted) return;
    }
    try {
        if (!state.voiceToMidi.mediaStream || state.voiceToMidi.mediaStream.getTracks().every(t => t.readyState === 'ended')) {
            state.voiceToMidi.mediaStream = await navigator.mediaDevices.getUserMedia({ audio: { echoCancellation: false, noiseSuppression: false, autoGainControl: false } });
        }
        state.voiceToMidi.audioContext = new (window.AudioContext || window.webkitAudioContext)();
        state.voiceToMidi.analyser = state.voiceToMidi.audioContext.createAnalyser();
        state.voiceToMidi.analyser.fftSize = 2048;
        const source = state.voiceToMidi.audioContext.createMediaStreamSource(state.voiceToMidi.mediaStream);
        source.connect(state.voiceToMidi.analyser);
        state.voiceToMidi.isActive = true;
        document.getElementById('voiceStartBtn').classList.add('active');
        document.getElementById('voiceStartBtn').disabled = true;
        document.getElementById('voiceStopBtn').disabled = false;
        document.getElementById('voiceStatus').textContent = 'üü¢ Actif - Chantez!';
        document.getElementById('voiceStatus').classList.add('active');
        document.getElementById('voicePitchDisplay').style.display = 'block';
        processVoiceAudio();
        showMessage('Voice to MIDI d√©marr√©!');
    } catch (error) { showMessage('Erreur: ' + error.message); }
}

function stopVoiceToMidi() {
    state.voiceToMidi.isActive = false;
    if (state.voiceToMidi.audioContext) state.voiceToMidi.audioContext.close();
    if (state.voiceToMidi.currentNote && state.midiOutCTK) state.midiOutCTK.send([0x80 + state.voiceToMidi.channel - 1, state.voiceToMidi.currentNote, 0]);
    state.voiceToMidi.currentNote = null;
    state.voiceToMidi.audioContext = null;
    state.voiceToMidi.analyser = null;
    document.getElementById('voiceStartBtn').classList.remove('active');
    document.getElementById('voiceStartBtn').disabled = false;
    document.getElementById('voiceStopBtn').disabled = true;
    document.getElementById('voiceStatus').textContent = '‚ö´ Arr√™t√©';
    document.getElementById('voiceStatus').classList.remove('active');
    document.getElementById('voicePitchDisplay').style.display = 'none';
    document.getElementById('vuMeterBar').style.width = '0%';
    document.getElementById('vuMeterValue').textContent = '0%';
    showMessage('Voice to MIDI arr√™t√©');
}

function processVoiceAudio() {
    if (!state.voiceToMidi.isActive || !state.voiceToMidi.analyser) return;
    const analyser = state.voiceToMidi.analyser;
    const bufferLength = analyser.fftSize;
    const buffer = new Float32Array(bufferLength);
    analyser.getFloatTimeDomainData(buffer);
    
    // VU Meter
    let rms = 0;
    for (let i = 0; i < bufferLength; i++) rms += buffer[i] * buffer[i];
    rms = Math.sqrt(rms / bufferLength);
    const vuLevel = Math.min(100, Math.round(rms * 500));
    document.getElementById('vuMeterBar').style.width = vuLevel + '%';
    document.getElementById('vuMeterValue').textContent = vuLevel + '%';
    
    // Pitch detection
    const threshold = state.voiceToMidi.sensitivity / 100;
    if (rms > threshold * 0.1) {
        const frequency = detectPitch(buffer, state.voiceToMidi.audioContext.sampleRate);
        if (frequency > 50 && frequency < 2000) {
            let midiNote = Math.round(12 * Math.log2(frequency / 440) + 69);
            midiNote += state.voiceToMidi.transpose;
            midiNote = quantizeToScale(midiNote, state.voiceToMidi.scale);
            const noteNames = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'];
            document.getElementById('voicePitchNote').textContent = noteNames[midiNote % 12] + (Math.floor(midiNote / 12) - 1);
            document.getElementById('voicePitchFreq').textContent = Math.round(frequency) + ' Hz';
            playVoiceMidiNote(midiNote);
        }
    } else {
        if (state.voiceToMidi.currentNote && state.midiOutCTK) {
            state.midiOutCTK.send([0x80 + state.voiceToMidi.channel - 1, state.voiceToMidi.currentNote, 0]);
            state.voiceToMidi.currentNote = null;
        }
    }
    requestAnimationFrame(processVoiceAudio);
}

function detectPitch(buffer, sampleRate) {
    const SIZE = buffer.length, MAX_SAMPLES = Math.floor(SIZE / 2);
    let bestOffset = -1, bestCorrelation = 0, foundGoodCorrelation = false;
    const correlations = new Array(MAX_SAMPLES);
    for (let offset = 0; offset < MAX_SAMPLES; offset++) {
        let correlation = 0;
        for (let i = 0; i < MAX_SAMPLES; i++) correlation += Math.abs(buffer[i] - buffer[i + offset]);
        correlation = 1 - (correlation / MAX_SAMPLES);
        correlations[offset] = correlation;
        if (correlation > 0.9 && correlation > bestCorrelation) { bestCorrelation = correlation; bestOffset = offset; foundGoodCorrelation = true; }
        else if (foundGoodCorrelation) { const shift = (correlations[bestOffset + 1] - correlations[bestOffset - 1]) / correlations[bestOffset]; return sampleRate / (bestOffset + (8 * shift)); }
    }
    return bestCorrelation > 0.01 ? sampleRate / bestOffset : -1;
}

function quantizeToScale(note, scaleName) {
    if (scaleName === 'chromatic') return note;
    const scale = voiceScales[scaleName];
    if (!scale) return note;
    const noteInOctave = note % 12, octave = Math.floor(note / 12);
    let closestNote = scale[0], minDistance = 12;
    for (const scaleNote of scale) {
        const distance = Math.min(Math.abs(noteInOctave - scaleNote), 12 - Math.abs(noteInOctave - scaleNote));
        if (distance < minDistance) { minDistance = distance; closestNote = scaleNote; }
    }
    return octave * 12 + closestNote;
}

function playVoiceMidiNote(note) {
    if (!state.midiOutCTK) return;
    const channel = state.voiceToMidi.channel - 1;
    const now = Date.now();
    if (now - state.voiceToMidi.lastNoteTime < 50) return;
    state.voiceToMidi.lastNoteTime = now;
    
    const toneSelect = document.getElementById('voiceToneSelect');
    if (toneSelect && toneSelect.selectedIndex >= 0) {
        const opt = toneSelect.options[toneSelect.selectedIndex];
        state.midiOutCTK.send([0xB0 + channel, 0, parseInt(opt.dataset.msb) || 0]);
        state.midiOutCTK.send([0xC0 + channel, parseInt(opt.dataset.pc) || 0]);
    }
    state.midiOutCTK.send([0xB0 + channel, 91, state.voiceToMidi.reverb]);
    
    if (state.voiceToMidi.currentNote && state.voiceToMidi.currentNote !== note) {
        state.midiOutCTK.send([0x80 + channel, state.voiceToMidi.currentNote, 0]);
        state.voiceToMidi.currentChordNotes.forEach(n => state.midiOutCTK.send([0x80 + channel, n, 0]));
        state.voiceToMidi.currentChordNotes = [];
    }
    
    const velocity = state.voiceToMidi.velocity || 100;
    switch(state.voiceToMidi.playMode) {
        case 'single': state.midiOutCTK.send([0x90 + channel, note, velocity]); break;
        case 'major': [note, note + 4, note + 7].forEach(n => { state.midiOutCTK.send([0x90 + channel, n, velocity]); state.voiceToMidi.currentChordNotes.push(n); }); break;
        case 'minor': [note, note + 3, note + 7].forEach(n => { state.midiOutCTK.send([0x90 + channel, n, velocity]); state.voiceToMidi.currentChordNotes.push(n); }); break;
        case 'arp3': case 'arp4': playArpeggio(state.voiceToMidi.playMode === 'arp3' ? [note, note + 4, note + 7] : [note, note + 4, note + 7, note + 12], channel, velocity); break;
    }
    state.voiceToMidi.currentNote = note;
}

function playArpeggio(notes, channel, velocity) {
    if (state.voiceToMidi.arpeggiatorInterval) clearInterval(state.voiceToMidi.arpeggiatorInterval);
    state.voiceToMidi.arpeggiatorIndex = 0;
    const playArpNote = () => {
        if (!state.voiceToMidi.isActive) { clearInterval(state.voiceToMidi.arpeggiatorInterval); return; }
        const prevNote = notes[(state.voiceToMidi.arpeggiatorIndex - 1 + notes.length) % notes.length];
        state.midiOutCTK.send([0x80 + channel, prevNote, 0]);
        state.midiOutCTK.send([0x90 + channel, notes[state.voiceToMidi.arpeggiatorIndex], velocity]);
        state.voiceToMidi.arpeggiatorIndex = (state.voiceToMidi.arpeggiatorIndex + 1) % notes.length;
    };
    playArpNote();
    state.voiceToMidi.arpeggiatorInterval = setInterval(playArpNote, 60000 / state.tempo / 4);
}

// UTILITIES
function toggleFullscreen() {
    if (!document.fullscreenElement) document.documentElement.requestFullscreen().catch(() => {});
    else document.exitFullscreen();
}

function showMessage(text) {
    const existingToast = document.querySelector('.toast');
    if (existingToast) existingToast.remove();
    const toast = document.createElement('div');
    toast.className = 'toast';
    toast.textContent = text;
    document.body.appendChild(toast);
    setTimeout(() => toast.remove(), 2500);
}
</script>
</body>
</html>
