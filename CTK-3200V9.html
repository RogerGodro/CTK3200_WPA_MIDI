<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="description" content="CTK-3200 V9 FIXED - Full Launchpad MK2 Integration">
    <meta name="theme-color" content="#0a0a0f">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="CTK V9">
    <meta name="format-detection" content="telephone=no">
    <title>CTK-3200 V9 FIXED - LAUNCHPAD MK2</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            user-select: none;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
        }

        :root {
            --primary: #00ff88;
            --secondary: #ff00aa;
            --accent: #00aaff;
            --warning: #ff8800;
            --danger: #ff3333;
            --success: #00ff00;
            
            --bg-dark: #0a0a0f;
            --bg-medium: #14141a;
            --bg-light: #1f1f28;
            --bg-lighter: #2a2a35;
            
            --text-primary: #ffffff;
            --text-secondary: #aaaaaa;
            --text-dim: #666666;
            
            --lp-off: #1e1e1e;
            --lp-red: #ff3333;
            --lp-orange: #ff8800;
            --lp-amber: #ffbb00;
            --lp-yellow: #ffff00;
            --lp-lime: #88ff00;
            --lp-green: #00ff00;
            --lp-turquoise: #00ff88;
            --lp-cyan: #00ffff;
            --lp-sky: #00aaff;
            --lp-blue: #0088ff;
            --lp-orchid: #5500ff;
            --lp-purple: #aa00ff;
            --lp-pink: #ff00aa;
            --lp-magenta: #ff0088;
            --lp-white: #ffffff;
        }

        body {
            background: var(--bg-dark);
            color: var(--text-primary);
            overflow: hidden;
            height: 100vh;
            width: 100vw;
            position: fixed;
            touch-action: none;
        }

        .app-container {
            height: 100vh;
            display: grid;
            grid-template-rows: 55px 1fr;
            background: radial-gradient(ellipse at center, #14141a 0%, #0a0a0f 100%);
        }

        /* Header - Compact */
        .header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 15px;
            background: linear-gradient(180deg, rgba(31,31,40,0.95) 0%, rgba(20,20,26,0.95) 100%);
            border-bottom: 1px solid var(--primary);
            gap: 10px;
        }

        .logo {
            font-size: 18px;
            font-weight: 900;
            background: linear-gradient(135deg, var(--primary) 0%, var(--accent) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            letter-spacing: -1px;
        }

        .status-group {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .status-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 3px 10px;
            background: var(--bg-light);
            border-radius: 8px;
            border: 1px solid var(--bg-lighter);
        }

        .status-label {
            font-size: 8px;
            color: var(--text-dim);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .status-value {
            font-size: 12px;
            font-weight: 700;
            color: var(--primary);
        }

        .tempo-controls {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 4px 10px;
            background: var(--bg-light);
            border-radius: 20px;
            border: 1px solid var(--accent);
        }

        .tempo-display {
            font-size: 16px;
            font-weight: 800;
            color: var(--accent);
            min-width: 40px;
            text-align: center;
        }

        .tempo-btn {
            width: 20px;
            height: 20px;
            background: var(--bg-lighter);
            border: 1px solid var(--accent);
            border-radius: 4px;
            color: var(--accent);
            cursor: pointer;
            font-size: 10px;
        }

        .tap-btn {
            padding: 6px 12px;
            background: var(--bg-lighter);
            border: 2px solid var(--warning);
            border-radius: 20px;
            color: var(--warning);
            font-weight: 700;
            font-size: 10px;
            cursor: pointer;
        }

        .midi-status {
            display: flex;
            gap: 8px;
        }

        .midi-device {
            padding: 4px 8px;
            background: var(--bg-light);
            border-radius: 15px;
            font-size: 9px;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .midi-led {
            width: 6px;
            height: 6px;
            background: #444;
            border-radius: 50%;
        }

        .midi-led.active {
            background: var(--success);
            box-shadow: 0 0 6px var(--success);
        }

        .connect-btn {
            padding: 6px 12px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--accent) 100%);
            border: none;
            border-radius: 20px;
            color: var(--bg-dark);
            font-weight: 700;
            font-size: 10px;
            cursor: pointer;
        }

        .fullscreen-btn {
            width: 32px;
            height: 32px;
            background: var(--bg-light);
            border: 2px solid var(--accent);
            border-radius: 50%;
            color: var(--accent);
            font-size: 14px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Main Content - Optimized Layout */
        .main-content {
            display: grid;
            grid-template-columns: 220px 1fr 300px;
            gap: 10px;
            padding: 10px;
            height: calc(100vh - 55px);
            overflow: hidden;
        }

        /* Left Panel */
        .left-panel {
            display: flex;
            flex-direction: column;
            gap: 8px;
            overflow-y: auto;
            overflow-x: hidden;
        }

        .panel-section {
            background: var(--bg-medium);
            border-radius: 10px;
            padding: 10px;
            border: 1px solid var(--bg-lighter);
            flex-shrink: 0;
        }

        .section-title {
            font-size: 9px;
            text-transform: uppercase;
            letter-spacing: 1.5px;
            color: var(--text-dim);
            margin-bottom: 8px;
            padding-left: 6px;
            border-left: 2px solid var(--primary);
        }

        .style-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 4px;
        }

        .style-btn {
            padding: 6px;
            background: var(--bg-light);
            border: 2px solid var(--bg-lighter);
            border-radius: 6px;
            color: var(--text-secondary);
            font-size: 10px;
            font-weight: 600;
            cursor: pointer;
        }

        .style-btn.active {
            background: var(--primary);
            color: var(--bg-dark);
            border-color: var(--primary);
        }

        .section-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 4px;
        }

        .section-btn {
            padding: 8px 4px;
            background: var(--bg-light);
            border: 2px solid var(--bg-lighter);
            border-radius: 6px;
            color: var(--text-secondary);
            font-size: 8px;
            font-weight: 700;
            cursor: pointer;
            text-transform: uppercase;
        }

        .section-btn.active {
            background: var(--accent);
            color: var(--bg-dark);
            border-color: var(--accent);
        }

        .variation-row {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 4px;
        }

        .var-btn {
            aspect-ratio: 1;
            background: var(--bg-light);
            border: 2px solid var(--bg-lighter);
            border-radius: 6px;
            font-size: 12px;
            font-weight: 700;
            color: var(--text-secondary);
            cursor: pointer;
        }

        .var-btn.active {
            background: var(--secondary);
            color: var(--bg-dark);
            border-color: var(--secondary);
        }

        /* Voice to MIDI - Compact */
        .voice-section {
            background: var(--bg-medium);
            border-radius: 10px;
            padding: 10px;
            border: 1px solid var(--accent);
        }

        .voice-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 6px;
            margin-bottom: 8px;
        }

        .voice-btn {
            background: var(--bg-light);
            border: 2px solid var(--bg-lighter);
            color: var(--text-primary);
            padding: 6px 8px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 10px;
            font-weight: 600;
        }

        .voice-btn:hover:not(:disabled) {
            background: linear-gradient(135deg, var(--primary) 0%, var(--accent) 100%);
            border-color: var(--primary);
            color: var(--bg-dark);
        }

        .voice-btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }

        .voice-btn.active {
            background: linear-gradient(135deg, var(--primary) 0%, var(--accent) 100%);
            border-color: var(--primary);
            color: var(--bg-dark);
        }

        .voice-status {
            text-align: center;
            padding: 4px;
            background: var(--bg-light);
            border-radius: 6px;
            font-size: 10px;
            color: var(--text-secondary);
            margin-bottom: 8px;
        }

        .voice-status.active {
            background: rgba(0, 255, 136, 0.15);
            color: var(--primary);
            animation: voicePulse 2s infinite;
        }

        @keyframes voicePulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }

        /* VU Meter for Microphone */
        .vu-meter-container {
            margin: 8px 0;
            padding: 6px;
            background: var(--bg-dark);
            border-radius: 6px;
        }

        .vu-meter-label {
            font-size: 8px;
            color: var(--text-dim);
            text-transform: uppercase;
            margin-bottom: 4px;
        }

        .vu-meter {
            height: 12px;
            background: var(--bg-lighter);
            border-radius: 6px;
            overflow: hidden;
            position: relative;
        }

        .vu-meter-bar {
            height: 100%;
            width: 0%;
            background: linear-gradient(90deg, var(--primary) 0%, var(--warning) 70%, var(--danger) 100%);
            border-radius: 6px;
            transition: width 0.05s ease-out;
        }

        .vu-meter-value {
            position: absolute;
            right: 4px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 8px;
            color: var(--text-primary);
            font-weight: 700;
        }

        .voice-control-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 6px;
            margin-bottom: 6px;
        }

        .voice-select {
            width: 100%;
            padding: 4px 6px;
            background: var(--bg-light);
            border: 1px solid var(--bg-lighter);
            border-radius: 6px;
            color: var(--text-primary);
            font-size: 10px;
            cursor: pointer;
        }

        .voice-slider-row {
            display: flex;
            align-items: center;
            gap: 6px;
            margin-bottom: 4px;
        }

        .voice-slider-row label {
            font-size: 9px;
            color: var(--text-dim);
            min-width: 50px;
        }

        .voice-slider-row input {
            flex: 1;
            height: 4px;
        }

        .voice-slider-row span {
            font-size: 9px;
            color: var(--primary);
            min-width: 25px;
            text-align: right;
        }

        /* Center Panel */
        .center-panel {
            display: flex;
            flex-direction: column;
            gap: 8px;
            overflow: hidden;
        }

        /* Chord Display - Compact */
        .chord-display {
            height: 70px;
            min-height: 70px;
            background: linear-gradient(135deg, var(--bg-medium) 0%, var(--bg-light) 50%);
            border-radius: 12px;
            border: 2px solid var(--bg-lighter);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 8px 15px;
            position: relative;
            overflow: hidden;
        }

        .chord-text {
            font-size: 32px;
            font-weight: 900;
            background: linear-gradient(135deg, var(--primary) 0%, var(--accent) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .chord-controls {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .instrument-select {
            background: var(--bg-dark);
            color: var(--primary);
            border: 1px solid var(--primary);
            border-radius: 6px;
            padding: 4px 8px;
            font-size: 10px;
            cursor: pointer;
            max-width: 120px;
        }

        .chord-velocity-control {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .chord-velocity-control label {
            color: var(--accent);
            font-size: 9px;
        }

        .chord-velocity-control input {
            width: 50px;
            height: 4px;
        }

        .chord-velocity-control span {
            color: var(--primary);
            font-size: 9px;
            min-width: 20px;
        }

        /* Chord Grid - FIXED: Smaller pads with note labels */
        .chord-grid-container {
            flex: 1;
            background: var(--bg-medium);
            border-radius: 12px;
            border: 1px solid var(--bg-lighter);
            padding: 8px;
            min-height: 0;
        }

        .chord-grid-header {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 6px;
            margin-bottom: 6px;
        }

        .chord-header-cell {
            text-align: center;
            font-size: 12px;
            font-weight: 800;
            color: var(--accent);
            padding: 4px;
            background: var(--bg-light);
            border-radius: 4px;
        }

        .chord-grid {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            grid-template-rows: repeat(4, 1fr);
            gap: 6px;
            height: calc(100% - 30px);
        }

        .chord-pad {
            background: linear-gradient(145deg, var(--bg-light) 0%, var(--bg-lighter) 100%);
            border: 2px solid var(--bg-lighter);
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.1s;
            min-height: 40px;
        }

        .chord-pad:hover {
            transform: translateY(-1px);
            border-color: var(--primary);
            box-shadow: 0 2px 8px rgba(0, 255, 136, 0.2);
        }

        .chord-pad:active,
        .chord-pad.active {
            background: linear-gradient(135deg, var(--primary) 0%, var(--accent) 100%);
            border-color: var(--primary);
            transform: scale(0.95);
        }

        .chord-name {
            font-size: 14px;
            font-weight: 700;
            color: var(--text-primary);
        }

        .chord-type {
            font-size: 8px;
            color: var(--text-dim);
            text-transform: uppercase;
        }

        .chord-pad.active .chord-name,
        .chord-pad.active .chord-type {
            color: var(--bg-dark);
        }

        /* Harmony coloring */
        .chord-pad.harmony-perfect {
            background: linear-gradient(145deg, rgba(0, 255, 0, 0.2) 0%, rgba(0, 255, 0, 0.1) 100%) !important;
            border-color: rgba(0, 255, 0, 0.8) !important;
            box-shadow: 0 0 8px rgba(0, 255, 0, 0.3);
        }

        .chord-pad.harmony-good {
            background: linear-gradient(145deg, rgba(255, 255, 0, 0.2) 0%, rgba(255, 255, 0, 0.1) 100%) !important;
            border-color: rgba(255, 255, 0, 0.8) !important;
            box-shadow: 0 0 8px rgba(255, 255, 0, 0.3);
        }

        .chord-pad.harmony-clash {
            background: linear-gradient(145deg, rgba(255, 0, 0, 0.2) 0%, rgba(255, 0, 0, 0.1) 100%) !important;
            border-color: rgba(255, 0, 0, 0.8) !important;
            box-shadow: 0 0 8px rgba(255, 0, 0, 0.3);
        }

        /* Pattern Sequencer - Compact */
        .pattern-container {
            background: var(--bg-medium);
            border-radius: 12px;
            border: 1px solid var(--bg-lighter);
            padding: 8px;
            height: 100px;
            min-height: 100px;
        }

        .pattern-grid {
            display: grid;
            grid-template-rows: repeat(4, 1fr);
            gap: 3px;
            height: calc(100% - 20px);
        }

        .pattern-row {
            display: grid;
            grid-template-columns: repeat(16, 1fr);
            gap: 2px;
        }

        .pattern-cell {
            background: var(--bg-light);
            border: 1px solid var(--bg-lighter);
            border-radius: 2px;
            cursor: pointer;
        }

        .pattern-cell:nth-child(4n+1) {
            border-left: 2px solid var(--accent);
        }

        .pattern-cell.active {
            background: var(--primary);
            border-color: var(--primary);
        }

        .pattern-cell.playing {
            background: var(--accent) !important;
            border-color: var(--accent) !important;
        }

        /* Right Panel */
        .right-panel {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        /* Transport - Compact */
        .transport-container {
            background: var(--bg-medium);
            border-radius: 12px;
            padding: 10px;
            display: flex;
            justify-content: center;
            gap: 12px;
        }

        .transport-btn {
            width: 50px;
            height: 50px;
            background: var(--bg-light);
            border: 2px solid var(--bg-lighter);
            border-radius: 50%;
            font-size: 20px;
            cursor: pointer;
            color: var(--text-secondary);
        }

        #playBtn {
            background: linear-gradient(135deg, var(--primary) 0%, var(--accent) 100%);
            color: var(--bg-dark);
            border-color: var(--primary);
        }

        #playBtn.playing {
            background: linear-gradient(135deg, var(--warning) 0%, var(--danger) 100%);
            animation: playingPulse 1s infinite;
        }

        @keyframes playingPulse {
            0%, 100% { box-shadow: 0 0 10px rgba(255, 136, 0, 0.4); }
            50% { box-shadow: 0 0 20px rgba(255, 136, 0, 0.6); }
        }

        #stopBtn:hover {
            background: var(--danger);
            border-color: var(--danger);
            color: white;
        }

        #recBtn.recording {
            background: var(--danger);
            border-color: var(--danger);
            color: white;
            animation: recPulse 1s infinite;
        }

        @keyframes recPulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }

        /* Launchpad View - Compact */
        .launchpad-container {
            background: var(--bg-medium);
            border-radius: 12px;
            padding: 10px;
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .lp-top-buttons {
            display: grid;
            grid-template-columns: repeat(8, 1fr);
            gap: 3px;
            margin-bottom: 8px;
        }

        .lp-top-btn {
            padding: 4px;
            background: var(--bg-light);
            border: 2px solid var(--bg-lighter);
            border-radius: 4px;
            font-size: 7px;
            font-weight: 700;
            color: var(--text-dim);
            cursor: pointer;
            text-align: center;
        }

        .lp-top-btn.active {
            background: var(--primary);
            border-color: var(--primary);
            color: var(--bg-dark);
        }

        .lp-main-area {
            display: flex;
            gap: 6px;
            flex: 1;
        }

        .lp-grid {
            display: grid;
            grid-template-columns: repeat(8, 1fr);
            grid-template-rows: repeat(8, 1fr);
            gap: 2px;
            flex: 1;
        }

        .lp-pad {
            background: var(--bg-light);
            border: 1px solid var(--bg-lighter);
            border-radius: 3px;
            cursor: pointer;
        }

        .lp-pad[data-color="red"] { background: var(--lp-red) !important; }
        .lp-pad[data-color="orange"] { background: var(--lp-orange) !important; }
        .lp-pad[data-color="amber"] { background: var(--lp-amber) !important; }
        .lp-pad[data-color="yellow"] { background: var(--lp-yellow) !important; }
        .lp-pad[data-color="lime"] { background: var(--lp-lime) !important; }
        .lp-pad[data-color="green"] { background: var(--lp-green) !important; }
        .lp-pad[data-color="turquoise"] { background: var(--lp-turquoise) !important; }
        .lp-pad[data-color="cyan"] { background: var(--lp-cyan) !important; }
        .lp-pad[data-color="sky"] { background: var(--lp-sky) !important; }
        .lp-pad[data-color="blue"] { background: var(--lp-blue) !important; }
        .lp-pad[data-color="purple"] { background: var(--lp-purple) !important; }
        .lp-pad[data-color="pink"] { background: var(--lp-pink) !important; }
        .lp-pad[data-color="white"] { background: var(--lp-white) !important; }

        .lp-right-buttons {
            display: flex;
            flex-direction: column;
            gap: 2px;
            width: 28px;
        }

        .lp-right-btn {
            flex: 1;
            background: var(--bg-light);
            border: 2px solid var(--bg-lighter);
            border-radius: 50%;
            font-size: 7px;
            font-weight: 700;
            color: var(--text-dim);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .lp-right-btn.active {
            background: var(--primary);
            border-color: var(--primary);
            color: var(--bg-dark);
        }

        .lp-right-btn[data-function="play"] {
            background: var(--success) !important;
            border-color: var(--success) !important;
            color: white !important;
        }

        .lp-right-btn[data-function="stop"] {
            background: var(--danger) !important;
            border-color: var(--danger) !important;
            color: white !important;
        }

        /* Controls - Compact */
        .controls-container {
            background: var(--bg-medium);
            border-radius: 12px;
            padding: 10px;
        }

        .controls-row {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
        }

        .control-item {
            text-align: center;
        }

        .control-knob {
            width: 40px;
            height: 40px;
            background: radial-gradient(circle at 30% 30%, var(--bg-lighter) 0%, var(--bg-light) 100%);
            border: 2px solid var(--bg-lighter);
            border-radius: 50%;
            margin: 0 auto 4px;
            position: relative;
            cursor: ew-resize;
        }

        .control-knob:hover {
            border-color: var(--primary);
        }

        .control-indicator {
            position: absolute;
            top: 4px;
            left: 50%;
            transform: translateX(-50%);
            width: 2px;
            height: 14px;
            background: var(--primary);
            border-radius: 2px;
        }

        .control-label {
            font-size: 8px;
            color: var(--text-dim);
            text-transform: uppercase;
        }

        .control-value {
            font-size: 12px;
            font-weight: 700;
            color: var(--primary);
        }

        /* Loading */
        .loading {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--bg-dark);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
        }

        .loading.hidden {
            opacity: 0;
            pointer-events: none;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid var(--bg-lighter);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Toast */
        .toast {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(135deg, var(--primary) 0%, var(--accent) 100%);
            color: var(--bg-dark);
            padding: 10px 20px;
            border-radius: 20px;
            font-weight: 700;
            font-size: 12px;
            z-index: 5000;
            animation: slideUp 0.3s ease;
        }

        @keyframes slideUp {
            from { transform: translate(-50%, 100px); opacity: 0; }
            to { transform: translate(-50%, 0); opacity: 1; }
        }

        /* Pitch Display */
        .voice-pitch-display {
            background: var(--bg-dark);
            border-radius: 8px;
            padding: 8px;
            text-align: center;
            margin-top: 8px;
        }

        .voice-pitch-note {
            font-size: 24px;
            font-weight: 900;
            color: var(--primary);
        }

        .voice-pitch-info {
            display: flex;
            justify-content: center;
            gap: 10px;
            font-size: 10px;
            color: var(--text-dim);
        }
    </style>
</head>
<body>
    <!-- Loading -->
    <div class="loading" id="loading">
        <div class="spinner"></div>
    </div>

    <div class="app-container">
        <!-- Header -->
        <header class="header">
            <div class="logo">CTK-3200 V9</div>
            
            <div class="status-group">
                <div class="status-item">
                    <span class="status-label">Style</span>
                    <span class="status-value" id="styleDisplay">8BEAT</span>
                </div>
                <div class="status-item">
                    <span class="status-label">Section</span>
                    <span class="status-value" id="sectionDisplay">MAIN</span>
                </div>
                <div class="status-item">
                    <span class="status-label">Var</span>
                    <span class="status-value" id="varDisplay">A</span>
                </div>
                <div class="status-item" id="bassStatus" style="display: none;">
                    <span class="status-label">Bass</span>
                    <span class="status-value" id="bassDisplay">ACOUSTIC</span>
                </div>
            </div>
            
            <div class="tempo-controls">
                <button class="tempo-btn" onclick="changeTempo(-1)">‚àí</button>
                <div class="tempo-display" id="tempoDisplay">120</div>
                <button class="tempo-btn" onclick="changeTempo(1)">+</button>
            </div>
            
            <button class="tap-btn" onclick="tapTempo()">TAP</button>
            
            <div class="midi-status">
                <div class="midi-device">
                    <span class="midi-led" id="ctkLed"></span>
                    <span>CTK</span>
                </div>
                <div class="midi-device">
                    <span class="midi-led" id="lpLed"></span>
                    <span>LP</span>
                </div>
            </div>
            
            <button class="connect-btn" onclick="connectMIDI()">CONNECT</button>
            <button class="fullscreen-btn" onclick="toggleFullscreen()" title="Fullscreen">‚§¢</button>
        </header>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Left Panel -->
            <aside class="left-panel">
                <!-- Style Selection -->
                <div class="panel-section">
                    <div class="section-title">RHYTHM STYLES</div>
                    <div class="style-grid" id="styleGrid"></div>
                </div>
                
                <!-- Sections -->
                <div class="panel-section">
                    <div class="section-title">SECTIONS</div>
                    <div class="section-grid" id="sectionGrid"></div>
                </div>
                
                <!-- Variations -->
                <div class="panel-section">
                    <div class="section-title">VARIATIONS</div>
                    <div class="variation-row" id="variationRow"></div>
                </div>
                
                <!-- Voice to MIDI Section - FIXED -->
                <div class="panel-section voice-section">
                    <div class="section-title">üéôÔ∏è VOICE TO MIDI</div>
                    
                    <div class="voice-buttons">
                        <button class="voice-btn" id="voiceStartBtn">üéôÔ∏è Start</button>
                        <button class="voice-btn" id="voiceStopBtn" disabled>‚èπÔ∏è Stop</button>
                    </div>
                    
                    <div id="voiceStatus" class="voice-status">‚ö´ Inactif</div>
                    
                    <!-- VU Meter -->
                    <div class="vu-meter-container">
                        <div class="vu-meter-label">Volume Micro</div>
                        <div class="vu-meter">
                            <div class="vu-meter-bar" id="vuMeterBar"></div>
                            <span class="vu-meter-value" id="vuMeterValue">0%</span>
                        </div>
                    </div>
                    
                    <div class="voice-control-row">
                        <select id="voiceToneSelect" class="voice-select">
                            <option value="0">Chargement...</option>
                        </select>
                        <select id="voicePlayMode" class="voice-select">
                            <option value="single">Note seule</option>
                            <option value="major">Accord majeur</option>
                            <option value="minor">Accord mineur</option>
                            <option value="arp3">Arp√®ge 3</option>
                            <option value="arp4">Arp√®ge 4</option>
                        </select>
                    </div>
                    
                    <select id="voiceScale" class="voice-select" style="width: 100%; margin-bottom: 6px;">
                        <option value="chromatic">Chromatique</option>
                        <option value="C-major">Do majeur</option>
                        <option value="G-major">Sol majeur</option>
                        <option value="A-minor">La mineur</option>
                        <option value="E-minor">Mi mineur</option>
                    </select>
                    
                    <div class="voice-slider-row">
                        <label>Sensibilit√©</label>
                        <input type="range" id="voiceSensitivity" min="1" max="100" value="30">
                        <span id="voiceSensitivityValue">30</span>
                    </div>
                    
                    <div class="voice-slider-row">
                        <label>Reverb</label>
                        <input type="range" id="voiceReverb" min="0" max="127" value="40">
                        <span id="voiceReverbValue">40</span>
                    </div>
                    
                    <div class="voice-slider-row">
                        <label>Transpose</label>
                        <input type="range" id="voiceTranspose" min="-24" max="24" value="0">
                        <span id="voiceTransposeValue">0</span>
                    </div>
                    
                    <div class="voice-pitch-display" id="voicePitchDisplay" style="display: none;">
                        <div class="voice-pitch-note" id="voicePitchNote">--</div>
                        <div class="voice-pitch-info">
                            <span id="voicePitchFreq">-- Hz</span>
                        </div>
                    </div>
                </div>
            </aside>

            <!-- Center Panel -->
            <div class="center-panel">
                <!-- Current Chord Display -->
                <div class="chord-display">
                    <div class="chord-text" id="currentChord">C</div>
                    <div class="chord-controls">
                        <select id="chordInstrument" class="instrument-select">
                            <!-- Will be populated -->
                        </select>
                        <div class="chord-velocity-control">
                            <label>Vol</label>
                            <input type="range" id="chordVelocity" min="1" max="127" value="80">
                            <span id="chordVelValue">80</span>
                        </div>
                    </div>
                </div>
                
                <!-- Chord Grid with Note Headers -->
                <div class="chord-grid-container">
                    <div class="chord-grid-header" id="chordGridHeader">
                        <div class="chord-header-cell">C</div>
                        <div class="chord-header-cell">D</div>
                        <div class="chord-header-cell">E</div>
                        <div class="chord-header-cell">F</div>
                        <div class="chord-header-cell">G</div>
                        <div class="chord-header-cell">A</div>
                    </div>
                    <div class="chord-grid" id="chordGrid"></div>
                </div>
                
                <!-- Pattern Sequencer -->
                <div class="pattern-container">
                    <div class="section-title">PATTERN SEQUENCER</div>
                    <div class="pattern-grid" id="patternGrid"></div>
                </div>
            </div>

            <!-- Right Panel -->
            <aside class="right-panel">
                <!-- Transport -->
                <div class="transport-container">
                    <button class="transport-btn" id="stopBtn" onclick="stopPlayback()">‚óº</button>
                    <button class="transport-btn" id="playBtn" onclick="togglePlay()">‚ñ∂</button>
                    <button class="transport-btn" id="recBtn" onclick="toggleRecord()">‚óè</button>
                </div>
                
                <!-- Launchpad View -->
                <div class="launchpad-container">
                    <div class="section-title">LAUNCHPAD MK2</div>
                    <div class="lp-top-buttons" id="lpTopButtons"></div>
                    <div class="lp-main-area">
                        <div class="lp-grid" id="lpGrid"></div>
                        <div class="lp-right-buttons" id="lpRightButtons"></div>
                    </div>
                </div>
                
                <!-- Controls -->
                <div class="controls-container">
                    <div class="controls-row">
                        <div class="control-item">
                            <div class="control-knob" id="swingKnob" data-value="50" data-min="0" data-max="100">
                                <div class="control-indicator"></div>
                            </div>
                            <div class="control-label">Swing</div>
                            <div class="control-value" id="swingValue">50%</div>
                        </div>
                        <div class="control-item">
                            <div class="control-knob" id="velocityKnob" data-value="100" data-min="1" data-max="127">
                                <div class="control-indicator"></div>
                            </div>
                            <div class="control-label">Velocity</div>
                            <div class="control-value" id="velocityValue">100</div>
                        </div>
                        <div class="control-item">
                            <div class="control-knob" id="humanizeKnob" data-value="0" data-min="0" data-max="100">
                                <div class="control-indicator"></div>
                            </div>
                            <div class="control-label">Humanize</div>
                            <div class="control-value" id="humanizeValue">0%</div>
                        </div>
                    </div>
                </div>
            </aside>
        </main>
    </div>

    <script>
        // ==========================================
        // APPLICATION STATE
        // ==========================================
        const state = {
            midiOutCTK: null,
            midiInCTK: null,
            midiOutLP: null,
            midiInLP: null,
            
            isPlaying: false,
            isRecording: false,
            currentBeat: 0,
            tempo: 120,
            swing: 50,
            velocity: 100,
            humanize: 0,
            
            currentStyle: '8BEAT',
            currentSection: 'main',
            currentVariation: 'A',
            
            currentChord: 'C',
            chordInstrument: 0,
            chordVelocity: 80,
            chordProgression: [],
            
            launchpadMode: 'session',
            bassUpActive: true,
            currentBassProgram: 83,
            
            drumPattern: [],
            bassPattern: [],
            
            tapTimes: [],
            isDragging: false,
            dragMode: false,
            lastTouchedCell: null,
            
            voiceToMidi: {
                isActive: false,
                audioContext: null,
                analyser: null,
                mediaStream: null,
                processor: null,
                currentNote: null,
                lastNoteTime: 0,
                sensitivity: 30,
                smoothing: 100,
                transpose: 0,
                reverb: 40,
                vibrato: 0,
                velocity: 100,
                channel: 2,
                scale: 'chromatic',
                playMode: 'single',
                currentChordNotes: [],
                arpeggiatorIndex: 0,
                arpeggiatorInterval: null,
                currentArpNotes: []
            }
        };

        // Initialize patterns
        for (let i = 0; i < 16; i++) {
            state.drumPattern[i] = { kick: false, snare: false, hihat: false, open: false };
            state.bassPattern[i] = null;
        }

        // Launchpad MIDI mapping
        const LP_MAPPING = {
            pads: [
                [81, 82, 83, 84, 85, 86, 87, 88],
                [71, 72, 73, 74, 75, 76, 77, 78],
                [61, 62, 63, 64, 65, 66, 67, 68],
                [51, 52, 53, 54, 55, 56, 57, 58],
                [41, 42, 43, 44, 45, 46, 47, 48],
                [31, 32, 33, 34, 35, 36, 37, 38],
                [21, 22, 23, 24, 25, 26, 27, 28],
                [11, 12, 13, 14, 15, 16, 17, 18]
            ],
            rightButtons: [89, 79, 69, 59, 49, 39, 29, 19],
            topButtons: {
                up: 104, down: 105, left: 106, right: 107,
                session: 108, user1: 109, user2: 110, mixer: 111
            }
        };

        // Launchpad colors
        const LP_COLORS = {
            off: 0, red: 5, orange: 9, amber: 13, yellow: 17,
            lime: 21, green: 25, turquoise: 29, cyan: 33,
            sky: 37, blue: 41, purple: 49, pink: 53, white: 3
        };

        // Bass programs
        const BASS_PROGRAMS = ['Acoustic', 'Finger', 'Pick', 'Fretless', 'Slap 1', 'Slap 2', 'Synth 1', 'Synth 2', 'Synth 3', 'Synth 4', 'Synth 5', 'Synth 6'];

        // Voice scales
        const voiceScales = {
            'chromatic': [0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11],
            'C-major': [0, 2, 4, 5, 7, 9, 11],
            'G-major': [7, 9, 11, 0, 2, 4, 6],
            'A-minor': [9, 11, 0, 2, 4, 5, 7],
            'E-minor': [4, 6, 7, 9, 11, 0, 2]
        };

        // Rhythm patterns
        const RHYTHM_PATTERNS = {
            '8BEAT': {
                main: {
                    A: { kick: '1000100010001000', snare: '0000100000001000', hihat: '1010101010101010', open: '0000000000000000' },
                    B: { kick: '1000100010001010', snare: '0000100000001000', hihat: '1010101010101010', open: '0000000000100000' },
                    C: { kick: '1010100010101000', snare: '0000100000001000', hihat: '1111111111111111', open: '0000000000000000' },
                    D: { kick: '1010101010101010', snare: '0000100000001000', hihat: '1111111111111111', open: '0000000100000001' }
                },
                intro: {
                    A: { kick: '1000000010000000', snare: '0000000000000000', hihat: '1010101010101010', open: '0000000000000000' },
                    B: { kick: '1000000010000000', snare: '0000100000000000', hihat: '1010101010101010', open: '0000000000000000' },
                    C: { kick: '1000100010001000', snare: '0000100000001000', hihat: '1010101010101010', open: '0000000000000000' },
                    D: { kick: '1000100010001000', snare: '0000100000001000', hihat: '1111111111111111', open: '0000000000000000' }
                },
                fill: {
                    A: { kick: '1000100010001000', snare: '0010001000100010', hihat: '1010101010101010', open: '0000000000000000' },
                    B: { kick: '1000100010001000', snare: '0010001000101010', hihat: '1010101010101010', open: '0000000000000010' },
                    C: { kick: '1000100010001010', snare: '0010001000101010', hihat: '1010101010101010', open: '0000000000000010' },
                    D: { kick: '1010101010101010', snare: '0010001000101111', hihat: '1111111111111111', open: '0000000000000001' }
                },
                ending: {
                    A: { kick: '1000100010000000', snare: '0000100000001000', hihat: '1010101010100000', open: '0000000000000000' },
                    B: { kick: '1000100010000000', snare: '0000100000001000', hihat: '1010101010100000', open: '0000000000000000' },
                    C: { kick: '1000100010000000', snare: '0000100000001000', hihat: '1010101010100000', open: '0000000000000000' },
                    D: { kick: '1000100010001000', snare: '0000100010001000', hihat: '1010101010101000', open: '0000000000000001' }
                },
                chorus: {
                    A: { kick: '1010100010101000', snare: '0000100000001000', hihat: '1111111111111111', open: '0000000000000000' },
                    B: { kick: '1010100010101000', snare: '0000100000001000', hihat: '1111111111111111', open: '0000000100000001' },
                    C: { kick: '1010101010101010', snare: '0000100000001000', hihat: '1111111111111111', open: '0000000100000001' },
                    D: { kick: '1010101010101010', snare: '0100100001001000', hihat: '1111111111111111', open: '0000000100000001' }
                },
                break: {
                    A: { kick: '1000000000000000', snare: '0000000000000000', hihat: '0000000000000000', open: '0000000000000000' },
                    B: { kick: '1000000010000000', snare: '0000000000000000', hihat: '1010000010100000', open: '0000000000000000' },
                    C: { kick: '1000000010000000', snare: '0000100000001000', hihat: '1010101010101010', open: '0000000000000000' },
                    D: { kick: '1000100010001000', snare: '0000100000001000', hihat: '1010101010101010', open: '0000000000000000' }
                }
            },
            '16BEAT': {
                main: {
                    A: { kick: '1000100000101000', snare: '0000100000001000', hihat: '1111111111111111', open: '0000000000000000' },
                    B: { kick: '1000100000101010', snare: '0000100000001000', hihat: '1111111111111111', open: '0000000000100000' },
                    C: { kick: '1010100010101000', snare: '0000100100001001', hihat: '1111111111111111', open: '0000000000000000' },
                    D: { kick: '1010101010101010', snare: '0000100100001001', hihat: '1111111111111111', open: '0000000100000001' }
                },
                intro: {
                    A: { kick: '1000000010000000', snare: '0000000000000000', hihat: '1111111111111111', open: '0000000000000000' },
                    B: { kick: '1000000010000000', snare: '0000100000000000', hihat: '1111111111111111', open: '0000000000000000' },
                    C: { kick: '1000100010001000', snare: '0000100000001000', hihat: '1111111111111111', open: '0000000000000000' },
                    D: { kick: '1000100010001000', snare: '0000100000001000', hihat: '1111111111111111', open: '0000000000000000' }
                },
                fill: {
                    A: { kick: '1000100010001000', snare: '0001000100010001', hihat: '1111111111111111', open: '0000000000000000' },
                    B: { kick: '1000100010001000', snare: '0001000100011111', hihat: '1111111111111111', open: '0000000000000010' },
                    C: { kick: '1000100010001010', snare: '0001000100011111', hihat: '1111111111111111', open: '0000000000000010' },
                    D: { kick: '1010101010101010', snare: '0001000100011111', hihat: '1111111111111111', open: '0000000000000001' }
                },
                ending: {
                    A: { kick: '1000100010000000', snare: '0000100000001000', hihat: '1111111111110000', open: '0000000000000000' },
                    B: { kick: '1000100010000000', snare: '0000100000001000', hihat: '1111111111110000', open: '0000000000000000' },
                    C: { kick: '1000100010000000', snare: '0000100000001000', hihat: '1111111111110000', open: '0000000000000000' },
                    D: { kick: '1000100010001000', snare: '0000100010001000', hihat: '1111111111111000', open: '0000000000000001' }
                },
                chorus: {
                    A: { kick: '1010100010101000', snare: '0000100100001001', hihat: '1111111111111111', open: '0000000000000000' },
                    B: { kick: '1010100010101000', snare: '0000100100001001', hihat: '1111111111111111', open: '0000000100000001' },
                    C: { kick: '1010101010101010', snare: '0000100100001001', hihat: '1111111111111111', open: '0000000100000001' },
                    D: { kick: '1010101010101010', snare: '0100100101001001', hihat: '1111111111111111', open: '0000000100000001' }
                },
                break: {
                    A: { kick: '1000000000000000', snare: '0000000000000000', hihat: '0000000000000000', open: '0000000000000000' },
                    B: { kick: '1000000010000000', snare: '0000000000000000', hihat: '1111000011110000', open: '0000000000000000' },
                    C: { kick: '1000000010000000', snare: '0000100000001000', hihat: '1111111111111111', open: '0000000000000000' },
                    D: { kick: '1000100010001000', snare: '0000100000001000', hihat: '1111111111111111', open: '0000000000000000' }
                }
            },
            'POP': {
                main: {
                    A: { kick: '1000100010001000', snare: '0000100000001000', hihat: '1010101010101010', open: '0000000000000000' },
                    B: { kick: '1000100010001010', snare: '0000100000001000', hihat: '1010101010101010', open: '0000000000100000' },
                    C: { kick: '1010100010101000', snare: '0000100000001000', hihat: '1111111111111111', open: '0000000000000000' },
                    D: { kick: '1010101010101010', snare: '0000100000001000', hihat: '1111111111111111', open: '0000000100000001' }
                },
                intro: {
                    A: { kick: '1000000010000000', snare: '0000000000000000', hihat: '1010101010101010', open: '0000000000000000' },
                    B: { kick: '1000000010000000', snare: '0000100000000000', hihat: '1010101010101010', open: '0000000000000000' },
                    C: { kick: '1000100010001000', snare: '0000100000001000', hihat: '1010101010101010', open: '0000000000000000' },
                    D: { kick: '1000100010001000', snare: '0000100000001000', hihat: '1111111111111111', open: '0000000000000000' }
                },
                fill: {
                    A: { kick: '1000100010001000', snare: '0010001000100010', hihat: '1010101010101010', open: '0000000000000000' },
                    B: { kick: '1000100010001000', snare: '0010001000101010', hihat: '1010101010101010', open: '0000000000000010' },
                    C: { kick: '1000100010001010', snare: '0010001000101010', hihat: '1010101010101010', open: '0000000000000010' },
                    D: { kick: '1010101010101010', snare: '0010001000101111', hihat: '1111111111111111', open: '0000000000000001' }
                },
                ending: {
                    A: { kick: '1000100010000000', snare: '0000100000001000', hihat: '1010101010100000', open: '0000000000000000' },
                    B: { kick: '1000100010000000', snare: '0000100000001000', hihat: '1010101010100000', open: '0000000000000000' },
                    C: { kick: '1000100010000000', snare: '0000100000001000', hihat: '1010101010100000', open: '0000000000000000' },
                    D: { kick: '1000100010001000', snare: '0000100010001000', hihat: '1010101010101000', open: '0000000000000001' }
                },
                chorus: {
                    A: { kick: '1010100010101000', snare: '0000100000001000', hihat: '1111111111111111', open: '0000000000000000' },
                    B: { kick: '1010100010101000', snare: '0000100000001000', hihat: '1111111111111111', open: '0000000100000001' },
                    C: { kick: '1010101010101010', snare: '0000100000001000', hihat: '1111111111111111', open: '0000000100000001' },
                    D: { kick: '1010101010101010', snare: '0100100001001000', hihat: '1111111111111111', open: '0000000100000001' }
                },
                break: {
                    A: { kick: '1000000000000000', snare: '0000000000000000', hihat: '0000000000000000', open: '0000000000000000' },
                    B: { kick: '1000000010000000', snare: '0000000000000000', hihat: '1010000010100000', open: '0000000000000000' },
                    C: { kick: '1000000010000000', snare: '0000100000001000', hihat: '1010101010101010', open: '0000000000000000' },
                    D: { kick: '1000100010001000', snare: '0000100000001000', hihat: '1010101010101010', open: '0000000000000000' }
                }
            },
            'ROCK': {
                main: {
                    A: { kick: '1000100010001000', snare: '0000100000001000', hihat: '1010101010101010', open: '0000000000000000' },
                    B: { kick: '1000100010001010', snare: '0000100000001000', hihat: '1010101010101010', open: '0000000000100000' },
                    C: { kick: '1010100010101000', snare: '0000100000001000', hihat: '1111111111111111', open: '0000000000000000' },
                    D: { kick: '1010101010101010', snare: '0000100000001000', hihat: '1111111111111111', open: '0000000100000001' }
                },
                intro: {
                    A: { kick: '1000000010000000', snare: '0000000000000000', hihat: '1010101010101010', open: '0000000000000000' },
                    B: { kick: '1000000010000000', snare: '0000100000000000', hihat: '1010101010101010', open: '0000000000000000' },
                    C: { kick: '1000100010001000', snare: '0000100000001000', hihat: '1010101010101010', open: '0000000000000000' },
                    D: { kick: '1000100010001000', snare: '0000100000001000', hihat: '1111111111111111', open: '0000000000000000' }
                },
                fill: {
                    A: { kick: '1000100010001000', snare: '0010001000100010', hihat: '1010101010101010', open: '0000000000000000' },
                    B: { kick: '1000100010001000', snare: '0010001000101010', hihat: '1010101010101010', open: '0000000000000010' },
                    C: { kick: '1000100010001010', snare: '0010001000101010', hihat: '1010101010101010', open: '0000000000000010' },
                    D: { kick: '1010101010101010', snare: '0010001000101111', hihat: '1111111111111111', open: '0000000000000001' }
                },
                ending: {
                    A: { kick: '1000100010000000', snare: '0000100000001000', hihat: '1010101010100000', open: '0000000000000000' },
                    B: { kick: '1000100010000000', snare: '0000100000001000', hihat: '1010101010100000', open: '0000000000000000' },
                    C: { kick: '1000100010000000', snare: '0000100000001000', hihat: '1010101010100000', open: '0000000000000000' },
                    D: { kick: '1000100010001000', snare: '0000100010001000', hihat: '1010101010101000', open: '0000000000000001' }
                },
                chorus: {
                    A: { kick: '1010100010101000', snare: '0000100000001000', hihat: '1111111111111111', open: '0000000000000000' },
                    B: { kick: '1010100010101000', snare: '0000100000001000', hihat: '1111111111111111', open: '0000000100000001' },
                    C: { kick: '1010101010101010', snare: '0000100000001000', hihat: '1111111111111111', open: '0000000100000001' },
                    D: { kick: '1010101010101010', snare: '0100100001001000', hihat: '1111111111111111', open: '0000000100000001' }
                },
                break: {
                    A: { kick: '1000000000000000', snare: '0000000000000000', hihat: '0000000000000000', open: '0000000000000000' },
                    B: { kick: '1000000010000000', snare: '0000000000000000', hihat: '1010000010100000', open: '0000000000000000' },
                    C: { kick: '1000000010000000', snare: '0000100000001000', hihat: '1010101010101010', open: '0000000000000000' },
                    D: { kick: '1000100010001000', snare: '0000100000001000', hihat: '1010101010101010', open: '0000000000000000' }
                }
            },
            'JAZZ': {
                main: {
                    A: { kick: '1000001000100000', snare: '0000100000001000', hihat: '1001001001001001', open: '0010010010010010' },
                    B: { kick: '1000001000100010', snare: '0000100000001000', hihat: '1001001001001001', open: '0010010010010010' },
                    C: { kick: '1001001000100100', snare: '0000100100001001', hihat: '1001001001001001', open: '0010010010010010' },
                    D: { kick: '1001001001001001', snare: '0000100100001001', hihat: '1001001001001001', open: '0010010010010010' }
                },
                intro: {
                    A: { kick: '1000000010000000', snare: '0000000000000000', hihat: '1001001001001001', open: '0010010010010010' },
                    B: { kick: '1000000010000000', snare: '0000100000000000', hihat: '1001001001001001', open: '0010010010010010' },
                    C: { kick: '1000001000100000', snare: '0000100000001000', hihat: '1001001001001001', open: '0010010010010010' },
                    D: { kick: '1000001000100000', snare: '0000100000001000', hihat: '1001001001001001', open: '0010010010010010' }
                },
                fill: {
                    A: { kick: '1000001000100000', snare: '0010001000100010', hihat: '1001001001001001', open: '0010010010010010' },
                    B: { kick: '1000001000100000', snare: '0010001000101010', hihat: '1001001001001001', open: '0010010010010010' },
                    C: { kick: '1000001000100010', snare: '0010001000101010', hihat: '1001001001001001', open: '0010010010010010' },
                    D: { kick: '1001001001001001', snare: '0010001000101111', hihat: '1001001001001001', open: '0010010010010010' }
                },
                ending: {
                    A: { kick: '1000001000100000', snare: '0000100000001000', hihat: '1001001001000000', open: '0010010010000000' },
                    B: { kick: '1000001000100000', snare: '0000100000001000', hihat: '1001001001000000', open: '0010010010000000' },
                    C: { kick: '1000001000100000', snare: '0000100000001000', hihat: '1001001001000000', open: '0010010010000000' },
                    D: { kick: '1000001000100010', snare: '0000100010001000', hihat: '1001001001001000', open: '0010010010010001' }
                },
                chorus: {
                    A: { kick: '1001001000100100', snare: '0000100100001001', hihat: '1001001001001001', open: '0010010010010010' },
                    B: { kick: '1001001000100100', snare: '0000100100001001', hihat: '1001001001001001', open: '0010010010010010' },
                    C: { kick: '1001001001001001', snare: '0000100100001001', hihat: '1001001001001001', open: '0010010010010010' },
                    D: { kick: '1001001001001001', snare: '0100100101001001', hihat: '1001001001001001', open: '0010010010010010' }
                },
                break: {
                    A: { kick: '1000000000000000', snare: '0000000000000000', hihat: '0000000000000000', open: '0000000000000000' },
                    B: { kick: '1000000010000000', snare: '0000000000000000', hihat: '1001000010010000', open: '0010000001000000' },
                    C: { kick: '1000000010000000', snare: '0000100000001000', hihat: '1001001001001001', open: '0010010010010010' },
                    D: { kick: '1000001000100000', snare: '0000100000001000', hihat: '1001001001001001', open: '0010010010010010' }
                }
            },
            'LATIN': {
                main: {
                    A: { kick: '1000100100001001', snare: '0001000100010001', hihat: '1010101010101010', open: '0100010001000100' },
                    B: { kick: '1000100100001001', snare: '0001000100010001', hihat: '1010101010101010', open: '0100010001000100' },
                    C: { kick: '1001001000100100', snare: '0001000100010001', hihat: '1111111111111111', open: '0100010001000100' },
                    D: { kick: '1001001001001001', snare: '0001000100010001', hihat: '1111111111111111', open: '0100010001000100' }
                },
                intro: {
                    A: { kick: '1000000010000000', snare: '0000000000000000', hihat: '1010101010101010', open: '0100010001000100' },
                    B: { kick: '1000100100001001', snare: '0000000000000000', hihat: '1010101010101010', open: '0100010001000100' },
                    C: { kick: '1000100100001001', snare: '0001000100010001', hihat: '1010101010101010', open: '0100010001000100' },
                    D: { kick: '1000100100001001', snare: '0001000100010001', hihat: '1010101010101010', open: '0100010001000100' }
                },
                fill: {
                    A: { kick: '1000100100001001', snare: '0010001000100010', hihat: '1010101010101010', open: '0100010001000100' },
                    B: { kick: '1000100100001001', snare: '0010001000101010', hihat: '1010101010101010', open: '0100010001000100' },
                    C: { kick: '1001001000100100', snare: '0010001000101010', hihat: '1010101010101010', open: '0100010001000100' },
                    D: { kick: '1001001001001001', snare: '0010001000101111', hihat: '1111111111111111', open: '0100010001000101' }
                },
                ending: {
                    A: { kick: '1000100100001000', snare: '0001000100010001', hihat: '1010101010100000', open: '0100010001000000' },
                    B: { kick: '1000100100001000', snare: '0001000100010001', hihat: '1010101010100000', open: '0100010001000000' },
                    C: { kick: '1000100100001000', snare: '0001000100010001', hihat: '1010101010100000', open: '0100010001000000' },
                    D: { kick: '1000100100001001', snare: '0001000100010001', hihat: '1010101010101000', open: '0100010001000101' }
                },
                chorus: {
                    A: { kick: '1001001000100100', snare: '0001000100010001', hihat: '1111111111111111', open: '0100010001000100' },
                    B: { kick: '1001001000100100', snare: '0001000100010001', hihat: '1111111111111111', open: '0100010001000100' },
                    C: { kick: '1001001001001001', snare: '0001000100010001', hihat: '1111111111111111', open: '0100010001000100' },
                    D: { kick: '1001001001001001', snare: '0101010101010101', hihat: '1111111111111111', open: '0100010001000100' }
                },
                break: {
                    A: { kick: '1000000000000000', snare: '0000000000000000', hihat: '0000000000000000', open: '0000000000000000' },
                    B: { kick: '1000000010000000', snare: '0000000000000000', hihat: '1010000010100000', open: '0100000001000000' },
                    C: { kick: '1000100100001001', snare: '0000000000000000', hihat: '1010101010101010', open: '0100010001000100' },
                    D: { kick: '1000100100001001', snare: '0001000100010001', hihat: '1010101010101010', open: '0100010001000100' }
                }
            }
        };

        // Chord definitions
        const CHORDS = [
            { name: 'C', type: 'Major', notes: [60, 64, 67] },
            { name: 'D', type: 'Major', notes: [62, 66, 69] },
            { name: 'E', type: 'Major', notes: [64, 68, 71] },
            { name: 'F', type: 'Major', notes: [65, 69, 72] },
            { name: 'G', type: 'Major', notes: [67, 71, 74] },
            { name: 'A', type: 'Major', notes: [69, 73, 76] },
            
            { name: 'Cm', type: 'Minor', notes: [60, 63, 67] },
            { name: 'Dm', type: 'Minor', notes: [62, 65, 69] },
            { name: 'Em', type: 'Minor', notes: [64, 67, 71] },
            { name: 'Fm', type: 'Minor', notes: [65, 68, 72] },
            { name: 'Gm', type: 'Minor', notes: [67, 70, 74] },
            { name: 'Am', type: 'Minor', notes: [69, 72, 76] },
            
            { name: 'C7', type: '7th', notes: [60, 64, 67, 70] },
            { name: 'D7', type: '7th', notes: [62, 66, 69, 72] },
            { name: 'E7', type: '7th', notes: [64, 68, 71, 74] },
            { name: 'F7', type: '7th', notes: [65, 69, 72, 75] },
            { name: 'G7', type: '7th', notes: [67, 71, 74, 77] },
            { name: 'A7', type: '7th', notes: [69, 73, 76, 79] },
            
            { name: 'B¬∞', type: 'Dim', notes: [71, 74, 77] },
            { name: 'Csus4', type: 'Sus4', notes: [60, 65, 67] },
            { name: 'Dsus2', type: 'Sus2', notes: [62, 64, 69] },
            { name: 'FM7', type: 'Maj7', notes: [65, 69, 72, 76] },
            { name: 'Gsus4', type: 'Sus4', notes: [67, 72, 74] },
            { name: 'Am7', type: 'Min7', notes: [69, 72, 76, 79] }
        ];

        // CTK Tones simplified
        const CTK_TONES = [
            { id: 1, name: "GRAND PIANO", category: "PIANO", program: 0 },
            { id: 2, name: "BRIGHT PIANO", category: "PIANO", program: 1 },
            { id: 3, name: "ELEC.PIANO", category: "PIANO", program: 4 },
            { id: 4, name: "STRINGS", category: "STRINGS", program: 48 },
            { id: 5, name: "SYNTH PAD", category: "PAD", program: 89 },
            { id: 6, name: "ORGAN", category: "ORGAN", program: 16 },
            { id: 7, name: "GUITAR", category: "GUITAR", program: 24 },
            { id: 8, name: "BASS", category: "BASS", program: 32 },
            { id: 9, name: "BRASS", category: "BRASS", program: 61 },
            { id: 10, name: "SAX", category: "REED", program: 65 },
            { id: 11, name: "FLUTE", category: "REED", program: 73 },
            { id: 12, name: "VIBRAPHONE", category: "CHROMATIC", program: 11 }
        ];

        // ==========================================
        // INITIALIZATION
        // ==========================================
        
        document.addEventListener('DOMContentLoaded', () => {
            initializeUI();
            buildToneSelectors();
            setupEventListeners();
            initializePatterns();
            
            document.getElementById('lpTopSESSION').classList.add('active');
            
            setTimeout(() => {
                document.getElementById('loading').classList.add('hidden');
            }, 500);
        });

        function initializeUI() {
            // Initialize Style Grid
            const styles = ['8BEAT', '16BEAT', 'POP', 'ROCK', 'JAZZ', 'LATIN'];
            const styleGrid = document.getElementById('styleGrid');
            styles.forEach(style => {
                const btn = document.createElement('button');
                btn.className = 'style-btn';
                btn.textContent = style;
                btn.onclick = () => selectStyle(style);
                if (style === state.currentStyle) btn.classList.add('active');
                styleGrid.appendChild(btn);
            });
            
            // Initialize Section Grid
            const sections = ['INTRO', 'MAIN', 'CHORUS', 'FILL', 'BREAK', 'ENDING'];
            const sectionGrid = document.getElementById('sectionGrid');
            sections.forEach(section => {
                const btn = document.createElement('button');
                btn.className = 'section-btn';
                btn.textContent = section;
                btn.onclick = () => selectSection(section.toLowerCase());
                if (section.toLowerCase() === state.currentSection) btn.classList.add('active');
                sectionGrid.appendChild(btn);
            });
            
            // Initialize Variation Row
            const variations = ['A', 'B', 'C', 'D'];
            const varRow = document.getElementById('variationRow');
            variations.forEach(variation => {
                const btn = document.createElement('button');
                btn.className = 'var-btn';
                btn.textContent = variation;
                btn.onclick = () => selectVariation(variation);
                if (variation === state.currentVariation) btn.classList.add('active');
                varRow.appendChild(btn);
            });
            
            // Initialize Chord Grid - FIXED
            const chordGrid = document.getElementById('chordGrid');
            CHORDS.forEach((chord, index) => {
                const pad = document.createElement('div');
                pad.className = 'chord-pad';
                pad.dataset.index = index;
                pad.dataset.chord = chord.name;
                
                const nameDiv = document.createElement('div');
                nameDiv.className = 'chord-name';
                nameDiv.textContent = chord.name;
                
                const typeDiv = document.createElement('div');
                typeDiv.className = 'chord-type';
                typeDiv.textContent = chord.type;
                
                pad.appendChild(nameDiv);
                pad.appendChild(typeDiv);
                
                // FIXED: Proper event handlers
                pad.addEventListener('mousedown', function(e) {
                    e.preventDefault();
                    playChordFromPad(chord, this);
                });
                pad.addEventListener('mouseup', function(e) {
                    e.preventDefault();
                    stopChord();
                });
                pad.addEventListener('mouseleave', function(e) {
                    if (this.classList.contains('active')) {
                        stopChord();
                    }
                });
                pad.addEventListener('touchstart', function(e) {
                    e.preventDefault();
                    playChordFromPad(chord, this);
                }, { passive: false });
                pad.addEventListener('touchend', function(e) {
                    e.preventDefault();
                    stopChord();
                }, { passive: false });
                
                chordGrid.appendChild(pad);
            });
            
            // Initialize Pattern Grid
            const patternGrid = document.getElementById('patternGrid');
            const instruments = ['KICK', 'SNARE', 'HIHAT', 'OPEN'];
            
            instruments.forEach((inst, row) => {
                const rowDiv = document.createElement('div');
                rowDiv.className = 'pattern-row';
                
                for (let step = 0; step < 16; step++) {
                    const cell = document.createElement('div');
                    cell.className = 'pattern-cell';
                    cell.dataset.row = row;
                    cell.dataset.step = step;
                    
                    cell.addEventListener('mousedown', handlePatternCellMouseDown);
                    cell.addEventListener('mouseenter', handlePatternCellMouseEnter);
                    cell.addEventListener('touchstart', handlePatternCellTouchStart, { passive: false });
                    cell.addEventListener('touchmove', handlePatternCellTouchMove, { passive: false });
                    
                    rowDiv.appendChild(cell);
                }
                
                patternGrid.appendChild(rowDiv);
            });
            
            // Initialize Launchpad
            initializeLaunchpadUI();
        }

        function initializeLaunchpadUI() {
            // Top buttons
            const topButtons = ['UP', 'DOWN', 'LEFT', 'RIGHT', 'SESSION', 'USER 1', 'USER 2', 'MIXER'];
            const topBtnContainer = document.getElementById('lpTopButtons');
            
            topButtons.forEach((btn) => {
                const button = document.createElement('button');
                button.className = 'lp-top-btn';
                button.textContent = btn;
                button.id = `lpTop${btn.replace(' ', '')}`;
                
                switch(btn) {
                    case 'UP': button.onclick = () => handleLPTopButton('up'); break;
                    case 'DOWN': button.onclick = () => handleLPTopButton('down'); break;
                    case 'LEFT': button.onclick = () => handleLPTopButton('left'); break;
                    case 'RIGHT': button.onclick = () => handleLPTopButton('right'); break;
                    case 'SESSION': button.onclick = () => setLaunchpadMode('session'); break;
                    case 'USER 1': button.onclick = () => setLaunchpadMode('user1'); break;
                    case 'USER 2': button.onclick = () => setLaunchpadMode('user2'); break;
                    case 'MIXER': button.onclick = () => handleMixerButton(); break;
                }
                
                topBtnContainer.appendChild(button);
            });
            
            // Grid
            const lpGrid = document.getElementById('lpGrid');
            for (let row = 0; row < 8; row++) {
                for (let col = 0; col < 8; col++) {
                    const pad = document.createElement('div');
                    pad.className = 'lp-pad';
                    pad.dataset.row = row;
                    pad.dataset.col = col;
                    pad.dataset.note = LP_MAPPING.pads[row][col];
                    pad.id = `lp-${row}-${col}`;
                    
                    pad.addEventListener('mousedown', () => handleLPPadPress(row, col));
                    pad.addEventListener('mouseup', () => {
                        if (state.launchpadMode === 'user1') handleLPPadRelease(row, col);
                    });
                    pad.addEventListener('touchstart', (e) => {
                        e.preventDefault();
                        handleLPPadPress(row, col);
                    }, { passive: false });
                    pad.addEventListener('touchend', (e) => {
                        e.preventDefault();
                        if (state.launchpadMode === 'user1') handleLPPadRelease(row, col);
                    }, { passive: false });
                    
                    lpGrid.appendChild(pad);
                }
            }
            
            // Right buttons
            const rightBtnContainer = document.getElementById('lpRightButtons');
            const rightLabels = ['DS1', 'DS2', 'DS3', 'DS4', 'DS5', 'DS6', 'STOP', 'PLAY'];
            
            for (let i = 0; i < 8; i++) {
                const btn = document.createElement('button');
                btn.className = 'lp-right-btn';
                btn.textContent = rightLabels[i];
                btn.dataset.index = i;
                btn.id = `lpRight${i}`;
                
                if (i === 7) {
                    btn.dataset.function = 'play';
                    btn.onclick = () => togglePlay();
                } else if (i === 6) {
                    btn.dataset.function = 'stop';
                    btn.onclick = () => stopPlayback();
                } else {
                    btn.onclick = () => handleLPRightButton(i);
                }
                
                rightBtnContainer.appendChild(btn);
            }
        }

        function buildToneSelectors() {
            const chordSelect = document.getElementById('chordInstrument');
            const voiceSelect = document.getElementById('voiceToneSelect');
            
            chordSelect.innerHTML = '';
            voiceSelect.innerHTML = '';
            
            CTK_TONES.forEach(tone => {
                const opt1 = document.createElement('option');
                opt1.value = tone.program;
                opt1.textContent = tone.name;
                chordSelect.appendChild(opt1);
                
                const opt2 = document.createElement('option');
                opt2.value = tone.program;
                opt2.textContent = tone.name;
                voiceSelect.appendChild(opt2);
            });
        }

        function setupEventListeners() {
            // Pattern drag end
            document.addEventListener('mouseup', () => state.isDragging = false);
            document.addEventListener('touchend', () => state.isDragging = false);
            
            // Keyboard shortcuts
            document.addEventListener('keydown', (e) => {
                if (e.code === 'Space') {
                    e.preventDefault();
                    togglePlay();
                } else if (e.code === 'KeyF') {
                    toggleFullscreen();
                }
            });
            
            // Chord velocity
            const chordVelocity = document.getElementById('chordVelocity');
            chordVelocity.addEventListener('input', (e) => {
                state.chordVelocity = parseInt(e.target.value);
                document.getElementById('chordVelValue').textContent = e.target.value;
            });
            
            // Chord instrument
            const chordInstrument = document.getElementById('chordInstrument');
            chordInstrument.addEventListener('change', (e) => {
                state.chordInstrument = parseInt(e.target.value);
            });
            
            // Voice controls
            document.getElementById('voiceStartBtn').addEventListener('click', startVoiceToMidi);
            document.getElementById('voiceStopBtn').addEventListener('click', stopVoiceToMidi);
            
            document.getElementById('voicePlayMode').addEventListener('change', (e) => {
                state.voiceToMidi.playMode = e.target.value;
            });
            
            document.getElementById('voiceScale').addEventListener('change', (e) => {
                state.voiceToMidi.scale = e.target.value;
            });
            
            document.getElementById('voiceSensitivity').addEventListener('input', (e) => {
                state.voiceToMidi.sensitivity = parseInt(e.target.value);
                document.getElementById('voiceSensitivityValue').textContent = e.target.value;
            });
            
            document.getElementById('voiceReverb').addEventListener('input', (e) => {
                state.voiceToMidi.reverb = parseInt(e.target.value);
                document.getElementById('voiceReverbValue').textContent = e.target.value;
            });
            
            document.getElementById('voiceTranspose').addEventListener('input', (e) => {
                state.voiceToMidi.transpose = parseInt(e.target.value);
                const val = parseInt(e.target.value);
                document.getElementById('voiceTransposeValue').textContent = (val > 0 ? '+' : '') + val;
            });
            
            // Knobs
            setupKnobControl('swingKnob', 'swingValue', (v) => {
                state.swing = v;
                document.getElementById('swingValue').textContent = v + '%';
            });
            setupKnobControl('velocityKnob', 'velocityValue', (v) => {
                state.velocity = v;
                document.getElementById('velocityValue').textContent = v;
            });
            setupKnobControl('humanizeKnob', 'humanizeValue', (v) => {
                state.humanize = v;
                document.getElementById('humanizeValue').textContent = v + '%';
            });
        }

        function setupKnobControl(knobId, valueId, callback) {
            const knob = document.getElementById(knobId);
            const indicator = knob.querySelector('.control-indicator');
            let startX = 0;
            let startValue = 0;
            
            const updateKnob = (value) => {
                const min = parseInt(knob.dataset.min);
                const max = parseInt(knob.dataset.max);
                value = Math.max(min, Math.min(max, value));
                
                knob.dataset.value = value;
                const angle = ((value - min) / (max - min)) * 270 - 135;
                indicator.style.transform = `translateX(-50%) rotate(${angle}deg)`;
                
                callback(value);
            };
            
            const handleStart = (e) => {
                e.preventDefault();
                startX = e.type.includes('touch') ? e.touches[0].clientX : e.clientX;
                startValue = parseInt(knob.dataset.value);
                
                const handleMove = (e) => {
                    const currentX = e.type.includes('touch') ? e.touches[0].clientX : e.clientX;
                    const diff = currentX - startX;
                    const min = parseInt(knob.dataset.min);
                    const max = parseInt(knob.dataset.max);
                    const range = max - min;
                    const newValue = startValue + Math.round(diff / 100 * range);
                    updateKnob(newValue);
                };
                
                const handleEnd = () => {
                    document.removeEventListener('mousemove', handleMove);
                    document.removeEventListener('touchmove', handleMove);
                    document.removeEventListener('mouseup', handleEnd);
                    document.removeEventListener('touchend', handleEnd);
                };
                
                document.addEventListener('mousemove', handleMove);
                document.addEventListener('touchmove', handleMove, { passive: false });
                document.addEventListener('mouseup', handleEnd);
                document.addEventListener('touchend', handleEnd);
            };
            
            knob.addEventListener('mousedown', handleStart);
            knob.addEventListener('touchstart', handleStart, { passive: false });
            
            updateKnob(parseInt(knob.dataset.value));
        }

        // ==========================================
        // CHORD HANDLING - FIXED
        // ==========================================
        
        function playChordFromPad(chord, padElement) {
            state.currentChord = chord.name;
            document.getElementById('currentChord').textContent = chord.name;
            
            if (state.midiOutCTK) {
                state.midiOutCTK.send([0xC0, state.chordInstrument]);
                chord.notes.forEach(note => {
                    state.midiOutCTK.send([0x90, note, state.chordVelocity]);
                });
            }
            
            if (state.isRecording) {
                state.chordProgression.push({ chord: chord.name, beat: state.currentBeat });
            }
            
            updateChordHarmony(chord.name);
            
            document.querySelectorAll('.chord-pad').forEach(pad => pad.classList.remove('active'));
            padElement.classList.add('active');
            
            // Update Launchpad
            syncLaunchpadChordPads(chord);
        }

        function stopChord() {
            if (state.midiOutCTK) {
                for (let note = 48; note < 84; note++) {
                    state.midiOutCTK.send([0x80, note, 0]);
                }
            }
            
            document.querySelectorAll('.chord-pad').forEach(pad => pad.classList.remove('active'));
        }

        function updateChordHarmony(currentChord) {
            const circleOfFifths = {
                'C': { perfect: ['G', 'F', 'Am'], good: ['Em', 'Dm'] },
                'G': { perfect: ['D', 'C', 'Em'], good: ['Bm', 'Am'] },
                'D': { perfect: ['A', 'G', 'Bm'], good: ['F#m', 'Em'] },
                'A': { perfect: ['E', 'D', 'F#m'], good: ['C#m', 'Bm'] },
                'E': { perfect: ['B', 'A', 'C#m'], good: ['G#m', 'F#m'] },
                'F': { perfect: ['C', 'Bb', 'Dm'], good: ['Am', 'Gm'] },
                'Am': { perfect: ['Dm', 'Em', 'C'], good: ['F', 'G'] },
                'Em': { perfect: ['Am', 'Bm', 'G'], good: ['C', 'D'] },
                'Dm': { perfect: ['Gm', 'Am', 'F'], good: ['Bb', 'C'] },
                'Gm': { perfect: ['Cm', 'Dm', 'Bb'], good: ['Eb', 'F'] },
                'Cm': { perfect: ['Fm', 'Gm', 'Eb'], good: ['Ab', 'Bb'] },
                'Fm': { perfect: ['Bbm', 'Cm', 'Ab'], good: ['Db', 'Eb'] }
            };
            
            const baseChord = currentChord.replace(/7|m7|maj7|sus|dim|aug|¬∞/g, '');
            const harmonyInfo = circleOfFifths[baseChord] || circleOfFifths[currentChord] || {};
            
            document.querySelectorAll('.chord-pad').forEach(pad => {
                pad.classList.remove('harmony-perfect', 'harmony-good', 'harmony-clash');
            });
            
            document.querySelectorAll('.chord-pad').forEach(pad => {
                if (pad.classList.contains('active')) return;
                
                const padChord = pad.querySelector('.chord-name').textContent;
                const basePadChord = padChord.replace(/7|m7|maj7|sus|dim|aug|¬∞/g, '');
                
                if (harmonyInfo.perfect && harmonyInfo.perfect.some(c => basePadChord === c || padChord === c)) {
                    pad.classList.add('harmony-perfect');
                } else if (harmonyInfo.good && harmonyInfo.good.some(c => basePadChord === c || padChord === c)) {
                    pad.classList.add('harmony-good');
                } else if (isDissonant(baseChord, basePadChord)) {
                    pad.classList.add('harmony-clash');
                }
            });
        }

        function isDissonant(chord1, chord2) {
            const roots = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'];
            const root1 = chord1.replace(/m|7/, '');
            const root2 = chord2.replace(/m|7/, '');
            
            const idx1 = roots.indexOf(root1);
            const idx2 = roots.indexOf(root2);
            
            if (idx1 === -1 || idx2 === -1) return false;
            
            const interval = Math.abs(idx1 - idx2);
            const normalizedInterval = Math.min(interval, 12 - interval);
            
            return normalizedInterval === 1 || normalizedInterval === 6;
        }

        // ==========================================
        // LAUNCHPAD SYNC - FIXED
        // ==========================================
        
        function syncLaunchpadChordPads(chord) {
            if (!state.midiOutLP) return;
            // Flash the corresponding pad on Launchpad when chord is played
        }

        function updateLaunchpadDisplay() {
            if (!state.midiOutLP) return;
            
            // Clear all pads first
            for (let row = 0; row < 8; row++) {
                for (let col = 0; col < 8; col++) {
                    const note = LP_MAPPING.pads[row][col];
                    state.midiOutLP.send([0x90, note, LP_COLORS.off]);
                    
                    const pad = document.getElementById(`lp-${row}-${col}`);
                    if (pad) {
                        pad.removeAttribute('data-color');
                    }
                }
            }
            
            switch(state.launchpadMode) {
                case 'session':
                    updateSessionMode();
                    break;
                case 'user1':
                    updateUser1Mode();
                    break;
                case 'user2':
                    updateUser2Mode();
                    break;
            }
            
            // Update mode buttons on physical Launchpad
            state.midiOutLP.send([0xB0, LP_MAPPING.topButtons.session, state.launchpadMode === 'session' ? 127 : 0]);
            state.midiOutLP.send([0xB0, LP_MAPPING.topButtons.user1, state.launchpadMode === 'user1' ? 127 : 0]);
            state.midiOutLP.send([0xB0, LP_MAPPING.topButtons.user2, state.launchpadMode === 'user2' ? 127 : 0]);
        }

        function updateSessionMode() {
            const instruments = ['kick', 'snare', 'hihat', 'open'];
            const colors = [LP_COLORS.red, LP_COLORS.orange, LP_COLORS.yellow, LP_COLORS.cyan];
            const uiColors = ['red', 'orange', 'yellow', 'cyan'];
            
            // Pattern display on rows 4-7 (bottom 4 rows)
            for (let row = 4; row < 8; row++) {
                const instIndex = row - 4;
                for (let col = 0; col < 8; col++) {
                    const step = col + (state.currentBeat >= 8 ? 8 : 0);
                    const displayStep = col;
                    
                    const pad = document.getElementById(`lp-${row}-${col}`);
                    const note = LP_MAPPING.pads[row][col];
                    
                    if (state.drumPattern[displayStep + (state.currentBeat >= 8 ? 8 : 0)] && 
                        state.drumPattern[displayStep + (state.currentBeat >= 8 ? 8 : 0)][instruments[instIndex]]) {
                        state.midiOutLP.send([0x90, note, colors[instIndex]]);
                        if (pad) pad.setAttribute('data-color', uiColors[instIndex]);
                    }
                }
            }
            
            // Current beat indicator
            if (state.isPlaying) {
                const beatCol = state.currentBeat % 8;
                for (let row = 4; row < 8; row++) {
                    const note = LP_MAPPING.pads[row][beatCol];
                    state.midiOutLP.send([0x90, note, LP_COLORS.white]);
                    const pad = document.getElementById(`lp-${row}-${beatCol}`);
                    if (pad) pad.setAttribute('data-color', 'white');
                }
            }
        }

        function updateUser1Mode() {
            // Drum pads layout
            const drumColors = [
                LP_COLORS.red, LP_COLORS.orange, LP_COLORS.yellow, LP_COLORS.green,
                LP_COLORS.cyan, LP_COLORS.blue, LP_COLORS.purple, LP_COLORS.pink
            ];
            const uiDrumColors = ['red', 'orange', 'yellow', 'green', 'cyan', 'blue', 'purple', 'pink'];
            
            for (let row = 4; row < 8; row++) {
                for (let col = 0; col < 8; col++) {
                    const colorIndex = (row - 4) * 2 + Math.floor(col / 4);
                    const note = LP_MAPPING.pads[row][col];
                    state.midiOutLP.send([0x90, note, drumColors[colorIndex % 8]]);
                    
                    const pad = document.getElementById(`lp-${row}-${col}`);
                    if (pad) pad.setAttribute('data-color', uiDrumColors[colorIndex % 8]);
                }
            }
        }

        function updateUser2Mode() {
            // Bass sequencer
            const bassColors = [LP_COLORS.blue, LP_COLORS.cyan, LP_COLORS.green, LP_COLORS.lime,
                              LP_COLORS.yellow, LP_COLORS.amber, LP_COLORS.orange, LP_COLORS.red];
            const uiBassColors = ['blue', 'cyan', 'green', 'lime', 'yellow', 'amber', 'orange', 'red'];
            
            for (let row = 0; row < 8; row++) {
                for (let col = 0; col < 8; col++) {
                    const step = col + (state.currentBeat >= 8 ? 8 : 0);
                    const note = LP_MAPPING.pads[row][col];
                    
                    if (state.bassPattern[step] && state.bassPattern[step][row]) {
                        state.midiOutLP.send([0x90, note, bassColors[row]]);
                        const pad = document.getElementById(`lp-${row}-${col}`);
                        if (pad) pad.setAttribute('data-color', uiBassColors[row]);
                    }
                }
            }
        }

        function setLaunchpadMode(mode) {
            state.launchpadMode = mode;
            
            document.getElementById('lpTopSESSION').classList.remove('active');
            document.getElementById('lpTopUSER1').classList.remove('active');
            document.getElementById('lpTopUSER2').classList.remove('active');
            
            const bassStatus = document.getElementById('bassStatus');
            if (mode === 'user2') {
                bassStatus.style.display = 'flex';
                document.getElementById('bassDisplay').textContent = BASS_PROGRAMS[state.currentBassProgram - 83].toUpperCase().substring(0, 8);
            } else {
                bassStatus.style.display = 'none';
            }
            
            switch(mode) {
                case 'session':
                    document.getElementById('lpTopSESSION').classList.add('active');
                    break;
                case 'user1':
                    document.getElementById('lpTopUSER1').classList.add('active');
                    break;
                case 'user2':
                    document.getElementById('lpTopUSER2').classList.add('active');
                    showMessage(`Bass: ${BASS_PROGRAMS[state.currentBassProgram - 83]}`);
                    break;
            }
            
            updateLaunchpadDisplay();
        }

        function handleLPTopButton(button) {
            showMessage(`LP: ${button.toUpperCase()}`);
        }

        function handleMixerButton() {
            showMessage('Mixer mode');
        }

        function handleLPPadPress(row, col) {
            const note = LP_MAPPING.pads[row][col];
            
            switch(state.launchpadMode) {
                case 'session':
                    handleSessionPadPress(row, col);
                    break;
                case 'user1':
                    handleUser1PadPress(row, col);
                    break;
                case 'user2':
                    handleUser2PadPress(row, col);
                    break;
            }
        }

        function handleLPPadRelease(row, col) {
            if (state.launchpadMode === 'user1') {
                // Stop drum sound
            }
        }

        function handleSessionPadPress(row, col) {
            if (row >= 4) {
                const instIndex = row - 4;
                const step = col + (state.currentBeat >= 8 ? 8 : 0);
                const instruments = ['kick', 'snare', 'hihat', 'open'];
                
                state.drumPattern[step][instruments[instIndex]] = !state.drumPattern[step][instruments[instIndex]];
                updatePatternDisplay();
                updateLaunchpadDisplay();
            }
        }

        function handleUser1PadPress(row, col) {
            if (state.midiOutCTK && row >= 4) {
                const drumNotes = [36, 38, 42, 46, 35, 37, 44, 49];
                const noteIndex = (row - 4) * 2 + Math.floor(col / 4);
                state.midiOutCTK.send([0x99, drumNotes[noteIndex % 8], state.velocity]);
            }
        }

        function handleUser2PadPress(row, col) {
            const step = col + (state.currentBeat >= 8 ? 8 : 0);
            
            if (!state.bassPattern[step]) {
                state.bassPattern[step] = Array(8).fill(false);
            }
            
            state.bassPattern[step][row] = !state.bassPattern[step][row];
            updateLaunchpadDisplay();
        }

        function handleLPRightButton(index) {
            if (index < 6) {
                state.currentBassProgram = 83 + index * 2;
                document.getElementById('bassDisplay').textContent = BASS_PROGRAMS[state.currentBassProgram - 83].toUpperCase().substring(0, 8);
                showMessage(`Bass: ${BASS_PROGRAMS[state.currentBassProgram - 83]}`);
            }
        }

        // ==========================================
        // PATTERN MANAGEMENT
        // ==========================================
        
        function initializePatterns() {
            loadPattern(state.currentStyle, state.currentSection, state.currentVariation);
        }

        function loadPattern(style, section, variation) {
            const patterns = RHYTHM_PATTERNS[style];
            if (patterns && patterns[section] && patterns[section][variation]) {
                const pattern = patterns[section][variation];
                
                for (let i = 0; i < 16; i++) {
                    state.drumPattern[i] = {
                        kick: pattern.kick[i] === '1',
                        snare: pattern.snare[i] === '1',
                        hihat: pattern.hihat[i] === '1',
                        open: pattern.open[i] === '1'
                    };
                }
                
                updatePatternDisplay();
                updateLaunchpadDisplay();
            }
        }

        function updatePatternDisplay() {
            const instruments = ['kick', 'snare', 'hihat', 'open'];
            
            instruments.forEach((inst, row) => {
                for (let step = 0; step < 16; step++) {
                    const cell = document.querySelector(`.pattern-cell[data-row="${row}"][data-step="${step}"]`);
                    if (cell) {
                        if (state.drumPattern[step][inst]) {
                            cell.classList.add('active');
                        } else {
                            cell.classList.remove('active');
                        }
                    }
                }
            });
        }

        function handlePatternCellMouseDown(e) {
            const row = parseInt(e.target.dataset.row);
            const step = parseInt(e.target.dataset.step);
            const instruments = ['kick', 'snare', 'hihat', 'open'];
            const instrument = instruments[row];
            
            state.drumPattern[step][instrument] = !state.drumPattern[step][instrument];
            e.target.classList.toggle('active');
            
            state.isDragging = true;
            state.dragMode = state.drumPattern[step][instrument];
            state.lastTouchedCell = e.target;
            
            updateLaunchpadDisplay();
        }

        function handlePatternCellMouseEnter(e) {
            if (state.isDragging) {
                const row = parseInt(e.target.dataset.row);
                const step = parseInt(e.target.dataset.step);
                const instruments = ['kick', 'snare', 'hihat', 'open'];
                const instrument = instruments[row];
                
                state.drumPattern[step][instrument] = state.dragMode;
                
                if (state.dragMode) {
                    e.target.classList.add('active');
                } else {
                    e.target.classList.remove('active');
                }
                
                updateLaunchpadDisplay();
            }
        }

        function handlePatternCellTouchStart(e) {
            e.preventDefault();
            handlePatternCellMouseDown(e);
        }

        function handlePatternCellTouchMove(e) {
            e.preventDefault();
            const touch = e.touches[0];
            const element = document.elementFromPoint(touch.clientX, touch.clientY);
            
            if (element && element.classList.contains('pattern-cell') && element !== state.lastTouchedCell) {
                state.lastTouchedCell = element;
                handlePatternCellMouseEnter({ target: element });
            }
        }

        // ==========================================
        // PLAYBACK ENGINE
        // ==========================================
        
        let sequencerTimeout = null;
        
        function togglePlay() {
            if (state.isPlaying) {
                stopPlayback();
            } else {
                startPlayback();
            }
        }

        function startPlayback() {
            if (state.isPlaying) return;
            
            state.isPlaying = true;
            document.getElementById('playBtn').classList.add('playing');
            document.getElementById('playBtn').textContent = '‚ùö‚ùö';
            
            playNextBeat();
        }

        function playNextBeat() {
            if (!state.isPlaying) return;
            
            playCurrentBeat();
            updateBeatDisplay();
            
            state.currentBeat = (state.currentBeat + 1) % 16;
            
            const beatDuration = 60000 / state.tempo / 4;
            let delay = beatDuration;
            
            if (state.swing > 50 && (state.currentBeat % 2) === 1) {
                const swingFactor = (state.swing - 50) / 50;
                delay = beatDuration * (1 + swingFactor * 0.5);
            }
            
            sequencerTimeout = setTimeout(playNextBeat, delay);
        }

        function stopPlayback() {
            state.isPlaying = false;
            state.currentBeat = 0;
            
            if (sequencerTimeout) {
                clearTimeout(sequencerTimeout);
                sequencerTimeout = null;
            }
            
            document.getElementById('playBtn').classList.remove('playing');
            document.getElementById('playBtn').textContent = '‚ñ∂';
            
            // Stop ONLY drum sounds (channel 10) - NOT voice-to-midi
            if (state.midiOutCTK) {
                const drumNotes = [35, 36, 38, 42, 46];
                drumNotes.forEach(note => {
                    state.midiOutCTK.send([0x89, note, 0]);
                });
            }
            
            document.querySelectorAll('.pattern-cell').forEach(cell => {
                cell.classList.remove('playing');
            });
            
            updateLaunchpadDisplay();
        }

        function playCurrentBeat() {
            const pattern = state.drumPattern[state.currentBeat] || { kick: false, snare: false, hihat: false, open: false };
            
            const humanizeAmount = state.humanize / 100;
            const velocityVariation = Math.round((Math.random() - 0.5) * humanizeAmount * 40);
            const finalVelocity = Math.max(1, Math.min(127, state.velocity + velocityVariation));
            
            if (state.midiOutCTK) {
                if (pattern.kick) state.midiOutCTK.send([0x99, 36, finalVelocity]);
                if (pattern.snare) state.midiOutCTK.send([0x99, 38, finalVelocity]);
                if (pattern.hihat) state.midiOutCTK.send([0x99, 42, finalVelocity]);
                if (pattern.open) state.midiOutCTK.send([0x99, 46, finalVelocity]);
                
                // Bass
                const bassNotes = state.bassPattern[state.currentBeat];
                if (bassNotes) {
                    const noteOffsets = [50, 52, 48, 45, 43, 38, 40, 36];
                    state.midiOutCTK.send([0xC0, state.currentBassProgram - 1]);
                    
                    bassNotes.forEach((active, index) => {
                        if (active) {
                            const note = noteOffsets[index];
                            state.midiOutCTK.send([0x90, note, finalVelocity]);
                            setTimeout(() => {
                                if (state.midiOutCTK) state.midiOutCTK.send([0x80, note, 0]);
                            }, 100);
                        }
                    });
                }
            }
        }

        function updateBeatDisplay() {
            document.querySelectorAll('.pattern-cell').forEach(cell => {
                cell.classList.remove('playing');
            });
            
            for (let row = 0; row < 4; row++) {
                const cell = document.querySelector(`.pattern-cell[data-row="${row}"][data-step="${state.currentBeat}"]`);
                if (cell) cell.classList.add('playing');
            }
            
            if (state.launchpadMode === 'session' || state.launchpadMode === 'user2') {
                updateLaunchpadDisplay();
            }
        }

        function toggleRecord() {
            state.isRecording = !state.isRecording;
            document.getElementById('recBtn').classList.toggle('recording');
            
            if (state.isRecording) {
                state.chordProgression = [];
                showMessage('Recording...');
            } else {
                showMessage(`Recorded ${state.chordProgression.length} chords`);
            }
        }

        // ==========================================
        // STYLE & SECTION CONTROLS
        // ==========================================
        
        function selectStyle(style) {
            state.currentStyle = style;
            document.getElementById('styleDisplay').textContent = style;
            
            document.querySelectorAll('.style-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.textContent === style) btn.classList.add('active');
            });
            
            loadPattern(style, state.currentSection, state.currentVariation);
        }

        function selectSection(section) {
            state.currentSection = section;
            document.getElementById('sectionDisplay').textContent = section.toUpperCase();
            
            document.querySelectorAll('.section-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.textContent.toLowerCase() === section) btn.classList.add('active');
            });
            
            loadPattern(state.currentStyle, section, state.currentVariation);
        }

        function selectVariation(variation) {
            state.currentVariation = variation;
            document.getElementById('varDisplay').textContent = variation;
            
            document.querySelectorAll('.var-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.textContent === variation) btn.classList.add('active');
            });
            
            loadPattern(state.currentStyle, state.currentSection, variation);
        }

        // ==========================================
        // TEMPO CONTROL
        // ==========================================
        
        function changeTempo(delta) {
            state.tempo = Math.max(40, Math.min(240, state.tempo + delta));
            document.getElementById('tempoDisplay').textContent = state.tempo;
        }

        function tapTempo() {
            const now = Date.now();
            state.tapTimes.push(now);
            
            if (state.tapTimes.length > 4) state.tapTimes.shift();
            
            if (state.tapTimes.length >= 2) {
                const intervals = [];
                for (let i = 1; i < state.tapTimes.length; i++) {
                    intervals.push(state.tapTimes[i] - state.tapTimes[i - 1]);
                }
                
                const avgInterval = intervals.reduce((a, b) => a + b) / intervals.length;
                const newTempo = Math.round(60000 / avgInterval);
                
                if (newTempo >= 40 && newTempo <= 240) {
                    state.tempo = newTempo;
                    document.getElementById('tempoDisplay').textContent = state.tempo;
                }
            }
        }

        // ==========================================
        // MIDI CONNECTION
        // ==========================================
        
        function connectMIDI() {
            if (navigator.requestMIDIAccess) {
                navigator.requestMIDIAccess({ sysex: true })
                    .then(onMIDISuccess)
                    .catch(onMIDIFailure);
            } else {
                showMessage('WebMIDI not supported');
            }
        }

        function onMIDISuccess(midiAccess) {
            const outputs = Array.from(midiAccess.outputs.values());
            const inputs = Array.from(midiAccess.inputs.values());
            
            // CTK-3200
            const ctkOut = outputs.find(device => 
                device.name.includes('CTK') || 
                device.name.includes('CASIO') ||
                device.name.includes('USB MIDI')
            );
            
            if (ctkOut) {
                state.midiOutCTK = ctkOut;
                document.getElementById('ctkLed').classList.add('active');
                showMessage(`CTK: ${ctkOut.name}`);
            }
            
            // Launchpad MK2
            const lpOut = outputs.find(device => 
                device.name.includes('Launchpad') || 
                device.name.includes('MK2')
            );
            
            const lpIn = inputs.find(device => 
                device.name.includes('Launchpad') || 
                device.name.includes('MK2')
            );
            
            if (lpOut && lpIn) {
                state.midiOutLP = lpOut;
                state.midiInLP = lpIn;
                document.getElementById('lpLed').classList.add('active');
                
                lpIn.onmidimessage = handleLaunchpadMIDI;
                
                initializeLaunchpad();
                
                showMessage(`LP: ${lpOut.name}`);
            }
            
            if (!ctkOut && !lpOut) {
                showMessage('No MIDI devices found');
            }
        }

        function onMIDIFailure() {
            showMessage('MIDI access failed');
        }

        function initializeLaunchpad() {
            if (!state.midiOutLP) return;
            
            state.midiOutLP.send([0xB0, 0, 0]);
            
            setTimeout(() => {
                state.midiOutLP.send([0xB0, LP_MAPPING.topButtons.session, 127]);
                state.midiOutLP.send([0xB0, LP_MAPPING.topButtons.user1, 0]);
                state.midiOutLP.send([0xB0, LP_MAPPING.topButtons.user2, 0]);
                
                updateLaunchpadDisplay();
            }, 100);
        }

        function handleLaunchpadMIDI(message) {
            const [status, data1, data2] = message.data;
            
            if (status === 0x90) {
                if (data2 === 0) {
                    handleLaunchpadNoteOff(data1);
                } else {
                    handleLaunchpadNoteOn(data1, data2);
                }
            } else if (status === 0x80) {
                handleLaunchpadNoteOff(data1);
            } else if (status === 0xB0) {
                handleLaunchpadCC(data1, data2);
            }
        }

        function handleLaunchpadNoteOn(note, velocity) {
            for (let row = 0; row < 8; row++) {
                for (let col = 0; col < 8; col++) {
                    if (LP_MAPPING.pads[row][col] === note) {
                        handleLPPadPress(row, col);
                        return;
                    }
                }
            }
            
            const rightIndex = LP_MAPPING.rightButtons.indexOf(note);
            if (rightIndex !== -1) {
                if (rightIndex === 7) togglePlay();
                else if (rightIndex === 6) stopPlayback();
                else handleLPRightButton(rightIndex);
            }
        }

        function handleLaunchpadNoteOff(note) {
            for (let row = 0; row < 8; row++) {
                for (let col = 0; col < 8; col++) {
                    if (LP_MAPPING.pads[row][col] === note) {
                        handleLPPadRelease(row, col);
                        return;
                    }
                }
            }
        }

        function handleLaunchpadCC(cc, value) {
            if (value === 0) return;
            
            switch(cc) {
                case LP_MAPPING.topButtons.up: handleLPTopButton('up'); break;
                case LP_MAPPING.topButtons.down: handleLPTopButton('down'); break;
                case LP_MAPPING.topButtons.left: handleLPTopButton('left'); break;
                case LP_MAPPING.topButtons.right: handleLPTopButton('right'); break;
                case LP_MAPPING.topButtons.session: setLaunchpadMode('session'); break;
                case LP_MAPPING.topButtons.user1: setLaunchpadMode('user1'); break;
                case LP_MAPPING.topButtons.user2: setLaunchpadMode('user2'); break;
                case LP_MAPPING.topButtons.mixer: handleMixerButton(); break;
            }
        }

        // ==========================================
        // VOICE TO MIDI - FIXED with VU Meter
        // ==========================================
        
        async function startVoiceToMidi() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    audio: { 
                        echoCancellation: false, 
                        noiseSuppression: false, 
                        autoGainControl: false 
                    } 
                });
                
                state.voiceToMidi.mediaStream = stream;
                state.voiceToMidi.audioContext = new (window.AudioContext || window.webkitAudioContext)();
                state.voiceToMidi.analyser = state.voiceToMidi.audioContext.createAnalyser();
                state.voiceToMidi.analyser.fftSize = 2048;
                
                const source = state.voiceToMidi.audioContext.createMediaStreamSource(stream);
                source.connect(state.voiceToMidi.analyser);
                
                state.voiceToMidi.isActive = true;
                
                document.getElementById('voiceStartBtn').classList.add('active');
                document.getElementById('voiceStartBtn').disabled = true;
                document.getElementById('voiceStopBtn').disabled = false;
                document.getElementById('voiceStatus').textContent = 'üü¢ Actif';
                document.getElementById('voiceStatus').classList.add('active');
                document.getElementById('voicePitchDisplay').style.display = 'block';
                
                processVoiceAudio();
                
                showMessage('Voice to MIDI started');
                
            } catch (error) {
                console.error('Voice to MIDI error:', error);
                
                if (error.name === 'NotAllowedError') {
                    showMessage('Permission denied - Allow microphone access');
                } else if (error.name === 'NotFoundError') {
                    showMessage('No microphone found');
                } else if (error.name === 'NotSupportedError') {
                    showMessage('Voice-to-MIDI requires HTTPS');
                } else {
                    showMessage('Error: ' + error.message);
                }
            }
        }

        function stopVoiceToMidi() {
            state.voiceToMidi.isActive = false;
            
            if (state.voiceToMidi.mediaStream) {
                state.voiceToMidi.mediaStream.getTracks().forEach(track => track.stop());
            }
            
            if (state.voiceToMidi.audioContext) {
                state.voiceToMidi.audioContext.close();
            }
            
            if (state.voiceToMidi.currentNote && state.midiOutCTK) {
                state.midiOutCTK.send([0x80 + state.voiceToMidi.channel - 1, state.voiceToMidi.currentNote, 0]);
            }
            
            if (state.voiceToMidi.arpeggiatorInterval) {
                clearInterval(state.voiceToMidi.arpeggiatorInterval);
            }
            
            document.getElementById('voiceStartBtn').classList.remove('active');
            document.getElementById('voiceStartBtn').disabled = false;
            document.getElementById('voiceStopBtn').disabled = true;
            document.getElementById('voiceStatus').textContent = '‚ö´ Inactif';
            document.getElementById('voiceStatus').classList.remove('active');
            document.getElementById('voicePitchDisplay').style.display = 'none';
            
            // Reset VU meter
            document.getElementById('vuMeterBar').style.width = '0%';
            document.getElementById('vuMeterValue').textContent = '0%';
            
            showMessage('Voice to MIDI stopped');
        }

        function processVoiceAudio() {
            if (!state.voiceToMidi.isActive) return;
            
            const analyser = state.voiceToMidi.analyser;
            const bufferLength = analyser.fftSize;
            const buffer = new Float32Array(bufferLength);
            analyser.getFloatTimeDomainData(buffer);
            
            // Calculate RMS for VU meter
            let rms = 0;
            for (let i = 0; i < bufferLength; i++) {
                rms += buffer[i] * buffer[i];
            }
            rms = Math.sqrt(rms / bufferLength);
            
            // Update VU meter (scale to percentage)
            const vuLevel = Math.min(100, Math.round(rms * 500));
            document.getElementById('vuMeterBar').style.width = vuLevel + '%';
            document.getElementById('vuMeterValue').textContent = vuLevel + '%';
            
            // Detect pitch
            const frequency = detectPitch(buffer, state.voiceToMidi.audioContext.sampleRate);
            
            if (frequency > 0) {
                const midiNote = frequencyToMidiNote(frequency);
                const quantizedNote = quantizeToScale(midiNote);
                
                document.getElementById('voicePitchNote').textContent = getNoteInfo(quantizedNote).name + getNoteInfo(quantizedNote).octave;
                document.getElementById('voicePitchFreq').textContent = Math.round(frequency) + ' Hz';
                
                playVoiceMidiNote(quantizedNote);
            }
            
            requestAnimationFrame(processVoiceAudio);
        }

        function detectPitch(buffer, sampleRate) {
            const SIZE = buffer.length;
            const threshold = state.voiceToMidi.sensitivity / 100;
            let rms = 0;
            
            for (let i = 0; i < SIZE; i++) {
                rms += buffer[i] * buffer[i];
            }
            rms = Math.sqrt(rms / SIZE);
            
            if (rms < threshold * 0.01) return -1;
            
            let correlation = [];
            for (let lag = 20; lag < 1000 && lag < SIZE - 1; lag++) {
                let sum = 0;
                for (let i = 0; i < SIZE - lag; i++) {
                    sum += Math.abs(buffer[i] - buffer[i + lag]);
                }
                correlation.push({ lag: lag, val: sum });
            }
            
            let minVal = 1000;
            let minLag = 0;
            for (let i = 0; i < correlation.length; i++) {
                if (correlation[i].val < minVal) {
                    minVal = correlation[i].val;
                    minLag = correlation[i].lag;
                }
            }
            
            const frequency = sampleRate / minLag;
            
            if (frequency < 80 || frequency > 2000) return -1;
            
            return frequency;
        }

        function frequencyToMidiNote(frequency) {
            return Math.round(69 + 12 * Math.log2(frequency / 440));
        }

        function quantizeToScale(midiNote) {
            const selectedScale = state.voiceToMidi.scale;
            
            if (selectedScale === 'chromatic') {
                return midiNote + state.voiceToMidi.transpose;
            }
            
            const scaleIntervals = voiceScales[selectedScale];
            if (!scaleIntervals) return midiNote + state.voiceToMidi.transpose;
            
            const noteInOctave = midiNote % 12;
            const octave = Math.floor(midiNote / 12);
            
            let closestNote = scaleIntervals[0];
            let minDistance = Math.abs(noteInOctave - scaleIntervals[0]);
            
            for (const interval of scaleIntervals) {
                const distance = Math.abs(noteInOctave - interval);
                if (distance < minDistance) {
                    minDistance = distance;
                    closestNote = interval;
                }
            }
            
            return octave * 12 + closestNote + state.voiceToMidi.transpose;
        }

        function playVoiceMidiNote(note) {
            if (!state.midiOutCTK) return;
            
            const now = performance.now();
            
            if (now - state.voiceToMidi.lastNoteTime < 100) return;
            
            if (state.voiceToMidi.currentNote && state.voiceToMidi.currentNote !== note) {
                state.midiOutCTK.send([0x80 + state.voiceToMidi.channel - 1, state.voiceToMidi.currentNote, 0]);
            }
            
            const toneSelect = document.getElementById('voiceToneSelect');
            if (toneSelect) {
                state.midiOutCTK.send([0xC0 + state.voiceToMidi.channel - 1, parseInt(toneSelect.value)]);
            }
            
            if (state.voiceToMidi.reverb > 0) {
                state.midiOutCTK.send([0xB0 + state.voiceToMidi.channel - 1, 91, state.voiceToMidi.reverb]);
            }
            
            const mode = state.voiceToMidi.playMode;
            const velocity = state.voiceToMidi.velocity;
            
            switch(mode) {
                case 'single':
                    state.midiOutCTK.send([0x90 + state.voiceToMidi.channel - 1, note, velocity]);
                    state.voiceToMidi.currentNote = note;
                    break;
                case 'major':
                    playVoiceChord(note, [0, 4, 7]);
                    break;
                case 'minor':
                    playVoiceChord(note, [0, 3, 7]);
                    break;
                case 'arp3':
                    startArpeggiator(note, [0, 4, 7]);
                    break;
                case 'arp4':
                    startArpeggiator(note, [0, 4, 7, 10]);
                    break;
            }
            
            state.voiceToMidi.lastNoteTime = now;
        }

        function playVoiceChord(root, intervals) {
            if (!state.midiOutCTK) return;
            
            state.voiceToMidi.currentChordNotes.forEach(note => {
                state.midiOutCTK.send([0x80 + state.voiceToMidi.channel - 1, note, 0]);
            });
            
            state.voiceToMidi.currentChordNotes = [];
            intervals.forEach(interval => {
                const note = root + interval;
                state.midiOutCTK.send([0x90 + state.voiceToMidi.channel - 1, note, state.voiceToMidi.velocity]);
                state.voiceToMidi.currentChordNotes.push(note);
            });
        }

        function startArpeggiator(root, intervals) {
            if (state.voiceToMidi.arpeggiatorInterval) {
                clearInterval(state.voiceToMidi.arpeggiatorInterval);
            }
            
            state.voiceToMidi.currentArpNotes = intervals.map(i => root + i);
            state.voiceToMidi.arpeggiatorIndex = 0;
            
            const delay = 60000 / (state.tempo * 4);
            
            state.voiceToMidi.arpeggiatorInterval = setInterval(() => {
                if (!state.voiceToMidi.isActive) {
                    clearInterval(state.voiceToMidi.arpeggiatorInterval);
                    return;
                }
                
                if (state.voiceToMidi.currentNote) {
                    state.midiOutCTK.send([0x80 + state.voiceToMidi.channel - 1, state.voiceToMidi.currentNote, 0]);
                }
                
                const note = state.voiceToMidi.currentArpNotes[state.voiceToMidi.arpeggiatorIndex];
                state.midiOutCTK.send([0x90 + state.voiceToMidi.channel - 1, note, state.voiceToMidi.velocity]);
                state.voiceToMidi.currentNote = note;
                
                state.voiceToMidi.arpeggiatorIndex = (state.voiceToMidi.arpeggiatorIndex + 1) % state.voiceToMidi.currentArpNotes.length;
            }, delay);
        }

        function getNoteInfo(midiNote) {
            const noteNames = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'];
            const octave = Math.floor(midiNote / 12) - 1;
            const noteIndex = midiNote % 12;
            return { name: noteNames[noteIndex], octave: octave };
        }

        // ==========================================
        // UTILITY FUNCTIONS
        // ==========================================
        
        function toggleFullscreen() {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen().catch(() => {});
            } else {
                document.exitFullscreen();
            }
        }

        function showMessage(text) {
            const existing = document.querySelector('.toast');
            if (existing) existing.remove();
            
            const toast = document.createElement('div');
            toast.className = 'toast';
            toast.textContent = text;
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.style.animation = 'slideUp 0.3s reverse';
                setTimeout(() => toast.remove(), 300);
            }, 2000);
        }
    </script>
</body>
</html>
