<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>üå∏ Chord Machine</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&family=Outfit:wght@300;400;600;700&display=swap');
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        :root {
            --bg-dark: #0a0a0f;
            --bg-panel: #141420;
            --bg-section: #1a1a2e;
            --accent-orange: #ff6b35;
            --accent-yellow: #ffc234;
            --accent-teal: #00d4aa;
            --accent-purple: #9d4edd;
            --accent-pink: #ff69b4;
            --text-primary: #f0f0f0;
            --text-secondary: #888;
        }
        
        html, body {
            height: 100%;
            overflow: hidden;
        }
        
        body {
            font-family: 'Outfit', sans-serif;
            background: var(--bg-dark);
            color: var(--text-primary);
            background-image: 
                radial-gradient(ellipse at 20% 80%, rgba(157, 78, 221, 0.1) 0%, transparent 50%),
                radial-gradient(ellipse at 80% 20%, rgba(255, 107, 53, 0.1) 0%, transparent 50%);
        }
        
        .app-container {
            height: 100vh;
            display: flex;
            flex-direction: column;
            padding: 10px;
            gap: 10px;
        }
        
        /* Header */
        .header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 8px 15px;
            background: var(--bg-panel);
            border-radius: 10px;
            flex-shrink: 0;
        }
        
        .logo {
            font-family: 'Space Mono', monospace;
            font-size: 1.2rem;
            font-weight: 700;
            background: linear-gradient(135deg, var(--accent-orange), var(--accent-yellow));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            letter-spacing: 2px;
        }
        
        .header-controls {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .header-btn {
            background: var(--bg-section);
            border: 2px solid var(--accent-orange);
            color: var(--accent-orange);
            padding: 8px 16px;
            border-radius: 8px;
            font-family: 'Space Mono', monospace;
            font-size: 0.75rem;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .header-btn:hover {
            background: var(--accent-orange);
            color: #000;
        }
        
        .header-btn.connected {
            border-color: var(--accent-teal);
            color: var(--accent-teal);
        }
        
        .header-btn.connected:hover {
            background: var(--accent-teal);
            color: #000;
        }
        
        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #444;
        }
        
        .status-dot.on {
            background: var(--accent-teal);
            box-shadow: 0 0 8px var(--accent-teal);
        }
        
        .status-dot.active {
            background: var(--accent-orange);
            box-shadow: 0 0 12px var(--accent-orange);
        }
        
        /* Main Content */
        .main-content {
            flex: 1;
            display: grid;
            grid-template-columns: 1fr 280px;
            gap: 10px;
            min-height: 0;
        }
        
        .left-panel {
            display: flex;
            flex-direction: column;
            gap: 10px;
            min-height: 0;
        }
        
        .right-panel {
            display: flex;
            flex-direction: column;
            gap: 10px;
            min-height: 0;
        }
        
        /* Panels */
        .panel {
            background: var(--bg-panel);
            border-radius: 12px;
            padding: 12px;
            border: 1px solid rgba(255,255,255,0.05);
        }
        
        .panel-title {
            font-family: 'Space Mono', monospace;
            font-size: 0.6rem;
            color: var(--accent-orange);
            text-transform: uppercase;
            letter-spacing: 1.5px;
            margin-bottom: 8px;
        }
        
        /* Chord Display */
        .chord-display {
            background: linear-gradient(135deg, var(--bg-section), #1f1f35);
            border-radius: 12px;
            padding: 15px;
            text-align: center;
            border: 1px solid rgba(255,255,255,0.1);
            position: relative;
            flex-shrink: 0;
        }
        
        .chord-display::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: linear-gradient(90deg, var(--accent-orange), var(--accent-yellow), var(--accent-teal));
        }
        
        .chord-name {
            font-family: 'Space Mono', monospace;
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--accent-yellow);
            text-shadow: 0 0 20px rgba(255, 194, 52, 0.5);
        }
        
        .chord-notes {
            font-size: 0.85rem;
            color: var(--text-secondary);
            letter-spacing: 3px;
            margin-top: 5px;
        }
        
        /* Chord Matrix */
        .chord-matrix {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            flex-shrink: 0;
        }
        
        .chord-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 5px;
        }
        
        .chord-btn {
            background: var(--bg-section);
            border: 2px solid transparent;
            color: var(--text-primary);
            padding: 10px 5px;
            border-radius: 8px;
            font-family: 'Space Mono', monospace;
            font-size: 0.75rem;
            cursor: pointer;
            transition: all 0.15s;
        }
        
        .chord-btn:hover {
            border-color: var(--accent-orange);
        }
        
        .chord-btn.active {
            background: var(--accent-orange);
            color: #000;
            box-shadow: 0 0 15px rgba(255, 107, 53, 0.4);
        }
        
        .chord-btn.ext.active {
            background: var(--accent-yellow);
        }
        
        /* Key Selector */
        .key-selector {
            display: flex;
            gap: 4px;
            justify-content: center;
            flex-wrap: wrap;
        }
        
        .key-btn {
            width: 36px;
            height: 36px;
            background: var(--bg-section);
            border: 2px solid transparent;
            color: var(--text-primary);
            border-radius: 6px;
            font-family: 'Space Mono', monospace;
            font-size: 0.75rem;
            cursor: pointer;
            transition: all 0.15s;
        }
        
        .key-btn.black {
            background: #1a1a1a;
        }
        
        .key-btn:hover {
            border-color: var(--accent-teal);
        }
        
        .key-btn.active {
            background: var(--accent-teal);
            color: #000;
            box-shadow: 0 0 12px rgba(0, 212, 170, 0.4);
        }
        
        /* Knobs Row */
        .knobs-row {
            display: flex;
            justify-content: space-around;
            align-items: center;
            padding: 10px 0;
            flex-shrink: 0;
        }
        
        .knob-container {
            text-align: center;
        }
        
        .knob {
            width: 60px;
            height: 60px;
            background: conic-gradient(from 220deg, var(--accent-orange), var(--accent-yellow), var(--accent-teal), var(--accent-purple), var(--accent-orange));
            border-radius: 50%;
            position: relative;
            cursor: pointer;
            box-shadow: 0 0 20px rgba(255, 107, 53, 0.2), inset 0 0 20px rgba(0,0,0,0.5);
        }
        
        .knob::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 42px;
            height: 42px;
            background: var(--bg-dark);
            border-radius: 50%;
            transform: translate(-50%, -50%);
        }
        
        .knob-indicator {
            position: absolute;
            top: 6px;
            left: 50%;
            width: 3px;
            height: 14px;
            background: #fff;
            border-radius: 2px;
            transform-origin: center 24px;
            z-index: 1;
        }
        
        .knob-label {
            font-size: 0.55rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            margin-top: 6px;
        }
        
        .knob-value {
            font-family: 'Space Mono', monospace;
            font-size: 0.9rem;
            color: var(--accent-teal);
        }
        
        /* Performance Modes */
        .perf-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 6px;
        }
        
        .perf-btn {
            background: var(--bg-section);
            border: 2px solid rgba(255,255,255,0.1);
            color: var(--text-primary);
            padding: 8px 4px;
            border-radius: 8px;
            font-size: 0.6rem;
            text-transform: uppercase;
            cursor: pointer;
            transition: all 0.15s;
            text-align: center;
        }
        
        .perf-btn .icon {
            font-size: 1.2rem;
            display: block;
            margin-bottom: 2px;
        }
        
        .perf-btn:hover {
            border-color: var(--accent-purple);
        }
        
        .perf-btn.active {
            background: var(--accent-purple);
            color: #fff;
            box-shadow: 0 0 15px rgba(157, 78, 221, 0.5);
        }
        
        /* Tempo Row */
        .tempo-row {
            display: flex;
            gap: 10px;
            align-items: stretch;
        }
        
        .tempo-box {
            flex: 1;
            background: var(--bg-section);
            border-radius: 8px;
            padding: 10px;
            text-align: center;
        }
        
        .tempo-value {
            font-family: 'Space Mono', monospace;
            font-size: 1.5rem;
            color: var(--accent-yellow);
        }
        
        .tempo-slider {
            width: 100%;
            margin-top: 5px;
            accent-color: var(--accent-orange);
        }
        
        .loop-btn {
            width: 70px;
            background: var(--bg-section);
            border: 2px solid rgba(255,255,255,0.1);
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            color: var(--text-primary);
        }
        
        .loop-btn:hover {
            border-color: var(--accent-pink);
        }
        
        .loop-btn.recording {
            background: #3a1520;
            border-color: #ff4444;
            animation: rec-pulse 1s infinite;
        }
        
        .loop-btn.playing {
            background: #152a35;
            border-color: var(--accent-teal);
        }
        
        @keyframes rec-pulse {
            0%, 100% { box-shadow: 0 0 5px rgba(255, 68, 68, 0.3); }
            50% { box-shadow: 0 0 15px rgba(255, 68, 68, 0.6); }
        }
        
        .loop-icon {
            font-size: 1.3rem;
        }
        
        .loop-text {
            font-size: 0.55rem;
            text-transform: uppercase;
        }
        
        /* Visual Keyboard */
        .keyboard-container {
            display: flex;
            justify-content: center;
            padding: 10px;
            background: var(--bg-section);
            border-radius: 10px;
            flex-shrink: 0;
        }
        
        .vkey {
            width: 28px;
            height: 70px;
            background: linear-gradient(180deg, #f5f5f5, #ddd);
            border-radius: 0 0 4px 4px;
            cursor: pointer;
            transition: all 0.1s;
            position: relative;
            margin: 0 1px;
        }
        
        .vkey:hover {
            background: linear-gradient(180deg, #fff, #eee);
        }
        
        .vkey.active {
            background: linear-gradient(180deg, var(--accent-yellow), var(--accent-orange));
            box-shadow: 0 0 10px rgba(255, 194, 52, 0.5);
        }
        
        .vkey.black {
            width: 20px;
            height: 45px;
            background: linear-gradient(180deg, #333, #111);
            margin: 0 -10px;
            z-index: 1;
        }
        
        .vkey.black:hover {
            background: linear-gradient(180deg, #444, #222);
        }
        
        .vkey.black.active {
            background: linear-gradient(180deg, var(--accent-purple), #6a2c9a);
        }
        
        /* Right Panel Components */
        .engine-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 5px;
            margin-bottom: 10px;
        }
        
        .engine-btn {
            background: var(--bg-section);
            border: 1px solid rgba(255,255,255,0.1);
            color: var(--text-secondary);
            padding: 8px 5px;
            border-radius: 6px;
            font-size: 0.6rem;
            cursor: pointer;
            text-transform: uppercase;
        }
        
        .engine-btn.active {
            background: linear-gradient(135deg, var(--accent-purple), var(--accent-pink));
            color: #fff;
        }
        
        .fx-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
        }
        
        .fx-item {
            text-align: center;
        }
        
        .fx-label {
            font-size: 0.55rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            margin-bottom: 4px;
        }
        
        .fx-slider {
            width: 100%;
            accent-color: var(--accent-teal);
        }
        
        /* Beat Grid */
        .beat-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 4px;
        }
        
        .beat-btn {
            background: var(--bg-section);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 5px;
            color: var(--text-secondary);
            font-size: 0.55rem;
            padding: 6px 2px;
            cursor: pointer;
            transition: all 0.15s;
        }
        
        .beat-btn:hover {
            border-color: var(--accent-pink);
        }
        
        .beat-btn.active {
            background: var(--accent-pink);
            color: #fff;
        }
        
        /* MIDI Config */
        .midi-config {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }
        
        .midi-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 6px 10px;
            background: var(--bg-section);
            border-radius: 5px;
            font-size: 0.7rem;
        }
        
        .midi-select {
            background: var(--bg-dark);
            border: 1px solid rgba(255,255,255,0.1);
            color: var(--text-primary);
            padding: 3px 6px;
            border-radius: 4px;
            font-family: 'Space Mono', monospace;
            font-size: 0.65rem;
            width: 70px;
        }
        
        /* Volume Section */
        .volume-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }
        
        .vol-item {
            background: var(--bg-section);
            border-radius: 6px;
            padding: 8px;
            text-align: center;
        }
        
        .vol-label {
            font-size: 0.55rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            margin-bottom: 5px;
        }
        
        /* MIDI Modal */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.8);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        
        .modal-overlay.show {
            display: flex;
        }
        
        .modal {
            background: var(--bg-panel);
            border-radius: 16px;
            padding: 25px;
            max-width: 400px;
            width: 90%;
            border: 1px solid var(--accent-orange);
            box-shadow: 0 0 40px rgba(255, 107, 53, 0.3);
        }
        
        .modal-title {
            font-family: 'Space Mono', monospace;
            font-size: 1.2rem;
            color: var(--accent-orange);
            margin-bottom: 15px;
            text-align: center;
        }
        
        .modal-text {
            color: var(--text-secondary);
            font-size: 0.85rem;
            margin-bottom: 20px;
            text-align: center;
            line-height: 1.5;
        }
        
        .modal-select-group {
            margin-bottom: 15px;
        }
        
        .modal-select-group label {
            display: block;
            font-size: 0.7rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            margin-bottom: 5px;
        }
        
        .modal-select-group select {
            width: 100%;
            background: var(--bg-section);
            border: 1px solid rgba(255,255,255,0.2);
            color: var(--text-primary);
            padding: 10px;
            border-radius: 8px;
            font-family: 'Space Mono', monospace;
            font-size: 0.85rem;
        }
        
        .modal-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        
        .modal-btn {
            flex: 1;
            padding: 12px;
            border-radius: 8px;
            font-family: 'Space Mono', monospace;
            font-size: 0.85rem;
            cursor: pointer;
            border: 2px solid;
            transition: all 0.2s;
        }
        
        .modal-btn.primary {
            background: var(--accent-orange);
            border-color: var(--accent-orange);
            color: #000;
        }
        
        .modal-btn.primary:hover {
            background: var(--accent-yellow);
            border-color: var(--accent-yellow);
        }
        
        .modal-btn.secondary {
            background: transparent;
            border-color: var(--text-secondary);
            color: var(--text-secondary);
        }
        
        .modal-btn.secondary:hover {
            border-color: var(--text-primary);
            color: var(--text-primary);
        }
        
        /* Responsive */
        @media (max-height: 700px) {
            .chord-name { font-size: 2rem; }
            .knob { width: 50px; height: 50px; }
            .knob::after { width: 35px; height: 35px; }
            .knob-indicator { height: 12px; transform-origin: center 19px; }
            .vkey { height: 55px; }
            .vkey.black { height: 35px; }
        }
        
        @media (max-width: 900px) {
            .main-content {
                grid-template-columns: 1fr;
            }
            .right-panel {
                display: none;
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Header -->
        <header class="header">
            <div class="logo">üå∏ CHORD MACHINE</div>
            <div class="header-controls">
                <button class="header-btn" id="midiBtn">
                    <span class="status-dot" id="statusDot"></span>
                    <span id="midiStatus">Connecter MIDI</span>
                </button>
                <button class="header-btn" id="fullscreenBtn">‚õ∂ Plein √©cran</button>
            </div>
        </header>
        
        <!-- Main Content -->
        <div class="main-content">
            <!-- Left Panel -->
            <div class="left-panel">
                <!-- Chord Display -->
                <div class="chord-display">
                    <div class="chord-name" id="chordName">C</div>
                    <div class="chord-notes" id="chordNotes">C ‚Ä¢ E ‚Ä¢ G</div>
                </div>
                
                <!-- Chord Matrix -->
                <div class="panel chord-matrix">
                    <div>
                        <div class="panel-title">Type</div>
                        <div class="chord-grid">
                            <button class="chord-btn active" data-type="maj">MAJ</button>
                            <button class="chord-btn" data-type="min">MIN</button>
                            <button class="chord-btn" data-type="dim">DIM</button>
                            <button class="chord-btn" data-type="aug">AUG</button>
                            <button class="chord-btn" data-type="sus2">SUS2</button>
                            <button class="chord-btn" data-type="sus4">SUS4</button>
                            <button class="chord-btn" data-type="power">5TH</button>
                            <button class="chord-btn" data-type="add9">ADD9</button>
                        </div>
                    </div>
                    <div>
                        <div class="panel-title">Extension</div>
                        <div class="chord-grid">
                            <button class="chord-btn ext active" data-ext="none">‚Äî</button>
                            <button class="chord-btn ext" data-ext="7">7</button>
                            <button class="chord-btn ext" data-ext="maj7">M7</button>
                            <button class="chord-btn ext" data-ext="9">9</button>
                            <button class="chord-btn ext" data-ext="11">11</button>
                            <button class="chord-btn ext" data-ext="13">13</button>
                            <button class="chord-btn ext" data-ext="6">6</button>
                            <button class="chord-btn ext" data-ext="69">6/9</button>
                        </div>
                    </div>
                </div>
                
                <!-- Key Selection + Knobs -->
                <div class="panel">
                    <div class="panel-title">Tonalit√©</div>
                    <div class="key-selector">
                        <button class="key-btn active" data-note="0">C</button>
                        <button class="key-btn black" data-note="1">C#</button>
                        <button class="key-btn" data-note="2">D</button>
                        <button class="key-btn black" data-note="3">D#</button>
                        <button class="key-btn" data-note="4">E</button>
                        <button class="key-btn" data-note="5">F</button>
                        <button class="key-btn black" data-note="6">F#</button>
                        <button class="key-btn" data-note="7">G</button>
                        <button class="key-btn black" data-note="8">G#</button>
                        <button class="key-btn" data-note="9">A</button>
                        <button class="key-btn black" data-note="10">A#</button>
                        <button class="key-btn" data-note="11">B</button>
                    </div>
                    <div class="knobs-row">
                        <div class="knob-container">
                            <div class="knob" id="voicingKnob">
                                <div class="knob-indicator" id="voicingIndicator"></div>
                            </div>
                            <div class="knob-label">Voicing</div>
                            <div class="knob-value" id="voicingValue">0</div>
                        </div>
                        <div class="knob-container">
                            <div class="knob" id="spreadKnob">
                                <div class="knob-indicator" id="spreadIndicator"></div>
                            </div>
                            <div class="knob-label">Spread</div>
                            <div class="knob-value" id="spreadValue">1</div>
                        </div>
                        <div class="knob-container">
                            <div class="knob" id="octaveKnob">
                                <div class="knob-indicator" id="octaveIndicator"></div>
                            </div>
                            <div class="knob-label">Octave</div>
                            <div class="knob-value" id="octaveValue">4</div>
                        </div>
                    </div>
                </div>
                
                <!-- Performance + Tempo -->
                <div class="panel">
                    <div class="panel-title">Performance</div>
                    <div class="perf-grid">
                        <button class="perf-btn active" data-mode="hold"><span class="icon">üéπ</span>Hold</button>
                        <button class="perf-btn" data-mode="arp"><span class="icon">‚ÜóÔ∏è</span>Arp</button>
                        <button class="perf-btn" data-mode="strum"><span class="icon">üé∏</span>Strum</button>
                        <button class="perf-btn" data-mode="harp"><span class="icon">üéª</span>Harp</button>
                        <button class="perf-btn" data-mode="random"><span class="icon">üé≤</span>Random</button>
                    </div>
                    <div class="tempo-row" style="margin-top: 10px;">
                        <div class="tempo-box">
                            <div class="fx-label">BPM</div>
                            <div class="tempo-value" id="bpmDisplay">120</div>
                            <input type="range" class="tempo-slider" id="bpmSlider" min="40" max="200" value="120">
                        </div>
                        <button class="loop-btn" id="loopBtn">
                            <span class="loop-icon" id="loopIcon">‚è∫Ô∏è</span>
                            <span class="loop-text" id="loopText">Loop</span>
                        </button>
                    </div>
                </div>
                
                <!-- Visual Keyboard -->
                <div class="panel">
                    <div class="keyboard-container" id="visualKeyboard">
                        <div class="vkey" data-note="48"></div>
                        <div class="vkey black" data-note="49"></div>
                        <div class="vkey" data-note="50"></div>
                        <div class="vkey black" data-note="51"></div>
                        <div class="vkey" data-note="52"></div>
                        <div class="vkey" data-note="53"></div>
                        <div class="vkey black" data-note="54"></div>
                        <div class="vkey" data-note="55"></div>
                        <div class="vkey black" data-note="56"></div>
                        <div class="vkey" data-note="57"></div>
                        <div class="vkey black" data-note="58"></div>
                        <div class="vkey" data-note="59"></div>
                        <div class="vkey" data-note="60"></div>
                    </div>
                </div>
            </div>
            
            <!-- Right Panel -->
            <div class="right-panel">
                <!-- Synth Engine -->
                <div class="panel">
                    <div class="panel-title">Synth Engine</div>
                    <div class="engine-grid">
                        <button class="engine-btn active" data-engine="analog">Analog</button>
                        <button class="engine-btn" data-engine="fm">FM</button>
                        <button class="engine-btn" data-engine="epiano">E-Piano</button>
                    </div>
                    <div class="fx-grid">
                        <div class="fx-item">
                            <div class="fx-label">Reverb</div>
                            <input type="range" class="fx-slider" id="reverbSlider" min="0" max="100" value="30">
                        </div>
                        <div class="fx-item">
                            <div class="fx-label">Chorus</div>
                            <input type="range" class="fx-slider" id="chorusSlider" min="0" max="100" value="0">
                        </div>
                        <div class="fx-item">
                            <div class="fx-label">Delay</div>
                            <input type="range" class="fx-slider" id="delaySlider" min="0" max="100" value="0">
                        </div>
                    </div>
                </div>
                
                <!-- Volume -->
                <div class="panel">
                    <div class="panel-title">Levels</div>
                    <div class="volume-row">
                        <div class="vol-item">
                            <div class="vol-label">Main</div>
                            <input type="range" class="fx-slider" id="mainVolume" min="0" max="100" value="70">
                        </div>
                        <div class="vol-item">
                            <div class="vol-label">Bass</div>
                            <input type="range" class="fx-slider" id="bassVolume" min="0" max="100" value="50">
                        </div>
                    </div>
                </div>
                
                <!-- Beat Machine -->
                <div class="panel">
                    <div class="panel-title">Beat Machine</div>
                    <div class="beat-grid">
                        <button class="beat-btn active" data-beat="0">OFF</button>
                        <button class="beat-btn" data-beat="1">Rock</button>
                        <button class="beat-btn" data-beat="2">Pop</button>
                        <button class="beat-btn" data-beat="3">Funk</button>
                        <button class="beat-btn" data-beat="4">Jazz</button>
                        <button class="beat-btn" data-beat="5">Bossa</button>
                        <button class="beat-btn" data-beat="6">R&B</button>
                        <button class="beat-btn" data-beat="7">House</button>
                        <button class="beat-btn" data-beat="8">Hip Hop</button>
                        <button class="beat-btn" data-beat="9">Trap</button>
                        <button class="beat-btn" data-beat="10">Chill</button>
                        <button class="beat-btn" data-beat="11">Ballad</button>
                    </div>
                </div>
                
                <!-- MIDI Channels -->
                <div class="panel">
                    <div class="panel-title">MIDI Out</div>
                    <div class="midi-config">
                        <div class="midi-row">
                            <span>Chords</span>
                            <select class="midi-select" id="chordChannel">
                                <option value="0">Ch 1</option>
                                <option value="1">Ch 2</option>
                                <option value="2">Ch 3</option>
                                <option value="3">Ch 4</option>
                            </select>
                        </div>
                        <div class="midi-row">
                            <span>Bass</span>
                            <select class="midi-select" id="bassChannel">
                                <option value="0">Ch 1</option>
                                <option value="1" selected>Ch 2</option>
                                <option value="2">Ch 3</option>
                                <option value="3">Ch 4</option>
                            </select>
                        </div>
                        <div class="midi-row">
                            <span>Drums</span>
                            <select class="midi-select" id="drumChannel">
                                <option value="9" selected>Ch 10</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- MIDI Modal -->
    <div class="modal-overlay" id="midiModal">
        <div class="modal">
            <div class="modal-title">üéπ Connexion MIDI</div>
            <div class="modal-text">S√©lectionnez vos p√©riph√©riques MIDI pour connecter votre MPK et envoyer des accords vers vos instruments.</div>
            
            <div class="modal-select-group">
                <label>Entr√©e MIDI (votre contr√¥leur)</label>
                <select id="modalMidiInput">
                    <option value="">-- Aucune entr√©e --</option>
                </select>
            </div>
            
            <div class="modal-select-group">
                <label>Sortie MIDI (synth√© externe)</label>
                <select id="modalMidiOutput">
                    <option value="">-- Audio interne seulement --</option>
                </select>
            </div>
            
            <div class="modal-buttons">
                <button class="modal-btn secondary" id="modalCancel">Annuler</button>
                <button class="modal-btn primary" id="modalConnect">Connecter</button>
            </div>
        </div>
    </div>

    <script>
        // ============================================
        // üå∏ CHORD MACHINE - Orchid Style
        // ============================================
        
        // Audio Context
        let audioCtx = null;
        let masterGain = null;
        
        // MIDI
        let midiAccess = null;
        let midiInput = null;
        let midiOutput = null;
        let midiInitialized = false;
        
        // State
        const state = {
            rootNote: 0,
            chordType: 'maj',
            extension: 'none',
            voicing: 0,
            spread: 1,
            octave: 4,
            performanceMode: 'hold',
            bpm: 120,
            engine: 'analog',
            reverb: 0.3,
            chorus: 0,
            delay: 0,
            mainVolume: 0.7,
            bassVolume: 0.5,
            chordChannel: 0,
            bassChannel: 1,
            drumChannel: 9,
            activeNotes: new Map(),
            activeOscillators: new Map(),
            arpInterval: null,
            arpIndex: 0,
            arpNotes: [],
            loopState: 'stopped',
            loopData: [],
            loopStartTime: 0,
            loopInterval: null,
            beatPattern: null,
            beatInterval: null,
            beatStep: 0
        };
        
        const NOTE_NAMES = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'];
        
        const CHORD_FORMULAS = {
            maj: [0, 4, 7],
            min: [0, 3, 7],
            dim: [0, 3, 6],
            aug: [0, 4, 8],
            sus2: [0, 2, 7],
            sus4: [0, 5, 7],
            power: [0, 7],
            add9: [0, 4, 7, 14]
        };
        
        const EXTENSIONS = {
            none: [],
            '7': [10],
            maj7: [11],
            '9': [10, 14],
            '11': [10, 14, 17],
            '13': [10, 14, 17, 21],
            '6': [9],
            '69': [9, 14]
        };
        
        const BEAT_PATTERNS = {
            0: null,
            1: { pattern: [1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0], accent: [1,0,0,0,1,0,0,0] },
            2: { pattern: [1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,1], accent: [1,0,0,0,1,0,0,0] },
            3: { pattern: [1,0,1,1,0,1,0,1,1,0,1,1,0,1,1,0], accent: [1,0,0,1,0,0,1,0] },
            4: { pattern: [1,0,0,1,0,1,0,0,1,0,0,1,0,1,0,1], accent: [1,0,0,0,1,0,0,0] },
            5: { pattern: [1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,0], accent: [1,0,0,0,0,0,1,0] },
            6: { pattern: [1,0,0,1,0,1,1,0,1,0,0,1,0,1,0,1], accent: [1,0,0,0,1,0,0,0] },
            7: { pattern: [1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0], accent: [1,0,0,0,1,0,0,0] },
            8: { pattern: [1,0,0,0,0,0,1,0,0,0,1,0,0,0,0,1], accent: [1,0,0,0,0,0,1,0] },
            9: { pattern: [1,1,0,1,1,0,1,1,0,1,1,0,1,0,1,1], accent: [1,0,0,0,1,0,0,0] },
            10: { pattern: [1,0,0,0,0,1,0,0,1,0,0,0,0,1,0,0], accent: [1,0,0,0,0,0,0,0] },
            11: { pattern: [1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0], accent: [1,0,0,0,0,0,0,0] }
        };
        
        // ============================================
        // AUDIO
        // ============================================
        
        function initAudio() {
            if (audioCtx) return;
            audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            masterGain = audioCtx.createGain();
            masterGain.gain.value = state.mainVolume;
            masterGain.connect(audioCtx.destination);
        }
        
        function playNote(midiNote, velocity = 100) {
            if (!audioCtx) initAudio();
            if (audioCtx.state === 'suspended') audioCtx.resume();
            
            const freq = 440 * Math.pow(2, (midiNote - 69) / 12);
            const vol = (velocity / 127) * state.mainVolume * 0.15;
            
            let oscData;
            switch (state.engine) {
                case 'analog': oscData = createAnalogOsc(freq, vol); break;
                case 'fm': oscData = createFMOsc(freq, vol); break;
                case 'epiano': oscData = createEPianoOsc(freq, vol); break;
            }
            
            if (oscData) state.activeOscillators.set(midiNote, oscData);
        }
        
        function createAnalogOsc(freq, vol) {
            const osc = audioCtx.createOscillator();
            const osc2 = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            const filter = audioCtx.createBiquadFilter();
            
            osc.type = 'sawtooth';
            osc.frequency.value = freq;
            osc2.type = 'square';
            osc2.frequency.value = freq * 1.005;
            
            filter.type = 'lowpass';
            filter.frequency.value = 2000 + freq * 2;
            filter.Q.value = 2;
            
            gain.gain.setValueAtTime(0, audioCtx.currentTime);
            gain.gain.linearRampToValueAtTime(vol, audioCtx.currentTime + 0.02);
            
            osc.connect(filter);
            osc2.connect(filter);
            filter.connect(gain);
            gain.connect(masterGain);
            
            osc.start();
            osc2.start();
            
            return { osc: [osc, osc2], gain };
        }
        
        function createFMOsc(freq, vol) {
            const carrier = audioCtx.createOscillator();
            const modulator = audioCtx.createOscillator();
            const modGain = audioCtx.createGain();
            const gain = audioCtx.createGain();
            
            carrier.type = 'sine';
            carrier.frequency.value = freq;
            modulator.type = 'sine';
            modulator.frequency.value = freq * 2;
            modGain.gain.value = freq * 0.5;
            
            gain.gain.setValueAtTime(0, audioCtx.currentTime);
            gain.gain.linearRampToValueAtTime(vol * 1.5, audioCtx.currentTime + 0.01);
            
            modulator.connect(modGain);
            modGain.connect(carrier.frequency);
            carrier.connect(gain);
            gain.connect(masterGain);
            
            carrier.start();
            modulator.start();
            
            return { osc: [carrier, modulator], gain };
        }
        
        function createEPianoOsc(freq, vol) {
            const osc = audioCtx.createOscillator();
            const osc2 = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            
            osc.type = 'sine';
            osc.frequency.value = freq;
            osc2.type = 'triangle';
            osc2.frequency.value = freq * 2;
            
            gain.gain.setValueAtTime(0, audioCtx.currentTime);
            gain.gain.linearRampToValueAtTime(vol, audioCtx.currentTime + 0.005);
            gain.gain.exponentialRampToValueAtTime(vol * 0.3, audioCtx.currentTime + 0.5);
            
            osc.connect(gain);
            osc2.connect(gain);
            gain.connect(masterGain);
            
            osc.start();
            osc2.start();
            
            return { osc: [osc, osc2], gain };
        }
        
        function stopNote(midiNote) {
            const oscData = state.activeOscillators.get(midiNote);
            if (oscData) {
                oscData.gain.gain.linearRampToValueAtTime(0, audioCtx.currentTime + 0.1);
                setTimeout(() => oscData.osc.forEach(o => o.stop()), 150);
                state.activeOscillators.delete(midiNote);
            }
        }
        
        // Bass
        let bassOsc = null, bassGain = null;
        
        function playBass(note, velocity) {
            if (!audioCtx) initAudio();
            const freq = 440 * Math.pow(2, (note - 69) / 12);
            const vol = (velocity / 127) * state.bassVolume * 0.2;
            
            if (bassOsc) bassOsc.forEach(o => o.stop());
            
            const osc = audioCtx.createOscillator();
            const osc2 = audioCtx.createOscillator();
            bassGain = audioCtx.createGain();
            
            osc.type = 'sine';
            osc.frequency.value = freq;
            osc2.type = 'triangle';
            osc2.frequency.value = freq;
            
            bassGain.gain.setValueAtTime(0, audioCtx.currentTime);
            bassGain.gain.linearRampToValueAtTime(vol, audioCtx.currentTime + 0.02);
            
            osc.connect(bassGain);
            osc2.connect(bassGain);
            bassGain.connect(masterGain);
            
            osc.start();
            osc2.start();
            bassOsc = [osc, osc2];
            
            sendMidiNoteOn(note, velocity, state.bassChannel);
        }
        
        function stopBass() {
            if (bassOsc && bassGain) {
                bassGain.gain.linearRampToValueAtTime(0, audioCtx.currentTime + 0.1);
                setTimeout(() => { bassOsc.forEach(o => o.stop()); bassOsc = null; }, 150);
            }
        }
        
        // Drums
        function playKick(vol) {
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.frequency.setValueAtTime(150, audioCtx.currentTime);
            osc.frequency.exponentialRampToValueAtTime(40, audioCtx.currentTime + 0.1);
            gain.gain.setValueAtTime(vol, audioCtx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.3);
            osc.connect(gain);
            gain.connect(masterGain);
            osc.start();
            osc.stop(audioCtx.currentTime + 0.3);
        }
        
        function playSnare(vol) {
            const noise = audioCtx.createBufferSource();
            const buf = audioCtx.createBuffer(1, audioCtx.sampleRate * 0.2, audioCtx.sampleRate);
            const data = buf.getChannelData(0);
            for (let i = 0; i < data.length; i++) data[i] = Math.random() * 2 - 1;
            noise.buffer = buf;
            const filter = audioCtx.createBiquadFilter();
            filter.type = 'highpass';
            filter.frequency.value = 1000;
            const gain = audioCtx.createGain();
            gain.gain.setValueAtTime(vol * 0.5, audioCtx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.15);
            noise.connect(filter);
            filter.connect(gain);
            gain.connect(masterGain);
            noise.start();
        }
        
        function playHihat(vol) {
            const noise = audioCtx.createBufferSource();
            const buf = audioCtx.createBuffer(1, audioCtx.sampleRate * 0.05, audioCtx.sampleRate);
            const data = buf.getChannelData(0);
            for (let i = 0; i < data.length; i++) data[i] = Math.random() * 2 - 1;
            noise.buffer = buf;
            const filter = audioCtx.createBiquadFilter();
            filter.type = 'highpass';
            filter.frequency.value = 7000;
            const gain = audioCtx.createGain();
            gain.gain.setValueAtTime(vol * 0.3, audioCtx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.05);
            noise.connect(filter);
            filter.connect(gain);
            gain.connect(masterGain);
            noise.start();
        }
        
        // ============================================
        // CHORDS
        // ============================================
        
        function buildChord(root, type, ext, voicing, spread, octave) {
            let intervals = [...CHORD_FORMULAS[type]];
            if (ext !== 'none') intervals = intervals.concat(EXTENSIONS[ext]);
            
            for (let i = 0; i < voicing; i++) {
                if (intervals.length > 1) {
                    intervals.push(intervals.shift() + 12);
                }
            }
            
            if (spread > 1) {
                intervals = intervals.map((int, idx) => int + Math.floor(idx / 2) * 12 * (spread - 1));
            }
            
            const baseMidi = 12 + octave * 12 + root;
            return intervals.map(i => baseMidi + i);
        }
        
        function getChordName() {
            const root = NOTE_NAMES[state.rootNote];
            let type = '';
            switch (state.chordType) {
                case 'min': type = 'm'; break;
                case 'dim': type = '¬∞'; break;
                case 'aug': type = '+'; break;
                case 'sus2': type = 'sus2'; break;
                case 'sus4': type = 'sus4'; break;
                case 'power': type = '5'; break;
                case 'add9': type = 'add9'; break;
            }
            let ext = state.extension !== 'none' ? (state.extension === 'maj7' ? 'maj7' : state.extension) : '';
            return root + type + ext;
        }
        
        function updateChordDisplay() {
            const notes = buildChord(state.rootNote, state.chordType, state.extension, state.voicing, state.spread, state.octave);
            document.getElementById('chordName').textContent = getChordName();
            document.getElementById('chordNotes').textContent = notes.map(n => NOTE_NAMES[n % 12]).join(' ‚Ä¢ ');
        }
        
        // ============================================
        // CHORD TRIGGERING
        // ============================================
        
        function triggerChord(inputNote, velocity) {
            const inputRoot = inputNote % 12;
            const chordNotes = buildChord(inputRoot, state.chordType, state.extension, state.voicing, state.spread, state.octave);
            
            state.rootNote = inputRoot;
            updateRootSelection();
            updateChordDisplay();
            
            if (state.arpInterval) {
                clearInterval(state.arpInterval);
                state.arpInterval = null;
            }
            
            state.activeNotes.forEach(notes => {
                notes.forEach(n => {
                    stopNote(n);
                    sendMidiNoteOff(n, state.chordChannel);
                });
            });
            state.activeNotes.clear();
            
            if (state.loopState === 'recording') {
                state.loopData.push({
                    type: 'chord',
                    time: Date.now() - state.loopStartTime,
                    notes: chordNotes,
                    velocity,
                    root: inputRoot
                });
            }
            
            switch (state.performanceMode) {
                case 'hold': playChordHold(chordNotes, velocity, inputNote); break;
                case 'arp': playChordArp(chordNotes, velocity, inputNote); break;
                case 'strum': playChordStrum(chordNotes, velocity, inputNote); break;
                case 'harp': playChordHarp(chordNotes, velocity, inputNote); break;
                case 'random': playChordRandom(chordNotes, velocity, inputNote); break;
            }
            
            const bassNote = inputRoot + (state.octave - 1) * 12 + 12;
            playBass(bassNote, velocity);
            updateVisualKeyboard(chordNotes);
        }
        
        function releaseChord(inputNote) {
            const notes = state.activeNotes.get(inputNote);
            if (notes) {
                notes.forEach(n => {
                    stopNote(n);
                    sendMidiNoteOff(n, state.chordChannel);
                });
                state.activeNotes.delete(inputNote);
            }
            
            if (state.arpInterval) {
                clearInterval(state.arpInterval);
                state.arpInterval = null;
                state.arpNotes.forEach(n => {
                    stopNote(n);
                    sendMidiNoteOff(n, state.chordChannel);
                });
            }
            
            stopBass();
            document.querySelectorAll('.vkey.active').forEach(k => k.classList.remove('active'));
        }
        
        function playChordHold(notes, velocity, inputNote) {
            notes.forEach(n => {
                playNote(n, velocity);
                sendMidiNoteOn(n, velocity, state.chordChannel);
            });
            state.activeNotes.set(inputNote, notes);
        }
        
        function playChordArp(notes, velocity, inputNote) {
            state.arpNotes = notes;
            state.arpIndex = 0;
            state.activeNotes.set(inputNote, []);
            
            const interval = 60000 / state.bpm / 4;
            const play = () => {
                state.arpNotes.forEach(n => {
                    stopNote(n);
                    sendMidiNoteOff(n, state.chordChannel);
                });
                const note = state.arpNotes[state.arpIndex];
                playNote(note, velocity);
                sendMidiNoteOn(note, velocity, state.chordChannel);
                document.querySelectorAll('.vkey.active').forEach(k => k.classList.remove('active'));
                const vkey = document.querySelector(`.vkey[data-note="${note % 12 + 48}"]`);
                if (vkey) vkey.classList.add('active');
                state.arpIndex = (state.arpIndex + 1) % state.arpNotes.length;
            };
            play();
            state.arpInterval = setInterval(play, interval);
        }
        
        function playChordStrum(notes, velocity, inputNote) {
            state.activeNotes.set(inputNote, notes);
            notes.forEach((n, i) => {
                setTimeout(() => {
                    playNote(n, velocity);
                    sendMidiNoteOn(n, velocity, state.chordChannel);
                }, i * 30);
            });
        }
        
        function playChordHarp(notes, velocity, inputNote) {
            state.activeNotes.set(inputNote, notes);
            const harpNotes = [...notes, ...notes.slice().reverse().slice(1, -1)];
            const interval = 60000 / state.bpm / 8;
            harpNotes.forEach((n, i) => {
                setTimeout(() => {
                    playNote(n, velocity * 0.8);
                    sendMidiNoteOn(n, velocity, state.chordChannel);
                    setTimeout(() => {
                        stopNote(n);
                        sendMidiNoteOff(n, state.chordChannel);
                    }, interval * 0.9);
                }, i * interval);
            });
        }
        
        function playChordRandom(notes, velocity, inputNote) {
            state.arpNotes = notes;
            state.activeNotes.set(inputNote, []);
            const interval = 60000 / state.bpm / 4;
            const play = () => {
                state.arpNotes.forEach(n => {
                    stopNote(n);
                    sendMidiNoteOff(n, state.chordChannel);
                });
                const note = state.arpNotes[Math.floor(Math.random() * state.arpNotes.length)];
                playNote(note, velocity);
                sendMidiNoteOn(note, velocity, state.chordChannel);
            };
            play();
            state.arpInterval = setInterval(play, interval);
        }
        
        // ============================================
        // MIDI
        // ============================================
        
        async function requestMIDI() {
            try {
                midiAccess = await navigator.requestMIDIAccess({ sysex: false });
                midiInitialized = true;
                populateMIDIDevices();
                return true;
            } catch (err) {
                console.error('MIDI Error:', err);
                alert('Impossible d\'acc√©der au MIDI. V√©rifiez que votre navigateur supporte Web MIDI.');
                return false;
            }
        }
        
        function populateMIDIDevices() {
            const inputSelect = document.getElementById('modalMidiInput');
            const outputSelect = document.getElementById('modalMidiOutput');
            
            inputSelect.innerHTML = '<option value="">-- Aucune entr√©e --</option>';
            outputSelect.innerHTML = '<option value="">-- Audio interne seulement --</option>';
            
            midiAccess.inputs.forEach((input, id) => {
                const opt = document.createElement('option');
                opt.value = id;
                opt.textContent = input.name;
                inputSelect.appendChild(opt);
            });
            
            midiAccess.outputs.forEach((output, id) => {
                const opt = document.createElement('option');
                opt.value = id;
                opt.textContent = output.name;
                outputSelect.appendChild(opt);
            });
        }
        
        function connectMIDI(inputId, outputId) {
            if (midiInput) midiInput.onmidimessage = null;
            
            if (inputId && midiAccess) {
                midiInput = midiAccess.inputs.get(inputId);
                if (midiInput) {
                    midiInput.onmidimessage = handleMIDIMessage;
                }
            }
            
            midiOutput = outputId ? midiAccess.outputs.get(outputId) : null;
            
            const btn = document.getElementById('midiBtn');
            const dot = document.getElementById('statusDot');
            const status = document.getElementById('midiStatus');
            
            if (midiInput) {
                btn.classList.add('connected');
                dot.classList.add('on');
                status.textContent = midiInput.name.substring(0, 15);
            } else {
                btn.classList.remove('connected');
                dot.classList.remove('on');
                status.textContent = 'Connecter MIDI';
            }
        }
        
        function handleMIDIMessage(event) {
            const [status, note, velocity] = event.data;
            const command = status >> 4;
            
            const dot = document.getElementById('statusDot');
            dot.classList.add('active');
            setTimeout(() => dot.classList.remove('active'), 100);
            
            if (command === 9 && velocity > 0) {
                triggerChord(note, velocity);
            } else if (command === 8 || (command === 9 && velocity === 0)) {
                releaseChord(note);
            } else if (command === 11) {
                if (note === 1) {
                    state.voicing = Math.floor(velocity / 16);
                    updateVoicingKnob();
                    updateChordDisplay();
                }
            }
        }
        
        function sendMidiNoteOn(note, velocity, channel) {
            if (midiOutput) midiOutput.send([0x90 | channel, note, velocity]);
        }
        
        function sendMidiNoteOff(note, channel) {
            if (midiOutput) midiOutput.send([0x80 | channel, note, 0]);
        }
        
        // ============================================
        // BEAT MACHINE
        // ============================================
        
        function startBeat(patternId) {
            stopBeat();
            const pattern = BEAT_PATTERNS[patternId];
            if (!pattern) return;
            
            state.beatPattern = pattern;
            state.beatStep = 0;
            const interval = 60000 / state.bpm / 4;
            
            state.beatInterval = setInterval(() => {
                const idx = state.beatStep % pattern.pattern.length;
                if (pattern.pattern[idx]) {
                    const accent = pattern.accent[idx % pattern.accent.length];
                    const vel = accent ? 100 : 70;
                    if (accent) {
                        playKick(vel / 127 * 0.3);
                        sendMidiNoteOn(36, vel, state.drumChannel);
                        setTimeout(() => sendMidiNoteOff(36, state.drumChannel), 50);
                    } else {
                        playHihat(vel / 127 * 0.3);
                        sendMidiNoteOn(42, vel, state.drumChannel);
                        setTimeout(() => sendMidiNoteOff(42, state.drumChannel), 50);
                    }
                    if (idx === 4 || idx === 12) {
                        playSnare(0.25);
                        sendMidiNoteOn(38, 90, state.drumChannel);
                        setTimeout(() => sendMidiNoteOff(38, state.drumChannel), 50);
                    }
                }
                state.beatStep++;
            }, interval);
        }
        
        function stopBeat() {
            if (state.beatInterval) {
                clearInterval(state.beatInterval);
                state.beatInterval = null;
            }
        }
        
        // ============================================
        // LOOP
        // ============================================
        
        function toggleLoop() {
            const btn = document.getElementById('loopBtn');
            const icon = document.getElementById('loopIcon');
            const text = document.getElementById('loopText');
            
            switch (state.loopState) {
                case 'stopped':
                    state.loopState = 'recording';
                    state.loopData = [];
                    state.loopStartTime = Date.now();
                    btn.classList.add('recording');
                    icon.textContent = '‚èπÔ∏è';
                    text.textContent = 'REC';
                    break;
                case 'recording':
                    state.loopState = 'playing';
                    btn.classList.remove('recording');
                    btn.classList.add('playing');
                    icon.textContent = '‚è∏Ô∏è';
                    text.textContent = 'Play';
                    playLoop();
                    break;
                case 'playing':
                    state.loopState = 'stopped';
                    btn.classList.remove('playing');
                    icon.textContent = '‚è∫Ô∏è';
                    text.textContent = 'Loop';
                    if (state.loopInterval) {
                        clearInterval(state.loopInterval);
                        state.loopInterval = null;
                    }
                    break;
            }
        }
        
        function playLoop() {
            if (state.loopData.length === 0) {
                state.loopState = 'stopped';
                return;
            }
            
            const loopLength = state.loopData[state.loopData.length - 1].time + 500;
            let startTime = Date.now();
            
            state.loopInterval = setInterval(() => {
                const elapsed = (Date.now() - startTime) % loopLength;
                state.loopData.forEach(event => {
                    if (Math.abs(event.time - elapsed) < 20 && event.type === 'chord') {
                        state.rootNote = event.root;
                        updateRootSelection();
                        updateChordDisplay();
                        event.notes.forEach(n => {
                            playNote(n, event.velocity);
                            sendMidiNoteOn(n, event.velocity, state.chordChannel);
                            setTimeout(() => {
                                stopNote(n);
                                sendMidiNoteOff(n, state.chordChannel);
                            }, 300);
                        });
                    }
                });
            }, 10);
        }
        
        // ============================================
        // UI
        // ============================================
        
        function updateRootSelection() {
            document.querySelectorAll('.key-btn').forEach(btn => {
                btn.classList.toggle('active', parseInt(btn.dataset.note) === state.rootNote);
            });
        }
        
        function updateVisualKeyboard(notes) {
            document.querySelectorAll('.vkey').forEach(k => k.classList.remove('active'));
            notes.forEach(note => {
                const vkey = document.querySelector(`.vkey[data-note="${(note % 12) + 48}"]`);
                if (vkey) vkey.classList.add('active');
            });
        }
        
        function updateVoicingKnob() {
            const angle = -135 + (state.voicing / 7) * 270;
            document.getElementById('voicingIndicator').style.transform = `rotate(${angle}deg)`;
            document.getElementById('voicingValue').textContent = state.voicing;
        }
        
        function updateSpreadKnob() {
            const angle = -135 + ((state.spread - 1) / 2) * 270;
            document.getElementById('spreadIndicator').style.transform = `rotate(${angle}deg)`;
            document.getElementById('spreadValue').textContent = state.spread;
        }
        
        function updateOctaveKnob() {
            const angle = -135 + ((state.octave - 2) / 5) * 270;
            document.getElementById('octaveIndicator').style.transform = `rotate(${angle}deg)`;
            document.getElementById('octaveValue').textContent = state.octave;
        }
        
        function setupKnob(knobId, min, max, stateKey, updateFn) {
            const knob = document.getElementById(knobId);
            let isDragging = false, startY = 0, startValue = 0;
            
            const start = (y) => {
                isDragging = true;
                startY = y;
                startValue = state[stateKey];
            };
            
            const move = (y) => {
                if (!isDragging) return;
                const delta = (startY - y) / 100;
                let newValue = Math.round(startValue + delta * (max - min));
                state[stateKey] = Math.max(min, Math.min(max, newValue));
                updateFn();
                updateChordDisplay();
            };
            
            const end = () => { isDragging = false; };
            
            knob.addEventListener('mousedown', e => { e.preventDefault(); start(e.clientY); });
            document.addEventListener('mousemove', e => move(e.clientY));
            document.addEventListener('mouseup', end);
            knob.addEventListener('touchstart', e => { e.preventDefault(); start(e.touches[0].clientY); });
            document.addEventListener('touchmove', e => { if (isDragging) move(e.touches[0].clientY); });
            document.addEventListener('touchend', end);
        }
        
        function toggleFullscreen() {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen().catch(err => {
                    console.log('Fullscreen error:', err);
                });
            } else {
                document.exitFullscreen();
            }
        }
        
        function showMidiModal() {
            document.getElementById('midiModal').classList.add('show');
        }
        
        function hideMidiModal() {
            document.getElementById('midiModal').classList.remove('show');
        }
        
        // ============================================
        // INIT
        // ============================================
        
        function setupEventListeners() {
            // MIDI Button
            document.getElementById('midiBtn').addEventListener('click', async () => {
                if (!midiInitialized) {
                    const success = await requestMIDI();
                    if (success) showMidiModal();
                } else {
                    populateMIDIDevices();
                    showMidiModal();
                }
            });
            
            // Modal
            document.getElementById('modalCancel').addEventListener('click', hideMidiModal);
            document.getElementById('modalConnect').addEventListener('click', () => {
                const inputId = document.getElementById('modalMidiInput').value;
                const outputId = document.getElementById('modalMidiOutput').value;
                connectMIDI(inputId, outputId);
                hideMidiModal();
            });
            
            document.getElementById('midiModal').addEventListener('click', (e) => {
                if (e.target.id === 'midiModal') hideMidiModal();
            });
            
            // Fullscreen
            document.getElementById('fullscreenBtn').addEventListener('click', toggleFullscreen);
            
            // Chord types
            document.querySelectorAll('.chord-btn[data-type]').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.chord-btn[data-type]').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    state.chordType = btn.dataset.type;
                    updateChordDisplay();
                });
            });
            
            // Extensions
            document.querySelectorAll('.chord-btn[data-ext]').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.chord-btn[data-ext]').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    state.extension = btn.dataset.ext;
                    updateChordDisplay();
                });
            });
            
            // Keys
            document.querySelectorAll('.key-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.key-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    state.rootNote = parseInt(btn.dataset.note);
                    updateChordDisplay();
                });
            });
            
            // Performance modes
            document.querySelectorAll('.perf-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.perf-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    state.performanceMode = btn.dataset.mode;
                });
            });
            
            // Engines
            document.querySelectorAll('.engine-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.engine-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    state.engine = btn.dataset.engine;
                });
            });
            
            // Beats
            document.querySelectorAll('.beat-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.beat-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    const beatId = parseInt(btn.dataset.beat);
                    beatId === 0 ? stopBeat() : startBeat(beatId);
                });
            });
            
            // BPM
            document.getElementById('bpmSlider').addEventListener('input', (e) => {
                state.bpm = parseInt(e.target.value);
                document.getElementById('bpmDisplay').textContent = state.bpm;
                if (state.beatInterval) {
                    const activeBtn = document.querySelector('.beat-btn.active');
                    if (activeBtn && activeBtn.dataset.beat !== '0') {
                        startBeat(parseInt(activeBtn.dataset.beat));
                    }
                }
            });
            
            // Loop
            document.getElementById('loopBtn').addEventListener('click', toggleLoop);
            
            // Volumes
            document.getElementById('mainVolume').addEventListener('input', (e) => {
                state.mainVolume = parseInt(e.target.value) / 100;
                if (masterGain) masterGain.gain.value = state.mainVolume;
            });
            
            document.getElementById('bassVolume').addEventListener('input', (e) => {
                state.bassVolume = parseInt(e.target.value) / 100;
            });
            
            // Channels
            document.getElementById('chordChannel').addEventListener('change', (e) => {
                state.chordChannel = parseInt(e.target.value);
            });
            
            document.getElementById('bassChannel').addEventListener('change', (e) => {
                state.bassChannel = parseInt(e.target.value);
            });
            
            // Visual keyboard
            document.querySelectorAll('.vkey').forEach(key => {
                const trigger = () => triggerChord(parseInt(key.dataset.note), 100);
                const release = () => releaseChord(parseInt(key.dataset.note));
                
                key.addEventListener('mousedown', trigger);
                key.addEventListener('mouseup', release);
                key.addEventListener('mouseleave', release);
                key.addEventListener('touchstart', (e) => { e.preventDefault(); trigger(); });
                key.addEventListener('touchend', (e) => { e.preventDefault(); release(); });
            });
            
            // Knobs
            setupKnob('voicingKnob', 0, 7, 'voicing', updateVoicingKnob);
            setupKnob('spreadKnob', 1, 3, 'spread', updateSpreadKnob);
            setupKnob('octaveKnob', 2, 7, 'octave', updateOctaveKnob);
            
            // Keyboard shortcuts
            const keyMap = { a:48, w:49, s:50, e:51, d:52, f:53, t:54, g:55, y:56, h:57, u:58, j:59, k:60 };
            document.addEventListener('keydown', (e) => {
                if (keyMap[e.key] && !e.repeat) triggerChord(keyMap[e.key], 100);
            });
            document.addEventListener('keyup', (e) => {
                if (keyMap[e.key]) releaseChord(keyMap[e.key]);
            });
        }
        
        document.addEventListener('DOMContentLoaded', () => {
            setupEventListeners();
            updateChordDisplay();
            updateVoicingKnob();
            updateSpreadKnob();
            updateOctaveKnob();
        });
    </script>
</body>
</html>
