<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üå∏ Chord Machine - Orchid Style</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&family=Outfit:wght@300;400;600;700&display=swap');
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        :root {
            --bg-dark: #0a0a0f;
            --bg-panel: #141420;
            --bg-section: #1a1a2e;
            --accent-orange: #ff6b35;
            --accent-yellow: #ffc234;
            --accent-teal: #00d4aa;
            --accent-purple: #9d4edd;
            --accent-pink: #ff69b4;
            --text-primary: #f0f0f0;
            --text-secondary: #888;
            --border-glow: rgba(255, 107, 53, 0.3);
        }
        
        body {
            font-family: 'Outfit', sans-serif;
            background: var(--bg-dark);
            color: var(--text-primary);
            min-height: 100vh;
            overflow-x: hidden;
            background-image: 
                radial-gradient(ellipse at 20% 80%, rgba(157, 78, 221, 0.1) 0%, transparent 50%),
                radial-gradient(ellipse at 80% 20%, rgba(255, 107, 53, 0.1) 0%, transparent 50%);
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        
        /* Header */
        .header {
            text-align: center;
            padding: 20px 0 30px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            margin-bottom: 25px;
        }
        
        .logo {
            font-family: 'Space Mono', monospace;
            font-size: 2.5rem;
            font-weight: 700;
            background: linear-gradient(135deg, var(--accent-orange), var(--accent-yellow));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            letter-spacing: 4px;
            text-transform: uppercase;
        }
        
        .subtitle {
            color: var(--text-secondary);
            font-size: 0.85rem;
            margin-top: 5px;
            letter-spacing: 2px;
        }
        
        /* MIDI Setup Bar */
        .midi-bar {
            display: flex;
            gap: 20px;
            padding: 15px 20px;
            background: var(--bg-panel);
            border-radius: 12px;
            margin-bottom: 25px;
            align-items: center;
            flex-wrap: wrap;
            border: 1px solid rgba(255,255,255,0.05);
        }
        
        .midi-bar label {
            font-size: 0.75rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .midi-bar select {
            background: var(--bg-section);
            border: 1px solid rgba(255,255,255,0.1);
            color: var(--text-primary);
            padding: 8px 12px;
            border-radius: 6px;
            font-family: 'Space Mono', monospace;
            font-size: 0.8rem;
            min-width: 180px;
        }
        
        .midi-status {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-left: auto;
        }
        
        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #444;
            transition: all 0.3s;
        }
        
        .status-dot.connected {
            background: var(--accent-teal);
            box-shadow: 0 0 10px var(--accent-teal);
        }
        
        .status-dot.active {
            background: var(--accent-orange);
            box-shadow: 0 0 15px var(--accent-orange);
            animation: pulse 0.15s ease;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.4); }
            100% { transform: scale(1); }
        }
        
        /* Main Grid */
        .main-grid {
            display: grid;
            grid-template-columns: 1fr 300px;
            gap: 25px;
        }
        
        @media (max-width: 1100px) {
            .main-grid {
                grid-template-columns: 1fr;
            }
        }
        
        /* Panels */
        .panel {
            background: var(--bg-panel);
            border-radius: 16px;
            padding: 20px;
            border: 1px solid rgba(255,255,255,0.05);
        }
        
        .panel-title {
            font-family: 'Space Mono', monospace;
            font-size: 0.7rem;
            color: var(--accent-orange);
            text-transform: uppercase;
            letter-spacing: 2px;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .panel-title::before {
            content: '';
            width: 8px;
            height: 8px;
            background: var(--accent-orange);
            border-radius: 2px;
        }
        
        /* Chord Section */
        .chord-section {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            margin-bottom: 25px;
        }
        
        .chord-types, .chord-extensions {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
        }
        
        .chord-btn {
            background: var(--bg-section);
            border: 2px solid transparent;
            color: var(--text-primary);
            padding: 12px 8px;
            border-radius: 10px;
            font-family: 'Space Mono', monospace;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
        }
        
        .chord-btn:hover {
            background: rgba(255, 107, 53, 0.15);
            border-color: var(--accent-orange);
        }
        
        .chord-btn.active {
            background: var(--accent-orange);
            color: #000;
            border-color: var(--accent-orange);
            box-shadow: 0 0 20px rgba(255, 107, 53, 0.4);
        }
        
        .chord-btn.ext {
            font-size: 0.75rem;
        }
        
        .chord-btn.ext.active {
            background: var(--accent-yellow);
            border-color: var(--accent-yellow);
        }
        
        /* Current Chord Display */
        .chord-display {
            background: linear-gradient(135deg, var(--bg-section), #1f1f35);
            border-radius: 16px;
            padding: 25px;
            text-align: center;
            margin-bottom: 25px;
            border: 1px solid rgba(255,255,255,0.1);
            position: relative;
            overflow: hidden;
        }
        
        .chord-display::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, var(--accent-orange), var(--accent-yellow), var(--accent-teal));
        }
        
        .chord-name {
            font-family: 'Space Mono', monospace;
            font-size: 3.5rem;
            font-weight: 700;
            color: var(--accent-yellow);
            text-shadow: 0 0 30px rgba(255, 194, 52, 0.5);
            margin-bottom: 10px;
        }
        
        .chord-notes {
            font-size: 1rem;
            color: var(--text-secondary);
            letter-spacing: 4px;
        }
        
        /* Voicing Knob */
        .voicing-section {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 40px;
            margin-bottom: 25px;
            padding: 20px;
            background: var(--bg-section);
            border-radius: 12px;
        }
        
        .knob-container {
            text-align: center;
        }
        
        .knob {
            width: 100px;
            height: 100px;
            background: conic-gradient(from 220deg, var(--accent-orange), var(--accent-yellow), var(--accent-teal), var(--accent-purple), var(--accent-orange));
            border-radius: 50%;
            position: relative;
            cursor: pointer;
            box-shadow: 
                0 0 30px rgba(255, 107, 53, 0.3),
                inset 0 0 30px rgba(0,0,0,0.5);
        }
        
        .knob::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 70px;
            height: 70px;
            background: var(--bg-dark);
            border-radius: 50%;
            transform: translate(-50%, -50%);
        }
        
        .knob-indicator {
            position: absolute;
            top: 10px;
            left: 50%;
            width: 4px;
            height: 20px;
            background: var(--text-primary);
            border-radius: 2px;
            transform-origin: center 40px;
            z-index: 1;
            transition: transform 0.1s;
        }
        
        .knob-label {
            font-size: 0.7rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-top: 12px;
        }
        
        .knob-value {
            font-family: 'Space Mono', monospace;
            font-size: 1.2rem;
            color: var(--accent-teal);
            margin-top: 5px;
        }
        
        /* Key Selection */
        .key-section {
            margin-bottom: 25px;
        }
        
        .key-selector {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
            justify-content: center;
        }
        
        .key-btn {
            width: 42px;
            height: 42px;
            background: var(--bg-section);
            border: 2px solid transparent;
            color: var(--text-primary);
            border-radius: 8px;
            font-family: 'Space Mono', monospace;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .key-btn:hover {
            border-color: var(--accent-teal);
        }
        
        .key-btn.active {
            background: var(--accent-teal);
            color: #000;
            box-shadow: 0 0 15px rgba(0, 212, 170, 0.4);
        }
        
        .key-btn.black {
            background: #222;
        }
        
        /* Performance Modes */
        .performance-section {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 10px;
            margin-bottom: 25px;
        }
        
        .perf-btn {
            background: var(--bg-section);
            border: 2px solid rgba(255,255,255,0.1);
            color: var(--text-primary);
            padding: 15px 10px;
            border-radius: 10px;
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
        }
        
        .perf-btn:hover {
            border-color: var(--accent-purple);
        }
        
        .perf-btn.active {
            background: var(--accent-purple);
            color: #fff;
            border-color: var(--accent-purple);
            box-shadow: 0 0 20px rgba(157, 78, 221, 0.5);
        }
        
        .perf-icon {
            font-size: 1.5rem;
            margin-bottom: 5px;
        }
        
        /* Tempo & Loop Section */
        .tempo-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .tempo-control {
            background: var(--bg-section);
            border-radius: 10px;
            padding: 15px;
            text-align: center;
        }
        
        .tempo-display {
            font-family: 'Space Mono', monospace;
            font-size: 2rem;
            color: var(--accent-yellow);
        }
        
        .tempo-slider {
            width: 100%;
            margin-top: 10px;
            accent-color: var(--accent-orange);
        }
        
        .loop-btn {
            background: var(--bg-section);
            border: 2px solid transparent;
            border-radius: 10px;
            padding: 15px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        
        .loop-btn:hover {
            border-color: var(--accent-pink);
        }
        
        .loop-btn.recording {
            background: #3a1520;
            border-color: #ff4444;
            animation: rec-pulse 1s infinite;
        }
        
        .loop-btn.playing {
            background: #152a35;
            border-color: var(--accent-teal);
        }
        
        @keyframes rec-pulse {
            0%, 100% { box-shadow: 0 0 10px rgba(255, 68, 68, 0.3); }
            50% { box-shadow: 0 0 25px rgba(255, 68, 68, 0.6); }
        }
        
        .loop-icon {
            font-size: 2rem;
            margin-bottom: 5px;
        }
        
        /* Synth Engine */
        .synth-panel {
            margin-bottom: 20px;
        }
        
        .engine-selector {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            margin-bottom: 15px;
        }
        
        .engine-btn {
            background: var(--bg-section);
            border: 1px solid rgba(255,255,255,0.1);
            color: var(--text-secondary);
            padding: 10px;
            border-radius: 8px;
            font-size: 0.7rem;
            cursor: pointer;
            transition: all 0.2s;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .engine-btn.active {
            background: linear-gradient(135deg, var(--accent-purple), var(--accent-pink));
            color: #fff;
            border-color: transparent;
        }
        
        /* Effects */
        .effects-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
        }
        
        .effect-control {
            background: var(--bg-section);
            border-radius: 8px;
            padding: 12px;
            text-align: center;
        }
        
        .effect-label {
            font-size: 0.65rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 8px;
        }
        
        .effect-slider {
            width: 100%;
            accent-color: var(--accent-teal);
        }
        
        /* Sidebar */
        .sidebar {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        /* Beat Machine */
        .beat-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 6px;
        }
        
        .beat-btn {
            aspect-ratio: 1;
            background: var(--bg-section);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 6px;
            color: var(--text-secondary);
            font-size: 0.6rem;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            padding: 4px;
        }
        
        .beat-btn:hover {
            border-color: var(--accent-pink);
        }
        
        .beat-btn.active {
            background: var(--accent-pink);
            color: #fff;
            border-color: var(--accent-pink);
        }
        
        /* Volume/Bass Section */
        .volume-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        
        .volume-control {
            background: var(--bg-section);
            border-radius: 10px;
            padding: 15px;
            text-align: center;
        }
        
        .volume-label {
            font-size: 0.65rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            margin-bottom: 10px;
        }
        
        .volume-slider {
            writing-mode: bt-lr;
            -webkit-appearance: slider-vertical;
            width: 30px;
            height: 80px;
            accent-color: var(--accent-orange);
        }
        
        /* MIDI Channel Config */
        .channel-config {
            display: grid;
            gap: 10px;
        }
        
        .channel-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            background: var(--bg-section);
            border-radius: 6px;
        }
        
        .channel-label {
            font-size: 0.75rem;
        }
        
        .channel-select {
            background: var(--bg-dark);
            border: 1px solid rgba(255,255,255,0.1);
            color: var(--text-primary);
            padding: 4px 8px;
            border-radius: 4px;
            font-family: 'Space Mono', monospace;
            font-size: 0.75rem;
            width: 60px;
        }
        
        /* Footer Info */
        .info-text {
            font-size: 0.7rem;
            color: var(--text-secondary);
            text-align: center;
            padding: 10px;
            line-height: 1.6;
        }
        
        /* Visual Keyboard */
        .visual-keyboard {
            display: flex;
            justify-content: center;
            gap: 3px;
            padding: 15px;
            background: var(--bg-section);
            border-radius: 10px;
            margin-top: 20px;
        }
        
        .vkey {
            width: 35px;
            height: 100px;
            background: linear-gradient(180deg, #f5f5f5, #ddd);
            border-radius: 0 0 5px 5px;
            cursor: pointer;
            transition: all 0.1s;
            position: relative;
        }
        
        .vkey:hover {
            background: linear-gradient(180deg, #fff, #eee);
        }
        
        .vkey.active {
            background: linear-gradient(180deg, var(--accent-yellow), var(--accent-orange));
            box-shadow: 0 0 15px rgba(255, 194, 52, 0.5);
        }
        
        .vkey.black {
            width: 25px;
            height: 65px;
            background: linear-gradient(180deg, #333, #111);
            margin: 0 -12px;
            z-index: 1;
        }
        
        .vkey.black:hover {
            background: linear-gradient(180deg, #444, #222);
        }
        
        .vkey.black.active {
            background: linear-gradient(180deg, var(--accent-purple), #6a2c9a);
        }
        
        .vkey-label {
            position: absolute;
            bottom: 5px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 0.6rem;
            color: #666;
        }
        
        .vkey.black .vkey-label {
            color: #888;
        }
    </style>
</head>
<body>
    <div class="container">
        <header class="header">
            <h1 class="logo">üå∏ Chord Machine</h1>
            <p class="subtitle">Orchid-Style Chord Generator ‚Ä¢ Web MIDI</p>
        </header>
        
        <!-- MIDI Setup -->
        <div class="midi-bar">
            <div>
                <label>MIDI Input (MPK)</label><br>
                <select id="midiInput">
                    <option value="">-- S√©lectionner --</option>
                </select>
            </div>
            <div>
                <label>MIDI Output</label><br>
                <select id="midiOutput">
                    <option value="">-- Aucun (Audio Only) --</option>
                </select>
            </div>
            <div class="midi-status">
                <span class="status-dot" id="statusDot"></span>
                <span id="statusText">D√©connect√©</span>
            </div>
        </div>
        
        <!-- Main Content -->
        <div class="main-grid">
            <div class="main-content">
                <!-- Chord Types & Extensions -->
                <div class="panel">
                    <div class="panel-title">Chord Matrix</div>
                    <div class="chord-section">
                        <div>
                            <div class="panel-title" style="font-size: 0.6rem; color: var(--text-secondary);">Type</div>
                            <div class="chord-types">
                                <button class="chord-btn active" data-type="maj">MAJ</button>
                                <button class="chord-btn" data-type="min">MIN</button>
                                <button class="chord-btn" data-type="dim">DIM</button>
                                <button class="chord-btn" data-type="aug">AUG</button>
                                <button class="chord-btn" data-type="sus2">SUS2</button>
                                <button class="chord-btn" data-type="sus4">SUS4</button>
                                <button class="chord-btn" data-type="power">5TH</button>
                                <button class="chord-btn" data-type="add9">ADD9</button>
                            </div>
                        </div>
                        <div>
                            <div class="panel-title" style="font-size: 0.6rem; color: var(--text-secondary);">Extension</div>
                            <div class="chord-extensions">
                                <button class="chord-btn ext active" data-ext="none">‚Äî</button>
                                <button class="chord-btn ext" data-ext="7">7</button>
                                <button class="chord-btn ext" data-ext="maj7">M7</button>
                                <button class="chord-btn ext" data-ext="9">9</button>
                                <button class="chord-btn ext" data-ext="11">11</button>
                                <button class="chord-btn ext" data-ext="13">13</button>
                                <button class="chord-btn ext" data-ext="6">6</button>
                                <button class="chord-btn ext" data-ext="69">6/9</button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Current Chord Display -->
                <div class="chord-display">
                    <div class="chord-name" id="chordName">C</div>
                    <div class="chord-notes" id="chordNotes">C ‚Ä¢ E ‚Ä¢ G</div>
                </div>
                
                <!-- Key Selection -->
                <div class="panel key-section">
                    <div class="panel-title">Root Note / Tonalit√©</div>
                    <div class="key-selector">
                        <button class="key-btn active" data-note="0">C</button>
                        <button class="key-btn black" data-note="1">C#</button>
                        <button class="key-btn" data-note="2">D</button>
                        <button class="key-btn black" data-note="3">D#</button>
                        <button class="key-btn" data-note="4">E</button>
                        <button class="key-btn" data-note="5">F</button>
                        <button class="key-btn black" data-note="6">F#</button>
                        <button class="key-btn" data-note="7">G</button>
                        <button class="key-btn black" data-note="8">G#</button>
                        <button class="key-btn" data-note="9">A</button>
                        <button class="key-btn black" data-note="10">A#</button>
                        <button class="key-btn" data-note="11">B</button>
                    </div>
                </div>
                
                <!-- Voicing Control -->
                <div class="panel">
                    <div class="panel-title">Voicing & Inversion</div>
                    <div class="voicing-section">
                        <div class="knob-container">
                            <div class="knob" id="voicingKnob">
                                <div class="knob-indicator" id="voicingIndicator"></div>
                            </div>
                            <div class="knob-label">Voicing</div>
                            <div class="knob-value" id="voicingValue">0</div>
                        </div>
                        <div class="knob-container">
                            <div class="knob" id="spreadKnob" style="background: conic-gradient(from 220deg, var(--accent-teal), var(--accent-purple), var(--accent-pink), var(--accent-teal));">
                                <div class="knob-indicator" id="spreadIndicator"></div>
                            </div>
                            <div class="knob-label">Spread</div>
                            <div class="knob-value" id="spreadValue">1</div>
                        </div>
                        <div class="knob-container">
                            <div class="knob" id="octaveKnob" style="background: conic-gradient(from 220deg, var(--accent-yellow), var(--accent-orange), var(--accent-pink), var(--accent-yellow));">
                                <div class="knob-indicator" id="octaveIndicator"></div>
                            </div>
                            <div class="knob-label">Octave</div>
                            <div class="knob-value" id="octaveValue">4</div>
                        </div>
                    </div>
                </div>
                
                <!-- Performance Modes -->
                <div class="panel">
                    <div class="panel-title">Performance Mode</div>
                    <div class="performance-section">
                        <button class="perf-btn active" data-mode="hold">
                            <div class="perf-icon">üéπ</div>
                            Hold
                        </button>
                        <button class="perf-btn" data-mode="arp">
                            <div class="perf-icon">‚ÜóÔ∏è</div>
                            Arp
                        </button>
                        <button class="perf-btn" data-mode="strum">
                            <div class="perf-icon">üé∏</div>
                            Strum
                        </button>
                        <button class="perf-btn" data-mode="harp">
                            <div class="perf-icon">üéª</div>
                            Harp
                        </button>
                        <button class="perf-btn" data-mode="random">
                            <div class="perf-icon">üé≤</div>
                            Random
                        </button>
                    </div>
                    
                    <!-- Tempo & Loop -->
                    <div class="tempo-section">
                        <div class="tempo-control">
                            <div class="effect-label">BPM</div>
                            <div class="tempo-display" id="bpmDisplay">120</div>
                            <input type="range" class="tempo-slider" id="bpmSlider" min="40" max="200" value="120">
                        </div>
                        <button class="loop-btn" id="loopBtn">
                            <div class="loop-icon" id="loopIcon">‚è∫Ô∏è</div>
                            <span id="loopText">Loop</span>
                        </button>
                    </div>
                </div>
                
                <!-- Visual Keyboard -->
                <div class="panel">
                    <div class="panel-title">Keyboard (ou cliquez)</div>
                    <div class="visual-keyboard" id="visualKeyboard">
                        <div class="vkey" data-note="48"><span class="vkey-label">C</span></div>
                        <div class="vkey black" data-note="49"><span class="vkey-label">C#</span></div>
                        <div class="vkey" data-note="50"><span class="vkey-label">D</span></div>
                        <div class="vkey black" data-note="51"><span class="vkey-label">D#</span></div>
                        <div class="vkey" data-note="52"><span class="vkey-label">E</span></div>
                        <div class="vkey" data-note="53"><span class="vkey-label">F</span></div>
                        <div class="vkey black" data-note="54"><span class="vkey-label">F#</span></div>
                        <div class="vkey" data-note="55"><span class="vkey-label">G</span></div>
                        <div class="vkey black" data-note="56"><span class="vkey-label">G#</span></div>
                        <div class="vkey" data-note="57"><span class="vkey-label">A</span></div>
                        <div class="vkey black" data-note="58"><span class="vkey-label">A#</span></div>
                        <div class="vkey" data-note="59"><span class="vkey-label">B</span></div>
                        <div class="vkey" data-note="60"><span class="vkey-label">C</span></div>
                    </div>
                </div>
            </div>
            
            <!-- Sidebar -->
            <div class="sidebar">
                <!-- Synth Engine -->
                <div class="panel synth-panel">
                    <div class="panel-title">Synth Engine</div>
                    <div class="engine-selector">
                        <button class="engine-btn active" data-engine="analog">Analog</button>
                        <button class="engine-btn" data-engine="fm">FM</button>
                        <button class="engine-btn" data-engine="epiano">E-Piano</button>
                    </div>
                    
                    <!-- Effects -->
                    <div class="effects-grid">
                        <div class="effect-control">
                            <div class="effect-label">Reverb</div>
                            <input type="range" class="effect-slider" id="reverbSlider" min="0" max="100" value="30">
                        </div>
                        <div class="effect-control">
                            <div class="effect-label">Chorus</div>
                            <input type="range" class="effect-slider" id="chorusSlider" min="0" max="100" value="0">
                        </div>
                        <div class="effect-control">
                            <div class="effect-label">Delay</div>
                            <input type="range" class="effect-slider" id="delaySlider" min="0" max="100" value="0">
                        </div>
                    </div>
                </div>
                
                <!-- Volume Controls -->
                <div class="panel">
                    <div class="panel-title">Levels</div>
                    <div class="volume-section">
                        <div class="volume-control">
                            <div class="volume-label">Main</div>
                            <input type="range" class="effect-slider" id="mainVolume" min="0" max="100" value="70" style="width: 100%;">
                        </div>
                        <div class="volume-control">
                            <div class="volume-label">Bass</div>
                            <input type="range" class="effect-slider" id="bassVolume" min="0" max="100" value="50" style="width: 100%;">
                        </div>
                    </div>
                </div>
                
                <!-- Beat Machine -->
                <div class="panel">
                    <div class="panel-title">Beat Machine</div>
                    <div class="beat-grid">
                        <button class="beat-btn" data-beat="0">OFF</button>
                        <button class="beat-btn" data-beat="1">Rock</button>
                        <button class="beat-btn" data-beat="2">Pop</button>
                        <button class="beat-btn" data-beat="3">Funk</button>
                        <button class="beat-btn" data-beat="4">Jazz</button>
                        <button class="beat-btn" data-beat="5">Bossa</button>
                        <button class="beat-btn" data-beat="6">R&B</button>
                        <button class="beat-btn" data-beat="7">House</button>
                        <button class="beat-btn" data-beat="8">Hip Hop</button>
                        <button class="beat-btn" data-beat="9">Trap</button>
                        <button class="beat-btn" data-beat="10">Chill</button>
                        <button class="beat-btn" data-beat="11">Ballad</button>
                    </div>
                </div>
                
                <!-- MIDI Channels -->
                <div class="panel">
                    <div class="panel-title">MIDI Channels</div>
                    <div class="channel-config">
                        <div class="channel-row">
                            <span class="channel-label">Chords</span>
                            <select class="channel-select" id="chordChannel">
                                <option value="0">Ch 1</option>
                                <option value="1">Ch 2</option>
                                <option value="2">Ch 3</option>
                                <option value="3">Ch 4</option>
                            </select>
                        </div>
                        <div class="channel-row">
                            <span class="channel-label">Bass</span>
                            <select class="channel-select" id="bassChannel">
                                <option value="0">Ch 1</option>
                                <option value="1" selected>Ch 2</option>
                                <option value="2">Ch 3</option>
                                <option value="3">Ch 4</option>
                            </select>
                        </div>
                        <div class="channel-row">
                            <span class="channel-label">Drums</span>
                            <select class="channel-select" id="drumChannel">
                                <option value="9" selected>Ch 10</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <div class="info-text">
                    Jouez des notes sur votre MPK pour d√©clencher des accords. 
                    Chaque note = accord avec la tonalit√© s√©lectionn√©e.
                </div>
            </div>
        </div>
    </div>

    <script>
        // ============================================
        // üå∏ CHORD MACHINE - Orchid Style
        // Web MIDI Chord Generator
        // ============================================
        
        // Audio Context
        let audioCtx = null;
        let masterGain = null;
        let reverbNode = null;
        let delayNode = null;
        let chorusNode = null;
        
        // MIDI
        let midiAccess = null;
        let midiInput = null;
        let midiOutput = null;
        
        // State
        const state = {
            rootNote: 0,        // C = 0
            chordType: 'maj',
            extension: 'none',
            voicing: 0,         // 0-7 inversions/voicings
            spread: 1,          // 1-3 octave spread
            octave: 4,
            performanceMode: 'hold',
            bpm: 120,
            engine: 'analog',
            
            // Effects
            reverb: 0.3,
            chorus: 0,
            delay: 0,
            
            // Volumes
            mainVolume: 0.7,
            bassVolume: 0.5,
            
            // Channels
            chordChannel: 0,
            bassChannel: 1,
            drumChannel: 9,
            
            // Active notes
            activeNotes: new Map(),
            activeOscillators: new Map(),
            
            // Arpeggiator
            arpInterval: null,
            arpIndex: 0,
            arpNotes: [],
            
            // Loop
            loopState: 'stopped', // stopped, recording, playing
            loopData: [],
            loopStartTime: 0,
            loopPlaybackIndex: 0,
            loopInterval: null,
            
            // Beat
            beatPattern: null,
            beatInterval: null,
            beatStep: 0
        };
        
        // Note names
        const NOTE_NAMES = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'];
        
        // Chord formulas (intervals from root)
        const CHORD_FORMULAS = {
            maj: [0, 4, 7],
            min: [0, 3, 7],
            dim: [0, 3, 6],
            aug: [0, 4, 8],
            sus2: [0, 2, 7],
            sus4: [0, 5, 7],
            power: [0, 7],
            add9: [0, 4, 7, 14]
        };
        
        // Extensions
        const EXTENSIONS = {
            none: [],
            '7': [10],
            maj7: [11],
            '9': [10, 14],
            '11': [10, 14, 17],
            '13': [10, 14, 17, 21],
            '6': [9],
            '69': [9, 14]
        };
        
        // Beat patterns (simplified)
        const BEAT_PATTERNS = {
            0: null,
            1: { name: 'Rock', pattern: [1,0,1,0,1,0,1,0, 1,0,1,0,1,0,1,0], accent: [1,0,0,0,1,0,0,0] },
            2: { name: 'Pop', pattern: [1,0,1,0,1,0,1,0, 1,0,1,0,1,0,1,1], accent: [1,0,0,0,1,0,0,0] },
            3: { name: 'Funk', pattern: [1,0,1,1,0,1,0,1, 1,0,1,1,0,1,1,0], accent: [1,0,0,1,0,0,1,0] },
            4: { name: 'Jazz', pattern: [1,0,0,1,0,1,0,0, 1,0,0,1,0,1,0,1], accent: [1,0,0,0,1,0,0,0] },
            5: { name: 'Bossa', pattern: [1,0,0,1,0,0,1,0, 0,1,0,0,1,0,0,0], accent: [1,0,0,0,0,0,1,0] },
            6: { name: 'R&B', pattern: [1,0,0,1,0,1,1,0, 1,0,0,1,0,1,0,1], accent: [1,0,0,0,1,0,0,0] },
            7: { name: 'House', pattern: [1,0,0,0,1,0,0,0, 1,0,0,0,1,0,0,0], accent: [1,0,0,0,1,0,0,0] },
            8: { name: 'Hip Hop', pattern: [1,0,0,0,0,0,1,0, 0,0,1,0,0,0,0,1], accent: [1,0,0,0,0,0,1,0] },
            9: { name: 'Trap', pattern: [1,1,0,1,1,0,1,1, 0,1,1,0,1,0,1,1], accent: [1,0,0,0,1,0,0,0] },
            10: { name: 'Chill', pattern: [1,0,0,0,0,1,0,0, 1,0,0,0,0,1,0,0], accent: [1,0,0,0,0,0,0,0] },
            11: { name: 'Ballad', pattern: [1,0,0,0,1,0,0,0, 1,0,0,0,1,0,0,0], accent: [1,0,0,0,0,0,0,0] }
        };
        
        // ============================================
        // AUDIO INIT
        // ============================================
        
        function initAudio() {
            if (audioCtx) return;
            
            audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            
            // Master gain
            masterGain = audioCtx.createGain();
            masterGain.gain.value = state.mainVolume;
            
            // Create reverb (convolver with impulse)
            reverbNode = audioCtx.createConvolver();
            createReverbImpulse();
            
            // Delay
            delayNode = audioCtx.createDelay(1.0);
            delayNode.delayTime.value = 0.3;
            const delayFeedback = audioCtx.createGain();
            delayFeedback.gain.value = 0.3;
            const delayWet = audioCtx.createGain();
            delayWet.gain.value = state.delay;
            
            // Simple routing
            masterGain.connect(audioCtx.destination);
        }
        
        function createReverbImpulse() {
            const rate = audioCtx.sampleRate;
            const length = rate * 2;
            const impulse = audioCtx.createBuffer(2, length, rate);
            
            for (let channel = 0; channel < 2; channel++) {
                const data = impulse.getChannelData(channel);
                for (let i = 0; i < length; i++) {
                    data[i] = (Math.random() * 2 - 1) * Math.pow(1 - i / length, 2);
                }
            }
            
            reverbNode.buffer = impulse;
        }
        
        // ============================================
        // CHORD GENERATION
        // ============================================
        
        function buildChord(rootNote, type, extension, voicing, spread, baseOctave) {
            let intervals = [...CHORD_FORMULAS[type]];
            
            // Add extension
            if (extension !== 'none') {
                intervals = intervals.concat(EXTENSIONS[extension]);
            }
            
            // Apply voicing (rotation)
            for (let i = 0; i < voicing; i++) {
                if (intervals.length > 1) {
                    const first = intervals.shift();
                    intervals.push(first + 12);
                }
            }
            
            // Apply spread
            if (spread > 1) {
                intervals = intervals.map((interval, idx) => {
                    return interval + Math.floor(idx / 2) * 12 * (spread - 1);
                });
            }
            
            // Convert to MIDI notes
            const baseMidi = 12 + (baseOctave * 12) + rootNote;
            return intervals.map(interval => baseMidi + interval);
        }
        
        function getChordName() {
            const rootName = NOTE_NAMES[state.rootNote];
            let typeName = '';
            
            switch (state.chordType) {
                case 'maj': typeName = ''; break;
                case 'min': typeName = 'm'; break;
                case 'dim': typeName = '¬∞'; break;
                case 'aug': typeName = '+'; break;
                case 'sus2': typeName = 'sus2'; break;
                case 'sus4': typeName = 'sus4'; break;
                case 'power': typeName = '5'; break;
                case 'add9': typeName = 'add9'; break;
            }
            
            let extName = '';
            if (state.extension !== 'none') {
                extName = state.extension === 'maj7' ? 'maj7' : state.extension;
            }
            
            return rootName + typeName + extName;
        }
        
        function updateChordDisplay() {
            const chordNotes = buildChord(
                state.rootNote,
                state.chordType,
                state.extension,
                state.voicing,
                state.spread,
                state.octave
            );
            
            const noteNames = chordNotes.map(midi => NOTE_NAMES[midi % 12]);
            
            document.getElementById('chordName').textContent = getChordName();
            document.getElementById('chordNotes').textContent = noteNames.join(' ‚Ä¢ ');
        }
        
        // ============================================
        // SYNTH ENGINES
        // ============================================
        
        function playNote(midiNote, velocity = 100) {
            if (!audioCtx) initAudio();
            if (audioCtx.state === 'suspended') audioCtx.resume();
            
            const freq = 440 * Math.pow(2, (midiNote - 69) / 12);
            const vol = (velocity / 127) * state.mainVolume * 0.15;
            
            let osc, gain;
            
            switch (state.engine) {
                case 'analog':
                    osc = createAnalogOsc(freq, vol);
                    break;
                case 'fm':
                    osc = createFMOsc(freq, vol);
                    break;
                case 'epiano':
                    osc = createEPianoOsc(freq, vol);
                    break;
            }
            
            if (osc) {
                state.activeOscillators.set(midiNote, osc);
            }
        }
        
        function createAnalogOsc(freq, vol) {
            const osc = audioCtx.createOscillator();
            const osc2 = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            const filter = audioCtx.createBiquadFilter();
            
            osc.type = 'sawtooth';
            osc.frequency.value = freq;
            osc2.type = 'square';
            osc2.frequency.value = freq * 1.005; // Slight detune
            
            filter.type = 'lowpass';
            filter.frequency.value = 2000 + (freq * 2);
            filter.Q.value = 2;
            
            gain.gain.setValueAtTime(0, audioCtx.currentTime);
            gain.gain.linearRampToValueAtTime(vol, audioCtx.currentTime + 0.02);
            
            osc.connect(filter);
            osc2.connect(filter);
            filter.connect(gain);
            gain.connect(masterGain);
            
            osc.start();
            osc2.start();
            
            return { osc: [osc, osc2], gain, filter };
        }
        
        function createFMOsc(freq, vol) {
            const carrier = audioCtx.createOscillator();
            const modulator = audioCtx.createOscillator();
            const modGain = audioCtx.createGain();
            const gain = audioCtx.createGain();
            
            carrier.type = 'sine';
            carrier.frequency.value = freq;
            
            modulator.type = 'sine';
            modulator.frequency.value = freq * 2;
            modGain.gain.value = freq * 0.5;
            
            gain.gain.setValueAtTime(0, audioCtx.currentTime);
            gain.gain.linearRampToValueAtTime(vol * 1.5, audioCtx.currentTime + 0.01);
            
            modulator.connect(modGain);
            modGain.connect(carrier.frequency);
            carrier.connect(gain);
            gain.connect(masterGain);
            
            carrier.start();
            modulator.start();
            
            return { osc: [carrier, modulator], gain };
        }
        
        function createEPianoOsc(freq, vol) {
            const osc = audioCtx.createOscillator();
            const osc2 = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            
            osc.type = 'sine';
            osc.frequency.value = freq;
            osc2.type = 'triangle';
            osc2.frequency.value = freq * 2;
            
            gain.gain.setValueAtTime(0, audioCtx.currentTime);
            gain.gain.linearRampToValueAtTime(vol, audioCtx.currentTime + 0.005);
            gain.gain.exponentialRampToValueAtTime(vol * 0.3, audioCtx.currentTime + 0.5);
            
            osc.connect(gain);
            osc2.connect(gain);
            gain.connect(masterGain);
            
            osc.start();
            osc2.start();
            
            return { osc: [osc, osc2], gain };
        }
        
        function stopNote(midiNote) {
            const oscData = state.activeOscillators.get(midiNote);
            if (oscData) {
                const { osc, gain } = oscData;
                
                gain.gain.linearRampToValueAtTime(0, audioCtx.currentTime + 0.1);
                
                setTimeout(() => {
                    osc.forEach(o => o.stop());
                }, 150);
                
                state.activeOscillators.delete(midiNote);
            }
        }
        
        // ============================================
        // CHORD TRIGGERING
        // ============================================
        
        function triggerChord(inputNote, velocity) {
            // Map input note to root selection (transpose within octave)
            const inputRoot = inputNote % 12;
            
            // Get chord notes
            const chordNotes = buildChord(
                inputRoot,
                state.chordType,
                state.extension,
                state.voicing,
                state.spread,
                state.octave
            );
            
            // Update display
            state.rootNote = inputRoot;
            updateRootSelection();
            updateChordDisplay();
            
            // Stop any current arp
            if (state.arpInterval) {
                clearInterval(state.arpInterval);
                state.arpInterval = null;
            }
            
            // Clear previous notes
            state.activeNotes.forEach((notes, key) => {
                notes.forEach(n => {
                    stopNote(n);
                    sendMidiNoteOff(n, state.chordChannel);
                });
            });
            state.activeNotes.clear();
            
            // Record to loop if recording
            if (state.loopState === 'recording') {
                const time = Date.now() - state.loopStartTime;
                state.loopData.push({
                    type: 'chord',
                    time,
                    notes: chordNotes,
                    velocity,
                    root: inputRoot
                });
            }
            
            // Play based on performance mode
            switch (state.performanceMode) {
                case 'hold':
                    playChordHold(chordNotes, velocity, inputNote);
                    break;
                case 'arp':
                    playChordArp(chordNotes, velocity, inputNote);
                    break;
                case 'strum':
                    playChordStrum(chordNotes, velocity, inputNote);
                    break;
                case 'harp':
                    playChordHarp(chordNotes, velocity, inputNote);
                    break;
                case 'random':
                    playChordRandom(chordNotes, velocity, inputNote);
                    break;
            }
            
            // Play bass
            const bassNote = inputRoot + (state.octave - 1) * 12 + 12;
            playBass(bassNote, velocity);
            
            // Update visual keyboard
            updateVisualKeyboard(chordNotes);
        }
        
        function releaseChord(inputNote) {
            const notes = state.activeNotes.get(inputNote);
            if (notes) {
                notes.forEach(n => {
                    stopNote(n);
                    sendMidiNoteOff(n, state.chordChannel);
                });
                state.activeNotes.delete(inputNote);
            }
            
            // Stop arp
            if (state.arpInterval) {
                clearInterval(state.arpInterval);
                state.arpInterval = null;
                state.arpNotes.forEach(n => {
                    stopNote(n);
                    sendMidiNoteOff(n, state.chordChannel);
                });
            }
            
            // Stop bass
            stopBass();
            
            // Clear visual keyboard
            document.querySelectorAll('.vkey.active').forEach(k => k.classList.remove('active'));
        }
        
        function playChordHold(notes, velocity, inputNote) {
            notes.forEach(n => {
                playNote(n, velocity);
                sendMidiNoteOn(n, velocity, state.chordChannel);
            });
            state.activeNotes.set(inputNote, notes);
        }
        
        function playChordArp(notes, velocity, inputNote) {
            state.arpNotes = notes;
            state.arpIndex = 0;
            state.activeNotes.set(inputNote, []);
            
            const interval = 60000 / state.bpm / 4; // 16th notes
            
            const playArpNote = () => {
                // Stop previous
                state.arpNotes.forEach(n => {
                    stopNote(n);
                    sendMidiNoteOff(n, state.chordChannel);
                });
                
                // Play current
                const note = state.arpNotes[state.arpIndex];
                playNote(note, velocity);
                sendMidiNoteOn(note, velocity, state.chordChannel);
                
                // Highlight on visual keyboard
                document.querySelectorAll('.vkey.active').forEach(k => k.classList.remove('active'));
                const vkey = document.querySelector(`.vkey[data-note="${note % 12 + 48}"]`);
                if (vkey) vkey.classList.add('active');
                
                state.arpIndex = (state.arpIndex + 1) % state.arpNotes.length;
            };
            
            playArpNote();
            state.arpInterval = setInterval(playArpNote, interval);
        }
        
        function playChordStrum(notes, velocity, inputNote) {
            state.activeNotes.set(inputNote, notes);
            
            notes.forEach((n, i) => {
                setTimeout(() => {
                    playNote(n, velocity);
                    sendMidiNoteOn(n, velocity, state.chordChannel);
                }, i * 30); // 30ms between each note
            });
        }
        
        function playChordHarp(notes, velocity, inputNote) {
            state.activeNotes.set(inputNote, notes);
            
            // Up then down
            const harpNotes = [...notes, ...notes.slice().reverse().slice(1, -1)];
            const interval = 60000 / state.bpm / 8;
            
            harpNotes.forEach((n, i) => {
                setTimeout(() => {
                    playNote(n, velocity * 0.8);
                    sendMidiNoteOn(n, velocity, state.chordChannel);
                    setTimeout(() => {
                        stopNote(n);
                        sendMidiNoteOff(n, state.chordChannel);
                    }, interval * 0.9);
                }, i * interval);
            });
        }
        
        function playChordRandom(notes, velocity, inputNote) {
            state.arpNotes = notes;
            state.activeNotes.set(inputNote, []);
            
            const interval = 60000 / state.bpm / 4;
            
            const playRandomNote = () => {
                state.arpNotes.forEach(n => {
                    stopNote(n);
                    sendMidiNoteOff(n, state.chordChannel);
                });
                
                const note = state.arpNotes[Math.floor(Math.random() * state.arpNotes.length)];
                playNote(note, velocity);
                sendMidiNoteOn(note, velocity, state.chordChannel);
            };
            
            playRandomNote();
            state.arpInterval = setInterval(playRandomNote, interval);
        }
        
        // Bass
        let bassOsc = null;
        let bassGain = null;
        
        function playBass(note, velocity) {
            if (!audioCtx) initAudio();
            
            const freq = 440 * Math.pow(2, (note - 69) / 12);
            const vol = (velocity / 127) * state.bassVolume * 0.2;
            
            if (bassOsc) {
                bassOsc.forEach(o => o.stop());
            }
            
            const osc = audioCtx.createOscillator();
            const osc2 = audioCtx.createOscillator();
            bassGain = audioCtx.createGain();
            
            osc.type = 'sine';
            osc.frequency.value = freq;
            osc2.type = 'triangle';
            osc2.frequency.value = freq;
            
            bassGain.gain.setValueAtTime(0, audioCtx.currentTime);
            bassGain.gain.linearRampToValueAtTime(vol, audioCtx.currentTime + 0.02);
            
            osc.connect(bassGain);
            osc2.connect(bassGain);
            bassGain.connect(masterGain);
            
            osc.start();
            osc2.start();
            
            bassOsc = [osc, osc2];
            
            // MIDI out
            sendMidiNoteOn(note, velocity, state.bassChannel);
        }
        
        function stopBass() {
            if (bassOsc && bassGain) {
                bassGain.gain.linearRampToValueAtTime(0, audioCtx.currentTime + 0.1);
                setTimeout(() => {
                    bassOsc.forEach(o => o.stop());
                    bassOsc = null;
                }, 150);
            }
        }
        
        // ============================================
        // MIDI I/O
        // ============================================
        
        async function initMIDI() {
            try {
                midiAccess = await navigator.requestMIDIAccess();
                populateMIDIDevices();
                
                midiAccess.onstatechange = () => populateMIDIDevices();
                
                document.getElementById('statusDot').classList.add('connected');
                document.getElementById('statusText').textContent = 'MIDI Ready';
            } catch (err) {
                console.error('MIDI Error:', err);
                document.getElementById('statusText').textContent = 'MIDI non disponible';
            }
        }
        
        function populateMIDIDevices() {
            const inputSelect = document.getElementById('midiInput');
            const outputSelect = document.getElementById('midiOutput');
            
            // Clear
            inputSelect.innerHTML = '<option value="">-- S√©lectionner --</option>';
            outputSelect.innerHTML = '<option value="">-- Aucun (Audio Only) --</option>';
            
            // Inputs
            midiAccess.inputs.forEach((input, id) => {
                const opt = document.createElement('option');
                opt.value = id;
                opt.textContent = input.name;
                inputSelect.appendChild(opt);
            });
            
            // Outputs
            midiAccess.outputs.forEach((output, id) => {
                const opt = document.createElement('option');
                opt.value = id;
                opt.textContent = output.name;
                outputSelect.appendChild(opt);
            });
        }
        
        function connectMIDIInput(id) {
            if (midiInput) {
                midiInput.onmidimessage = null;
            }
            
            if (id && midiAccess) {
                midiInput = midiAccess.inputs.get(id);
                if (midiInput) {
                    midiInput.onmidimessage = handleMIDIMessage;
                    document.getElementById('statusText').textContent = 'Connect√©: ' + midiInput.name;
                }
            }
        }
        
        function connectMIDIOutput(id) {
            if (id && midiAccess) {
                midiOutput = midiAccess.outputs.get(id);
            } else {
                midiOutput = null;
            }
        }
        
        function handleMIDIMessage(event) {
            const [status, note, velocity] = event.data;
            const command = status >> 4;
            const channel = status & 0x0F;
            
            // Flash activity indicator
            const dot = document.getElementById('statusDot');
            dot.classList.add('active');
            setTimeout(() => dot.classList.remove('active'), 100);
            
            if (command === 9 && velocity > 0) {
                // Note On
                triggerChord(note, velocity);
            } else if (command === 8 || (command === 9 && velocity === 0)) {
                // Note Off
                releaseChord(note);
            } else if (command === 11) {
                // CC
                handleCC(note, velocity);
            }
        }
        
        function handleCC(cc, value) {
            // Map common CCs
            switch (cc) {
                case 1: // Mod wheel -> voicing
                    state.voicing = Math.floor(value / 16);
                    updateVoicingKnob();
                    updateChordDisplay();
                    break;
                case 74: // Filter/Cutoff -> spread
                    state.spread = Math.floor(value / 43) + 1;
                    updateSpreadKnob();
                    updateChordDisplay();
                    break;
            }
        }
        
        function sendMidiNoteOn(note, velocity, channel) {
            if (midiOutput) {
                midiOutput.send([0x90 | channel, note, velocity]);
            }
        }
        
        function sendMidiNoteOff(note, channel) {
            if (midiOutput) {
                midiOutput.send([0x80 | channel, note, 0]);
            }
        }
        
        // ============================================
        // BEAT MACHINE
        // ============================================
        
        function startBeat(patternId) {
            stopBeat();
            
            const pattern = BEAT_PATTERNS[patternId];
            if (!pattern) return;
            
            state.beatPattern = pattern;
            state.beatStep = 0;
            
            const interval = 60000 / state.bpm / 4; // 16th notes
            
            state.beatInterval = setInterval(() => {
                const idx = state.beatStep % pattern.pattern.length;
                
                if (pattern.pattern[idx]) {
                    const accent = pattern.accent[idx % pattern.accent.length];
                    const velocity = accent ? 100 : 70;
                    
                    // Play kick on accent, hihat otherwise
                    if (accent) {
                        playDrumSound('kick', velocity);
                        sendMidiNoteOn(36, velocity, state.drumChannel);
                        setTimeout(() => sendMidiNoteOff(36, state.drumChannel), 50);
                    } else {
                        playDrumSound('hihat', velocity);
                        sendMidiNoteOn(42, velocity, state.drumChannel);
                        setTimeout(() => sendMidiNoteOff(42, state.drumChannel), 50);
                    }
                    
                    // Snare on 2 and 4
                    if (idx === 4 || idx === 12) {
                        playDrumSound('snare', 90);
                        sendMidiNoteOn(38, 90, state.drumChannel);
                        setTimeout(() => sendMidiNoteOff(38, state.drumChannel), 50);
                    }
                }
                
                state.beatStep++;
            }, interval);
        }
        
        function stopBeat() {
            if (state.beatInterval) {
                clearInterval(state.beatInterval);
                state.beatInterval = null;
            }
        }
        
        function playDrumSound(type, velocity) {
            if (!audioCtx) initAudio();
            
            const vol = (velocity / 127) * 0.3;
            
            switch (type) {
                case 'kick':
                    playKick(vol);
                    break;
                case 'snare':
                    playSnare(vol);
                    break;
                case 'hihat':
                    playHihat(vol);
                    break;
            }
        }
        
        function playKick(vol) {
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            
            osc.frequency.setValueAtTime(150, audioCtx.currentTime);
            osc.frequency.exponentialRampToValueAtTime(40, audioCtx.currentTime + 0.1);
            
            gain.gain.setValueAtTime(vol, audioCtx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.3);
            
            osc.connect(gain);
            gain.connect(masterGain);
            osc.start();
            osc.stop(audioCtx.currentTime + 0.3);
        }
        
        function playSnare(vol) {
            const noise = audioCtx.createBufferSource();
            const noiseBuffer = audioCtx.createBuffer(1, audioCtx.sampleRate * 0.2, audioCtx.sampleRate);
            const data = noiseBuffer.getChannelData(0);
            for (let i = 0; i < data.length; i++) {
                data[i] = Math.random() * 2 - 1;
            }
            noise.buffer = noiseBuffer;
            
            const filter = audioCtx.createBiquadFilter();
            filter.type = 'highpass';
            filter.frequency.value = 1000;
            
            const gain = audioCtx.createGain();
            gain.gain.setValueAtTime(vol * 0.5, audioCtx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.15);
            
            noise.connect(filter);
            filter.connect(gain);
            gain.connect(masterGain);
            noise.start();
        }
        
        function playHihat(vol) {
            const noise = audioCtx.createBufferSource();
            const noiseBuffer = audioCtx.createBuffer(1, audioCtx.sampleRate * 0.05, audioCtx.sampleRate);
            const data = noiseBuffer.getChannelData(0);
            for (let i = 0; i < data.length; i++) {
                data[i] = Math.random() * 2 - 1;
            }
            noise.buffer = noiseBuffer;
            
            const filter = audioCtx.createBiquadFilter();
            filter.type = 'highpass';
            filter.frequency.value = 7000;
            
            const gain = audioCtx.createGain();
            gain.gain.setValueAtTime(vol * 0.3, audioCtx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.05);
            
            noise.connect(filter);
            filter.connect(gain);
            gain.connect(masterGain);
            noise.start();
        }
        
        // ============================================
        // LOOP
        // ============================================
        
        function toggleLoop() {
            const btn = document.getElementById('loopBtn');
            const icon = document.getElementById('loopIcon');
            const text = document.getElementById('loopText');
            
            switch (state.loopState) {
                case 'stopped':
                    // Start recording
                    state.loopState = 'recording';
                    state.loopData = [];
                    state.loopStartTime = Date.now();
                    btn.classList.add('recording');
                    btn.classList.remove('playing');
                    icon.textContent = '‚èπÔ∏è';
                    text.textContent = 'REC...';
                    break;
                    
                case 'recording':
                    // Stop recording, start playback
                    state.loopState = 'playing';
                    btn.classList.remove('recording');
                    btn.classList.add('playing');
                    icon.textContent = '‚è∏Ô∏è';
                    text.textContent = 'Playing';
                    playLoop();
                    break;
                    
                case 'playing':
                    // Stop playback
                    state.loopState = 'stopped';
                    btn.classList.remove('playing');
                    icon.textContent = '‚è∫Ô∏è';
                    text.textContent = 'Loop';
                    if (state.loopInterval) {
                        clearInterval(state.loopInterval);
                        state.loopInterval = null;
                    }
                    break;
            }
        }
        
        function playLoop() {
            if (state.loopData.length === 0) {
                state.loopState = 'stopped';
                return;
            }
            
            const loopLength = state.loopData[state.loopData.length - 1].time + 500;
            let startTime = Date.now();
            
            const checkAndPlay = () => {
                const elapsed = (Date.now() - startTime) % loopLength;
                
                state.loopData.forEach(event => {
                    if (Math.abs(event.time - elapsed) < 20 && event.type === 'chord') {
                        state.rootNote = event.root;
                        updateRootSelection();
                        updateChordDisplay();
                        
                        event.notes.forEach(n => {
                            playNote(n, event.velocity);
                            sendMidiNoteOn(n, event.velocity, state.chordChannel);
                            
                            setTimeout(() => {
                                stopNote(n);
                                sendMidiNoteOff(n, state.chordChannel);
                            }, 300);
                        });
                    }
                });
            };
            
            state.loopInterval = setInterval(checkAndPlay, 10);
        }
        
        // ============================================
        // UI UPDATES
        // ============================================
        
        function updateRootSelection() {
            document.querySelectorAll('.key-btn').forEach(btn => {
                btn.classList.toggle('active', parseInt(btn.dataset.note) === state.rootNote);
            });
        }
        
        function updateVisualKeyboard(notes) {
            document.querySelectorAll('.vkey').forEach(k => k.classList.remove('active'));
            
            notes.forEach(note => {
                const normalizedNote = (note % 12) + 48;
                const vkey = document.querySelector(`.vkey[data-note="${normalizedNote}"]`);
                if (vkey) vkey.classList.add('active');
            });
        }
        
        function updateVoicingKnob() {
            const angle = -135 + (state.voicing / 7) * 270;
            document.getElementById('voicingIndicator').style.transform = `rotate(${angle}deg)`;
            document.getElementById('voicingValue').textContent = state.voicing;
        }
        
        function updateSpreadKnob() {
            const angle = -135 + ((state.spread - 1) / 2) * 270;
            document.getElementById('spreadIndicator').style.transform = `rotate(${angle}deg)`;
            document.getElementById('spreadValue').textContent = state.spread;
        }
        
        function updateOctaveKnob() {
            const angle = -135 + ((state.octave - 2) / 5) * 270;
            document.getElementById('octaveIndicator').style.transform = `rotate(${angle}deg)`;
            document.getElementById('octaveValue').textContent = state.octave;
        }
        
        // Knob interaction
        function setupKnob(knobId, valueId, indicatorId, min, max, stateKey, updateFn) {
            const knob = document.getElementById(knobId);
            let isDragging = false;
            let startY = 0;
            let startValue = 0;
            
            knob.addEventListener('mousedown', (e) => {
                isDragging = true;
                startY = e.clientY;
                startValue = state[stateKey];
                e.preventDefault();
            });
            
            document.addEventListener('mousemove', (e) => {
                if (!isDragging) return;
                
                const delta = (startY - e.clientY) / 100;
                let newValue = startValue + delta * (max - min);
                newValue = Math.round(Math.max(min, Math.min(max, newValue)));
                
                state[stateKey] = newValue;
                updateFn();
                updateChordDisplay();
            });
            
            document.addEventListener('mouseup', () => {
                isDragging = false;
            });
            
            // Touch support
            knob.addEventListener('touchstart', (e) => {
                isDragging = true;
                startY = e.touches[0].clientY;
                startValue = state[stateKey];
                e.preventDefault();
            });
            
            document.addEventListener('touchmove', (e) => {
                if (!isDragging) return;
                
                const delta = (startY - e.touches[0].clientY) / 100;
                let newValue = startValue + delta * (max - min);
                newValue = Math.round(Math.max(min, Math.min(max, newValue)));
                
                state[stateKey] = newValue;
                updateFn();
                updateChordDisplay();
            });
            
            document.addEventListener('touchend', () => {
                isDragging = false;
            });
        }
        
        // ============================================
        // EVENT LISTENERS
        // ============================================
        
        function setupEventListeners() {
            // MIDI selects
            document.getElementById('midiInput').addEventListener('change', (e) => {
                connectMIDIInput(e.target.value);
            });
            
            document.getElementById('midiOutput').addEventListener('change', (e) => {
                connectMIDIOutput(e.target.value);
            });
            
            // Chord type buttons
            document.querySelectorAll('.chord-btn[data-type]').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.chord-btn[data-type]').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    state.chordType = btn.dataset.type;
                    updateChordDisplay();
                });
            });
            
            // Extension buttons
            document.querySelectorAll('.chord-btn[data-ext]').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.chord-btn[data-ext]').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    state.extension = btn.dataset.ext;
                    updateChordDisplay();
                });
            });
            
            // Key buttons
            document.querySelectorAll('.key-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.key-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    state.rootNote = parseInt(btn.dataset.note);
                    updateChordDisplay();
                });
            });
            
            // Performance mode buttons
            document.querySelectorAll('.perf-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.perf-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    state.performanceMode = btn.dataset.mode;
                });
            });
            
            // Engine buttons
            document.querySelectorAll('.engine-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.engine-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    state.engine = btn.dataset.engine;
                });
            });
            
            // Beat buttons
            document.querySelectorAll('.beat-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.beat-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    
                    const beatId = parseInt(btn.dataset.beat);
                    if (beatId === 0) {
                        stopBeat();
                    } else {
                        startBeat(beatId);
                    }
                });
            });
            
            // BPM slider
            document.getElementById('bpmSlider').addEventListener('input', (e) => {
                state.bpm = parseInt(e.target.value);
                document.getElementById('bpmDisplay').textContent = state.bpm;
                
                // Restart beat if playing
                if (state.beatInterval) {
                    const activeBtn = document.querySelector('.beat-btn.active');
                    if (activeBtn && activeBtn.dataset.beat !== '0') {
                        startBeat(parseInt(activeBtn.dataset.beat));
                    }
                }
            });
            
            // Loop button
            document.getElementById('loopBtn').addEventListener('click', toggleLoop);
            
            // Volume sliders
            document.getElementById('mainVolume').addEventListener('input', (e) => {
                state.mainVolume = parseInt(e.target.value) / 100;
                if (masterGain) masterGain.gain.value = state.mainVolume;
            });
            
            document.getElementById('bassVolume').addEventListener('input', (e) => {
                state.bassVolume = parseInt(e.target.value) / 100;
            });
            
            // Effect sliders
            document.getElementById('reverbSlider').addEventListener('input', (e) => {
                state.reverb = parseInt(e.target.value) / 100;
            });
            
            document.getElementById('chorusSlider').addEventListener('input', (e) => {
                state.chorus = parseInt(e.target.value) / 100;
            });
            
            document.getElementById('delaySlider').addEventListener('input', (e) => {
                state.delay = parseInt(e.target.value) / 100;
            });
            
            // Channel selects
            document.getElementById('chordChannel').addEventListener('change', (e) => {
                state.chordChannel = parseInt(e.target.value);
            });
            
            document.getElementById('bassChannel').addEventListener('change', (e) => {
                state.bassChannel = parseInt(e.target.value);
            });
            
            // Visual keyboard
            document.querySelectorAll('.vkey').forEach(key => {
                key.addEventListener('mousedown', () => {
                    const note = parseInt(key.dataset.note);
                    triggerChord(note, 100);
                });
                
                key.addEventListener('mouseup', () => {
                    const note = parseInt(key.dataset.note);
                    releaseChord(note);
                });
                
                key.addEventListener('mouseleave', () => {
                    const note = parseInt(key.dataset.note);
                    releaseChord(note);
                });
                
                // Touch
                key.addEventListener('touchstart', (e) => {
                    e.preventDefault();
                    const note = parseInt(key.dataset.note);
                    triggerChord(note, 100);
                });
                
                key.addEventListener('touchend', (e) => {
                    e.preventDefault();
                    const note = parseInt(key.dataset.note);
                    releaseChord(note);
                });
            });
            
            // Setup knobs
            setupKnob('voicingKnob', 'voicingValue', 'voicingIndicator', 0, 7, 'voicing', updateVoicingKnob);
            setupKnob('spreadKnob', 'spreadValue', 'spreadIndicator', 1, 3, 'spread', updateSpreadKnob);
            setupKnob('octaveKnob', 'octaveValue', 'octaveIndicator', 2, 7, 'octave', updateOctaveKnob);
            
            // Keyboard shortcuts
            document.addEventListener('keydown', (e) => {
                const keyMap = {
                    'a': 48, 'w': 49, 's': 50, 'e': 51, 'd': 52,
                    'f': 53, 't': 54, 'g': 55, 'y': 56, 'h': 57,
                    'u': 58, 'j': 59, 'k': 60
                };
                
                if (keyMap[e.key] && !e.repeat) {
                    triggerChord(keyMap[e.key], 100);
                }
            });
            
            document.addEventListener('keyup', (e) => {
                const keyMap = {
                    'a': 48, 'w': 49, 's': 50, 'e': 51, 'd': 52,
                    'f': 53, 't': 54, 'g': 55, 'y': 56, 'h': 57,
                    'u': 58, 'j': 59, 'k': 60
                };
                
                if (keyMap[e.key]) {
                    releaseChord(keyMap[e.key]);
                }
            });
        }
        
        // ============================================
        // INIT
        // ============================================
        
        document.addEventListener('DOMContentLoaded', () => {
            initMIDI();
            setupEventListeners();
            updateChordDisplay();
            updateVoicingKnob();
            updateSpreadKnob();
            updateOctaveKnob();
            
            // Select first beat button as "off"
            document.querySelector('.beat-btn[data-beat="0"]').classList.add('active');
        });
    </script>
</body>
</html>